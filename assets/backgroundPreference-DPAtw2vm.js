import{c as N,s as S}from"./constellation-uI2meXO3.js";const T=(o="constellation-canvas")=>{const n=document.getElementById(o);if(!n)return{cleanup:()=>{}};const e=n.getContext("2d"),r=[];let c=0,l=0,i,f=!0;const d=()=>{c=window.innerWidth,l=Math.max(window.innerHeight,document.documentElement.scrollHeight),n.width=c,n.height=l;const a=Math.min(260,Math.max(120,Math.floor(c*l/14e3)));for(;r.length<a;)r.push({x:Math.random()*c,y:Math.random()*l,r:Math.random()*2.2+.8,speed:Math.random()*.7+.6,drift:(Math.random()-.5)*.6,opacity:Math.random()*.4+.4,wobble:Math.random()*Math.PI*2});r.splice(a)},v=a=>{const h=a*.02,b=a*.06;r.forEach(s=>{s.wobble+=a*.0025,s.x+=(Math.sin(s.wobble)*.6+s.drift)*h,s.y+=(s.speed+Math.cos(s.wobble)*.08)*b,s.x<-10&&(s.x=c+10),s.x>c+10&&(s.x=-10),s.y>l+12&&(s.y=-12,s.x=Math.random()*c)})},w=()=>{e.clearRect(0,0,c,l),e.fillStyle="#e2e8f0",r.forEach(a=>{e.beginPath(),e.globalAlpha=a.opacity,e.arc(a.x,a.y,a.r,0,Math.PI*2),e.fill()}),e.globalAlpha=1};let y=performance.now();const p=a=>{if(!f)return;const h=Math.min(40,a-y);y=a,v(h),w(),i=requestAnimationFrame(p)};return d(),window.addEventListener("resize",d),i=requestAnimationFrame(p),{cleanup:()=>{f=!1,i&&cancelAnimationFrame(i),window.removeEventListener("resize",d),e.clearRect(0,0,c,l),r.splice(0,r.length)}}},U=(o="constellation-canvas")=>{const n=document.getElementById(o);if(!n)return{cleanup:()=>{}};const e=n.getContext("2d"),r=[];let c=0,l=0,i,f=!0;const d=()=>{c=window.innerWidth,l=Math.max(window.innerHeight,document.documentElement.scrollHeight),n.width=c,n.height=l;const a=Math.min(320,Math.max(140,Math.floor(c*l/12e3)));for(;r.length<a;)r.push({x:Math.random()*c,y:Math.random()*l,len:Math.random()*18+12,speed:Math.random()*.9+.9,opacity:Math.random()*.35+.35,drift:(Math.random()-.5)*.4});r.splice(a)},v=a=>{const h=a*.35,b=a*.12;r.forEach(s=>{s.x+=s.drift*b,s.y+=s.speed*h,s.x<-20&&(s.x=c+20),s.x>c+20&&(s.x=-20),s.y>l+20&&(s.y=-20,s.x=Math.random()*c)})},w=()=>{e.clearRect(0,0,c,l),e.strokeStyle="rgba(125, 211, 252, 0.7)",e.lineWidth=1.1,e.lineCap="round",r.forEach(a=>{e.globalAlpha=a.opacity,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x+a.drift*6,a.y+a.len),e.stroke()}),e.globalAlpha=1};let y=performance.now();const p=a=>{if(!f)return;const h=Math.min(40,a-y);y=a,v(h),w(),i=requestAnimationFrame(p)};return d(),window.addEventListener("resize",d),i=requestAnimationFrame(p),{cleanup:()=>{f=!1,i&&cancelAnimationFrame(i),window.removeEventListener("resize",d),e.clearRect(0,0,c,l),r.splice(0,r.length)}}},W=async()=>{try{const o=await fetch("https://ipapi.co/json/",{cache:"no-store"});if(!o.ok)return null;const n=await o.json(),e=Number(n?.latitude),r=Number(n?.longitude);if(!Number.isFinite(e)||!Number.isFinite(r))return null;const c=n?.city,l=n?.region,i=n?.country_name||n?.country;return{lat:e,lon:r,source:"ip",...c?{city:c}:{},...l?{region:l}:{},...i?{country:i}:{}}}catch{return null}},D=W,I="techloc-background-mode",G=new Set([71,73,75,77,85,86]),H=new Set([51,53,55,56,57,61,63,65,66,67,80,81,82]),V=(o,n)=>`https://api.open-meteo.com/v1/forecast?latitude=${o}&longitude=${n}&current=weather_code&timezone=auto`,L=new Set(["snow","rain","constellation","auto"]),_=I;Array.from(L);const m=o=>L.has(o)?o:"auto",j=()=>m(localStorage.getItem(I)),K=o=>localStorage.setItem(I,m(o)),X=({canvasId:o="constellation-canvas",controlButton:n,controlMenu:e,statusLabel:r,initialMode:c,onModeChange:l}={})=>{let i=m(c??j()),f=null,d=!1,v=null,w=null;const y=async()=>{try{const t=await D();if(!t?.lat||!t?.lon)return{snowing:!1,raining:!1,reason:null};const u=await fetch(V(t.lat,t.lon),{cache:"no-store"});if(!u.ok)return{snowing:!1,raining:!1,reason:null};const g=await u.json(),x=Number(g?.current?.weather_code),A=G.has(x),k=H.has(x);return{snowing:A,raining:k,reason:A?"Snow detected in your area":k?"Rain detected in your area":"No precipitation right now"}}catch{return{snowing:!1,raining:!1,reason:null}}},p=()=>{w&&(clearInterval(w),w=null)},E=async()=>{if(i!=="auto")return;h("Checking local weather for backgroundâ€¦");const{snowing:t,raining:u,reason:g}=await y();i==="auto"&&(F(t?"snow":u?"rain":"constellation"),h(g||""))},a=()=>{p(),E(),w=setInterval(E,10*60*1e3)},h=t=>{r&&(r.textContent=t)},b=()=>{e&&e.classList.add("hidden"),d=!1},s=()=>{e&&e.classList.remove("hidden"),d=!0},P=()=>d?b():s(),F=t=>{v=t,f&&f(),f=(t==="snow"?T(o):t==="rain"?U(o):N(o))?.cleanup||null},z=()=>{e&&e.querySelectorAll("[data-bg-option]").forEach(t=>{t.getAttribute("data-bg-option")===i?t.classList.add("bg-slate-800","text-white"):t.classList.remove("bg-slate-800","text-white")})},B=()=>{if(!n)return;const t=n.querySelector("[data-bg-label]");if(t){const g={auto:"Background: Auto",snow:"Background: Snow",rain:"Background: Rain",constellation:"Background: Constellations"};t.textContent=g[i]||"Background"}const u=n.querySelector("[data-bg-icon]");u&&(u.setAttribute("data-lucide",i==="snow"?"snowflake":i==="rain"?"cloud-rain":i==="constellation"?"sparkles":"cloud-sun"),window.lucide&&window.lucide.createIcons())},O=t=>{const u=m(t);K(u),typeof l=="function"&&Promise.resolve().then(()=>l(u)).catch(g=>console.warn("Unable to sync background mode",g))},M=async(t=i)=>{if(i=m(t),O(i),z(),B(),t==="auto"){a();return}p(),F(t==="snow"?"snow":t==="rain"?"rain":"constellation"),h(t==="snow"?"Snow mode active":t==="rain"?"Rain mode active":"Constellations mode active")},q=t=>{const u=t.target.closest("[data-bg-option]");if(!u)return;const g=u.getAttribute("data-bg-option");if(g==="auto"){const x=["auto","constellation","snow","rain"],A=x.indexOf(i),k=x[(A+1)%x.length];M(k);return}b(),M(g)};return n&&n.addEventListener("click",t=>{t.stopPropagation(),P()}),e&&e.addEventListener("click",q),document.addEventListener("click",t=>{d&&(e&&e.contains(t.target)||n&&n.contains(t.target)||b())}),document.addEventListener("keydown",t=>{t.key==="Escape"&&d&&b()}),M(i),{applyMode:M,setAuto:()=>M("auto"),setConstellations:()=>M("constellation"),setSnow:()=>M("snow"),get mode(){return i},get variant(){return v}}},Y=()=>m(localStorage.getItem(_)),C=o=>localStorage.setItem(_,m(o)),R=async()=>{if(!S?.auth?.getUser)return null;try{const{data:{user:o}}=await S.auth.getUser();return o?.id||null}catch(o){return console.warn("Unable to resolve current user for background preference",o),null}},$=async()=>{if(!S)return null;const o=await R();if(!o)return null;const{data:n,error:e}=await S.from("profiles").select("*").eq("id",o).maybeSingle();return e?e.code==="PGRST204"||e.message?.includes("background_mode")?(console.warn("Profile background_mode column missing in Supabase schema."),null):(console.warn("Unable to fetch background preference from profile",e),null):n&&"background_mode"in n?m(n.background_mode):null},J=async o=>{if(!S)return;const n=await R();if(!n)return;const e=m(o);try{const{error:r}=await S.from("profiles").update({background_mode:e}).eq("id",n);if(r){if(r.code==="PGRST204"||r.message?.includes("background_mode")){console.warn("Cannot save background_mode: column missing in Supabase.");return}throw r}}catch(r){console.warn("Failed to save background preference:",r)}},Z=async()=>{const o=await $();return o?(C(o),o):Y()},ee=async o=>{const n=m(o);C(n);try{await J(n)}catch(e){console.warn("Unable to save background preference to profile",e)}};export{Z as l,ee as p,X as s};
