import{c as ut,s as pt}from"./constellation-uI2meXO3.js";import{r as ft}from"./Header-CYr_2qJu.js";ft("header-root");const fe="services_request",Te="user_table_configs",Re="services_request",gt="vehicles",mt="services_categories",yt="services",$=20,qe="tl_services_table_prefs_v5";function E(e){if(!e)return"—";const t=new Date(e);if(isNaN(t))return"—";const n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0"),s=String(t.getFullYear()).slice(-2);return`${n}/${o}/${s}`}function Ne(e){if(e==null||e==="")return"—";const t=Number(e);return isNaN(t)?String(e):t.toLocaleString("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2})}function k(e){if(!e)return null;const t=new Date(e);return isNaN(t)?null:t.getTime()}function te(e){return e==null?"":String(e).toLowerCase()}const le=["Open","In Progress","Waiting","Closed"];function I(e){const t=String(e??"").trim();if(!t)return null;const n=t.toLowerCase().replace(/\s+/g," ").trim();return n==="open"||n==="new"?"Open":n==="in progress"||n==="inprogress"||n==="in-progress"||n==="progress"||n==="working"?"In Progress":n==="waiting"||n==="on hold"||n==="hold"||n==="pending"||n==="awaiting"||n==="awaiting parts"?"Waiting":n==="closed"||n==="done"||n==="completed"||n==="complete"||n==="resolved"?"Closed":le.find(s=>s.toLowerCase()===n)||t}function _(e){const t=new Date(e);return t.setHours(0,0,0,0),t.getTime()}function T(e){const t=new Date(e);return t.setHours(23,59,59,999),t.getTime()}function bt(e){const t=new Date(e);return new Date(t.getFullYear(),t.getMonth(),1,0,0,0,0).getTime()}function ht(e){const t=new Date(e);return new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59,999).getTime()}function ge(e){return new Date(e.getFullYear(),e.getMonth(),1)}function Ve(e,t){return new Date(e.getFullYear(),e.getMonth()+t,1)}function vt(e,t){const n=e["request date"]||e.request_date,o=e.workdate||e["work date"]||e.work_date,s=e["shipping date"]||e.shipping_date;return t==="request"?k(n):t==="work"?k(o):t==="shipping"?k(s):k(s)??k(o)??k(n)}const kt=[{key:"company_name",label:"Company Name",filter:"text",defaultWidth:180},{key:"company phone",label:"Company Phone",filter:"text",defaultWidth:150},{key:"doc",label:"Doc",filter:"text",defaultWidth:120},{key:"unittype",label:"Unit Type",filter:"text",defaultWidth:120},{key:"brand",label:"Brand",filter:"text",defaultWidth:120},{key:"model",label:"Model",filter:"text",defaultWidth:120},{key:"model year",label:"Model Year",filter:"text",defaultWidth:100},{key:"shortvin",label:"Short VIN",filter:"text",defaultWidth:100},{key:"status",label:"Status",filter:"select",options:["","Open","In Progress","Waiting","Closed"],defaultWidth:120},{key:"request date",label:"Request Date",filter:"text",isDate:!0,defaultWidth:120},{key:"workdate",label:"Work Date",filter:"text",isDate:!0,defaultWidth:120},{key:"shipping date",label:"Shipping Date",filter:"text",isDate:!0,defaultWidth:130},{key:"quote",label:"Quote",filter:"text",isMoney:!0,defaultWidth:120},{key:"poc name",label:"POC Name",filter:"text",defaultWidth:140},{key:"poc phone",label:"POC Phone",filter:"text",defaultWidth:140},{key:"confirmed",label:"Confirmed",filter:"select",options:["","true","false"],isBoolean:!0,defaultWidth:110},{key:"state",label:"State",filter:"text",defaultWidth:70},{key:"city",label:"City",filter:"text",defaultWidth:120},{key:"zip",label:"ZIP",filter:"text",defaultWidth:80},{key:"address",label:"Address",filter:"text",defaultWidth:320,wide:!0},{key:"Service_category",label:"Service Category",filter:"text",defaultWidth:150},{key:"Notes",label:"Notes",filter:"text",defaultWidth:220,wide:!0},{key:"POC email",label:"POC Email",filter:"text",defaultWidth:170}],a={view:"table",filterStatus:null,kbDateField:"auto",kbRange:"all",kbFrom:null,kbTo:null,calendarMonth:null,client:null,loading:!1,lastError:null,allRows:[],filteredRows:[],page:1,total:0,sortKey:null,sortDir:"asc",colFilters:{},colOrder:[],colVisible:{},colWidths:{},dbColumns:[],vehicles:[],vehiclesByVin:new Map,categories:[],modalVinSelected:!1,pinnedRowId:null},xt=document.getElementById("tableView"),wt=document.getElementById("kanbanView"),Et=document.getElementById("calendarView"),It=document.getElementById("ganttView"),$e=document.getElementById("kanbanColumns"),St=document.getElementById("calendarList"),Lt=document.getElementById("calendarPrevBtn"),$t=document.getElementById("calendarNextBtn"),Bt=document.getElementById("calendarTodayBtn"),Dt=document.getElementById("calendarMonthLabel"),Mt=document.getElementById("calendarMeta"),F=document.getElementById("tableScrollWrap"),Ct=document.getElementById("dataTable"),H=document.getElementById("colGroup"),S=document.getElementById("tableHeaderRow"),K=document.getElementById("tableBody"),ne=document.getElementById("topScrollWrap"),_t=document.getElementById("topScrollInner"),Be=document.getElementById("emptyState"),Tt=document.getElementById("emptyTitle"),Rt=document.getElementById("emptyMsg"),A=document.getElementById("resultsMeta"),Fe=document.getElementById("prevPage"),Oe=document.getElementById("nextPage"),qt=document.getElementById("pageMeta"),Nt=document.getElementById("columnsBtn"),re=document.getElementById("columnsMenu"),De=document.getElementById("columnsList"),Vt=document.getElementById("colsAll"),Ft=document.getElementById("colsNone"),Ot=document.getElementById("colsClose"),R=document.getElementById("modalOverlay"),Pt=document.getElementById("modalClose"),V=document.getElementById("newRequestBtn"),Wt=document.getElementById("requestForm"),me=document.getElementById("requestId"),Pe=document.getElementById("companyNameInput"),We=document.getElementById("companyPhoneInput"),Ae=document.getElementById("docInput"),ye=document.getElementById("unitTypeInput"),be=document.getElementById("brandInput"),he=document.getElementById("modelInput"),j=document.getElementById("modelYearInput"),x=document.getElementById("shortVinInput"),B=document.getElementById("vinMenu"),ie=document.getElementById("vinHint"),He=document.getElementById("statusInput"),Ke=document.getElementById("quoteInput"),je=document.getElementById("requestDateInput"),ze=document.getElementById("workDateInput"),Ue=document.getElementById("shippingDateInput"),Ye=document.getElementById("pocNameInput"),Ge=document.getElementById("pocPhoneInput"),ce=document.getElementById("confirmedInput"),Xe=document.getElementById("stateInput"),Ze=document.getElementById("cityInput"),Je=document.getElementById("zipInput"),Qe=document.getElementById("addressInput"),q=document.getElementById("categoryInput"),z=document.getElementById("formError"),At=document.getElementById("modalTitle"),et=document.getElementById("deleteBtn"),de=document.getElementById("kbDateField"),Ht=document.getElementById("kbMeta"),Kt=document.getElementById("kbCustomWrap"),ue=document.getElementById("kbFrom"),pe=document.getElementById("kbTo"),P=document.getElementById("ganttScale"),Me=document.getElementById("ganttMeta"),Ce=document.getElementById("ganttHeader"),ae=document.getElementById("ganttList");function d(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function y(e){return d(e).replaceAll(`
`," ")}const X=e=>{const t={Open:"bg-slate-800 text-slate-100 border-slate-700","In Progress":"bg-blue-600/20 text-blue-200 border-blue-700/40",Waiting:"bg-amber-600/20 text-amber-200 border-amber-700/40",Closed:"bg-emerald-600/20 text-emerald-200 border-emerald-700/40"},n=I(e);return`<span class="inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-bold ${t[n]||"bg-slate-800 text-slate-100 border-slate-700"}">${d(n||"—")}</span>`};function tt(e){const t=e?.["company phone"]??e?.company_phone??null,n=e?.["poc phone"]??e?.poc_phone??null,o=e?.status??e?.Status??e?.status??e?.service_status??e?.request_status??null,s=I(o)||null,l=e?.shortvin??e?.short_vin??null;return{...e,status:s,Service_category:e?.Service_category??e?.service_category??e?.servicecategory??null,"company phone":t,unittype:e?.unittype??e?.unit_type??null,"model year":e?.["model year"]??e?.model_year??null,shortvin:l,"request date":e?.["request date"]??e?.request_date??null,workdate:e?.workdate??e?.work_date??e?.["work date"]??null,"shipping date":e?.["shipping date"]??e?.shipping_date??null,"poc name":e?.["poc name"]??e?.poc_name??null,"poc phone":n}}let se=null;function nt(e){if(e&&typeof e=="object"&&(a.colOrder=Array.isArray(e.colOrder)?e.colOrder:a.colOrder,a.colVisible=e.colVisible&&typeof e.colVisible=="object"?e.colVisible:a.colVisible,a.colWidths=e.colWidths&&typeof e.colWidths=="object"?e.colWidths:a.colWidths,a.sortKey=e.sortKey??a.sortKey,a.sortDir=e.sortDir??a.sortDir,a.colFilters=e.colFilters&&typeof e.colFilters=="object"?e.colFilters:a.colFilters,a.kbDateField=e.kbDateField??a.kbDateField,a.kbRange=e.kbRange??a.kbRange,a.kbFrom=e.kbFrom??a.kbFrom,a.kbTo=e.kbTo??a.kbTo,e.ganttScale))try{P.value=e.ganttScale}catch{}}function jt(){try{const e=localStorage.getItem(qe);if(!e)return;const t=JSON.parse(e);nt(t)}catch{}}async function zt(){try{const{data:e}=await a.client.auth.getSession(),t=e?.session;if(!t?.user?.id)return;const{data:n,error:o}=await a.client.from(Te).select("config").eq("user_id",t.user.id).eq("table_key",Re).maybeSingle();if(o||!n?.config)return;nt(n.config)}catch(e){console.warn("Prefs load error:",e)}}function Ut(e){se&&window.clearTimeout(se),se=window.setTimeout(async()=>{try{const{data:t}=await a.client.auth.getSession(),n=t?.session;if(!n?.user?.id)return;await a.client.from(Te).upsert({user_id:n.user.id,table_key:Re,config:e},{onConflict:"user_id,table_key"})}catch(t){console.warn("Prefs save error:",t)}},500)}function h(){const e={colOrder:a.colOrder,colVisible:a.colVisible,colWidths:a.colWidths,sortKey:a.sortKey,sortDir:a.sortDir,colFilters:a.colFilters,kbDateField:a.kbDateField,kbRange:a.kbRange,kbFrom:a.kbFrom,kbTo:a.kbTo,ganttScale:P?.value||"week"};try{localStorage.setItem(qe,JSON.stringify(e))}catch{}Ut(e)}function L(){const e=new Map(kt.map(t=>[t.key,t]));for(const t of a.dbColumns)e.has(t)||e.set(t,{key:t,label:t,filter:"text",defaultWidth:160,extra:!0});return Array.from(e.values())}function Yt(){const e=L();if(!a.colOrder.length)a.colOrder=e.map(t=>t.key);else{const t=new Set(a.colOrder);for(const n of e)t.has(n.key)||a.colOrder.push(n.key)}for(const t of e)t.key in a.colVisible||(a.colVisible[t.key]=!t.extra);for(const t of e)t.key in a.colWidths||(a.colWidths[t.key]=t.defaultWidth??160);for(const t of e)t.key in a.colFilters||(a.colFilters[t.key]="");h()}function at(){const e=L(),t=new Map(e.map(n=>[n.key,n]));return a.colOrder.map(n=>t.get(n)).filter(Boolean).filter(n=>!!a.colVisible[n.key])}function Gt(e,t){const n=t?.[e.key];return e.isDate?E(n):e.isMoney?Ne(n):n??"—"}function Xt(e){if(a.view!=="kanban"&&a.view!=="gantt"||!a.kbRange||a.kbRange==="all")return e;const t=Date.now();let n=null,o=null;if(a.kbRange==="today")n=_(t),o=T(t);else if(a.kbRange==="7d")n=_(t-6*864e5),o=T(t);else if(a.kbRange==="30d")n=_(t-29*864e5),o=T(t);else if(a.kbRange==="90d")n=_(t-89*864e5),o=T(t);else if(a.kbRange==="thisMonth")n=bt(t),o=ht(t);else if(a.kbRange==="custom"){const s=a.kbFrom?k(a.kbFrom):null,l=a.kbTo?k(a.kbTo):null;n=s!==null?_(s):null,o=l!==null?T(l):null}return e.filter(s=>{const l=vt(s,a.kbDateField);return!(l===null||n!==null&&l<n||o!==null&&l>o)})}function Zt(){const e=L(),t=new Map(e.map(s=>[s.key,s]));let n=[...a.allRows];if(a.filterStatus){const s=I(a.filterStatus);n=n.filter(l=>I(l.status)===s)}for(const[s,l]of Object.entries(a.colFilters)){const i=String(l??"").trim();if(!i)continue;const c=t.get(s)||{key:s,filter:"text"};if(c.filter==="select")n=n.filter(p=>String(p[s]??"")===i);else{const p=i.toLowerCase();n=n.filter(r=>te(Gt(c,r)).includes(p))}}if(n=Xt(n),a.sortKey){const s=a.sortKey,l=t.get(s),i=a.sortDir==="desc"?-1:1;n.sort((c,p)=>{const r=c[s],u=p[s];if(l?.isDate){const N=k(r)??-1/0,W=k(u)??-1/0;return(N-W)*i}if(l?.isMoney){const N=Number(r),W=Number(u),ct=r!==null&&r!==""&&r!==void 0&&!isNaN(N),dt=u!==null&&u!==""&&u!==void 0&&!isNaN(W);if(ct&&dt)return(N-W)*i}const m=Number(r),f=Number(u),b=r!==null&&r!==""&&r!==void 0&&!isNaN(m),w=u!==null&&u!==""&&u!==void 0&&!isNaN(f);if(b&&w)return(m-f)*i;const v=te(r),M=te(u);return v<M?-1*i:v>M?1*i:0})}if(a.pinnedRowId){const s=n.findIndex(l=>String(l.id)===String(a.pinnedRowId));if(s>-1){const[l]=n.splice(s,1);n.unshift(l)}}a.filteredRows=n,a.total=n.length;const o=Math.max(1,Math.ceil(a.total/$));a.page>o&&(a.page=o)}function Jt(){const e=(a.page-1)*$;return a.filteredRows.slice(e,e+$)}function Z(){const e=L();De.innerHTML=e.map(t=>{const n=a.colVisible[t.key]?"checked":"",o=t.label||t.key,s=t.extra?'<span class="ml-2 rounded-full border border-slate-700 px-2 py-0.5 text-[10px] text-slate-400">DB</span>':"";return`
          <label class="flex items-center justify-between gap-3 rounded-xl px-3 py-2 hover:bg-slate-900/60">
            <div class="flex items-center gap-2">
              <input type="checkbox" class="colToggle h-4 w-4 accent-blue-600" data-col="${y(t.key)}" ${n} />
              <span class="text-sm text-slate-200">${d(o)}</span>
              ${s}
            </div>
            <span class="text-[11px] text-slate-500">${d(t.key)}</span>
          </label>
        `}).join(""),De.querySelectorAll(".colToggle").forEach(t=>{t.addEventListener("change",()=>{const n=t.dataset.col;a.colVisible[n]=t.checked,h(),g()})})}function Qt(e){H.innerHTML="";for(const t of e){const n=Math.max(80,Number(a.colWidths[t.key]||t.defaultWidth||160)),o=document.createElement("col");o.style.width=`${n}px`,H.appendChild(o)}}function en(){const e=at();Qt(e),S.innerHTML=e.map(t=>{const n=a.sortKey===t.key,o=n?a.sortDir==="asc"?"arrow-up":"arrow-down":"arrow-up-down",s=String(a.colFilters[t.key]??""),l="no-drag w-full rounded-lg border border-slate-800 bg-slate-950/60 px-2 py-1 text-[11px] text-slate-100 placeholder:text-slate-600 focus:outline-none focus:ring-2 focus:ring-blue-600",i=t.filter==="select"?`<select data-filter-key="${y(t.key)}" class="${l}">
              ${(t.options||[""]).map(c=>{const p=String(c)===String(s)?"selected":"",r=c===""?"All":c;return`<option value="${y(c)}" ${p}>${d(r)}</option>`}).join("")}
            </select>`:`<input data-filter-key="${y(t.key)}" class="${l}" placeholder="Search..." value="${y(s)}" />`;return`
          <th class="relative px-3 py-2 align-top"
              draggable="true"
              data-col-key="${y(t.key)}">
            <div class="header-controls">
              <span class="table-header-label text-[10px] font-semibold uppercase tracking-[0.12em] text-slate-400">${d(t.label||t.key)}</span>
              <div class="header-actions">
                <button
                  type="button"
                  class="header-sort-btn no-drag inline-flex items-center rounded-lg border border-slate-800 bg-slate-950/60 p-1 text-slate-300 hover:text-white hover:bg-slate-900"
                  data-sort-toggle="${y(t.key)}"
                  title="Toggle sort">
                  <i data-lucide="${o}" class="h-3 w-3 ${n?"text-blue-300":"text-slate-600"}"></i>
                </button>
                <button
                  type="button"
                  class="header-menu-btn no-drag rounded-lg border border-slate-800 bg-slate-950/60 p-1 text-slate-300 hover:text-white hover:bg-slate-900"
                  data-header-menu-btn="${y(t.key)}"
                  title="Filter & sort">
                  <i data-lucide="sliders-horizontal" class="h-3 w-3"></i>
                </button>
              </div>
            </div>
            <div class="header-menu hidden" data-menu-for="${y(t.key)}">
              <div class="text-[10px] font-bold uppercase tracking-[0.12em] text-slate-400 mb-1">Filter</div>
              ${i}
              <div class="mt-2 grid grid-cols-2 gap-2">
                <button type="button" class="no-drag rounded-lg border border-slate-800 bg-slate-950/60 px-2 py-1 text-[11px] text-slate-200 hover:bg-slate-900" data-sort-key="${y(t.key)}" data-sort-dir="asc">Sort A → Z</button>
                <button type="button" class="no-drag rounded-lg border border-slate-800 bg-slate-950/60 px-2 py-1 text-[11px] text-slate-200 hover:bg-slate-900" data-sort-key="${y(t.key)}" data-sort-dir="desc">Sort Z → A</button>
                <button type="button" class="no-drag col-span-2 rounded-lg border border-slate-800 bg-slate-950/60 px-2 py-1 text-[11px] text-slate-200 hover:bg-slate-900" data-sort-key="${y(t.key)}" data-sort-dir="clear">Clear sort</button>
              </div>
              <button type="button" class="no-drag mt-2 text-[10px] font-semibold uppercase tracking-[0.12em] text-slate-400 hover:text-white" data-clear-filter="${y(t.key)}">Clear filter</button>
            </div>
            <div class="col-resizer" data-resize-key="${y(t.key)}"></div>
          </th>
        `}).join(""),O=null,sn(),on(e),ve(),lucide.createIcons()}let O=null;function tn(e){const t=typeof CSS<"u"&&CSS.escape?CSS.escape(e):e.replace(/"/g,'\\"');return S.querySelector(`[data-menu-for="${t}"]`)}function U(){S.querySelectorAll(".header-menu").forEach(e=>e.classList.add("hidden")),O=null}function nn(e){O&&O!==e&&U();const t=tn(e);if(!t)return;const n=t.classList.contains("hidden");t.classList.toggle("hidden",!n),O=n?e:null,n&&an(t)}function ve(){S.querySelectorAll("th[data-col-key]").forEach(t=>{const n=t.getBoundingClientRect().width;t.classList.toggle("header-compact",n<140)})}function an(e){e.style.transform="",e.style.left="",e.style.right="8px",requestAnimationFrame(()=>{const t=e.getBoundingClientRect(),n=F.getBoundingClientRect();let o=0;t.left<n.left+8?o=n.left+8-t.left:t.right>n.right-8&&(o=n.right-8-t.right),o!==0&&(e.style.transform=`translateX(${o}px)`)})}function sn(){const e=S.querySelectorAll("th[data-col-key]");let t=null;e.forEach(n=>{n.addEventListener("dragstart",o=>{if(o.target.closest(".no-drag")){o.preventDefault();return}t=n.dataset.colKey,n.classList.add("dragging"),o.dataTransfer.effectAllowed="move";try{o.dataTransfer.setData("text/plain",t)}catch{}}),n.addEventListener("dragend",()=>{t=null,e.forEach(o=>o.classList.remove("dragging","drop-target"))}),n.addEventListener("dragover",o=>{o.preventDefault();const s=n.dataset.colKey;!t||t===s||(n.classList.add("drop-target"),o.dataTransfer.dropEffect="move")}),n.addEventListener("dragleave",()=>n.classList.remove("drop-target")),n.addEventListener("drop",o=>{o.preventDefault();const s=n.dataset.colKey,l=t||(()=>{try{return o.dataTransfer.getData("text/plain")}catch{return null}})();if(!l||!s||l===s)return;const i=[...a.colOrder],c=i.indexOf(l),p=i.indexOf(s);c===-1||p===-1||(i.splice(c,1),i.splice(p,0,l),a.colOrder=i,h(),g())})})}function on(e){const t=S.querySelectorAll("[data-resize-key]");let n=null,o=0,s=0;const l=c=>{if(!n)return;const p=c.clientX-o,r=Math.max(80,s+p);a.colWidths[n]=r;const u=e.findIndex(f=>f.key===n),m=u;u>=0&&H.children[m]&&(H.children[m].style.width=`${r}px`,Y())},i=()=>{n&&(document.body.classList.remove("resizing"),n=null,h(),window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",i),Y(),ve())};t.forEach(c=>{c.addEventListener("mousedown",p=>{p.preventDefault(),p.stopPropagation();const r=c.dataset.resizeKey;n=r,o=p.clientX,s=Number(a.colWidths[r]||160),document.body.classList.add("resizing"),window.addEventListener("mousemove",l),window.addEventListener("mouseup",i)})})}function ln(e){const t=at();if(K.innerHTML="",!e.length){Be.classList.remove("hidden"),Tt.textContent=a.lastError?"Could not load service requests":"No service requests found",Rt.textContent=a.lastError||"Try adjusting filters/search.";return}Be.classList.add("hidden");for(const n of e){const o=document.createElement("tr");o.className="hover:bg-slate-950/30",o.dataset.rowId=n.id;const s=t.map(l=>{const i=n[l.key],c=`data-row-id="${y(n.id)}" data-col-key="${y(l.key)}"`;return l.key==="status"?`<td ${c} class="px-3 py-2 text-slate-200 editable-cell">${X(i)}</td>`:l.isDate?`<td ${c} class="px-3 py-2 text-slate-300 whitespace-nowrap editable-cell">${d(E(i))}</td>`:l.isMoney?`<td ${c} class="px-3 py-2 text-slate-200 whitespace-nowrap font-semibold text-right editable-cell">${d(Ne(i))}</td>`:l.key==="phones"?`<td ${c} class="px-3 py-2 text-slate-200 whitespace-nowrap">${d(i||"—")}</td>`:l.key==="address"?`<td ${c} class="px-3 py-2 text-slate-200 whitespace-normal editable-cell">${d(i??"—")}</td>`:l.key==="company_name"||l.key==="brand"||l.key==="model"?`<td ${c} class="px-3 py-2 font-semibold text-white editable-cell">${d(i||"—")}</td>`:`<td ${c} class="px-3 py-2 text-slate-200 editable-cell">${d(i??"—")}</td>`}).join("");o.innerHTML=s,K.appendChild(o)}lucide.createIcons()}function ke(e){return!e||e.virtual?!1:!new Set(["phones","id"]).has(e.key)}function rn(e){return a.dbColumns?.includes(e),e}function cn(e,t){return e.isDate?t?String(t).slice(0,10):"":e.isBoolean?t==null||t===""?"":t?"true":"false":t==null?"":String(t)}function dn(e,t){const n=typeof t=="string"?t.trim():t;if(e.isDate)return n||null;if(e.isMoney){if(n==="")return null;const o=Number(n);return isNaN(o)?n:o}return e.isBoolean?n===""?null:n===!0||n==="true":e.filter==="select"?n||null:n===""?null:n}async function un(e,t,n){const o=rn(t),s={id:e,[o]:n},l=G(s);if(Object.keys(l).length<=1)return;const i=await we(l),c=a.allRows.findIndex(p=>String(p.id)===String(i.id));c>=0&&(a.allRows[c]=i),g()}function st(e,t,n){if(e.classList.contains("cell-editing")||!ke(n))return;const o=e.innerHTML,s=t?.[n.key],l=cn(n,s),i=document.createElement(n.filter==="select"?"select":"input");if(i.className="no-drag w-full rounded-md border border-slate-700 bg-slate-950/70 px-2 py-1 text-[11px] text-slate-100 focus:outline-none focus:ring-2 focus:ring-blue-600",i.tagName==="INPUT")n.isDate&&(i.type="date"),n.isMoney&&(i.type="number",i.step="0.01"),i.value=l;else{const r=(n.options||[""]).map(u=>{const m=u===""?"—":u;return`<option value="${y(u)}">${d(m)}</option>`}).join("");i.innerHTML=r,i.value=l}e.classList.add("cell-editing"),e.innerHTML="",e.appendChild(i);const c=()=>{e.classList.remove("cell-editing"),e.innerHTML=o,lucide.createIcons()},p=async()=>{if(!e.classList.contains("cell-editing"))return;const r=i.value,u=dn(n,r),m=String(l??""),f=String(r??"");if(m===f){c();return}try{if(!await D()){c();return}let w=u;n.key==="status"&&(w=I(u)||null),await un(t.id,n.key,w)}catch(b){console.error(b),a.lastError=b?.message||String(b),c(),g()}};i.addEventListener("keydown",r=>{r.key==="Escape"&&(r.preventDefault(),c()),r.key==="Enter"&&i.tagName==="INPUT"&&(r.preventDefault(),p())}),i.addEventListener("blur",()=>p()),i.focus(),i.tagName==="INPUT"&&i.select()}function pn(){const e=[];e.push(`Time: ${a.kbRange||"all"}`),e.push(`Date: ${a.kbDateField}`),Ht.textContent=`${a.filteredRows.length} items • ${e.join(" • ")}`}function fn(){const e=new Map;for(const l of le)e.set(l,[]);const t=new Map;for(const l of a.filteredRows){const i=I(l.status);if(!i){const c="Unspecified";t.has(c)||t.set(c,[]),t.get(c).push(l);continue}e.has(i)?e.get(i).push(l):(t.has(i)||t.set(i,[]),t.get(i).push(l))}const n=Array.from(t.keys()),o=le.concat(n.length?["Other"]:[]),s=[];if(n.length)for(const l of n)s.push(...t.get(l)||[]);$e.innerHTML=o.map(l=>{const i=l==="Other"?s:e.get(l)||[],c=i.map(r=>{const u=E(r["shipping date"]||r.workdate||r["request date"]),m=I(r.status);return`
            <div class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 shadow-md shadow-blue-900/20">
              <div class="flex items-center justify-between gap-3 text-xs text-slate-400">
                <span>${d(u)}</span>

                <div class="flex items-center gap-2">
                  ${X(m)}
                  <button
                    type="button"
                    class="kbEditBtn inline-flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800"
                    data-id="${y(r.id)}"
                    title="Edit"
                  >
                    <i data-lucide="pencil" class="h-4 w-4"></i>
                    Edit
                  </button>
                </div>
              </div>

              <p class="mt-2 text-sm font-black text-white">${d(r.company_name||"—")}</p>
              <p class="text-sm text-slate-300">${d(r.unittype||"")} ${d(r.brand||"")} ${d(r.model||"")}</p>
              <p class="text-xs text-slate-400">VIN: ${d(r.shortvin||"—")} • Cat: ${d(r.Service_category||"—")}</p>
              <p class="mt-1 text-xs text-slate-400">POC: ${d(r["poc name"]||"—")}</p>
              ${l==="Other"&&n.length?`<p class="mt-2 text-[11px] text-slate-500">Other includes: ${d(n.join(", "))}</p>`:""}
            </div>
          `}).join(""),p=i.length===1?"1 item":`${i.length} items`;return`
          <div class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4">
            <div class="flex items-center justify-between">
              <p class="text-sm font-bold text-white">${d(l)}</p>
              <span class="text-xs text-slate-400">${p}</span>
            </div>
            <div class="mt-3 space-y-3">
              ${c||'<p class="text-xs text-slate-500">No items</p>'}
            </div>
          </div>
        `}).join(""),$e.querySelectorAll(".kbEditBtn").forEach(l=>{l.addEventListener("click",i=>{i.stopPropagation();const c=l.dataset.id,p=a.allRows.find(r=>String(r.id)===String(c));p&&it(p)})}),lucide.createIcons()}function J(){const e=a.calendarMonth?new Date(a.calendarMonth):new Date,t=ge(e),n=new Date(e.getFullYear(),e.getMonth()+1,0),o=a.filteredRows.map(r=>{const u=r.workdate||r["work date"],m=k(u);return{row:r,ts:m,key:u?new Date(u).toISOString().slice(0,10):null}}).filter(r=>r.ts!==null&&r.key).filter(r=>r.ts>=t.getTime()&&r.ts<=n.getTime()).sort((r,u)=>r.ts-u.ts),s=new Date(t);s.setDate(s.getDate()-s.getDay());const l=new Date(n);l.setDate(l.getDate()+(6-l.getDay()));const i=new Map;for(const r of o)i.has(r.key)||i.set(r.key,[]),i.get(r.key).push(r.row);const c=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],p=[];for(let r=new Date(s);r<=l;r.setDate(r.getDate()+1)){const u=r.toISOString().slice(0,10),m=i.get(u)||[],f=r.getMonth()===e.getMonth(),b=`${r.getMonth()+1}/${r.getDate()}`,w=m.map(v=>`
            <div class="rounded-xl border border-slate-800 bg-slate-950/70 p-3 text-left space-y-1">
              <div class="flex items-center justify-between text-[11px] text-slate-400">
                <span class="truncate max-w-[140px]">${d(v.company_name||"—")}</span>
                ${X(v.status)}
              </div>
              <p class="text-xs text-slate-300 truncate">${d(v.unittype||"")} ${d(v.brand||"")} ${d(v.model||"")}</p>
              <p class="text-[11px] text-slate-400 truncate">VIN: ${d(v.shortvin||"—")} • Cat: ${d(v.Service_category||"—")}</p>
            </div>
          `).join("");p.push(`
          <div class="rounded-2xl border ${f?"border-slate-800 bg-slate-950/60":"border-slate-900 bg-slate-950/30"} p-3 space-y-2">
            <div class="flex items-center justify-between text-xs ${f?"text-slate-200":"text-slate-500"}">
              <span class="font-semibold">${d(b)}</span>
              <span class="text-[11px]">${c[r.getDay()]}</span>
            </div>
            <div class="space-y-2 max-h-48 overflow-auto pr-1">
              ${w||'<p class="text-[11px] text-slate-500">No work scheduled</p>'}
            </div>
          </div>
        `)}Dt.textContent=`${e.toLocaleString("default",{month:"long"})} ${e.getFullYear()}`,Mt.textContent=o.length?`${o.length} items in month`:"No dated requests in this month.",St.innerHTML=`
        <div class="overflow-x-auto">
          <div class="min-w-[980px] grid grid-cols-7 gap-2">
            ${p.join("")}
          </div>
        </div>
      `}function gn(e){const t=I(e);return t==="Waiting"?"waiting":t==="Closed"?"closed":t==="In Progress"?"progress":"open"}function oe(e){return new Date(e).toISOString().slice(0,10)}function ot(){const e=a.filteredRows.map(r=>{const u=k(r["request date"]),m=k(r.workdate),f=k(r["shipping date"]),b=u??m??f,w=f??m??u;if(b===null||w===null)return null;const v=Math.min(b,w),M=Math.max(b,w);return{row:r,start:v,end:M}}).filter(Boolean);if(!e.length){Me.textContent="No tasks with dates match current filters.",Ce.innerHTML="",ae.innerHTML='<p class="text-sm text-slate-400">No dated items.</p>';return}let t=1/0,n=-1/0;for(const r of e)r.start<t&&(t=r.start),r.end>n&&(n=r.end);const o=3;t=_(t-o*864e5),n=T(n+o*864e5);const s=Math.max(1,n-t),l=Math.max(1,Math.round(s/864e5));Me.textContent=`${e.length} items • Range: ${E(oe(t))} → ${E(oe(n))} • Scale: ${P.value}`;const c=P.value==="day"?1:7,p=[];for(let r=0;r<=l;r+=c){const u=t+r*864e5;p.push({day:r,label:E(oe(u))})}Ce.innerHTML=`
        <div class="flex items-center justify-between">
          <span class="font-bold text-slate-300">Company / Unit</span>
          <span class="text-slate-500">Timeline</span>
        </div>
      `,ae.innerHTML=e.map(r=>{const u=(r.start-t)/s*100,m=Math.max(.8,(r.end-r.start)/s*100),f=r.row,b=`${f.company_name||"—"} • ${f.unittype||""} ${f.brand||""} ${f.model||""}`.trim(),w=`Req: ${E(f["request date"])} • Work: ${E(f.workdate)} • Ship: ${E(f["shipping date"])}`,v=p.map(M=>`<div class="gantt-gridline" style="left:${M.day/l*100}%;"></div>`).join("");return`
          <div class="rounded-2xl border border-slate-800 bg-slate-950/60 p-4">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <div class="min-w-[260px]">
                <div class="flex items-center gap-2">
                  <p class="text-sm font-black text-white">${d(f.company_name||"—")}</p>
                  ${X(f.status)}
                </div>
                <p class="text-xs text-slate-400 mt-1">${d(w)}</p>
                <p class="text-xs text-slate-300 mt-1">${d(b)}</p>
              </div>

              <div class="flex items-center gap-2">
                <button
                  type="button"
                  class="ganttEditBtn inline-flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-3 py-2 text-xs font-bold text-slate-200 hover:bg-slate-800"
                  data-id="${y(f.id)}"
                >
                  <i data-lucide="pencil" class="h-4 w-4"></i>
                  Edit
                </button>
              </div>
            </div>

            <div class="mt-3 gantt-track">
              ${v}
              <div class="gantt-bar ${gn(f.status)}" style="left:${u}%; width:${m}%;"></div>
            </div>

            <div class="mt-2 flex flex-wrap gap-2 text-[11px] text-slate-500">
              <span class="rounded-full border border-slate-800 bg-slate-950/40 px-3 py-1">Doc: ${d(f.doc||"—")}</span>
              <span class="rounded-full border border-slate-800 bg-slate-950/40 px-3 py-1">VIN: ${d(f.shortvin||"—")}</span>
              <span class="rounded-full border border-slate-800 bg-slate-950/40 px-3 py-1">Cat: ${d(f.Service_category||"—")}</span>
              <span class="rounded-full border border-slate-800 bg-slate-950/40 px-3 py-1">POC: ${d(f["poc name"]||"—")}</span>
            </div>
          </div>
        `}).join(""),ae.querySelectorAll(".ganttEditBtn").forEach(r=>{r.addEventListener("click",u=>{u.stopPropagation();const m=r.dataset.id,f=a.allRows.find(b=>String(b.id)===String(m));f&&it(f)})}),lucide.createIcons()}let C=!1;function Y(){_t.style.width=Ct.scrollWidth+"px"}function mn(){ne.addEventListener("scroll",()=>{C||(C=!0,F.scrollLeft=ne.scrollLeft,C=!1)}),F.addEventListener("scroll",()=>{C||(C=!0,ne.scrollLeft=F.scrollLeft,C=!1)}),window.addEventListener("resize",()=>{Y(),ve()})}function yn(){const e=Math.max(1,Math.ceil(a.total/$));qt.textContent=`Page ${a.page} of ${e}`,Fe.disabled=a.page===1||a.loading,Oe.disabled=a.page===e||a.loading,a.loading?A.textContent="Loading...":a.lastError?A.textContent=`Error: ${a.lastError}`:a.total===0?A.textContent="0 items":A.textContent=`${a.total} items • showing ${(a.page-1)*$+1}-${Math.min(a.page*$,a.total)}`}function lt(){de.value=a.kbDateField,document.querySelectorAll(".kbRangeBtn").forEach(e=>{const t=e.dataset.kbRange===a.kbRange;e.classList.toggle("bg-blue-600",t),e.classList.toggle("text-white",t),e.classList.toggle("border-blue-600",t)}),Kt.classList.toggle("hidden",a.kbRange!=="custom"),ue.value=a.kbFrom||"",pe.value=a.kbTo||""}function g(){Yt(),Z(),Zt(),en(),yn(),a.view==="table"&&(ln(Jt()),requestAnimationFrame(()=>Y())),a.view==="kanban"&&(lt(),fn(),pn()),a.view==="calendar"&&J(),a.view==="gantt"&&ot()}async function D(){const{data:e}=await a.client.auth.getSession();return e?.session?!0:(a.lastError="You must be logged in to view service requests.",a.allRows=[],a.filteredRows=[],a.total=0,g(),!1)}async function xe(){if(a.lastError=null,a.loading=!0,g(),!await D()){a.loading=!1,g();return}const{data:t,error:n}=await a.client.from(fe).select("*");if(n)a.lastError=n.message||String(n),a.allRows=[],a.filteredRows=[],a.total=0;else{const o=(t||[]).map(tt);a.allRows=o;const s=o[0]||null;if(s){const l=Object.keys(s).filter(i=>!i.startsWith("_"));a.dbColumns=l.sort((i,c)=>i.localeCompare(c))}else a.dbColumns=[]}a.loading=!1,g()}async function we(e){const{data:t,error:n}=await a.client.from(fe).upsert(e).select().single();if(n)throw n;return tt(t)}function bn(){const e={},t=["status","request date","workdate","shipping date","company_name"],n=a.dbColumns||[];if(!n.length)return e.status=null,G(e);const o=new Set(n),s=t.find(l=>o.has(l))||n[0];return s&&(e[s]=null),G(e)}async function hn(){try{if(!await D())return;V.disabled=!0,V.classList.add("opacity-60");const t=bn();if(!Object.keys(t).length)throw new Error("No writable columns found for a blank request.");const n=await we(t);a.allRows=[n,...a.allRows.filter(o=>String(o.id)!==String(n.id))],a.page=1,a.pinnedRowId=n.id,g(),requestAnimationFrame(()=>{if(a.view!=="table"){a.pinnedRowId=null;return}F.scrollTop=0;const o=String(n.id),s=a.allRows.find(i=>String(i.id)===o)||n,l=K.querySelectorAll("td[data-row-id][data-col-key]");for(const i of l){if(i.dataset.rowId!==o)continue;const c=L().find(p=>p.key===i.dataset.colKey);if(!(!c||!ke(c))){st(i,s,c);break}}a.pinnedRowId=null})}catch(e){console.error(e),a.lastError=e?.message||String(e),g()}finally{V.disabled=!1,V.classList.remove("opacity-60")}}async function vn(e){const{error:t}=await a.client.from(fe).delete().eq("id",e);if(t)throw t}function kn(e){const t=e?.short_vin??e?.shortvin??e?.shortVin??e?.vin_short??e?.vin??null,n=e?.unit_type??e?.unittype??e?.unitType??null,o=e?.brand??null,s=e?.model??null,l=e?.model_year??e?.["model year"]??e?.year??null;return{short_vin:t,unit_type:n,brand:o,model:s,model_year:l}}async function xn(){if(!await D())return;const{data:t,error:n}=await a.client.from(gt).select('short_vin, shortvin, unit_type, unittype, brand, model, model_year, "model year"');if(n){console.warn("Vehicles load error:",n),a.vehicles=[],a.vehiclesByVin=new Map;return}const o=(t||[]).map(kn).filter(s=>s.short_vin);o.sort((s,l)=>String(s.short_vin).localeCompare(String(l.short_vin))),a.vehicles=o,a.vehiclesByVin=new Map(o.map(s=>[String(s.short_vin).toUpperCase(),s]))}async function wn(){if(!await D())return;let t=[];try{const o=await a.client.from(mt).select("category");o.error||(t=(o.data||[]).map(s=>s?.category).filter(Boolean).map(s=>String(s).trim()).filter(Boolean))}catch{}if(!t.length)try{const o=await a.client.from(yt).select("category");o.error||(t=(o.data||[]).map(s=>s?.category).filter(Boolean).map(s=>String(s).trim()).filter(Boolean))}catch{}const n=Array.from(new Set(t)).sort((o,s)=>o.localeCompare(s));a.categories=n,Q()}function Q(e=""){const t=[""].concat(a.categories||[]);q.innerHTML=t.map(n=>{const o=n===""?"— Select service category —":n,s=String(n)===String(e)?"selected":"";return`<option value="${y(n)}" ${s}>${d(o)}</option>`}).join("")}function Ee(){B.classList.add("hidden")}function _e(){B.innerHTML.trim()&&B.classList.remove("hidden")}function Ie(e=""){const t=String(e||"").trim().toLowerCase(),n=a.vehicles||[],o=t?n.filter(s=>`${s.short_vin} ${s.brand||""} ${s.model||""} ${s.model_year||""} ${s.unit_type||""}`.toLowerCase().includes(t)):n.slice(0,50);if(!o.length){B.innerHTML='<div class="px-3 py-2 text-sm text-slate-400">No matches.</div>',_e();return}B.innerHTML=o.slice(0,60).map(s=>{const l=`${s.brand||"—"} • ${s.model||"—"} • ${s.model_year||"—"} • ${s.unit_type||"—"}`;return`
          <button type="button"
            class="w-full text-left px-3 py-2 hover:bg-slate-900/60 border-b border-slate-800 last:border-b-0"
            data-vin="${y(s.short_vin)}">
            <div class="flex items-center justify-between gap-3">
              <span class="text-sm font-black text-white">${d(s.short_vin)}</span>
              <span class="text-[11px] text-slate-500 truncate">${d(l)}</span>
            </div>
          </button>
        `}).join(""),B.querySelectorAll("button[data-vin]").forEach(s=>{s.addEventListener("click",()=>{const l=s.dataset.vin;Se(l),Ee()})}),_e()}function Se(e){const t=String(e||"").toUpperCase().trim();if(!t)return;x.value=e;const n=a.vehiclesByVin.get(t);n?(ye.value=n.unit_type||"",be.value=n.brand||"",he.value=n.model||"",j.value=n.model_year??"",a.modalVinSelected=!0,ie.textContent="Vehicle auto-filled from Vehicles. You can adjust fields if needed."):(a.modalVinSelected=!1,ie.textContent="Type to search. Select a VIN to fill Brand/Model/Year/Unit type.")}function rt(){a.modalVinSelected=!1,ie.textContent="Type to search. Select a VIN to fill Brand/Model/Year/Unit type."}function it(e=null){z.textContent="";const t=!!e;At.textContent=t?"Edit request":"New request",et.classList.toggle("hidden",!t),me.value=e?.id||"",Pe.value=e?.company_name||"",We.value=e?.["company phone"]||e?.company_phone||"",Ae.value=e?.doc||"",x.value=e?.shortvin||e?.short_vin||"",ye.value=e?.unittype||e?.unit_type||"",be.value=e?.brand||"",he.value=e?.model||"",j.value=e?.["model year"]||e?.model_year||"",He.value=I(e?.status)||"Open",Ke.value=e?.quote??"",q.value=e?.Service_category??e?.service_category??e?.servicecategory??"",je.value=e?.["request date"]?String(e["request date"]).slice(0,10):e?.request_date?String(e.request_date).slice(0,10):"",ze.value=e?.workdate?String(e.workdate).slice(0,10):e?.work_date?String(e.work_date).slice(0,10):"",Ue.value=e?.["shipping date"]?String(e["shipping date"]).slice(0,10):e?.shipping_date?String(e.shipping_date).slice(0,10):"",Ye.value=e?.["poc name"]||e?.poc_name||"",Ge.value=e?.["poc phone"]||e?.poc_phone||"",ce.value=e?.confirmed===!0?"true":e?.confirmed===!1?"false":"",Xe.value=e?.state||"",Ze.value=e?.city||"",Je.value=e?.zip||"",Qe.value=e?.address||"",x.value.trim()?Se(x.value.trim()):rt(),Q(q.value||""),R.classList.remove("hidden"),R.classList.add("flex"),lucide.createIcons(),Ie(x.value)}function ee(){Ee(),R.classList.add("hidden"),R.classList.remove("flex")}function Le(e){const t=typeof e=="boolean"?e:re.classList.contains("hidden");re.classList.toggle("hidden",!t),t&&Z(),lucide.createIcons()}function En(){a.categories?.length?Q(q.value||""):q.innerHTML='<option value="">Loading…</option>'}function G(e){const t=a.dbColumns||[];if(!t.length){const s={},l=new Set(["id","company_name","company phone","doc","unittype","brand","model","model year","shortvin","status","quote","request date","workdate","shipping date","poc name","poc phone","confirmed","state","city","zip","address","Service_category","Notes","POC email"]);for(const[i,c]of Object.entries(e))l.has(i)&&(s[i]=c);return s}const n=new Set(t),o={};for(const[s,l]of Object.entries(e))(s==="id"||n.has(s))&&(o[s]=l);return o}Fe.addEventListener("click",()=>{a.page>1&&(a.page--,g())});Oe.addEventListener("click",()=>{const e=Math.max(1,Math.ceil(a.total/$));a.page<e&&(a.page++,g())});document.querySelectorAll(".viewBtn").forEach(e=>e.addEventListener("click",()=>{const t=e.dataset.view;a.view=t,xt.classList.toggle("hidden",t!=="table"),wt.classList.toggle("hidden",t!=="kanban"),Et.classList.toggle("hidden",t!=="calendar"),It.classList.toggle("hidden",t!=="gantt"),document.querySelectorAll(".viewBtn").forEach(n=>{const o=n.dataset.view===t;n.classList.toggle("bg-blue-600",o),n.classList.toggle("text-white",o),n.classList.toggle("text-slate-300",!o)}),g()}));document.querySelectorAll(".filterChip").forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.filter;a.filterStatus=a.filterStatus===t?null:t,document.querySelectorAll(".filterChip").forEach(n=>n.classList.remove("bg-blue-600","text-white","border-blue-600")),a.filterStatus===t&&e.classList.add("bg-blue-600","text-white","border-blue-600"),a.page=1,g()})});de.addEventListener("change",()=>{a.kbDateField=de.value,h(),g()});document.querySelectorAll(".kbRangeBtn").forEach(e=>{e.addEventListener("click",()=>{if(a.kbRange=e.dataset.kbRange,a.kbRange==="custom"){const t=new Date,n=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0");a.kbFrom||(a.kbFrom=`${n}-${o}-01`),a.kbTo||(a.kbTo=`${n}-${o}-${String(new Date(n,t.getMonth()+1,0).getDate()).padStart(2,"0")}`)}h(),g()})});ue.addEventListener("change",()=>{a.kbFrom=ue.value||null,h(),g()});pe.addEventListener("change",()=>{a.kbTo=pe.value||null,h(),g()});P.addEventListener("change",()=>{h(),a.view==="gantt"&&ot()});Nt.addEventListener("click",e=>{e.stopPropagation(),Le()});Ot.addEventListener("click",()=>Le(!1));Vt.addEventListener("click",()=>{const e=L();for(const t of e)a.colVisible[t.key]=!0;h(),g(),Z()});Ft.addEventListener("click",()=>{const e=L();for(const t of e)a.colVisible[t.key]=!1;a.colVisible.company_name=!0,h(),g(),Z()});document.addEventListener("click",()=>Le(!1));re.addEventListener("click",e=>e.stopPropagation());S.addEventListener("click",e=>{const t=e.target.closest("[data-header-menu-btn]");if(t){e.stopPropagation(),nn(t.dataset.headerMenuBtn);return}const n=e.target.closest("[data-sort-toggle]");if(n){e.stopPropagation();const l=n.dataset.sortToggle;a.sortKey!==l?(a.sortKey=l,a.sortDir="asc"):a.sortDir==="asc"?a.sortDir="desc":(a.sortKey=null,a.sortDir="asc"),h(),g();return}e.target.closest(".header-menu")&&e.stopPropagation();const o=e.target.closest("[data-clear-filter]");if(o){e.stopPropagation();const l=o.dataset.clearFilter;a.colFilters[l]="",a.page=1,h(),g(),U();return}const s=e.target.closest("[data-sort-key][data-sort-dir]");if(s){e.stopPropagation();const l=s.dataset.sortKey,i=s.dataset.sortDir;i==="clear"?(a.sortKey=null,a.sortDir="asc"):(a.sortKey=l,a.sortDir=i),h(),g(),U()}});S.addEventListener("input",e=>{const t=e.target.closest("[data-filter-key]");if(!t)return;const n=t.getAttribute("data-filter-key");a.colFilters[n]=t.value,a.page=1,h(),g()});S.addEventListener("change",e=>{const t=e.target.closest("[data-filter-key]");if(!t)return;const n=t.getAttribute("data-filter-key");a.colFilters[n]=t.value,a.page=1,h(),g()});document.addEventListener("click",()=>U());Lt.addEventListener("click",()=>{a.calendarMonth=Ve(a.calendarMonth||new Date,-1),J()});$t.addEventListener("click",()=>{a.calendarMonth=Ve(a.calendarMonth||new Date,1),J()});Bt.addEventListener("click",()=>{a.calendarMonth=ge(new Date),J()});K.addEventListener("dblclick",e=>{const t=e.target.closest("td[data-row-id][data-col-key]");if(!t)return;const n=t.dataset.rowId,o=t.dataset.colKey,s=L().find(i=>i.key===o);if(!s||!ke(s))return;const l=a.allRows.find(i=>String(i.id)===String(n));l&&st(t,l,s)});V.addEventListener("click",()=>hn());Pt.addEventListener("click",ee);R.addEventListener("click",e=>{e.target===R&&ee()});x.addEventListener("focus",()=>{Ie(x.value)});x.addEventListener("input",()=>{Ie(x.value);const e=x.value.trim().toUpperCase();a.vehiclesByVin.has(e)?Se(x.value.trim()):rt()});document.addEventListener("click",e=>{x.contains(e.target)||B.contains(e.target)||Ee()});et.addEventListener("click",async()=>{try{const e=me.value;if(!e||!await D())return;await vn(e),ee(),await xe()}catch(e){console.error(e),z.textContent=`Could not delete. ${e?.message||"Check RLS policies."}`}});Wt.addEventListener("submit",async e=>{e.preventDefault(),z.textContent="";try{if(!await D())return;const n=Ke.value.trim(),o=n===""?null:isNaN(Number(n))?n:Number(n),s=q.value.trim()||null,l=ce.value===""?null:ce.value==="true",i={id:me.value||void 0,company_name:Pe.value.trim()||null,"company phone":We.value.trim()||null,doc:Ae.value.trim()||null,shortvin:x.value.trim()||null,unittype:ye.value.trim()||null,brand:be.value.trim()||null,model:he.value.trim()||null,"model year":j.value?Number(j.value):null,status:He.value,quote:o,"request date":je.value||null,workdate:ze.value||null,"shipping date":Ue.value||null,"poc name":Ye.value.trim()||null,"poc phone":Ge.value.trim()||null,confirmed:l,state:Xe.value.trim()||null,city:Ze.value.trim()||null,zip:Je.value.trim()||null,address:Qe.value.trim()||null,Service_category:s},c=G(i);await we(c),ee(),await xe()}catch(t){console.error(t),z.textContent=`Could not save. ${t?.message||"Check RLS policies + table columns."}`}});document.addEventListener("DOMContentLoaded",async()=>{ut(),lucide.createIcons(),a.calendarMonth=ge(new Date),a.client=pt,jt(),await zt(),mn(),lt(),En(),await xe(),await xn(),await wn(),Q("")});
