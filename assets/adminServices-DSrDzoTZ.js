import{s as E}from"./constellation-uI2meXO3.js";import"./admin-auth-DJpBhotk.js";import{r as ke}from"./Header-CYr_2qJu.js";import{l as ze,s as Ie,p as Ne}from"./backgroundPreference-DPAtw2vm.js";import{l as We}from"./adminAudit-BQKTmVXV.js";ke("header-root");const Be="Services",V="Services",fe=e=>{if(e===!0||e===!1)return e;const t=String(e??"").trim().toLowerCase();return["true","1","yes","y","verified"].includes(t)?!0:["false","0","no","n","unverified","not verified"].includes(t)?!1:null},Z=e=>e===!0?"Verified":e===!1?"Not verified":e==null||String(e).trim()===""?"—":String(e),f=(e,...t)=>{for(const i of t){const n=e[i];if(n!=null&&String(n).trim()!=="")return n}return""},Te=e=>{const t=fe(e);if(t===!0||t===!1)return t;const i=e==null?"":String(e).trim();return i===""?null:i},te=e=>({id:e.id,company:f(e,"company_name","Installation Company","Company","company","name"),authorization:f(e,"Authorization","authorization"),category:f(e,"category","Category"),phone:f(e,"Phone","phone"),contact:f(e,"contact","Contact"),address:f(e,"address","Address"),city:f(e,"City","city"),state:f(e,"State","state","state_code"),zip:f(e,"Zip","zip","zipcode","postal_code"),email:f(e,"Email","email"),notes:f(e,"Notes","notes"),website:f(e,"website","Website"),availability:f(e,"availability","Availability"),verified:Te(f(e,"Verified","verified","is_verified","Is Verified")),region:f(e,"region","Region"),status:f(e,"status","Status"),type:f(e,"type","Type"),lat:f(e,"lat","latitude","Lat"),long:f(e,"long","lng","longitude","Lon")}),ge={company:"company_name",authorization:"authorization",category:"category",verified:"verified",phone:"phone",contact:"contact",address:"address",city:"city",state:"state",zip:"zip",email:"email",notes:"notes",website:"website",availability:"availability",region:"region",status:"status",type:"type",lat:"lat",long:"long"},l={status:document.getElementById("dataset-status"),total:document.getElementById("tech-total"),states:document.getElementById("tech-states"),companies:document.getElementById("tech-companies"),paginationSummary:document.getElementById("pagination-summary"),prevPage:document.getElementById("prev-page"),nextPage:document.getElementById("next-page"),pageIndicator:document.getElementById("page-indicator"),refresh:document.getElementById("refresh-button"),addRecord:document.getElementById("add-record"),colgroup:document.getElementById("colgroup"),thead:document.getElementById("table-head"),tbody:document.getElementById("table-body"),tableScroll:document.getElementById("table-scroll"),topScrollbar:document.getElementById("top-scrollbar"),topScrollbarInner:document.getElementById("top-scrollbar-inner"),columnsBtn:document.getElementById("columns-btn"),columnsPopover:document.getElementById("columns-popover"),columnsList:document.getElementById("columns-list"),colsAll:document.getElementById("cols-all"),colsNone:document.getElementById("cols-none"),analyticsWrap:document.getElementById("analytics-wrap")},b=[{id:"company",label:"Company Name",key:"company",defaultWidth:220},{id:"authorization",label:"Authorization",key:"authorization",defaultWidth:160},{id:"category",label:"Category",key:"category",defaultWidth:170},{id:"verified",label:"Verified",key:"verified",defaultWidth:120},{id:"phone",label:"Phone",key:"phone",defaultWidth:150},{id:"contact",label:"Contact",key:"contact",defaultWidth:160},{id:"address",label:"Address",key:"address",defaultWidth:260},{id:"city",label:"City",key:"city",defaultWidth:140},{id:"state",label:"State",key:"state",defaultWidth:100},{id:"zip",label:"Zip",key:"zip",defaultWidth:100},{id:"email",label:"Email",key:"email",defaultWidth:240},{id:"notes",label:"Notes",key:"notes",defaultWidth:260},{id:"website",label:"Website",key:"website",defaultWidth:220},{id:"availability",label:"Availability",key:"availability",defaultWidth:180},{id:"region",label:"Region",key:"region",defaultWidth:150},{id:"status",label:"Status",key:"status",defaultWidth:120},{id:"type",label:"Type",key:"type",defaultWidth:120},{id:"lat",label:"Lat",key:"lat",defaultWidth:120},{id:"long",label:"Long",key:"long",defaultWidth:120}],a={rows:[],currentUserRole:"user",currentUserId:"anon",currentUserEmail:"",filters:{columnFilters:{}},sort:{key:"",dir:"asc"},pagination:{page:1,pageSize:20},columnOrder:["actions",...b.map(e=>e.id)],columnVisibility:Object.fromEntries([["actions",!0],...b.map(e=>[e.id,!0])]),columnWidths:Object.fromEntries([["actions",140],...b.map(e=>[e.id,e.defaultWidth])]),columnLabels:{},drag:{resizing:null,draggingCol:null},inlineEdit:{td:null,rowId:null,colId:null,original:null,inputEl:null,saving:!1,skipBlurCommit:!1}},Ae="techloc_services_table_prefs_v1",be=()=>`${Ae}:${a.currentUserId}`,$e=e=>{try{return JSON.parse(e)}catch{return null}},x=()=>{localStorage.setItem(be(),JSON.stringify({columnOrder:a.columnOrder,columnVisibility:a.columnVisibility,columnWidths:a.columnWidths,columnLabels:a.columnLabels,filters:a.filters,pagination:a.pagination}))},he=()=>{const e=$e(localStorage.getItem(be())||"");if(!e)return;const t=new Set(["actions",...b.map(i=>i.id)]);if(Array.isArray(e.columnOrder)){const i=e.columnOrder.filter(r=>t.has(r)),n=[...t].filter(r=>!i.includes(r));a.columnOrder=[...i,...n]}if(e.columnVisibility&&typeof e.columnVisibility=="object"){const i={...a.columnVisibility};for(const[n,r]of Object.entries(e.columnVisibility))t.has(n)&&(i[n]=!!r);i.actions=!0,a.columnVisibility=i}if(e.columnWidths&&typeof e.columnWidths=="object"){const i={...a.columnWidths};for(const[n,r]of Object.entries(e.columnWidths))t.has(n)&&Number.isFinite(+r)&&(i[n]=+r);a.columnWidths=i}if(e.columnLabels&&typeof e.columnLabels=="object"){const i={};for(const[n,r]of Object.entries(e.columnLabels))t.has(n)&&typeof r=="string"&&(i[n]=r);a.columnLabels=i}if(e.filters&&typeof e.filters=="object"){const i={columnFilters:{}};if(e.filters.columnFilters&&typeof e.filters.columnFilters=="object")for(const[n,r]of Object.entries(e.filters.columnFilters)){if(!t.has(n))continue;const o=Array.isArray(r?.values)?r.values:[],s=typeof r?.query=="string"?r.query:"";(o.length||s)&&(i.columnFilters[n]={values:o,query:s})}a.filters=i}if(e.pagination&&typeof e.pagination=="object"){const i=Number.isFinite(+e.pagination.page)?+e.pagination.page:1;a.pagination.page=Math.max(1,i),Number.isFinite(+e.pagination.pageSize)&&(a.pagination.pageSize=+e.pagination.pageSize)}},Oe=async()=>{const{data:e}=await E.auth.getSession();if(e?.session)if(a.currentUserId=e.session.user.id,a.currentUserEmail=e.session.user.email||"",window.currentUserRole)a.currentUserRole=window.currentUserRole;else{const{data:i}=await E.from("profiles").select("role").eq("id",e.session.user.id).single();a.currentUserRole=i?.role||"user"}else a.currentUserRole="anon",a.currentUserId="anon";he();const t=a.currentUserRole==="administrator";l.addRecord&&(l.addRecord.classList.toggle("hidden",!t),l.addRecord.disabled=!t)};E.auth.onAuthStateChange((e,t)=>{const i=t?.user?.id||"anon";i!==a.currentUserId&&(a.currentUserId=i,a.currentUserEmail=t?.user?.email||"",he(),v())});const Pe=()=>{let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.className="fixed bottom-6 right-6 z-50 flex flex-col gap-3",document.body.appendChild(e)),e},y=(e,t="info")=>{const i=Pe(),n=document.createElement("div"),r=t==="success"?"border-emerald-500/60 bg-emerald-500/10 text-emerald-50 shadow-emerald-500/30":t==="warning"?"border-amber-500/60 bg-amber-500/10 text-amber-50 shadow-amber-500/30":t==="info"?"border-blue-500/60 bg-blue-500/10 text-blue-50 shadow-blue-500/30":"border-red-500/60 bg-red-500/10 text-red-50 shadow-red-500/30";n.className=`flex min-w-[260px] max-w-sm items-start gap-3 rounded-xl border px-4 py-3 text-sm shadow-xl backdrop-blur ${r}`;const o=document.createElement("span");o.className=`mt-0.5 h-2.5 w-2.5 rounded-full ${t==="success"?"bg-emerald-400":t==="warning"?"bg-amber-400":t==="info"?"bg-blue-400":"bg-red-400"}`;const s=document.createElement("p");s.className="whitespace-pre-line font-semibold leading-relaxed",s.textContent=e,n.appendChild(o),n.appendChild(s),i.appendChild(n),setTimeout(()=>{n.classList.add("opacity-0","translate-y-2","transition","duration-300"),setTimeout(()=>n.remove(),320)},4200)},G=async({action:e="edit",summary:t="",tableName:i=V,recordId:n=null,columnName:r=null,previousValue:o=null,newValue:s=null}={})=>{await We({client:E,action:e,tableName:i,summary:t,recordId:n,columnName:r,previousValue:o,newValue:s,actor:a.currentUserEmail||a.currentUserId||null})},ye=(e,{confirmText:t="Confirm",cancelText:i="Cancel"}={})=>new Promise(n=>{const r=document.createElement("div");r.className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 backdrop-blur";const o=document.createElement("div");o.className="w-[min(420px,92vw)] rounded-2xl border border-slate-800 bg-slate-900/95 p-5 shadow-2xl shadow-black",o.innerHTML=`
          <div class="flex items-start gap-3">
            <div class="mt-1 h-3 w-3 rounded-full bg-amber-400"></div>
            <div class="space-y-3">
              <p class="text-sm font-semibold text-white">${e}</p>
              <div class="flex flex-wrap gap-2">
                <button type="button" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow shadow-emerald-600/40 hover:-translate-y-0.5 transition" data-confirm> ${t} </button>
                <button type="button" class="rounded-xl border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 hover:-translate-y-0.5 transition" data-cancel> ${i} </button>
              </div>
            </div>
          </div>
        `;const s=d=>{document.removeEventListener("keydown",m),r.remove(),n(d)};o.querySelector("[data-confirm]")?.addEventListener("click",()=>s(!0)),o.querySelector("[data-cancel]")?.addEventListener("click",()=>s(!1)),r.addEventListener("click",d=>{d.target===r&&s(!1)});function m(d){d.key==="Escape"&&s(!1)}document.addEventListener("keydown",m),r.appendChild(o),document.body.appendChild(r)}),S=e=>String(e??"").toLowerCase().trim(),J={show:()=>{l.status.textContent="Loading data…",l.total.innerHTML='<div class="h-7 w-16 rounded bg-slate-800/70 animate-pulse"></div>',l.states.innerHTML='<div class="h-7 w-12 rounded bg-slate-800/70 animate-pulse"></div>',l.companies.innerHTML='<div class="h-7 w-12 rounded bg-slate-800/70 animate-pulse"></div>',l.paginationSummary.textContent="Loading…",l.pageIndicator.textContent="—",l.prevPage.disabled=!0,l.nextPage.disabled=!0,l.refresh&&(l.refresh.disabled=!0);const e=A();l.tbody.innerHTML="";for(let t=0;t<6;t+=1){const i=document.createElement("tr");e.forEach(()=>{const n=document.createElement("td");n.className="compact-td",n.innerHTML='<div class="h-4 w-full rounded bg-slate-800/70 animate-pulse"></div>',i.appendChild(n)}),l.tbody.appendChild(i)}},hide:()=>{l.prevPage.disabled=!1,l.nextPage.disabled=!1,l.refresh&&(l.refresh.disabled=!1)}},Re=()=>{const e=a.rows.length,t=new Set(a.rows.map(n=>(n.state||"").trim()).filter(Boolean)).size,i=new Set(a.rows.map(n=>(n.company||"").trim()).filter(Boolean)).size;l.total.textContent=e,l.states.textContent=t,l.companies.textContent=i,l.status.textContent=e?`Connected • ${e} records`:"Awaiting data"},ve=(e,t)=>{if(e==="verified")return Z(t.verified);const i=b.find(r=>r.id===e),n=i?t[i.key]:"";return n==null||String(n).trim()===""?"—":String(n)},Me=e=>{const t=new Set;return a.rows.forEach(i=>{t.add(ve(e,i))}),Array.from(t).sort((i,n)=>S(i).localeCompare(S(n),void 0,{numeric:!0}))},Ve=e=>{const t=a.filters.columnFilters[e]||{};return{values:Array.isArray(t.values)?t.values:[],query:typeof t.query=="string"?t.query:""}},ce=(e,t)=>{const i=Array.isArray(t.values)?t.values:[],n=typeof t.query=="string"?t.query:"";!i.length&&!n?delete a.filters.columnFilters[e]:a.filters.columnFilters[e]={values:i,query:n},a.pagination.page=1,x(),v()},ne=()=>{let e=[...a.rows];const t=a.filters.columnFilters||{};return Object.entries(t).forEach(([i,n])=>{const r=Array.isArray(n.values)?n.values:[],o=typeof n.query=="string"?n.query.trim():"";if(!r.length&&!o)return;const s=new Set(r.map(S));e=e.filter(m=>{const d=ve(i,m),c=S(d),u=o?c.includes(S(o)):!0,p=s.size?s.has(c):!0;return u&&p})}),e},ie=e=>{const{key:t,dir:i}=a.sort;if(!t)return e;const n=b.find(o=>o.id===t);if(!n)return e;const r=[...e].sort((o,s)=>{if(n.id==="verified"){const m=u=>u===!0?"2":u===!1?"1":S(u),d=m(o.verified),c=m(s.verified);return d.localeCompare(c,void 0,{numeric:!0,sensitivity:"base"})}return S(o[n.key]).localeCompare(S(s[n.key]),void 0,{numeric:!0,sensitivity:"base"})});return i==="asc"?r:r.reverse()},A=()=>a.columnOrder.filter(e=>a.columnVisibility[e]),qe=()=>{const e=A();l.colgroup.innerHTML="",e.forEach(t=>{const i=document.createElement("col");i.setAttribute("data-col",t),i.style.width=`${a.columnWidths[t]||140}px`,l.colgroup.appendChild(i)})},q=()=>{l.topScrollbarInner.style.width=l.tableScroll.scrollWidth+"px",l.topScrollbar.scrollLeft=l.tableScroll.scrollLeft},Fe=(e,t)=>{a.columnWidths[e]=Math.max(72,Math.min(800,t));const r=l.colgroup.querySelector(`col[data-col="${e}"]`);r&&(r.style.width=`${a.columnWidths[e]}px`);const o=l.thead.querySelector(`th[data-col="${e}"]`);o&&(o.style.width=`${a.columnWidths[e]}px`,o.style.minWidth=`${a.columnWidths[e]}px`),q(),x(),requestAnimationFrame(()=>{w&&w.resize(),L&&L.resize()})},Ue=e=>a.sort.key!==e?"arrow-up-down":a.sort.dir==="asc"?"arrow-up":"arrow-down",He=e=>{if(!e||e==="actions")return;const t=a.columnLabels[e]||b.find(r=>r.id===e)?.label||e,i=prompt("Nuevo nombre de columna",t);if(i===null)return;const n=i.trim();n&&(a.columnLabels[e]=n,x(),v())},_e=e=>{a.sort.key===e?a.sort.dir=a.sort.dir==="asc"?"desc":"asc":(a.sort.key=e,a.sort.dir="asc"),a.pagination.page=1,v()},De=e=>{const t=document.createElement("th");t.className="text-left font-semibold text-slate-200 resizable bg-slate-950/60 compact-th",t.setAttribute("data-col",e);const i=a.columnWidths[e]||140;if(t.style.width=`${i}px`,t.style.minWidth=`${i}px`,e==="actions")return t.className="text-left font-semibold text-blue-300 resizable bg-slate-950/60 compact-th",t.style.width=`${a.columnWidths[e]||110}px`,t.style.minWidth=`${a.columnWidths[e]||110}px`,t.innerHTML=`
          <div class="th-inner">
            <span class="text-blue-300">Actions</span>
            <span class="opacity-60 text-[11px] uppercase tracking-wide">—</span>
          </div>
          <div class="col-resizer" data-resize="${e}" title="Drag to resize"></div>
        `,t;const n=b.find(W=>W.id===e),r=a.columnLabels[e]||n?.label||e;t.setAttribute("draggable","true");const o=document.createElement("div");o.className="th-inner";const s=document.createElement("div");s.className="flex items-center gap-2 min-w-0";const m=document.createElement("span");m.className="truncate th-label",m.dataset.renameCol=e,m.title="Doble click para renombrar",m.textContent=r,s.appendChild(m);const d=document.createElement("div");d.className="header-actions";const c=document.createElement("div");c.className="relative";const u=document.createElement("button");u.type="button",u.title="Filter column",u.className="filter-btn";const p=Ve(e),F=p.values.length||p.query;u.innerHTML=`<i data-lucide="list-filter" class="h-3.5 w-3.5 ${F?"text-blue-400":"text-slate-400"}"></i>`;const h=document.createElement("div");h.className="filter-popover hidden";const z=document.createElement("label");z.textContent="Filter this column",h.appendChild(z);const k=document.createElement("div");k.className="filter-search";const I=document.createElement("i");I.setAttribute("data-lucide","search"),I.className="h-3.5 w-3.5 text-slate-500";const g=document.createElement("input");g.type="search",g.placeholder=`Search ${r}`,g.value=p.query,k.appendChild(I),k.appendChild(g),h.appendChild(k);const N=document.createElement("div");N.className="filter-options",h.appendChild(N);const $=new Set(p.values),U=(W="")=>{const D=S(W);N.innerHTML="";const oe=Me(e),le=D?oe.filter(C=>S(C).includes(D)):oe;if(!le.length){const C=document.createElement("p");C.className="text-xs text-slate-500",C.textContent="No options",N.appendChild(C);return}le.forEach(C=>{const j=document.createElement("label");j.className="filter-option";const T=document.createElement("input");T.type="checkbox",T.className="h-4 w-4 accent-blue-600",T.value=C,T.checked=$.has(C),T.addEventListener("change",Se=>{Se.target.checked?$.add(C):$.delete(C)});const Q=document.createElement("span");Q.className="truncate",Q.textContent=C,j.appendChild(T),j.appendChild(Q),N.appendChild(j)})};U(g.value);const H=document.createElement("div");H.className="filter-actions";const O=document.createElement("button");O.type="button",O.className="flex-1 rounded-md bg-blue-600 px-3 py-2 text-xs font-semibold text-white hover:bg-blue-500",O.textContent="Apply";const P=document.createElement("button");P.type="button",P.className="flex-1 rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-xs font-semibold text-slate-200 hover:border-blue-500",P.textContent="Clear",H.appendChild(O),H.appendChild(P),h.appendChild(H);const R=W=>{(!W||!c.contains(W.target))&&(h.classList.add("hidden"),document.removeEventListener("click",R))};u.addEventListener("click",W=>{W.stopPropagation();const D=h.classList.contains("hidden");h.classList.toggle("hidden"),D?(U(g.value),document.addEventListener("click",R)):document.removeEventListener("click",R)}),g.addEventListener("input",()=>{U(g.value)}),O.addEventListener("click",()=>{ce(e,{values:Array.from($),query:g.value.trim()}),R()}),P.addEventListener("click",()=>{$.clear(),g.value="",U(""),ce(e,{values:[],query:""}),R()}),c.appendChild(u),c.appendChild(h);const B=document.createElement("button");B.type="button",B.className="sort-btn text-[11px] font-semibold text-slate-200",B.dataset.sortCol=e,B.title="Sort",B.innerHTML=`<i data-lucide="${Ue(e)}" class="h-3.5 w-3.5"></i>`,d.appendChild(c),d.appendChild(B),o.appendChild(s),o.appendChild(d),t.appendChild(o);const _=document.createElement("div");return _.className="col-resizer",_.dataset.resize=e,_.title="Drag to resize",t.appendChild(_),t},je=()=>{const e=A(),t=document.createElement("tr");e.forEach(i=>t.appendChild(De(i))),l.thead.innerHTML="",l.thead.appendChild(t),l.thead.querySelectorAll('th[draggable="true"]').forEach(i=>{i.addEventListener("dragstart",n=>{if(a.drag.resizing){n.preventDefault();return}const r=i.dataset.col;a.drag.draggingCol=r,i.classList.add("dragging"),n.dataTransfer.effectAllowed="move",n.dataTransfer.setData("text/plain",r)}),i.addEventListener("dragend",()=>{i.classList.remove("dragging"),a.drag.draggingCol=null,l.thead.querySelectorAll("th").forEach(n=>n.classList.remove("drop-target"))}),i.addEventListener("dragover",n=>{n.preventDefault();const r=i.dataset.col;!a.drag.draggingCol||a.drag.draggingCol===r||i.classList.add("drop-target")}),i.addEventListener("dragleave",()=>i.classList.remove("drop-target")),i.addEventListener("drop",n=>{n.preventDefault();const r=a.drag.draggingCol,o=i.dataset.col;if(!r||!o||r===o)return;const s=[...a.columnOrder],m=s.indexOf(r),d=s.indexOf(o);m===-1||d===-1||(s.splice(m,1),s.splice(d,0,r),a.columnOrder=s,x(),v())})}),l.thead.querySelectorAll("[data-sort-col]").forEach(i=>{i.addEventListener("click",n=>{n.stopPropagation(),_e(i.getAttribute("data-sort-col"))})}),l.thead.querySelectorAll("[data-rename-col]").forEach(i=>{i.addEventListener("dblclick",n=>{n.stopPropagation();const r=i.getAttribute("data-rename-col");He(r)})}),lucide.createIcons()},Je=e=>{const t=A(),i=a.currentUserRole==="administrator";l.tbody.innerHTML="",e.forEach(n=>{const r=document.createElement("tr");r.className="transition hover:bg-slate-800/40",t.forEach(o=>{const s=document.createElement("td");if(s.className="align-top text-slate-200 compact-td",o==="actions"){if(s.className="text-center align-top compact-td",i){const c=document.createElement("div");c.className="inline-flex items-center justify-center gap-2";const u=document.createElement("button");u.type="button",u.className="text-blue-300 transition hover:text-blue-200 hover:scale-110",u.innerHTML='<i data-lucide="copy" class="h-4 w-4"></i>',u.onclick=()=>st(n),c.appendChild(u);const p=document.createElement("button");p.type="button",p.className="text-red-400 transition hover:text-red-300 hover:scale-110",p.innerHTML='<i data-lucide="trash-2" class="h-4 w-4"></i>',p.onclick=()=>ot(n),c.appendChild(p),s.appendChild(c)}else s.innerHTML='<span class="text-slate-600 text-xs">Read Only</span>';r.appendChild(s);return}const m=b.find(c=>c.id===o);let d=m?n[m.key]:"";o==="verified"&&(d=Z(n.verified)),o==="company"&&(s.className="font-semibold text-white align-top compact-td"),s.textContent=d===""||d===null||d===void 0?"—":String(d),s.dataset.rowId=n.id,s.dataset.colId=o,s.dataset.editable=i&&o!=="actions"?"true":"false",r.appendChild(s)}),l.tbody.appendChild(r)}),lucide.createIcons()},Xe=e=>{const t=Math.max(1,Math.ceil(e.length/a.pagination.pageSize)),i=a.pagination.page;a.pagination.page>t&&(a.pagination.page=t);const n=(a.pagination.page-1)*a.pagination.pageSize,r=Math.min(e.length,n+a.pagination.pageSize);return l.paginationSummary.textContent=e.length?`Showing ${n+1}-${r} of ${e.length}`:"No entries to display",l.pageIndicator.textContent=`${a.pagination.page} / ${t}`,l.prevPage.disabled=a.pagination.page===1||e.length===0,l.nextPage.disabled=a.pagination.page>=t||e.length===0,i!==a.pagination.page&&x(),{start:n,end:r}},v=()=>{const e=ne(),t=ie(e),{start:i,end:n}=Xe(t);qe(),je(),Je(t.slice(i,n)),re(),q(),Le(t),lucide.createIcons()},Ke=(e,t=2e4)=>{let i;const n=new Promise((r,o)=>{i=setTimeout(()=>o(new Error(`Request timed out after ${t/1e3}s`)),t)});return Promise.race([e,n]).finally(()=>clearTimeout(i))},ae=e=>a.rows.find(t=>String(t.id)===String(e)),M=(e={save:!1})=>{const t=a.inlineEdit;if(!t.td)return;const i=t.td,n=t.original;if(i.classList.remove("editing"),i.classList.remove("failed"),i.classList.remove("saved"),!e.save){i.innerHTML="",i.textContent=n===""?"—":n,t.td=null,t.rowId=null,t.colId=null,t.original=null,t.inputEl=null;return}t.td=null,t.rowId=null,t.colId=null,t.original=null,t.inputEl=null},Ze=(e,t)=>{if(e==="verified"){const n=String(t??"").trim();return n===""?null:n==="true"?!0:n==="false"?!1:n}const i=String(t??"").trim();return i===""?null:i},X=(e,t)=>e==="verified"?Z(t):t==null||String(t).trim()===""?"—":String(t),Ge=new Set(["category","authorization","state","verified"]),ee=(e,t)=>e==="state"?String(t).toUpperCase():e==="verified"?Z(t):String(t),K="__insert_new__",Qe=e=>{if(e==="verified"){const r=[{value:"",label:"—"},{value:"true",label:"Verified"},{value:"false",label:"Not verified"}],o=new Set(r.map(m=>m.value)),s=[];return a.rows.forEach(m=>{const d=m.verified,c=d===!0?"true":d===!1?"false":d==null?"":String(d);!c||o.has(c)||(o.add(c),s.push({value:c,label:ee(e,d)}))}),[...r,...s,{value:K,label:"Insert new…"}]}const t=b.find(r=>r.id===e);if(!t)return[];const i=new Set,n=[];return a.rows.forEach(r=>{const o=r[t.key],s=o==null?"":String(o).trim();if(!s)return;const m=S(s);i.has(m)||(i.add(m),n.push({value:s,label:ee(e,s)}))}),[{value:"",label:"—"},...n,{value:K,label:"Insert new…"}]},de=(e,t,i)=>{if([...e.options].some(o=>o.value===t))return;const n=document.createElement("option");n.value=t,n.textContent=i;const r=[...e.options].find(o=>o.value===K);r?e.insertBefore(n,r):e.appendChild(n)},ue=(e,t,i)=>{const n=ae(e);if(!n)return;const r=b.find(o=>o.id===t);r&&(n[r.key]=i)},Ye=async({rowId:e,colId:t,newValue:i,td:n})=>{const r=ge[t];if(!r)throw new Error(`No DB mapping for column "${t}"`);n.classList.add("saving");const o={[r]:i},{error:s}=await Ke(E.from(V).update(o).eq("id",e),2e4);if(s)throw s},Y=async()=>{const e=a.inlineEdit;if(!e.td||e.saving)return;const t=e.td,i=e.rowId,n=e.colId,r=e.inputEl;if(!r)return;const o=r.value;let s=Ze(n,o);if(n==="phone"){const p=String(o??"").replace(/\D/g,"");if(p.length!==10){t.classList.add("failed"),y("Phone numbers must include exactly 10 digits (e.g., 809-555-1234).","error");return}s=`${p.slice(0,3)}-${p.slice(3,6)}-${p.slice(6)}`}if(n==="email"&&s&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)){t.classList.add("failed"),y("Please enter a valid email address.","error");return}const m=ae(i),d=b.find(p=>p.id===n),c=n==="verified"?m?.verified??null:m?.[d?.key]??null;if(n==="verified"?String(c??"").trim()===String(s??"").trim():String(c??"")===String(s??"")){t.innerHTML="",t.textContent=X(n,c),M({save:!0});return}try{if(i==null)throw new Error("Cannot save cell: missing row id");e.saving=!0,t.classList.remove("failed"),t.classList.remove("saved"),ue(i,n,s),t.innerHTML="",t.textContent=X(n,s),await Ye({rowId:i,colId:n,newValue:s,td:t}),t.classList.add("saved"),setTimeout(()=>t.classList.remove("saved"),900),M({save:!0}),Le(ie(ne())),G({action:"edit",summary:`Updated ${d?.label||n} for ${m.company||"Service"} (#${i})`,recordId:i,columnName:n,previousValue:c,newValue:s})}catch(p){console.error("Cell save failed:",p),ue(i,n,c),t.classList.add("failed"),t.innerHTML="",t.textContent=X(n,c),M({save:!0}),y("Error saving cell: "+(p?.message||JSON.stringify(p)),"error")}finally{e.saving=!1,t.classList.remove("saving")}},Ee=e=>{if(!(e?.dataset?.editable==="true"))return;const i=e.dataset.rowId,n=e.dataset.colId;if(!i||!n||n==="actions")return;a.inlineEdit.td&&M({save:!1});const r=ae(i);if(!r)return;const o=b.find(c=>c.id===n);if(!o)return;const s=n==="verified"?r.verified:r[o.key]??null,m=X(n,s);a.inlineEdit.td=e,a.inlineEdit.rowId=i,a.inlineEdit.colId=n,a.inlineEdit.original=m==="—"?"—":m,a.inlineEdit.skipBlurCommit=!1,e.classList.add("editing"),e.innerHTML="";let d;if(Ge.has(n)){const c=document.createElement("div");c.className="flex items-center gap-2";const u=document.createElement("select");u.className="cell-select flex-1 min-w-0",Qe(n).forEach(({value:z,label:k})=>de(u,z,k));const F=n==="verified"?s===!0?"true":s===!1?"false":s==null?"":String(s):s==null?"":String(s);u.value=[...u.options].some(z=>z.value===F)?F:"";let h=u.value;u.addEventListener("change",()=>{if(u.value!==K){h=u.value;return}const z=n==="verified"?"verification":o.label.toLowerCase(),k=prompt(`Enter a new ${z} value:`);if(k===null){u.value=h;return}const I=k.trim();if(I===""){u.value=h;return}let g=I;if(n==="verified"){const N=fe(I);N===!0?g="true":N===!1&&(g="false")}de(u,g,ee(n,I)),u.value=g,h=g}),c.appendChild(u),d=u,a.inlineEdit.inputEl=d,e.appendChild(c)}else{const c=document.createElement("input");c.type="text",c.className="cell-input",c.value=s==null?"":String(s),d=c,a.inlineEdit.inputEl=d,e.appendChild(d)}setTimeout(()=>{d.focus(),d.select&&d.select()},0),d.addEventListener("keydown",async c=>{if(c.key==="Enter"){c.preventDefault(),a.inlineEdit.skipBlurCommit=!0;try{await Y()}finally{a.inlineEdit.skipBlurCommit=!1}}else c.key==="Escape"?(c.preventDefault(),M({save:!1})):c.key==="Tab"&&(c.preventDefault(),await Y(),et(e,c.shiftKey?-1:1))}),d.addEventListener("blur",async()=>{if(a.inlineEdit.skipBlurCommit){a.inlineEdit.skipBlurCommit=!1;return}await Y()})},et=(e,t)=>{const i=e.closest("tr");if(!i)return;const n=Array.from(i.querySelectorAll('td[data-editable="true"]')),r=n.indexOf(e),o=n[r+t];o&&Ee(o)},tt=()=>{l.tbody.addEventListener("dblclick",e=>{const t=e.target.closest("td");t&&Ee(t)}),document.addEventListener("mousedown",e=>{!a.inlineEdit.td||e.target.closest("td.editing")})},xe=e=>{const t=a.drag.resizing;if(!t||t.pointerId!==void 0&&t.pointerId!==null&&e.pointerId!==void 0&&e.pointerId!==t.pointerId)return;e.preventDefault();const{colId:i,startX:n,startW:r}=t,o=e.clientX-n;Fe(i,r+o)},Ce=e=>{const t=a.drag.resizing;t&&(t.pointerId!==void 0&&t.pointerId!==null&&e&&e.pointerId!==void 0&&e.pointerId!==t.pointerId||(a.drag.resizing=null,document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("pointermove",xe),window.removeEventListener("pointerup",Ce,!0)))},nt=()=>{l.thead.addEventListener("pointerdown",e=>{const t=e.target.closest("[data-resize]");if(!t)return;e.preventDefault(),e.stopPropagation();const i=t.getAttribute("data-resize"),n=t.closest("th"),r=n?parseFloat(getComputedStyle(n).width):0,o=Number.isFinite(a.columnWidths[i])?a.columnWidths[i]:r||140;a.drag.resizing={colId:i,startX:e.clientX,startW:o,pointerId:e.pointerId},document.body.style.cursor="col-resize",document.body.style.userSelect="none",t.setPointerCapture&&t.setPointerCapture(e.pointerId),window.addEventListener("pointermove",xe),window.addEventListener("pointerup",Ce,!0)})},re=()=>{l.columnsList.innerHTML="";const e=(t,i,n=!1)=>{const r=document.createElement("label");r.className="flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 hover:border-blue-500/60";const o=document.createElement("div");o.className="flex items-center gap-2 min-w-0",o.innerHTML=`
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">${n?"Locked":"Show"}</span>
          <span class="truncate font-semibold">${a.columnLabels[t]||i}</span>
        `;const s=document.createElement("input");return s.type="checkbox",s.checked=!!a.columnVisibility[t],s.disabled=n,s.className="h-4 w-4 accent-blue-600",s.addEventListener("change",()=>{a.columnVisibility[t]=s.checked,a.columnVisibility.actions=!0,x(),v()}),r.appendChild(o),r.appendChild(s),r};l.columnsList.appendChild(e("actions","Actions",!0)),b.forEach(t=>l.columnsList.appendChild(e(t.id,t.label))),lucide.createIcons()},we=e=>{const t=typeof e=="boolean"?e:l.columnsPopover.classList.contains("hidden");l.columnsPopover.classList.toggle("hidden",!t),t&&re()};document.addEventListener("click",e=>{e.target.closest("#columns-popover")||e.target.closest("#columns-btn")||we(!1)});l.columnsBtn.addEventListener("click",e=>{e.stopPropagation(),we()});l.colsAll.addEventListener("click",()=>{Object.keys(a.columnVisibility).forEach(e=>a.columnVisibility[e]=!0),a.columnVisibility.actions=!0,x(),v()});l.colsNone.addEventListener("click",()=>{Object.keys(a.columnVisibility).forEach(e=>a.columnVisibility[e]=!1),a.columnVisibility.actions=!0,x(),v()});const it=()=>{let e=!1;l.tableScroll.addEventListener("scroll",()=>{e||(e=!0,l.topScrollbar.scrollLeft=l.tableScroll.scrollLeft,e=!1)}),l.topScrollbar.addEventListener("scroll",()=>{e||(e=!0,l.tableScroll.scrollLeft=l.topScrollbar.scrollLeft,e=!1)}),window.addEventListener("resize",()=>{q(),w&&w.resize(),L&&L.resize()})};let w=null,L=null;const me=(e,t)=>{const i=new Map;return e.forEach(n=>{const r=(n[t]||"—").toString().trim()||"—";i.set(r,(i.get(r)||0)+1)}),[...i.entries()].sort((n,r)=>r[1]-n[1])},pe=()=>({responsive:!0,maintainAspectRatio:!1,animation:!1,plugins:{legend:{labels:{color:"rgba(226,232,240,.85)",boxWidth:10,boxHeight:10,usePointStyle:!0}},tooltip:{backgroundColor:"rgba(2,6,23,.95)",borderColor:"rgba(51,65,85,.8)",borderWidth:1,titleColor:"rgba(226,232,240,.95)",bodyColor:"rgba(226,232,240,.85)"}},scales:{x:{ticks:{color:"rgba(148,163,184,.8)"},grid:{color:"rgba(51,65,85,.35)"}},y:{ticks:{color:"rgba(148,163,184,.8)"},grid:{color:"rgba(51,65,85,.35)"}}}}),Le=e=>{const t=me(e,"state").slice(0,10),i=me(e,"category").slice(0,8),n=t.map(([u])=>u==="—"?"Unknown":u.toUpperCase()),r=t.map(([,u])=>u),o=i.map(([u])=>u==="—"?"Unknown":u),s=i.map(([,u])=>u),m=["rgba(59,130,246,.55)","rgba(99,102,241,.55)","rgba(16,185,129,.55)","rgba(245,158,11,.55)","rgba(236,72,153,.55)","rgba(148,163,184,.45)","rgba(34,197,94,.45)","rgba(14,165,233,.45)"],d=document.getElementById("chart-states"),c=document.getElementById("chart-categories");!d||!c||(w&&w.destroy(),L&&L.destroy(),w=new Chart(d,{type:"bar",data:{labels:n,datasets:[{label:"Services",data:r,backgroundColor:m[0],borderColor:"rgba(59,130,246,.85)",borderWidth:1,borderRadius:10}]},options:{...pe()}}),L=new Chart(c,{type:"doughnut",data:{labels:o,datasets:[{label:"Services",data:s,backgroundColor:s.map((u,p)=>m[p%m.length]),borderColor:"rgba(15,23,42,.9)",borderWidth:2,hoverOffset:6}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"62%",animation:!1,plugins:{legend:{position:"right",labels:{color:"rgba(226,232,240,.85)",boxWidth:10,boxHeight:10,usePointStyle:!0}},tooltip:pe().plugins.tooltip}}}),requestAnimationFrame(()=>{w&&w.resize(),L&&L.resize(),q()}))},at=()=>{if(!("ResizeObserver"in window))return;new ResizeObserver(()=>{w&&w.resize(),L&&L.resize()}).observe(l.analyticsWrap)},se=async()=>{if(J.show(),!E){console.error("Supabase client is not initialized."),J.hide(),l.status.textContent="Client Error",l.tbody.innerHTML=`<tr><td class="compact-td text-sm text-red-200" colspan="${A().length||1}">Supabase client initialization failed. Check console.</td></tr>`,y("Supabase client unavailable.","error");return}try{const{data:e,error:t}=await E.from(Be).select("*");if(t)throw t;a.rows=(e||[]).map(te),J.hide(),Re(),v(),x()}catch(e){console.error("Error fetching services:",e),J.hide(),l.status.textContent="Error loading data",l.tbody.innerHTML=`<tr><td class="compact-td text-sm text-red-200" colspan="${A().length||1}">Unable to load data: ${e.message||"Unknown error"}</td></tr>`,l.paginationSummary.textContent="No data available",l.pageIndicator.textContent="—",y("Error loading services data: "+(e.message||"Check console"),"error")}},rt=e=>{const t={};return b.forEach(i=>{const n=ge[i.id];n&&(t[n]=e[i.key]??null)}),t};async function st(e){if(!e?.id)return;if(a.currentUserRole!=="administrator"){y("Only administrators can duplicate records.","warning");return}if(await ye(`Duplicate "${e.company}"?`,{confirmText:"Duplicate"}))try{const i=rt(e),{data:n,error:r}=await E.from(V).insert([i]).select("*").single();if(r)throw r;const o=te(n),s=a.rows.findIndex(m=>m.id===e.id);s>=0?a.rows.splice(s+1,0,o):a.rows.push(o),v(),y("Record duplicated successfully.","success"),G({action:"insert",summary:`Duplicated ${e.company||"service"} as #${o.id}`,recordId:o.id})}catch(i){console.error(i),y("Error duplicating record: "+(i?.message||JSON.stringify(i)),"error")}}async function ot(e){if(!e?.id)return;if(a.currentUserRole!=="administrator"){y("Only administrators can delete records.","warning");return}if(!await ye(`Delete "${e.company}"?`,{confirmText:"Delete",cancelText:"Cancel"}))return;const{error:i}=await E.from(V).delete().eq("id",e.id);i?y("Error deleting: "+i.message,"error"):(y("Record deleted.","success"),G({action:"delete",summary:`Deleted ${e.company||"service"} (#${e.id})`,recordId:e.id}),se())}l.prevPage.addEventListener("click",()=>{a.pagination.page>1&&(a.pagination.page-=1,x(),v())});l.nextPage.addEventListener("click",()=>{const e=ie(ne()).length,t=Math.max(1,Math.ceil(e/a.pagination.pageSize));a.pagination.page<t&&(a.pagination.page+=1,x(),v())});l.refresh.addEventListener("click",se);l.addRecord?.addEventListener("click",async()=>{if(a.currentUserRole==="administrator")try{const e={company_name:"",authorization:"",category:"",verified:null,phone:"",contact:"",address:"",city:"",state:"",zip:"",email:"",notes:"",website:"",availability:"",lat:null,long:null},{data:t,error:i}=await E.from(V).insert([e]).select("*").single();if(i)throw i;const n=te(t);if(n?.id===void 0||n?.id===null||n.id===""){console.error("Insert returned row without a valid id",t),y("Error creating record: missing ID from server. Please refresh and try again.","error");return}a.rows.unshift(n),a.pagination.page=1,v(),x(),G({action:"insert",summary:`Created new service record (#${n.id})`,recordId:n.id})}catch(e){console.error(e),y("Error creating record: "+(e?.message||JSON.stringify(e)),"error")}});const lt=async()=>{const e=await ze();Ie({canvasId:"constellation-canvas",initialMode:e,onModeChange:Ne})},ct=async()=>{await lt(),await Oe(),nt(),it(),at(),tt(),await se(),re(),q(),lucide.createIcons()};ct();const dt=async()=>{if(!E?.auth?.getSession)return;const{data:e}=await E.auth.getSession();e?.session||(window.location.href="../login.html")};dt();
