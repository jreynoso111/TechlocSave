import{s as _,c as ns}from"./constellation-uI2meXO3.js";import"./admin-auth-DJpBhotk.js";import"./datasets-qvn61PCv.js";import{r as rs}from"./Header-CYr_2qJu.js";rs("header-root");const ia=[39.8,-98.5],ls=1609.34,os=50;let xe={};const Te=new Map,is=new URL("data:application/json;base64,ewogICJERUZBVUxUIjogWzM5LjgsIC05OC41XSwKICAiQUwiOiBbMzIuODA2NywgLTg2Ljc5MTFdLAogICJBSyI6IFs2MS4zNzA3LCAtMTUyLjQwNDRdLAogICJBWiI6IFszMy43Mjk4LCAtMTExLjQzMTJdLAogICJBUiI6IFszNC45Njk3LCAtOTIuMzczMV0sCiAgIkNBIjogWzM2LjExNjIsIC0xMTkuNjgxNl0sCiAgIkNPIjogWzM5LjA1OTgsIC0xMDUuMzExMV0sCiAgIkNUIjogWzQxLjU5NzgsIC03Mi43NTU0XSwKICAiREUiOiBbMzkuMzE4NSwgLTc1LjUwNzFdLAogICJGTCI6IFsyNy43NjYzLCAtODEuNjg2OF0sCiAgIkdBIjogWzMzLjA0MDYsIC04My42NDMxXSwKICAiSEkiOiBbMjEuMDk0MywgLTE1Ny40OTgzXSwKICAiSUQiOiBbNDQuMjQwNSwgLTExNC40Nzg4XSwKICAiSUwiOiBbNDAuMzQ5NSwgLTg4Ljk4NjFdLAogICJJTiI6IFszOS44NDk0LCAtODYuMjU4M10sCiAgIklBIjogWzQyLjAxMTUsIC05My4yMTA1XSwKICAiS1MiOiBbMzguNTI2NiwgLTk2LjcyNjVdLAogICJLWSI6IFszNy42NjgxLCAtODQuNjcwMV0sCiAgIkxBIjogWzMxLjE2OTUsIC05MS44Njc4XSwKICAiTUUiOiBbNDQuNjkzOSwgLTY5LjM4MTldLAogICJNRCI6IFszOS4wNjM5LCAtNzYuODAyMV0sCiAgIk1BIjogWzQyLjIzMDIsIC03MS41MzAxXSwKICAiTUkiOiBbNDMuMzI2NiwgLTg0LjUzNjFdLAogICJNTiI6IFs0NS42OTQ1LCAtOTMuOTAwMl0sCiAgIk1TIjogWzMyLjc0MTYsIC04OS42Nzg3XSwKICAiTU8iOiBbMzguNDU2MSwgLTkyLjI4ODRdLAogICJNVCI6IFs0Ni45MjE5LCAtMTEwLjQ1NDRdLAogICJORSI6IFs0MS4xMjU0LCAtOTguMjY4MV0sCiAgIk5WIjogWzM4LjMxMzUsIC0xMTcuMDU1NF0sCiAgIk5IIjogWzQzLjQ1MjUsIC03MS41NjM5XSwKICAiTkoiOiBbNDAuMjk4OSwgLTc0LjUyMV0sCiAgIk5NIjogWzM0Ljg0MDUsIC0xMDYuMjQ4NV0sCiAgIk5ZIjogWzQyLjE2NTcsIC03NC45NDgxXSwKICAiTkMiOiBbMzUuNjMwMSwgLTc5LjgwNjRdLAogICJORCI6IFs0Ny41Mjg5LCAtOTkuNzg0XSwKICAiT0giOiBbNDAuMzg4OCwgLTgyLjc2NDldLAogICJPSyI6IFszNS41NjUzLCAtOTYuOTI4OV0sCiAgIk9SIjogWzQzLjkzMzYsIC0xMjAuNTU4M10sCiAgIlBBIjogWzQwLjU5MDgsIC03Ny4yMDk4XSwKICAiUkkiOiBbNDEuNjgwOSwgLTcxLjUxMThdLAogICJTQyI6IFszMy44NTY5LCAtODAuOTQ1XSwKICAiU0QiOiBbNDQuMjk5OCwgLTk5LjQzODhdLAogICJUTiI6IFszNS43NDc4LCAtODYuNjkyM10sCiAgIlRYIjogWzMxLjA1NDUsIC05Ny41NjM1XSwKICAiVVQiOiBbNDAuMTUsIC0xMTEuODYyNF0sCiAgIlZUIjogWzQ0LjA0NTksIC03Mi43MTA3XSwKICAiVkEiOiBbMzcuNzY5MywgLTc4LjE2OTldLAogICJXQSI6IFs0Ny40MDA5LCAtMTIxLjQ5MDVdLAogICJXViI6IFszOC40OTEyLCAtODAuOTU0NV0sCiAgIldJIjogWzQ0LjI2ODUsIC04OS42MTY1XSwKICAiV1kiOiBbNDIuNzU1OSwgLTEwNy4zMDI1XSwKICAiREMiOiBbMzguOTA3MiwgLTc3LjAzNjldCn0K",import.meta.url),cs=async(e=is)=>{try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch state centers: ${t.status}`);xe=await t.json()||{}}catch(t){console.error("Failed to load state centers configuration",t),xe={}}Array.isArray(xe.DEFAULT)||(xe.DEFAULT=ia)},ds=(e="")=>xe[e]?xe[e]:xe.DEFAULT||ia,Ee=(e,t,a,s)=>{const n=(a-e)*Math.PI/180,l=(s-t)*Math.PI/180,o=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(l/2)*Math.sin(l/2);return 3958.8*(2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)))},yt=({zip:e="",city:t="",stateCode:a="",fallbackLatLng:s=null,seed:r=0})=>{if(s&&Number.isFinite(s.lat)&&Number.isFinite(s.lng))return{lat:s.lat,lng:s.lng};const n=ds(a),l=`${e}`.trim();if(l){const d=`${l}-${a}`.toLowerCase();if(Te.has(d))return Te.get(d);const p=parseInt(l.replace(/\D/g,""),10);if(Number.isFinite(p)){const c=p%360*(Math.PI/180),i=.15+p%700/1200,m={lat:n[0]+i*Math.cos(c),lng:n[1]+i*Math.sin(c)*1.3};return Te.set(d,m),m}}const o=`${t}`.trim().toLowerCase();if(o){const d=`${o}-${a}`;if(Te.has(d))return Te.get(d);const p=o.split("").reduce((C,h)=>C+h.charCodeAt(0),r||1),c=p%360*(Math.PI/180),i=.18+p%500/1400,m={lat:n[0]+i*Math.cos(c),lng:n[1]+i*Math.sin(c)*1.25};return Te.set(d,m),m}return{lat:n[0],lng:n[1]}},ps=(e,...t)=>{for(const a of t){const s=e?.[a];if(s!=null&&String(s).trim()!=="")return s}return""},Oe=(e,{zip:t="",city:a="",stateCode:s="",seed:r=0,fallbackLatLng:n=null,getField:l=ps}={})=>{const o=parseFloat(l(e,"lat","Lat","latitude","Latitude")),d=parseFloat(l(e,"lng","Lng","long","Long","longitude","Longitude"));if(Number.isFinite(o)&&Number.isFinite(d)&&o!==0&&d!==0)return{coords:{lat:o,lng:d},hasExactCoords:!0,accuracy:"exact"};if(n&&Number.isFinite(n.lat)&&Number.isFinite(n.lng))return{coords:n,hasExactCoords:!0,accuracy:"exact"};const c=yt({zip:t,stateCode:s,seed:r});if(`${t}`.trim())return{coords:c,hasExactCoords:!1,accuracy:"zip"};const i=yt({city:a,stateCode:s,seed:r});return`${a}`.trim()?{coords:i,hasExactCoords:!1,accuracy:"city"}:{coords:yt({stateCode:s,seed:r}),hasExactCoords:!1,accuracy:"state"}},ta=(e="")=>`${e}`.trim().toLowerCase().replace(/\s+/g,"_"),z=(e,...t)=>{for(const a of t){const s=e?.[a];if(s!=null&&String(s).trim()!=="")return s;const r=typeof a=="string"?a.toLowerCase():a,n=e?.[r];if(n!=null&&String(n).trim()!=="")return n;const l=ta(a),o=e?.[l];if(o!=null&&String(o).trim()!=="")return o}if(e?.metadata)for(const a of t){const s=e.metadata?.[a]??e.metadata?.[ta(a)];if(s!=null&&String(s).trim()!=="")return s}return""},ca=e=>{const t=String(e??"").replace(/\s+/g," ").trim();if(!t)return{display:"",tel:""};const a=t.replace(/\D+/g,"");if(a.length===11&&a.startsWith("1")){const r=a.slice(1);return{display:`${r.slice(0,3)}-${r.slice(3,6)}-${r.slice(6)}`,tel:a}}if(a.length===10)return{display:`${a.slice(0,3)}-${a.slice(3,6)}-${a.slice(6)}`,tel:a};const s=t.replace(/\s+/g,"");return{display:a||s,tel:a||s}},wt=(e,{fallbackLatLng:t=null}={})=>t&&Number.isFinite(t.lat)&&Number.isFinite(t.lng)?{coords:t,hasExactCoords:!0,accuracy:"exact"}:{coords:{lat:0,lng:0},hasExactCoords:!1,accuracy:"state"},us=(e,t=0,{getField:a,toStateCode:s,resolveCoords:r}={})=>{const n=a||z,l=s||((v="")=>`${v}`.slice(0,2).toUpperCase()),o=r||wt,d=n(e,"company_name","Installation Company","Company","company","name"),p=l(n(e,"State","state","state_code"))||"US",c=n(e,"City","city"),i=n(e,"Zip","zip"),{coords:m,accuracy:C}=o(e,{zip:i,city:c,stateCode:p,seed:t,getField:n}),{display:h,tel:f}=ca(n(e,"Phone","phone"));return{id:e?.id??t,type:"technicians",name:d||"Installer",company:d||"Installer",email:n(e,"Email","email")||"-",phone:h||"-",phoneDial:f,city:c||"",state:p,zip:i||"",lat:m.lat,lng:m.lng,locationAccuracy:C,details:e||{},seed:t}},da=(e,t="tech",a=0,{getField:s,toStateCode:r,resolveCoords:n}={})=>{const l=s||z,o=r||((v="")=>`${v}`.slice(0,2).toUpperCase()),d=n||wt,p=o(l(e,"state","region","State","Region","state_code"))||"US",c=l(e,"city","City"),i=l(e,"zip","Zip","zipcode","postal_code"),{coords:m,accuracy:C}=d(e,{zip:i,city:c,stateCode:p,seed:a,getField:l}),{display:h,tel:f}=ca(l(e,"phone","Phone"));return{id:e?.id??`${t}-${a}`,type:t,company:l(e,"company_name","company","Company","name")||"Partner",region:l(e,"region","Region","state")||p,phone:h,phoneDial:f,contact:l(e,"contact","Contact","contact_name"),availability:l(e,"availability","tier","Availability"),authorization:l(e,"authorization","Authorization"),notes:l(e,"notes","Notes"),city:c||"",state:p,zip:i||"",lat:m.lat,lng:m.lng,locationAccuracy:C,details:e,seed:a}},ms=(e,t=0,{getField:a,toStateCode:s,resolveCoords:r}={})=>{const n=a||z,l=s||((x="")=>`${x}`.slice(0,2).toUpperCase()),o=r||wt,d=l(n(e,"State Loc","State","state","state_code")),p=parseFloat(n(e,"Lat","lat")),c=parseFloat(n(e,"Long","Lng","long","lng")),i=Number.isFinite(p)&&Number.isFinite(c)&&p!==0&&c!==0,m=n(e,"PT ZipCode","Zip","zip"),C=n(e,"PT City","City","city"),{coords:h,accuracy:f}=o(e,{zip:m,city:C,stateCode:d,seed:t,fallbackLatLng:i?{lat:p,lng:c}:null,getField:n}),v=n(e,"Deal Completion","Deal completion","Deal completition","Remaining"),E={id:e?.id??t,status:n(e,"Deal Status","status")||"ACTIVE",invPrepStatus:n(e,"INV Prep Stat","Inv. Prep. Stat.","Inv Prep Stat"),dealCompletion:v,type:n(e,"Unit Type","type")||"Vehicle",year:n(e,"Model Year","year"),model:n(e,"Model","model")||"Vehicle",vin:n(e,"ShortVIN","VIN","vin")||"N/A",gpsFix:n(e,"GPS Fix","gps_fix"),gpsReason:n(e,"GPS Fix Reason","gps_fix_reason"),gpsMoving:n(e,"GPS Moving","gps_moving"),moving:n(e,"Moving","moving"),movingCalc:n(e,"Moving (Calc)","moving_calc"),ptStatus:n(e,"PT Status","pt_status"),ptSerial:n(e,"PT Serial ","PT Serial","pt_serial"),encoreSerial:n(e,"Encore Serial","encore_serial"),lastRead:n(e,"PT Last Read","pt_last_read"),daysStationary:n(e,"days_stationary","Days Stationary","Days stationary","Days Stationary (Calc)","Days Parked"),state:d,city:C||"",zipcode:m||"",lat:h.lat,lng:h.lng,locationAccuracy:f,customerId:n(e,"Customer ID","Customer","customer_id"),customer:n(e,"PT City","City","city")?`${n(e,"PT City","City","city")}, ${d||"US"}`:d||"Unknown area",lastLocation:`${n(e,"PT City","City","city")||"Unknown"}, ${d||"USA"}${m?" "+m:""}`.trim(),payment:n(e,"Payment Schedule","payment"),details:e};return E._searchBlob=`${E.model} ${E.vin} ${E.lastLocation} ${E.customerId} ${E.customer}`.toLowerCase(),E},gs=(e,t)=>({vehicle_id:e?.vehicle_id??e?.vehicleId??e?.id,deal_status:e?.deal_status??e?.status,customer_id:e?.customer_id??e?.customerId,unit_type:e?.unit_type??e?.type,model_year:e?.model_year??e?.year,model:e?.model,inv_prep_stat:e?.inv_prep_stat??e?.invPrepStatus,deal_completion:e?.deal_completion??e?.dealCompletion,pt_status:e?.pt_status??e?.ptStatus,pt_serial:e?.pt_serial??e?.ptSerial,encore_serial:e?.encore_serial??e?.encoreSerial,moving:e?.moving,pt_last_read:e?.pt_last_read??e?.lastRead,lat:e?.lat,long:e?.long??e?.lng,phys_loc:e?.phys_loc??e?.lastLocation,VIN:t(e),vehicle_status:e?.vehicle_status??e?.status,open_balance:e?.open_balance??e?.openBalance,days_stationary:e?.days_stationary??e?.daysStationary,short_location:e?.short_location??e?.shortLocation??e?.city,current_stock_no:e?.details?.["Current Stock No"]??e?.current_stock_no,gps_fix:e?.gps_fix??e?.gpsFix,gps_fix_reason:e?.gps_fix_reason??e?.gpsReason}),fs=()=>({escapeHTML:(e="")=>`${e}`,formatDateTime:e=>e}),bt=e=>{const t=e?.VIN??e?.details?.VIN??"";return typeof t=="string"?t.trim():""},ys=({supabaseClient:e,startLoading:t,ensureSupabaseSession:a,runWithTimeout:s,timeoutMs:r=1e4,tableName:n,escapeHTML:l,formatDateTime:o}={})=>{const d=fs(),p=l||d.escapeHTML,c=o||d.formatDateTime,i=async h=>{if(!e||!h)return[];try{await a?.();const{data:f,error:v}=await s(e.from(n).select("*").eq("VIN",h).order("created_at",{ascending:!1}),r,"Repair history request timed out.");if(v)throw v;return f||[]}catch(f){return console.error("Failed to load repair history:",f),[]}},m=async(h,f,v)=>{try{if(!e)throw new Error("Supabase unavailable");await a?.();const E=Number.parseFloat(`${f.get("repair_price")||"0"}`.replace(/[$,]/g,""))||0,x={...gs(h,bt),cs_contact_date:f.get("cs_contact_date")||null,status:f.get("status")||null,doc:f.get("doc")||null,shipping_date:f.get("shipping_date")||null,poc_name:f.get("poc_name")||null,poc_phone:f.get("poc_phone")||null,customer_availability:f.get("customer_availability")||null,installer_request_date:f.get("installer_request_date")||null,installation_company:f.get("installation_company")||null,technician_availability_date:f.get("technician_availability_date")||null,installation_place:f.get("installation_place")||null,repair_price:E,repair_notes:f.get("repair_notes")||null},u=e.from(n),{data:k,error:R}=v?await s(u.update(x).eq("id",v).select("*"),r,"Repair update request timed out."):await s(u.insert(x).select("*"),r,"Repair create request timed out.");if(R)throw R;return k||[]}catch(E){throw console.error("Failed to save repair entry:",E),E}};return{getRepairVehicleVin:bt,fetchRepairs:i,saveRepair:m,setupRepairHistoryUI:({vehicle:h,body:f,signal:v,setActiveTab:E})=>{const x=bt(h),u=f.querySelector("[data-repair-history-body]"),k=f.querySelector("[data-repair-empty]"),R=f.querySelector("[data-repair-history-head]"),K=f.querySelector("[data-repair-columns-toggle]"),G=f.querySelector("[data-repair-columns-panel]"),q=f.querySelector("[data-repair-columns-list]"),F=f.querySelector("[data-repair-search]"),I=f.querySelector("[data-repair-form]"),w=f.querySelector("[data-repair-status]"),M=f.querySelector("[data-repair-submit]");let V=[],B=[],Q={},W="",oe="",je="desc";const Rt="repairHistoryColumns",Je=[{key:"cs_contact_date",label:"Date"},{key:"status",label:"Status"},{key:"doc",label:"DOC"},{key:"shipping_date",label:"Shipping Date"},{key:"poc_name",label:"POC Name"},{key:"poc_phone",label:"POC Phone"},{key:"customer_availability",label:"Customer Availability"},{key:"installer_request_date",label:"Installer Request Date"},{key:"installation_company",label:"Installation Company"},{key:"technician_availability_date",label:"Technician Availability Date"},{key:"installation_place",label:"Installation Place"},{key:"repair_notes",label:"Notes"},{key:"repair_price",label:"Cost"}],Da=(y,b)=>b==null||b===""?"—":y.includes("date")?c(b):b,Ua=y=>{const b=y?`${y}`:"—",$=b.toLowerCase();let S="bg-slate-800/70 text-slate-200 border-slate-700";return $.includes("done")||$.includes("complete")?S="bg-emerald-500/15 text-emerald-200 border-emerald-400/40":$.includes("pending")||$.includes("open")?S="bg-amber-500/15 text-amber-200 border-amber-400/40":($.includes("cancel")||$.includes("fail"))&&(S="bg-rose-500/15 text-rose-200 border-rose-400/40"),`<span class="inline-flex items-center rounded-full border px-2 py-0.5 text-[10px] font-semibold uppercase tracking-[0.12em] ${S}">${p(b)}</span>`},Ha=y=>y==null||y===""?"—":`
        <button type="button" class="max-w-[260px] truncate text-left text-slate-300 hover:text-slate-100 transition-colors" data-repair-notes>
          ${p(y)}
        </button>
      `,qa=(y,b)=>y==="status"?Ua(b?.[y]):y==="repair_notes"?Ha(b?.[y]):p(Da(y,b?.[y])),Ka=y=>y.replace(/_/g," ").replace(/\b\w/g,b=>b.toUpperCase()),Wa=new Set(["cs_contact_date","status","repair_notes"]),Ga=new Set(["id","vehicle_id","vehicleId","customer_id","customerId","created_at","updated_at","VIN","vin"]),Ft=y=>Wa.has(y)?!0:Ga.has(y)?!1:!!Je.some(b=>b.key===y),Qa=(y,b)=>{Q[y]=b,Ya(),Vt(),Me(V)},Za=y=>{let b={};try{b=JSON.parse(localStorage.getItem(Rt)||"{}")}catch{b={}}Q=y.reduce(($,S)=>($[S.key]=b[S.key]!==void 0?b[S.key]:Ft(S.key),$),{})},Ya=()=>{localStorage.setItem(Rt,JSON.stringify(Q))},Ja=y=>{const b=new Map(Je.map(S=>[S.key,S]));y.forEach(S=>{Object.keys(S||{}).forEach(A=>{b.has(A)||b.set(A,{key:A,label:Ka(A)})})}),B=[...Je.map(S=>S.key),...[...b.keys()].filter(S=>!Je.some(A=>A.key===S))].map(S=>b.get(S)).filter(Boolean),Object.keys(Q).length?B.forEach(S=>{Q[S.key]===void 0&&(Q[S.key]=Ft(S.key))}):Za(B)},Xa=()=>{if(q){if(!B.length){q.innerHTML='<p class="text-xs text-slate-400">No columns available.</p>';return}q.innerHTML=B.map(y=>`
        <label class="flex items-center gap-2">
          <input type="checkbox" value="${y.key}" class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950" ${Q[y.key]?"checked":""} />
          <span class="text-slate-200">${p(y.label)}</span>
        </label>
      `).join("")}},jt=()=>B.filter(y=>Q[y.key]),Vt=()=>{if(!R)return;const y=jt();if(!y.length){R.innerHTML=`
          <tr>
            <th class="py-2 pr-3">No columns selected</th>
            <th class="py-2">Actions</th>
          </tr>
        `;return}R.innerHTML=`
        <tr>
          ${y.map(b=>`
            <th class="py-2 pr-3">
              <button type="button" class="group inline-flex items-center gap-1 text-left text-[10px] uppercase tracking-[0.08em] text-slate-400 hover:text-slate-200 transition-colors" data-repair-sort="${b.key}">
                <span>${p(b.label)}</span>
                <span class="text-[9px] text-slate-500 group-hover:text-slate-300">${oe===b.key?je==="asc"?"▲":"▼":""}</span>
              </button>
            </th>
          `).join("")}
          <th class="py-2">Actions</th>
        </tr>
      `},es=y=>{const b=W.trim().toLowerCase();return b?y.filter($=>{const S=`${$?.status||""}`.toLowerCase(),A=`${$?.repair_notes||""}`.toLowerCase(),N=`${$?.installation_company||""}`.toLowerCase();return S.includes(b)||A.includes(b)||N.includes(b)}):y},ts=y=>{if(!oe)return y;const b=je==="asc"?1:-1;return[...y].sort(($,S)=>{const A=$?.[oe],N=S?.[oe];return A===N?0:A==null||A===""?1*b:N==null||N===""?-1*b:typeof A=="number"&&typeof N=="number"?(A-N)*b:`${A}`.localeCompare(`${N}`,void 0,{numeric:!0,sensitivity:"base"})*b})},Me=(y=[])=>{if(!u)return;V=y,Ja(y),Xa(),Vt();const b=jt(),$=ts(es(y));if(!$.length){const S=Math.max(b.length+1,1);u.innerHTML=`
          <tr data-repair-empty>
            <td class="py-2 pr-3 text-slate-400" colspan="${S}">No repair records yet.</td>
          </tr>
        `;return}u.innerHTML=$.map(S=>`
        <tr>
          ${b.map(A=>`
            <td class="py-2 pr-3 text-slate-300">${qa(A.key,S)}</td>
          `).join("")}
          <td class="py-2">
            <div class="flex items-center gap-2">
              <button type="button" class="rounded border border-blue-400/50 bg-blue-500/10 px-2 py-1 text-[10px] font-semibold text-blue-100 hover:bg-blue-500/20 transition-colors" data-repair-edit="${S?.id||""}">Edit</button>
              <button type="button" class="rounded border border-rose-400/50 bg-rose-500/10 px-2 py-1 text-[10px] font-semibold text-rose-100 hover:bg-rose-500/20 transition-colors" data-repair-delete="${S?.id||""}">Delete</button>
            </div>
          </td>
        </tr>
      `).join("")},as=async y=>{if(!e)throw new Error("Supabase unavailable");if(!y||!window.confirm("Are you sure you want to delete this repair entry?"))return;const{error:$}=await e.from(n).delete().eq("id",y);if($)throw $;const S=await i(x);Me(S)};k&&(k.textContent="Loading history..."),i(x).then(Me),K&&G&&K.addEventListener("click",()=>{G.classList.toggle("hidden")},{signal:v}),q&&q.addEventListener("change",y=>{const b=y.target;!b||b.tagName!=="INPUT"||Qa(b.value,b.checked)},{signal:v}),R&&R.addEventListener("click",y=>{const b=y.target.closest("[data-repair-sort]");if(!b)return;const $=b.dataset.repairSort;$&&(oe===$?je=je==="asc"?"desc":"asc":(oe=$,je="asc"),Me(V))},{signal:v}),F&&F.addEventListener("input",y=>{W=y.target.value||"",Me(V)},{signal:v}),u&&u.addEventListener("click",async y=>{const b=y.target.closest("[data-repair-notes]");if(b){b.classList.toggle("truncate"),b.classList.toggle("whitespace-normal"),b.classList.toggle("break-words");return}const $=y.target.closest("[data-repair-edit]"),S=y.target.closest("[data-repair-delete]");if($){const A=$.dataset.repairEdit,N=V.find(ss=>`${ss?.id}`==`${A}`);if(!N||!I)return;I.dataset.editRepairId=A;const Dt=I.querySelector('[name="cs_contact_date"]'),Ut=I.querySelector('[name="status"]'),Ht=I.querySelector('[name="doc"]'),qt=I.querySelector('[name="shipping_date"]'),Kt=I.querySelector('[name="poc_name"]'),Wt=I.querySelector('[name="poc_phone"]'),Gt=I.querySelector('[name="customer_availability"]'),Qt=I.querySelector('[name="installer_request_date"]'),Zt=I.querySelector('[name="installation_company"]'),Yt=I.querySelector('[name="technician_availability_date"]'),Jt=I.querySelector('[name="installation_place"]'),Xt=I.querySelector('[name="repair_price"]'),ea=I.querySelector('[name="repair_notes"]');Dt&&(Dt.value=N?.cs_contact_date||""),Ut&&(Ut.value=N?.status||""),Ht&&(Ht.value=N?.doc||""),qt&&(qt.value=N?.shipping_date||""),Kt&&(Kt.value=N?.poc_name||""),Wt&&(Wt.value=N?.poc_phone||""),Gt&&(Gt.value=N?.customer_availability||""),Qt&&(Qt.value=N?.installer_request_date||""),Zt&&(Zt.value=N?.installation_company||""),Yt&&(Yt.value=N?.technician_availability_date||""),Jt&&(Jt.value=N?.installation_place||""),Xt&&(Xt.value=N?.repair_price??""),ea&&(ea.value=N?.repair_notes||""),M&&(M.textContent="Update Record"),w&&(w.textContent=""),E("new-entry");return}if(S)try{await as(S.dataset.repairDelete)}catch(A){console.warn("Failed to delete repair:",A)}},{signal:v}),I&&I.addEventListener("submit",async y=>{if(y.preventDefault(),!h)return;const b=M?.textContent||"Save entry";M&&(M.disabled=!0),M&&(M.textContent="Saving..."),w&&(w.textContent="Saving repair...",w.classList.remove("text-amber-200"),w.classList.add("text-slate-400"));const $=t("Saving repair...");try{const S=new FormData(I),A=I?.dataset.editRepairId||"";await m(h,S,A),I.reset(),A&&(delete I.dataset.editRepairId,M&&(M.textContent="Save entry"));const N=await i(x);Me(N),w&&(w.textContent="Entry saved successfully.",w.classList.remove("text-slate-400","text-amber-300"),w.classList.add("text-amber-200")),E("history")}catch(S){console.warn("Failed to save repair:",S),w&&(w.textContent=S?.message||"Unable to save repair.",w.classList.remove("text-slate-400","text-amber-200"),w.classList.add("text-amber-300"))}finally{$(),M&&(M.disabled=!1,M.textContent=b)}},{signal:v})}}};let g,ae,ue,rt,Be,ze,P,he,ve,Le,$e,ie,ce,ne=[],pa=[],ua=[],qe=[],Ke=[],se=[],Z=new Map,vt=null,D=null,ke=new Map,Ve=null,J=[],ma=[],X=!0,Ne=!0,_e=!0;const bs={};let re=null,U=null;const pe=new Map;let ge=null,He=!1,at=!1,st=!1,be=!1,ga=null,Ce=null,Lt="",Ie=null;const lt={tech:"",reseller:"",repair:"",custom:""},T={invPrep:"all",gpsFix:"all",moving:"all",dealStatus:"all",ptStatus:"all",dealMin:0,dealMax:100},Se={},Et={tech:{originKey:null,distances:new Map},partners:{originKey:null,distances:new Map}},xs=e=>e?`${Number(e.lat).toFixed(6)},${Number(e.lng).toFixed(6)}`:null,Mt=(e,t,a,s)=>{if(!t)return[...e];const r=xs(t);return a.originKey!==r&&(a.distances.clear(),a.originKey=r),e.map(n=>{const l=a.distances.get(n.id);if(l!==void 0)return{...n,distance:l};const o=s(n);return a.distances.set(n.id,o),{...n,distance:o}})},hs=(e,t="#334155")=>{const a=e.getChildCount();return L.divIcon({html:`<div class="relative text-xs font-semibold rounded-full flex items-center justify-center w-8 h-8 border-2 shadow-md bg-slate-900/90" style="color:${t}; border-color:${t}">${a}</div>`,className:"partner-cluster-icon",iconSize:[32,32],iconAnchor:[16,16]})},De=(e="#334155")=>L.markerClusterGroup({maxClusterRadius:45,disableClusteringAtZoom:17,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,iconCreateFunction:t=>hs(t,e)}),vs=(e,t=300)=>{let a;return(...s)=>new Promise((r,n)=>{clearTimeout(a),a=setTimeout(async()=>{try{r(await e(...s))}catch(l){n(l)}},t)})};let Xe=0;function ye(e="Loading…"){const t=document.getElementById("loading-overlay"),a=document.getElementById("loading-text");return!t||!a?()=>{}:(Xe++,a.textContent=e,t.classList.remove("hidden"),document.body.classList.add("loading"),()=>{Xe=Math.max(0,Xe-1),Xe===0&&(t.classList.add("hidden"),document.body.classList.remove("loading"))})}const Tt="Services",Ls={tech:["GPS Technician"],reseller:["dealer/auction"],repair:["Repair Shop"]},We={services:Tt,vehicles:"vehicles",hotspots:"Hotspots",blacklist:"Services_Blacklist",repairHistory:"repair_history"},Cs=1e4,Is=(e,t,a)=>new Promise((s,r)=>{const n=setTimeout(()=>{r(new Error(a))},t);e.then(l=>{clearTimeout(n),s(l)}).catch(l=>{clearTimeout(n),r(l)})}),Ss=async()=>{const{data:e,error:t}=await _.auth.getSession();if(t||!e?.session){const{data:a,error:s}=await _.auth.refreshSession();if(s||!a?.session)throw s||new Error("Supabase session unavailable")}},Pe=new Map,fa=e=>Pe.get(e)||"",ya=(e="")=>fe(e).toLowerCase(),ws=(e=[])=>{const t=new Map;return e.forEach(a=>{const s=ya(a?.category||"uncategorized"),r=t.get(s)||[];r.push(a),t.set(s,r)}),t},ot=async()=>{if(!_)return null;if(ke.size)return ke;if(Ve)return Ve;const e=ye("Loading Services…");return Ve=(async()=>{const{data:t,error:a}=await _.from(Tt).select("*");if(a)throw a;return ke=ws(t||[]),ke})().finally(()=>{e(),Ve=null}),Ve},$t=e=>e?ke.get(ya(e))||[]:[],ba=(e=new Map)=>{Pe.clear();const t=new Map;e.forEach(a=>{const s=fe(a).toLowerCase();t.has(s)||t.set(s,a)}),Re.filter(a=>a!=="custom").forEach(a=>{const r=(Ls[a]||[]).map(n=>fe(n).toLowerCase()).find(n=>t.has(n));r&&Pe.set(a,t.get(r))})},fe=(e="")=>`${e}`.trim(),Es=(e="")=>$s(e)||`custom-${Z.size+1}`,it=(e="")=>{const t=fe(e)||"Custom",a=Es(t);if(!Z.has(a)){const s=na[Z.size%na.length]||me.custom,r=De(s);Z.set(a,{key:a,label:t,color:s,layer:r})}return Z.get(a)};function aa(){const e=document.getElementById("custom-legend-slot");if(e){if(e.innerHTML="",!ee.size){e.classList.add("hidden");return}e.classList.remove("hidden"),Array.from(ee).sort((t,a)=>`${t}`.localeCompare(`${a}`)).forEach(t=>{const a=it(t),s=document.createElement("div");s.className="legend-pill",s.dataset.legend=a.key||"custom",s.innerHTML=`
            <span class="inline-flex items-center justify-center">
              <svg class="h-3 w-3" viewBox="0 0 18 16" fill="${a.color}" stroke="#0f172a" stroke-width="1.2">
                <path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path>
              </svg>
            </span>
          `,s.appendChild(document.createTextNode(` ${a.label}`)),e.appendChild(s)})}}function xa(){const e=document.getElementById("custom-category-toggles");if(!e)return;if(e.innerHTML="",D=null,!ee.size){e.classList.add("hidden"),vt=null,aa();return}const t=[],a=()=>{t.forEach(r=>{const n=r.dataset.categoryKey||"",l=n&&D===n;r.classList.toggle("active",l)})},s=(r,n=null)=>{const l=document.createElement("button");l.className="sidebar-toggle-btn",l.textContent=r,l.dataset.categoryKey=n||"",l.addEventListener("click",()=>{D=D===n?null:n,ge?.setState?.("custom",!0),Qe(D),a();const o=le();o&&D&&de(o,{forceType:"custom"})}),e.appendChild(l),t.push(l)};Array.from(ee).sort((r,n)=>`${r}`.localeCompare(`${n}`)).forEach(r=>{const n=it(r);s(n.label,n.key)}),aa(),vt=t[0]||null,e.classList.remove("hidden"),a(),ge?.updateTogglePositions?.()}const O=e=>Ta.has(e),Ms=()=>Re.filter(O);async function Ts(){if(_){try{const{data:e,error:t}=await _.from(Tt).select("category");if(t)throw t;const a=new Map;(e||[]).forEach(l=>{const o=`${l?.category??""}`.trim();if(!o)return;const d=fe(o).toLowerCase();a.has(d)||a.set(d,o)}),ba(a);const s=Re.filter(l=>l==="custom"?!1:Pe.has(l)),r=new Set(Array.from(Pe.values()).map(l=>`${l}`.trim().toLowerCase())),n=new Map;a.forEach((l,o)=>{r.has(o)||n.set(o,l)}),ee=new Set(n.values()),ee.size&&s.push("custom"),xa(),Ta=s.length?new Set(s):new Set}catch(e){console.warn(`Service availability warning: ${e.message}`)}ha()}}const ha=()=>{Re.forEach(e=>{const t=Ma[e];if(!t)return;const a=O(e);if(e==="custom"){const l=document.getElementById("custom-category-toggles");l&&l.classList.toggle("hidden",!a||!ee.size)}const s=t.toggleId?document.getElementById(t.toggleId):null,r=document.getElementById(t.sidebarId),n=t.layer?.();s&&(s.classList.toggle("hidden",!a),s.setAttribute("aria-hidden",(!a).toString())),r&&(r.classList.toggle("hidden",!a),!a&&t.collapsedClass&&r.classList.add(t.collapsedClass)),t.legendSelector&&document.querySelectorAll(t.legendSelector).forEach(l=>{l.classList.remove("hidden")}),a||n?.clearLayers?.()}),document.querySelectorAll("[data-legend]").forEach(e=>e.classList.remove("hidden"))},va=(e,t=[])=>{!e||!Array.isArray(t)||!t.length||(bs[e]=Object.keys(t[0]))},Ge=(e="")=>{if(!e)return"";const t=`${e}`.match(/([A-Z]{2})/i);return t?t[1].toUpperCase():""},$s=(e="")=>`${e}`.trim().toLowerCase().replace(/\s+/g,"_"),Y=(e="")=>`${e}`.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),La={days_stationary:"Days Parked",short_location:"GPS City"},ks={"gps fix":"gpsFix","gps fix reason":"gpsReason"},Ca="vehicleModalColumns",Ia=e=>{if(!e)return"—";const t=new Date(e);return Number.isNaN(t.getTime())?"—":t.toLocaleString("en-US",{month:"2-digit",day:"2-digit",year:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).replace(",","")},Ct=ys({supabaseClient:_,startLoading:ye,ensureSupabaseSession:Ss,runWithTimeout:Is,timeoutMs:Cs,tableName:We.repairHistory,escapeHTML:Y,formatDateTime:Ia}),kt=()=>{try{const e=localStorage.getItem(Ca),t=e?JSON.parse(e):{};return{order:Array.isArray(t.order)?t.order:[],hidden:Array.isArray(t.hidden)?t.hidden:[]}}catch(e){return console.warn("Failed to load vehicle modal column preferences.",e),{order:[],hidden:[]}}},Sa=e=>{localStorage.setItem(Ca,JSON.stringify(e))},As=()=>{const e=ma.filter(s=>s.toLowerCase()!=="pt city"),t=kt(),a=t.order.filter(s=>e.includes(s));return e.forEach(s=>{a.includes(s)||a.push(s)}),{headers:a,hidden:new Set(t.hidden||[])}},Ns=(e,t)=>{const a=document.getElementById("vehicle-modal-columns-list");a&&(a.innerHTML="",e.forEach(s=>{const r=`vehicle-col-${s.replace(/\s+/g,"-").toLowerCase()}`,n=La[s]||s,l=document.createElement("label");l.className="flex items-center gap-2 rounded-md border border-slate-800 bg-slate-900/60 px-2 py-1",l.innerHTML=`
          <input type="checkbox" class="rounded border-slate-700 bg-slate-900 text-amber-400 focus:ring-amber-400" id="${r}">
          <span class="text-[11px] text-slate-200">${n}</span>
        `;const o=l.querySelector("input");o.checked=!t.has(s),o.addEventListener("change",()=>{const d=kt(),p=new Set(d.hidden||[]);o.checked?p.delete(s):p.add(s),d.hidden=[...p],Sa(d);const c=window.CSS&&CSS.escape?CSS.escape(s):s.replace(/"/g,'\\"'),i=document.querySelector(`tr[data-header="${c}"]`);i&&i.classList.toggle("hidden",!o.checked)}),a.appendChild(l)}))},_s=(e,t=0)=>{const a=Ge(z(e,"state","State"))||"US",s=z(e,"city","City"),r=z(e,"zip","Zip"),n=parseFloat(z(e,"lat","Lat")),l=parseFloat(z(e,"long","Long","lng","Lng","longitude","Longitude")),o=parseFloat(z(e,"radius","Radius")),d=Number.isFinite(n)&&Number.isFinite(l)?{lat:n,lng:l}:null,{coords:p}=Oe(e,{zip:r,city:s,stateCode:a,seed:t,fallbackLatLng:d,getField:z});return{id:e?.id??`hotspot-${t}`,city:s||"",state:a,zip:r||"",lat:p.lat,lng:p.lng,radiusMiles:Number.isFinite(o)?o:os}},Bs=(e,t=0)=>{const a=parseFloat(z(e,"lat","Lat","latitude","Latitude")),s=parseFloat(z(e,"long","Long","lng","Lng","longitude","Longitude"));return{id:e?.id??`blacklist-${t}`,company:z(e,"company_name","Company","company","name"),assocUnit:z(e,"Assoc.Unit","assoc_unit","AssocUnit"),note:z(e,"Note","note","notes","Notes"),lat:a,lng:s}},H=e=>Number.isFinite(e?.lat)&&Number.isFinite(e?.lng)&&e.lat!==0&&e.lng!==0,sa=(e="")=>e==="zip"?"Approximate location (based on ZIP code)":e==="city"?"Approximate location (based on city)":e==="state"?"Approximate location (state center)":"",zs=(e="")=>e==="exact"?"bg-emerald-300":"bg-amber-300",Ps={mapPin:'<path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0Z"></path><circle cx="12" cy="10" r="3"></circle>',navigation:'<polygon points="3 11 12 2 21 11 12 20 3 11"></polygon><line x1="12" y1="22" x2="12" y2="13"></line>',mail:'<rect x="3" y="5" width="18" height="14" rx="2"></rect><polyline points="3 7 12 13 21 7"></polyline>',wifiOff:'<line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 0 12 9.5 10.94 10.94 0 0 0 4.08 12.74"></path><path d="M5.1 16.5A6.95 6.95 0 0 1 12 14.5a6.95 6.95 0 0 1 3.53.96"></path><line x1="12" y1="20" x2="12.01" y2="20"></line>',hash:'<line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>',clock:'<circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline>',info:'<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>',search:'<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',save:'<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2Z"></path><path d="M17 21v-8H7v8"></path><path d="M7 3v5h8"></path>',alertCircle:'<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>',fileWarning:'<path d="M14.5 2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9.5L14.5 2Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path>',loader2:'<path d="M21 12a9 9 0 1 1-6.219-8.56"></path>'},j=(e,t="h-3 w-3")=>{const a=Ps[e];return a?`<svg class="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">${a}</svg>`:""},xt=35,wa=35,Re=["tech","reseller","repair","custom"],me={tech:"#3b82f6",reseller:"#34d399",repair:"#fb923c",custom:"#f472b6"},ct={tech:"left",reseller:"reseller",repair:"repair",custom:"custom"},Ea=Object.fromEntries(Object.entries(ct).map(([e,t])=>[t,e])),Ma={tech:{sidebarId:"left-sidebar",toggleId:"open-left-sidebar",legendSelector:'[data-legend="tech"]',collapsedClass:"collapsed-left",layer:()=>ae},reseller:{sidebarId:"reseller-sidebar",toggleId:"open-reseller-sidebar",legendSelector:'[data-legend="reseller"]',collapsedClass:"collapsed-reseller",layer:()=>ve},repair:{sidebarId:"repair-sidebar",toggleId:"open-repair-sidebar",legendSelector:'[data-legend="repair"]',collapsedClass:"collapsed-repair",layer:()=>Le},custom:{sidebarId:"dynamic-service-sidebar",toggleId:null,legendSelector:"#custom-legend-slot [data-legend]",collapsedClass:"collapsed-dynamic",layer:()=>$e}},Os=[{type:"reseller",eyebrow:"Reseller network",title:"Nearby resellers",accentClass:"text-emerald-300",filterPlaceholder:"Filter resellers by name, city, or state",emptyText:"Resellers will appear here."},{type:"repair",eyebrow:"Repair network",title:"Repair shops nearby",accentClass:"text-orange-200",filterPlaceholder:"Filter repair shops by name, city, or state",emptyText:"Repair shops will appear here."}],Rs={eyebrow:"Dynamic services",title:"New categories",accentClass:"text-indigo-200",description:"Showing every new category detected in Supabase."},Fs=({type:e,eyebrow:t,title:a,accentClass:s,filterPlaceholder:r,emptyText:n})=>`
      <aside id="${e}-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--${e}-sidebar-width)">
        <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-[10px] font-bold uppercase ${s} mb-1">${t}</p>
              <h2 class="text-xl font-black text-white leading-tight">${a}</h2>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
                <p id="${e}-count" class="text-xl font-black text-white leading-none">0</p>
              </div>
              <button id="collapse-${e}" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize ${e} sidebar">-</button>
            </div>
          </div>
          <div class="mt-4 space-y-2">
            <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
            <form id="${e}-search-form" class="relative">
              <input
                id="${e}-address-input"
                type="text"
                class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                placeholder="Ex: 33101, Phoenix, AZ..."
                autocomplete="off"
              >
              <button type="submit" id="${e}-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
                CALCULATE
              </button>
            </form>
            <div class="flex justify-between items-end">
              <div id="${e}-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
            </div>
            <input
              id="${e}-filter"
              type="text"
              class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="${r}"
              autocomplete="off"
            >
          </div>
        </div>
        <div id="${e}-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
          <div class="text-center mt-10 text-slate-600 text-xs">${n}</div>
        </div>
      </aside>
    `,js=e=>`
      <aside id="dynamic-service-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl collapsed-dynamic" style="width: var(--dynamic-sidebar-width)">
        <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p id="dynamic-service-eyebrow" class="text-[10px] font-bold uppercase ${e.accentClass} mb-1">${e.eyebrow}</p>
              <h2 id="dynamic-service-title" class="text-xl font-black text-white leading-tight">${e.title}</h2>
              <p id="dynamic-service-description" class="mt-1 text-[12px] text-slate-400">${e.description}</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
                <p id="dynamic-service-count" class="text-xl font-black text-white leading-none">0</p>
              </div>
              <button id="collapse-dynamic" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize dynamic services sidebar">-</button>
            </div>
          </div>
          <div class="mt-4 space-y-2">
            <input
              id="dynamic-service-filter"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Filter services by name, city, or state"
              autocomplete="off"
            >
          </div>
        </div>
        <div id="dynamic-service-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900 scroll-smooth relative">
          <div class="text-center mt-10 text-slate-600 text-xs">New categories will appear here.</div>
        </div>
      </aside>
    `;function Vs(){const e=document.getElementById("partner-sidebars");if(!e)return;const t=[...Os.map(a=>Fs(a)),js(Rs)].join(`
`);e.innerHTML=t}Vs();const Ue=e=>{if(!O(e))return!1;const t=Ma[e];if(!t?.sidebarId)return!1;const a=document.getElementById(t.sidebarId);return!a||a.classList.contains("hidden")?!1:!t.collapsedClass||!a.classList.contains(t.collapsedClass)};let Ta=new Set(Re),ee=new Set;const na=["#f472b6","#f97316","#14b8a6","#a78bfa","#ec4899","#10b981","#fb7185","#22d3ee"],dt=(e={})=>{const t=`${e.authorization||e.details?.authorization||""}`.trim().toLowerCase();return t==="no"||t==="unauthorized"},Ds=(e={})=>`${e.authorization??""}`.trim().toLowerCase()==="authorized",Us=(e={})=>`${e.categoryLabel||e.category||""}`.trim().toLowerCase()==="repo agent",Hs=(e={})=>`${e.categoryLabel||e.category||""}`.trim().toLowerCase()==="parking/storage",qs=(e={})=>`${e.notes||""}`.trim().toLowerCase()==="sp agent",Ks=(e={})=>`${e.notes||""}`.trim().toLowerCase()==="sp storage",$a=(e,t)=>dt(e)?"#94a3b8":t,nt=(e={})=>{const t=e.city?`${e.city}, `:"",a=e.state||e.region||"US",s=e.zip?` ${e.zip}`:"";return`${t}${a}${s}`.trim()},ka=e=>{if(!g||!e)return;const t=nt(e)||"Location unavailable",a=e.zip||"N/A",s=e.notes||e.note||e.details?.note||"";L.popup({className:"service-mini-popup",closeButton:!0,autoClose:!0,closeOnClick:!0,maxWidth:220,offset:[0,-6]}).setLatLng([e.lat,e.lng]).setContent(`
          <div class="service-mini-card">
            <p class="service-mini-title">${Y(e.company||e.name||"Service")}</p>
            <p class="service-mini-location">${Y(t)}</p>
            <p class="service-mini-meta"><span class="service-mini-label">ZIP</span><span>${Y(a)}</span></p>
            ${s?`<p class="service-mini-note"><span class="service-mini-label">Note</span> ${Y(s)}</p>`:""}
          </div>
        `).openOn(g)},pt=(e,{unauthorized:t=!1,checkPulseColor:a=null}={})=>L.divIcon({className:"service-triangle-icon",html:`<div class="service-icon-wrapper"><svg width="18" height="16" viewBox="0 0 18 16" fill="${e}" stroke="#0f172a" stroke-width="1.4" xmlns="http://www.w3.org/2000/svg"><path d="M9 1.1L17 14.8H1L9 1.1Z"/></svg>${t?'<span class="service-cross">✕</span>':""}${a?`<span class="service-check" style="--service-check-accent:${a}">✓</span>`:""}</div>`,iconSize:[18,16],iconAnchor:[9,14],popupAnchor:[0,-10]});function Ws(){g=L.map("tech-map",{renderer:L.canvas(),zoomControl:!1,minZoom:3,zoomSnap:.25,zoomDelta:.5}).setView([39.8,-98.5],5),L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19,minZoom:3}).addTo(g),L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png",{maxZoom:19,minZoom:3,opacity:.95}).addTo(g),L.control.zoom({position:"bottomright"}).addTo(g),ie=L.layerGroup().addTo(g),ce=L.layerGroup().addTo(g),ae=De(me.tech),P=L.markerClusterGroup({maxClusterRadius:35,disableClusteringAtZoom:17,spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,iconCreateFunction(s){const r=s.getChildCount();let n="w-8 h-8 text-xs",l=[32,32];r>100?(n="w-10 h-10 text-sm",l=[40,40]):r>10&&(n="w-9 h-9 text-sm",l=[36,36]);const o=typeof s.getAllChildMarkers=="function"?s.getAllChildMarkers():[];let d=!1,p=!1,c=!0,i=!1;o.forEach(v=>{const E=v?.options?.markerColor||(v?.options?.vehicleData?Bt(v.options.vehicleData):null);if((v?.options?.isStopped||(v?.options?.vehicleData?ft(v.options.vehicleData):!1))&&(i=!0),E){const u=`${E}`.toLowerCase();u==="#ef4444"?(d=!0,c=!1):u==="#f59e0b"||u==="#fbbf24"?(p=!0,c=!1):u!=="#22c55e"&&(c=!1)}else c=!1});let m="#f59e0b";d?m="#ef4444":p?m="#f59e0b":c&&o.length>0&&(m="#22c55e");const C=i?'<span class="vehicle-cross-badge absolute inset-0 flex items-center justify-center pointer-events-none">✕</span>':"",[h,f]=l;return L.divIcon({html:`<div class="relative border-2 font-bold rounded-full flex items-center justify-center shadow-lg bg-slate-900/90 ${n}" style="color:${m}; border-color:${m}">${C}<span>${r}</span></div>`,className:"vehicle-cluster-icon",iconSize:l,iconAnchor:[h/2,f/2]})}}).addTo(g),ue=L.layerGroup().addTo(g),rt=L.layerGroup().addTo(g),Be=L.layerGroup().addTo(g),ze=L.layerGroup().addTo(g),he=L.layerGroup().addTo(g),ve=De(me.reseller),Le=De(me.repair),$e=De(me.custom);const e=()=>g?.invalidateSize(),t=document.getElementById("tech-map");t&&typeof ResizeObserver<"u"&&new ResizeObserver(()=>{e()}).observe(t);const a=document.querySelector("[data-auth-protected]");a&&typeof MutationObserver<"u"&&new MutationObserver(()=>{a.classList.contains("hidden")||requestAnimationFrame(()=>e())}).observe(a,{attributes:!0,attributeFilter:["class"]}),g.on("click",s=>{if(s.originalEvent?.handledByMarker)return;const r=parseFloat(s.latlng.lat.toFixed(6)),n=parseFloat(s.latlng.lng.toFixed(6));if(re!==null||Ce!==null||Ie!==null){St(),Ie=null,Ce=null,ue?.clearLayers(),we();return}St(),ue?.clearLayers();const o={lat:r,lng:n,name:"Pinned location"};Ce=o,Ie=o;const d=L.divIcon({className:"",html:'<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>'});L.marker([r,n],{icon:d}).addTo(ue),L.marker([r,n]).addTo(ue).bindPopup(`<b>Selected point</b><br>${r.toFixed(4)}, ${n.toFixed(4)}`).openPopup(),de(o,{forceType:Fe()?Ye():null}),we()})}async function Gs(){if(!O("tech"))return;if(!_){console.warn("Supabase unavailable: showing local installer placeholders."),document.getElementById("tech-list").innerHTML=`
          <div class="text-center mt-10 px-6">
            ${j("alertCircle","mx-auto h-8 w-8 text-slate-600 mb-2")}
            <p class="text-slate-500 text-xs">Supabase is offline. Unable to load installers.</p>
          </div>
        `;return}const e=ye("Loading Installers…");try{await ot();const t=$t(fa("tech"));ne=(t||[]).map((a,s)=>us(a,s,{getField:z,toStateCode:Ge,resolveCoords:Oe})).filter(a=>a.company||a.city||a.state),va("technicians",t||[]),Lt="",document.getElementById("total-count").textContent=ne.length,At(ne),te()}catch(t){console.warn("System warning: "+t.message),document.getElementById("file-error").classList.remove("hidden"),document.getElementById("tech-list").innerHTML=`
          <div class="text-center mt-10 px-6">
            ${j("fileWarning","mx-auto h-8 w-8 text-slate-600 mb-2")}
            <p class="text-slate-500 text-xs">No installer data detected.</p>
          </div>
        `}finally{e()}}async function Qs(){if(J.length)return;if(!_){console.warn("Supabase unavailable: skipping vehicle load.");return}const e=ye("Loading Vehicles…");try{const{data:t,error:a}=await _.from(We.vehicles).select("*");if(a)throw a;J=(t||[]).map((s,r)=>ms(s,r,{getField:z,toStateCode:Ge,resolveCoords:Oe})),ma=t?.length?Object.keys(t[0]):[],Sn(),gt(),te()}catch(t){console.warn("Vehicle load warning: "+t.message),document.getElementById("vehicle-list").innerHTML=`
          <div class="text-center mt-10 px-6">
            ${j("fileWarning","mx-auto h-8 w-8 text-slate-600 mb-2")}
            <p class="text-slate-500 text-xs">Unable to load vehicle data.</p>
          </div>
        `}finally{e()}}function Aa(){ie&&(ie.clearLayers(),ua.filter(H).forEach(e=>{const t=L.circle([e.lat,e.lng],{radius:e.radiusMiles*ls,color:"#22c55e",weight:1.5,fillColor:"#22c55e",fillOpacity:.18,opacity:.7}).addTo(ie);t?.bringToBack?.();const a=[e.city,e.state,e.zip].filter(Boolean).join(", ");t.bindPopup(`
          <div class="text-xs text-slate-100 space-y-1">
            <p class="font-bold text-white text-sm">Hotspot</p>
            <p class="text-[11px] text-slate-300">${a||"Location unavailable"}</p>
            <p class="text-[11px] text-emerald-300">Coverage radius: ${e.radiusMiles} miles</p>
          </div>
        `)}))}const Zs=()=>L.divIcon({className:"blacklist-triangle-icon",html:'<div class="blacklist-marker">!</div>',iconSize:[18,24],iconAnchor:[9,20],popupAnchor:[0,-18]});function Na(){ce&&(ce.clearLayers(),pa.filter(H).forEach(e=>{const t=L.marker([e.lat,e.lng],{icon:Zs()}).addTo(ce);t.on("click",a=>{a.originalEvent.handledByMarker=!0}),t.bindPopup(`
          <div class="text-xs text-slate-100 space-y-1">
            <p class="font-bold text-amber-200 flex items-center gap-2 text-sm">
              <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-amber-500/20 text-amber-200 border border-amber-400/60">!</span>
              Device removal location
            </p>
            <p class="text-[11px] text-slate-300"><span class="text-slate-400">Company:</span> ${Y(e.company||"Unknown")}</p>
            ${e.assocUnit?`<p class="text-[11px] text-slate-300"><span class="text-slate-400">Assoc. Unit:</span> ${Y(e.assocUnit)}</p>`:""}
            ${e.note?`<p class="text-[11px] text-amber-200 font-semibold">${Y(e.note)}</p>`:""}
          </div>
        `)}))}async function Ys(){if(!_){console.warn("Supabase unavailable: skipping hotspot load.");return}const e=ye("Loading hotspots…");try{const{data:t,error:a}=await _.from(We.hotspots).select("*");if(a)throw a;ua=(t||[]).map((s,r)=>_s(s,r)).filter(H),Aa()}catch(t){console.warn(`Hotspot load warning: ${t.message}`)}finally{e()}}async function Js(){if(!_){console.warn("Supabase unavailable: skipping blacklist load.");return}const e=ye("Loading Blacklist Locations…");try{const{data:t,error:a}=await _.from(We.blacklist).select("*");if(a)throw a;pa=(t||[]).map((s,r)=>Bs(s,r)).filter(H),Na()}catch(t){console.warn(`Blacklist load warning: ${t.message}`)}finally{e()}}const _a={reseller:{uiUpdate:ut,setList:e=>{qe=e},warningLabel:"Reseller"},repair:{uiUpdate:mt,setList:e=>{Ke=e},warningLabel:"Repair shop"}};async function Xs(e){if(!O(e)||!_)return;const t=_a[e];if(!t){console.warn(`No service config found for type "${e}".`);return}try{await ot();const a=$t(fa(e));va(e,a);const s=(a||[]).map((r,n)=>da(r,e,n,{getField:z,toStateCode:Ge,resolveCoords:Oe}));t.setList(s),t.uiUpdate(s)}catch(a){const s=t.warningLabel||e;console.warn(`${s} load warning: ${a.message}`)}}async function en(){if(!_)return;await ot();const e=new Map;ke.forEach((a,s)=>{const n=a?.[0]?.category||s||"Custom";e.set(s,n)}),ba(e);const t=new Set(Array.from(Pe.values()).map(a=>fe(a).toLowerCase()));ee=new Set(Array.from(e.values()).filter(a=>!t.has(fe(a).toLowerCase()))),xa();for(const a of Object.keys(_a))await Xs(a);O("custom")&&ee.size&&await tn()}async function tn(){if(!(!O("custom")||!ee.size)){if(!_){console.warn("Supabase unavailable: skipping custom categories.");return}try{const e=Array.from(ee);await ot();const t=e.flatMap(a=>$t(a));Z.forEach(({layer:a})=>a?.clearLayers?.()),se=(t||[]).map((a,s)=>{const r=fe(a?.category||"Custom"),n=it(r);return{...da(a,"custom",s,{getField:z,toStateCode:Ge,resolveCoords:Oe}),categoryKey:n.key,categoryLabel:n.label,color:n.color,type:`custom-${n.key}`}}),!D&&se.length&&(D=se[0].categoryKey),Qe(D,se)}catch(e){console.warn(`Custom service warning: ${e.message}`)}}}function At(e,t=null,a=null){if(!He){ae?.clearLayers();return}const s=document.getElementById("tech-list");s.innerHTML="";const r=a||le(),n=Mt(e,r,Et.tech,i=>Ee(r.lat,r.lng,i.lat,i.lng)),l=r?n.sort((i,m)=>i.distance-m.distance):[...n],o=U!==null?l.find(i=>i.id===U)||e.find(i=>i.id===U):null,d=o?[o,...l.filter(i=>i.id!==o.id)]:l,p=d.map(i=>i.id).join("|"),c=He&&p!==Lt;c&&ae.clearLayers(),d.length===0&&(s.innerHTML='<div class="text-center mt-10 text-slate-600 text-xs">No technicians match this selection.</div>'),c&&(d.forEach(i=>{const m=L.marker([i.lat,i.lng],{icon:pt(me.tech)}).addTo(ae);m.bindPopup(`
            <div class="text-slate-900 p-1 font-sans">
              <strong class="block text-sm font-bold mb-1">${i.company}</strong>
              <div class="text-xs text-slate-500 mb-2">${i.city}, ${i.state} ${i.zip}</div>
              <a href="tel:${i.phoneDial||i.phone}" class="block bg-blue-100 text-blue-700 px-2 py-1 rounded text-center text-xs font-bold mb-1">${i.phone}</a>
              <div class="text-[10px] text-slate-400 truncate">${i.email}</div>
            </div>
          `),m.on("click",C=>{C.originalEvent.handledByMarker=!0,g.flyTo([i.lat,i.lng],15,{duration:1.2}),Ze(null,i.id)})}),Lt=p),d.slice(0,50).forEach((i,m)=>{const C=t&&m===0,h=document.createElement("div");h.className=`p-3 rounded-lg border transition-colors cursor-pointer ${C?"bg-slate-800 border-blue-500 ring-1 ring-blue-500":"bg-slate-900 border-slate-800 hover:border-slate-700"}`,h.dataset.id=i.id,h.dataset.type="tech";const f=r&&typeof i.distance=="number"?`${Math.round(i.distance)} mi`:"";h.innerHTML=`
          <div class="flex justify-between items-start gap-3">
            <div class="min-w-0 space-y-1">
              <h3 class="font-bold text-white text-sm break-words leading-tight" title="${i.company}">${i.company}</h3>
              <p class="flex items-center gap-1 text-[11px] text-slate-400 leading-tight">${j("mapPin","h-3 w-3")}<span class="truncate">${i.city||"Unknown"}, ${i.state||"US"}</span></p>
            </div>
            <div class="text-right text-[11px] text-slate-400 leading-tight space-y-0.5">
              <p class="font-semibold text-slate-200">${i.phone||""}</p>
              ${i.email?`<p class="flex items-center gap-1 justify-end text-slate-400">${j("mail","h-3 w-3")}<span class="truncate max-w-[160px]">${i.email}</span></p>`:""}
              ${f?`<p class="flex items-center gap-1 justify-end text-slate-300">${j("navigation","h-3 w-3")}<span class="font-semibold text-slate-100">${f}</span></p>`:""}
            </div>
          </div>
          ${i.zip?`<p class="text-[10px] text-slate-500 mt-1">${i.zip}</p>`:""}

        `,s.appendChild(h)})}const Fe=()=>Ot().length>0,an=(e="tech")=>`${lt[e]||""}`.trim().toLowerCase(),It=(e=[],t="tech")=>{const a=an(t);return a?e.filter(s=>[s.company,s.contact,s.city,s.state,s.zip,s.region].some(r=>`${r||""}`.toLowerCase().includes(a))):e};function Ba(e,t){if(!e||!t)return;const a=t.company||t.name||t.zip||"";lt[e]=a;const s=e==="custom"?"dynamic-service-filter":`${e}-filter`,r=document.getElementById(s);r&&(r.value=a),we()}const ra=(e,t,a=t)=>{const s=e==="custom"?"dynamic-service-count":`${e}-count`,r=document.getElementById(s);r&&(r.textContent=a!==t?`${a}/${t}`:t)},le=()=>{if(re!==null){const t=J.find(a=>a.id===re&&H(a));if(t)return t}if(U!==null){const t=ne.find(a=>a.id===U&&H(a));if(t)return t}const e=Object.values(Se).find(Boolean);return e&&H(e)?e:Ie||Ce||null},za=e=>Se[e]||null;function Nt(e=[],t){const{containerId:a,layer:s,visible:r,accentColor:n,badgeLabel:l,type:o}=t;if(!O(o))return;const d=document.getElementById(a);if(!d)return;if(!r){const u=document.createElement("div");u.className="text-center mt-10 text-slate-600 text-xs",u.textContent="Open this sidebar to view nearby partners.",d.replaceChildren(u),s?.clearLayers(),ra(o,e.length,It(e,o).length);return}d.replaceChildren(),s?.clearLayers();const p=e.length,c=It(e,o),i=za(o),m=le()||i,C=Mt(c,m,Et.partners,u=>Ee(m.lat,m.lng,u.lat,u.lng)),h=m?C.sort((u,k)=>u.distance-k.distance):[...C],f=i?[h.find(u=>u.id===i.id)||i,...h.filter(u=>u.id!==i.id)]:h;if(ra(o,p,f.length),!f.length){const u=document.createElement("div");u.className="text-center mt-10 text-slate-600 text-xs",u.textContent="No partners available.",d.replaceChildren(u);return}const v=document.createDocumentFragment(),E=Math.min(f.length,75),x=Math.min(f.length,wa);if(f.forEach((u,k)=>{const R=dt(u),K=$a(u,n),G=!R&&o==="reseller"&&Ds(u)?K:null;if(k<E){const w=L.marker([u.lat,u.lng],{icon:pt(K,{unauthorized:R,checkPulseColor:G})}).addTo(s),M=nt(u);w.bindPopup(`
              <div class="text-slate-900 p-1 font-sans">
                <strong class="block text-sm font-bold mb-1">${u.company}</strong>
                <div class="text-xs text-slate-500 mb-2">${M||"US"}</div>
                <a href="tel:${u.phoneDial||u.phone}" class="block bg-slate-100 text-slate-800 px-2 py-1 rounded text-center text-xs font-bold mb-1">${u.phone||"Contact"}</a>
                <div class="text-[10px] text-slate-500">${u.availability||""}</div>
              </div>
            `),w.on("click",V=>{V.originalEvent.handledByMarker=!0,ge?.setState?.(ct[o]||"left",!0),Se[o]=u,Ba(o,u);const B=le()||u;B&&de(B,{forceType:o}),ka(u),Nt(e,t),g.flyTo([u.lat,u.lng],15,{duration:1.2})})}if(k>=x)return;const q=nt(u),F=document.createElement("div"),I=i?.id===u.id;F.className=`p-3 rounded-lg border transition-colors cursor-pointer ${I||k===0&&m?"bg-slate-800 border-amber-400 ring-1 ring-amber-400":"bg-slate-900 border-slate-800 hover:border-slate-700"}`,F.dataset.id=u.id,F.dataset.type="partner",F.dataset.partnerType=o,F.innerHTML=`
            <div class="flex justify-between items-start gap-3">
              <div class="min-w-0">
                <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">${l}</p>
                <h3 class="font-bold text-white text-sm break-words leading-tight" title="${u.company}">${u.company}</h3>
              </div>
              <div class="text-right text-[11px] text-slate-400 leading-tight">
                <p class="font-semibold text-slate-200">${u.contact||"Dispatch"}</p>
                <a class="block font-bold text-blue-200" href="tel:${u.phoneDial||u.phone}">${u.phone||""}</a>
                <p class="text-[10px] text-slate-500">${u.availability||""}</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2 text-[11px] text-slate-300">
              <div class="flex items-center gap-1 text-slate-400">${j("mapPin")}<span>${q||"US"}</span></div>
              ${m?`<div class="flex items-center gap-1 justify-end text-slate-300">${j("navigation")}<span class="font-semibold text-slate-100">${Math.round(u.distance)} mi</span></div>`:""}
              ${u.notes?`<div class="col-span-2 text-[10px] text-slate-400 leading-tight">${u.notes}</div>`:""}
            </div>

          `,v.appendChild(F)}),f.length>x){const u=document.createElement("p");u.className="text-[11px] text-slate-500 px-1 pt-1",u.textContent=`Showing the first ${x} of ${f.length} partners.`,v.appendChild(u)}d.replaceChildren(v)}function ut(e=qe){Nt(e,{containerId:"reseller-list",layer:ve,visible:at,accentColor:"#34d399",badgeLabel:"Reseller",type:"reseller"})}function mt(e=Ke){Nt(e,{containerId:"repair-list",layer:Le,visible:st,accentColor:"#fb923c",badgeLabel:"Repair shop",type:"repair"})}function Qe(e=D,t=se){const a=document.getElementById("dynamic-service-list"),s=document.getElementById("dynamic-service-count"),r=document.getElementById("dynamic-service-title"),n=document.getElementById("dynamic-service-eyebrow"),l=document.getElementById("dynamic-service-description"),o=document.getElementById("dynamic-service-filter");if(!a)return;const d=e?Z.get(e)||it(e):null,p=d?.label||"Dynamic services";r&&(r.textContent=`${p} Network`),n&&(n.textContent=p),l&&(l.textContent=`Showing ${p} partners detected in Supabase.`);const c=t.filter(x=>!e||x?.categoryKey===e),i=`${lt.custom||o?.value||""}`.toLowerCase(),m=le(),C=Mt(c,m,Et.partners,x=>m?Ee(m.lat,m.lng,x.lat,x.lng):0),h=m?[...C].sort((x,u)=>x.distance-u.distance):[...C],f=i?h.filter(x=>`${x.company||x.name||""} ${x.city||""} ${x.state||""}`.toLowerCase().includes(i)):h,v=be&&O("custom");if(Z.forEach(({layer:x})=>x?.clearLayers?.()),a.innerHTML="",!f.length){a.innerHTML='<div class="text-center mt-10 text-slate-600 text-xs">No services available.</div>',s&&(s.textContent="0");return}const E=document.createDocumentFragment();f.slice(0,wa).forEach(x=>{const u=nt(x)||"US",k=document.createElement("article");k.className="rounded-xl border border-slate-800 bg-slate-900/70 p-3 shadow-sm hover:border-blue-500/70 transition-colors",k.dataset.id=x.id,k.dataset.type="partner",k.dataset.partnerType="custom";const R=m&&typeof x.distance=="number"?`${Math.round(x.distance)} mi`:"";if(k.innerHTML=`
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm font-bold text-white leading-tight">${Y(x.company||x.name||"Service")}</p>
              <p class="flex items-center gap-1 text-[11px] text-slate-400 leading-tight">${j("mapPin","h-3 w-3")}<span class="truncate">${Y(u)}</span></p>
            </div>
            <div class="text-right text-[11px] text-slate-400 leading-tight space-y-0.5">
              ${x.phone?`<a class="font-bold text-blue-200 block" href="tel:${x.phoneDial||x.phone}">${x.phone}</a>`:""}
              ${R?`<p class="flex items-center gap-1 justify-end text-slate-300">${j("navigation","h-3 w-3")}<span class="font-semibold text-slate-100">${R}</span></p>`:""}
            </div>
          </div>
          ${x.notes?`<p class="mt-2 text-[11px] text-slate-400 leading-tight">${Y(x.notes)}</p>`:""}
        `,E.appendChild(k),v&&g&&d?.layer&&(g.hasLayer(d.layer)||d.layer.addTo(g),H(x))){const K=Us(x)&&qs(x)||Hs(x)&&Ks(x)?d.color:null,G=pt(d.color,{unauthorized:dt(x),checkPulseColor:K}),q=L.marker([x.lat,x.lng],{icon:G});q.on("click",F=>{F.originalEvent.handledByMarker=!0,showServicePopup(x,d.color)}),q.addTo(d.layer)}}),a.appendChild(E),s&&(s.textContent=f.length)}function we(){He&&O("tech")&&At(Tn(ne)),at&&O("reseller")&&ut(qe),st&&O("repair")&&mt(Ke),be&&O("custom")&&Qe(D,se)}const _t={reseller:{containerId:"reseller-list",updater:ut,getList:()=>qe},repair:{containerId:"repair-list",updater:mt,getList:()=>Ke},custom:{containerId:"dynamic-service-list",updater:Qe,getList:()=>se}},sn=e=>J.find(t=>`${t.id}`==`${e}`),nn=e=>ne.find(t=>`${t.id}`==`${e}`),rn=(e,t)=>{const a=_t[e]?.getList;return(typeof a=="function"?a():[]).find(r=>`${r.id}`==`${t}`)};function ln(e){const t=e.currentTarget,a=e.target.closest('[data-type="vehicle"]'),s=e.target.closest('[data-action="vehicle-view-more"]'),r=e.target.closest('[data-action="repair-history"]');if(!a||!t.contains(a))return;const n=sn(a.dataset.id);if(n){if(s){e.stopPropagation(),Va(n);return}if(r){e.stopPropagation(),Bn(n);return}Ze(n.id,null),Fa(n)}}function on(e){const t=e.currentTarget,a=e.target.closest('[data-type="tech"]');if(!a||!t.contains(a))return;const s=nn(a.dataset.id);s&&(g.flyTo([s.lat,s.lng],15,{duration:1.2}),Ze(null,s.id))}function cn(e,t){const a=e.currentTarget,s=e.target.closest('[data-type="partner"]');if(!s||!a.contains(s)||s.dataset.partnerType!==t)return;const r=rn(t,s.dataset.id);if(!r)return;ge?.setState?.(ct[t]||"left",!0),H(r)&&g&&g.flyTo([r.lat,r.lng],15,{duration:1.2}),Se[t]=r;const n=t==="custom"?null:le()||r;n&&de(n,{forceType:t}),t==="custom"&&H(r)&&showServicePopup(r,r.color||me.custom);const l=_t[t]?.updater;typeof l=="function"&&l()}function dn(){const e=document.getElementById("vehicle-list");e&&e.addEventListener("click",ln);const t=document.getElementById("tech-list");t&&t.addEventListener("click",on),Object.entries(_t).forEach(([a,s])=>{const r=document.getElementById(s.containerId);r&&r.addEventListener("click",n=>cn(n,a))})}function Pa(){const e=document.getElementById("toggle-hotspots");e&&(e.textContent=Ne?"Hide Hotspot Areas":"Show Hotspot Areas",e.classList.toggle("active",Ne),e.setAttribute("aria-pressed",Ne?"true":"false"))}function pn(e){if(Ne=!!e,Pa(),!(!ie||!g)){if(!Ne){g.hasLayer(ie)&&g.removeLayer(ie);return}g.hasLayer(ie)||ie.addTo(g),Aa()}}function un(){const e=document.getElementById("toggle-hotspots");e&&(e.addEventListener("click",()=>pn(!Ne)),Pa())}function Oa(){const e=document.getElementById("toggle-blacklist");e&&(e.textContent=_e?"Hide Blacklist Marks":"Show Blacklist Marks",e.classList.toggle("active",_e),e.setAttribute("aria-pressed",_e?"true":"false"))}function mn(e){if(_e=!!e,Oa(),!(!ce||!g)){if(!_e){g.hasLayer(ce)&&g.removeLayer(ce);return}g.hasLayer(ce)||ce.addTo(g),Na()}}function gn(){const e=document.getElementById("toggle-blacklist");e&&(e.addEventListener("click",()=>mn(!_e)),Oa())}function Ra(){const e=document.getElementById("toggle-vehicle-markers");e&&(e.textContent=X?"Hide Vehicles Marks":"Show Vehicles Marks",e.classList.toggle("active",X),e.setAttribute("aria-pressed",X?"true":"false"))}function fn(e){if(X=!!e,Ra(),!X){P&&(P.clearLayers(),g?.hasLayer(P)&&g.removeLayer(P)),pe.clear(),he?.clearLayers();return}P&&g&&!g.hasLayer(P)&&P.addTo(g),te()}function yn(){const e=document.getElementById("toggle-vehicle-markers");e&&(e.addEventListener("click",()=>fn(!X)),Ra())}function bn(e,t,a){return L.divIcon({className:"vehicle-marker-wrapper",html:`<div class="vehicle-marker-icon"><span class="vehicle-marker-dot" style="background:${e}; border-color:${t}"></span>${a?'<span class="vehicle-cross-badge">✕</span>':""}</div>`,iconSize:[18,18],iconAnchor:[9,9]})}function la(e){if(!P)return;if(!X){P.clearLayers(),pe.clear();return}const t=new Set;e.forEach(({vehicle:a,coords:s,focusHandler:r})=>{if(!s)return;const n=Bt(a),l=$n(n),o=ft(a),d=bn(n,l,o);let c=pe.get(a.id)?.marker;c?(c.setLatLng([s.lat,s.lng]),c.setIcon(d),c.setZIndexOffset(o?500:0),c.options.vehicleData=a,c.options.markerColor=n,c.options.isStopped=o):(c=L.marker([s.lat,s.lng],{icon:d,zIndexOffset:o?500:0,vehicleData:a,markerColor:n,isStopped:o}).addTo(P),c.on("click",i=>{i.originalEvent.handledByMarker=!0,r()})),pe.set(a.id,{marker:c}),t.add(a.id)}),[...pe.keys()].forEach(a=>{if(t.has(a))return;const s=pe.get(a);s?.marker&&P.removeLayer(s.marker),pe.delete(a)})}function te(){const e=document.getElementById("vehicle-list");if(!e)return;g&&g.closePopup(),e.replaceChildren(),!X&&g?.hasLayer(P)?g.removeLayer(P):X&&g&&P&&!g.hasLayer(P)&&P.addTo(g);const t=document.getElementById("vehicle-search"),a=Mn(t?.value||"");if(document.getElementById("vehicles-count").textContent=a.length,a.length===0){const n=document.createElement("div");n.className="text-center mt-10 text-slate-600 text-xs",n.textContent="No vehicles match your search.",e.replaceChildren(n),la([]);return}const s=document.createDocumentFragment(),r=[];if(a.forEach((n,l)=>{const o=kn(n),d=()=>{if(!H(n)){console.warn(`No coordinates available for vehicle ${n.vin||n.id||"unknown"}`);return}Ze(n.id,null),Fa(n)};let p=null;if(H(n))n.locationAccuracy=n.locationAccuracy||"exact",n.locationNote=sa(n.locationAccuracy),p={lat:n.lat,lng:n.lng};else if(n.zipcode||n.city||n.state){const h=Oe(n,{zip:n.zipcode,city:n.city,stateCode:n.state});p=h.coords,n.lat=p.lat,n.lng=p.lng,n.locationAccuracy=h.accuracy,n.locationNote=sa(n.locationAccuracy)}else console.warn(`No location data for vehicle ${n.vin||n.id||"unknown"}`);if(p&&X&&r.push({vehicle:n,coords:p,focusHandler:d}),l>=xt)return;const c=document.createElement("div"),i=ht(n.status,"deal"),m=ht(n.invPrepStatus,"prep"),C=ht(n.ptStatus,"pt");c.className="p-3 rounded-lg border border-slate-800 bg-slate-900/80 hover:border-amber-500/80 transition-all cursor-pointer shadow-sm hover:shadow-amber-500/20 backdrop-blur space-y-3",c.dataset.id=n.id,c.dataset.type="vehicle",c.innerHTML=`
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-300">${n.model}</p>
                <h3 class="font-extrabold text-white text-sm leading-tight flex items-center gap-2">${n.year||"—"} <span class="text-slate-600">•</span> ${n.vin||"VIN N/A"}</h3>
                <p class="text-[11px] text-slate-400 flex items-center gap-1">${j("mapPin")} ${n.lastLocation||"No location provided"}</p>
                ${n.locationNote?`<p class="text-[10px] text-amber-200 font-semibold">${n.locationNote}</p>`:""}
                <p class="text-[11px] text-blue-200 font-semibold">Customer ID: <span class="text-slate-100">${n.customerId||"—"}</span></p>
              </div>
              <div class="flex flex-col items-end gap-1 text-right">
                <div class="inline-flex items-center gap-2 text-[10px] font-bold text-slate-300">
                  <span class="px-2 py-1 rounded-full border border-amber-400/40 bg-amber-500/10 text-amber-100">${n.status}</span>
                </div>
                <div class="inline-flex items-center gap-2 text-[10px] font-semibold ${o.text} px-2 py-1 rounded-full border border-slate-800 ${o.bg}">
                  <span class="w-2 h-2 rounded-full ${o.dot}"></span>
                  <span>${o.label}</span>
                </div>
                <div class="text-[10px] font-semibold text-slate-300">
                  Days Parked <span class="text-slate-100">${n.daysStationary||"—"}</span>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                ${j("wifiOff","h-3 w-3 text-amber-300")}
                <div class="text-left leading-tight">
                  <p class="font-semibold">${n.gpsFix||"GPS issue"}</p>
                  <p class="text-[10px] text-slate-400">${n.gpsReason||"Pending"}</p>
                </div>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                ${j("hash","h-3 w-3 text-blue-400")}
                <div class="text-left leading-tight">
                  <p class="font-semibold">VIN</p>
                  <p class="text-[10px] text-slate-400">${n.vin||"Not available"}</p>
                </div>
              </div>
            </div>
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-[10px] text-slate-200 space-y-2">
              <div class="grid grid-cols-4 gap-2">
                <div class="rounded border px-2 py-1.5 ${i.card}">
                  <p class="text-[9px] uppercase font-bold ${i.label}">Deal</p>
                  <p class="text-[11px] font-semibold ${i.value}">${n.status||"—"}</p>
                </div>
                <div class="rounded border px-2 py-1.5 ${m.card}">
                  <p class="text-[9px] uppercase font-bold ${m.label}">Prep</p>
                  <p class="text-[11px] font-semibold ${m.value}">${n.invPrepStatus||"—"}</p>
                </div>
                <div class="rounded border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Deal %</p>
                  <p class="text-[11px] font-semibold text-slate-100">${n.dealCompletion||"—"}</p>
                </div>
                <div class="rounded border px-2 py-1.5 ${C.card}">
                  <p class="text-[9px] uppercase font-bold ${C.label}">PT</p>
                  <p class="text-[11px] font-semibold ${C.value}">${n.ptStatus||"—"}</p>
                </div>
              </div>
              <div class="flex items-center justify-between text-[11px] text-slate-400">
                <span class="flex items-center gap-2 font-semibold text-slate-200">${j("clock","h-3 w-3")} PT Last Read ${Ia(n.lastRead)}</span>
                <span class="text-slate-400">${n.payment||""}</span>
              </div>
            </div>
            <div class="pt-1 flex items-center justify-end gap-2">
              <button data-view-more data-action="vehicle-view-more" class="inline-flex items-center gap-1.5 rounded-lg border border-amber-400/50 bg-amber-500/15 px-3 py-1 text-[10px] font-bold text-amber-100 hover:bg-amber-500/25 transition-colors">
                ${j("info","h-3.5 w-3.5")}
                See more
              </button>
              <button data-action="repair-history" class="inline-flex items-center gap-1.5 rounded-lg border border-blue-400/50 bg-blue-500/15 px-3 py-1 text-[10px] font-bold text-blue-100 hover:bg-blue-500/25 transition-colors">History</button>
            </div>
          `,s.appendChild(c)}),a.length>xt){const n=document.createElement("p");n.className="text-[11px] text-slate-500 px-1 pt-1",n.textContent=`Showing the first ${xt} of ${a.length} vehicles. Refine filters to see more.`,s.appendChild(n)}e.replaceChildren(s),la(r)}function Fa(e){if(!e||!H(e)||!X)return;he.clearLayers();const t=pe.get(e.id)?.marker,a=Bt(e),s=t||L.circleMarker([e.lat,e.lng],{radius:9,color:"#0b1220",weight:2.8,fillColor:a,fillOpacity:.95,opacity:.98,className:"vehicle-dot"}).addTo(he);L.circleMarker([e.lat,e.lng],{radius:12,color:a,weight:1.2,fillColor:a,fillOpacity:.18}).addTo(he).bringToBack(),ft(e)&&L.marker([e.lat,e.lng],{icon:L.divIcon({className:"vehicle-cross",html:'<div class="vehicle-cross-badge">✕</div>',iconSize:[16,16],iconAnchor:[8,8]}),interactive:!1,zIndexOffset:500}).addTo(he),s.bindPopup(xn(e),{className:"vehicle-popup",autoPan:!1,keepInView:!1}).openPopup(),setTimeout(On,50),de(e,{forceType:Fe()?Ye():null}),Ze(e.id,null)}function xn(e){const t=zs(e.locationAccuracy);return`
        <div class="w-[240px] bg-slate-950/90 text-white">
          <div class="p-3 space-y-2">
            <div class="flex items-start justify-between gap-2">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-400">Vehicle</p>
                <h3 class="text-base font-extrabold leading-tight text-white">${[e.model||"Vehicle",e.year].filter(Boolean).join(" · ")}</h3>
                <p class="text-[11px] text-slate-300">VIN ${e.vin||"N/A"}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/15 px-2 py-1 text-[10px] font-semibold text-amber-200 border border-amber-400/40">${e.status||"ACTIVE"}</span>
            </div>

            <div class="text-[12px] text-slate-200 space-y-1">
              <p class="font-semibold">${e.customer||"Customer pending"}</p>
              <p class="flex items-center gap-2">
                <span class="inline-flex h-2 w-2 rounded-full ${t}"></span>
                <span>${e.lastLocation||"No location provided"}</span>
              </p>
              ${e.locationNote?`<p class="text-[11px] text-amber-200 font-semibold">${e.locationNote}</p>`:""}
            </div>

            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-2 py-2">
                <p class="text-[9px] uppercase text-slate-500 font-bold">GPS</p>
                <p class="font-semibold text-slate-50">${e.gpsFix||"Unknown"}</p>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-2 py-2">
                <p class="text-[9px] uppercase text-slate-500 font-bold">Deal %</p>
                <p class="font-semibold text-slate-50">${e.dealCompletion||"—"}</p>
              </div>
            </div>
          </div>
        </div>
      `}function hn(e){if(e==null)return null;const t=String(e).replace(/%/g,"").trim(),a=parseFloat(t);return Number.isFinite(a)?a<=1?a*100:a:null}function vn(e,t,a){const s=hn(e);return Number.isFinite(s)?s>=t&&s<=a:t<=0}const Ae=e=>(e??"").toString().trim().toLowerCase();function ht(e,t){const a=Ae(e);return t==="deal"&&a==="active"?{card:"border-emerald-500/60 bg-emerald-500/15 text-emerald-100",label:"text-emerald-200/80",value:"text-emerald-50"}:t==="prep"&&a==="out for repo"?{card:"border-red-500/60 bg-red-500/15 text-red-100",label:"text-red-200/80",value:"text-red-50"}:t==="pt"&&a==="disabled"?{card:"border-red-500/60 bg-red-500/15 text-red-100",label:"text-red-200/80",value:"text-red-50"}:{card:"border-slate-800 bg-slate-900 text-slate-200",label:"text-slate-500",value:"text-slate-100"}}function Ln(e,t){const a=(t||"").toLowerCase();if(a&&!e._searchBlob.includes(a))return!1;const s=Ae(e.invPrepStatus);if(T.invPrep!=="all"&&s!==T.invPrep)return!1;const r=Ae(e.gpsFix);if(T.gpsFix!=="all"&&r!==T.gpsFix)return!1;const n=Ae(e.status);if(T.dealStatus!=="all"&&n!==T.dealStatus)return!1;const l=Ae(e.ptStatus);if(T.ptStatus!=="all"&&l!==T.ptStatus||!vn(e.dealCompletion,T.dealMin,T.dealMax))return!1;const o=ft(e);return!(T.moving==="moving"&&o||T.moving==="stopped"&&!o)}function Cn(e,t){return e.filter(a=>Ln(a,t))}function In(e){return!e||!g?[]:J.filter(H).map(a=>({vehicle:a,distance:Ee(a.lat,a.lng,e.lat,e.lng)})).filter(a=>a.distance<=180).sort((a,s)=>a.distance-s.distance).map(a=>a.vehicle)}function et(e){return Array.from(new Set(J.map(t=>Ae(t?.[e])).filter(Boolean))).sort()}function tt(e,t){const a=document.getElementById(e);if(!a)return;const s=a.value;a.innerHTML='<option value="all">All</option>',t.forEach(r=>{const n=document.createElement("option");n.value=r,n.textContent=r,a.appendChild(n)}),t.includes(s)&&(a.value=s)}function Sn(){tt("filter-invprep",et("invPrepStatus")),tt("filter-gps",et("gpsFix")),tt("filter-deal-status",et("status")),tt("filter-pt",et("ptStatus"))}function gt(){const e=document.getElementById("filter-invprep"),t=document.getElementById("filter-gps"),a=document.getElementById("filter-moving"),s=document.getElementById("filter-deal-status"),r=document.getElementById("filter-pt"),n=document.getElementById("filter-deal-min"),l=document.getElementById("filter-deal-max");e&&(e.value=T.invPrep),t&&(t.value=T.gpsFix),a&&(a.value=T.moving),s&&(s.value=T.dealStatus),r&&(r.value=T.ptStatus),n&&(n.value=T.dealMin),l&&(l.value=T.dealMax)}function wn(){T.invPrep="all",T.gpsFix="all",T.moving="all",T.dealStatus="all",T.ptStatus="all",T.dealMin=0,T.dealMax=100,gt(),te()}function En(){[{id:"filter-invprep",key:"invPrep"},{id:"filter-gps",key:"gpsFix"},{id:"filter-moving",key:"moving"},{id:"filter-deal-status",key:"dealStatus"},{id:"filter-pt",key:"ptStatus"}].forEach(({id:r,key:n})=>{const l=document.getElementById(r);l&&l.addEventListener("change",()=>{T[n]=l.value||"all",te()})});const t=document.getElementById("filter-deal-min"),a=document.getElementById("filter-deal-max");[t,a].forEach((r,n)=>{r&&r.addEventListener("input",()=>{const l=parseFloat(r.value);Number.isFinite(l)?n===0?T.dealMin=Math.max(0,Math.min(l,100)):T.dealMax=Math.max(0,Math.min(l,100)):n===0?T.dealMin=0:T.dealMax=100,T.dealMin>T.dealMax&&(T.dealMin=T.dealMax,gt()),te()})}),document.getElementById("vehicle-filters-reset")?.addEventListener("click",r=>{r.preventDefault(),wn()})}function Mn(e){if(re!==null)return J.filter(t=>t.id===re);if(U!==null){const t=ne.find(s=>s.id===U),a=In(t);return a.length?a:J}return Cn(J,e)}function Tn(e=ne){const t=le(),a=t?e.map(s=>({...s,distance:Ee(t.lat,t.lng,s.lat,s.lng)})).sort((s,r)=>s.distance-r.distance):[...e];if(U!==null){const s=a.find(r=>r.id===U)||e.find(r=>r.id===U);if(s)return[s,...a.filter(r=>r.id!==s.id)]}return a}function Bt(e){const t=(e.gpsFix||"").trim().toLowerCase();return t.includes("fully working")?"#22c55e":t==="all"||t.includes("all")?"#ef4444":"#f59e0b"}function $n(e){const t=(e||"").toLowerCase();return t==="#22c55e"?"#166534":t==="#f59e0b"?"#92400e":"#991b1b"}function kn(e){const t=parseInt(e.moving||e.movingCalc||e.gpsMoving||"",10);return t===1?{label:"Moving",text:"text-emerald-200",bg:"bg-emerald-500/10",dot:"bg-emerald-400"}:t===-1?{label:"Not moving",text:"text-amber-200",bg:"bg-amber-500/10",dot:"bg-amber-400"}:{label:"Unknown",text:"text-slate-300",bg:"bg-slate-800/70",dot:"bg-slate-400"}}function ft(e){return parseInt(e.moving||e.movingCalc||e.gpsMoving||"",10)===-1}function ja(){const e=document.getElementById("selection-banner"),t=document.getElementById("selection-text");if(!e||!t)return;if(re===null&&U===null){e.classList.add("hidden");return}const a=J.find(n=>n.id===re),s=ne.find(n=>n.id===U),r=[];a&&r.push(`Vehicle ${a.vin||a.model}`),s&&r.push(`Technician ${s.company}`),t.textContent=`Filtered by ${r.join(" & ")}`,e.classList.remove("hidden")}function Ze(e=null,t=null){re=e,U=t,e!==null&&ge?.setState?.("right",!0),te(),we(),ja()}function St(){re=null,U=null,Object.keys(Se).forEach(e=>delete Se[e]),he?.clearLayers(),rt?.clearLayers(),Be?.clearLayers(),ze?.clearLayers(),Ie=null,Ce=null,te(),we(),ja(),ge?.setState?.("right",!1)}async function An(e){try{const a=await(await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e+", USA")}`)).json();return a&&a.length>0?{lat:parseFloat(a[0].lat),lng:parseFloat(a[0].lon),name:a[0].display_name}:null}catch(t){return console.error("Geocoding error",t),null}}const Nn=vs(An,400);function _n(e,t="",a=null){if(!e)return;t&&(document.getElementById("address-input").value=t),ue.clearLayers(),rt.clearLayers(),Be?.clearLayers(),ze?.clearLayers();const s=L.divIcon({className:"",html:'<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>'});L.marker([e.lat,e.lng],{icon:s}).addTo(ue),L.marker([e.lat,e.lng]).addTo(ue).bindPopup(`<b>Client</b><br>${t||e.name||""}`).openPopup(),Ce=e;const n=a||(Fe()?Ye():null);if(n){const l=Pt(n);n==="tech"?At(l,!0,e):n==="reseller"?ut(l):n==="repair"&&mt(l)}de(e,{forceType:n}),g.flyTo([e.lat,e.lng],13,{duration:1.5})}function zt({formId:e,inputId:t,buttonId:a,statusId:s,partnerType:r}){const n=document.getElementById(e),l=document.getElementById(t),o=document.getElementById(a),d=s?document.getElementById(s):null;!n||!l||!o||n.addEventListener("submit",async p=>{p.preventDefault();const c=l.value.trim(),i=Pt(r);if(!c||i.length===0)return;const m=o.innerHTML,C=ye("Searching address…");o.innerHTML=j("loader2","animate-spin h-4 w-4"),o.disabled=!0,d?.classList.remove("hidden");let h=null;try{h=await Nn(c)}finally{C(),o.innerHTML=m,o.disabled=!1,d?.classList.add("hidden")}if(!h){alert("Address not found. Try a ZIP code or city name.");return}_n(h,h.name||c,r)})}zt({formId:"search-form",inputId:"address-input",buttonId:"search-btn",statusId:"search-status",partnerType:"tech"});zt({formId:"reseller-search-form",inputId:"reseller-address-input",buttonId:"reseller-search-btn",statusId:"reseller-search-status",partnerType:"reseller"});zt({formId:"repair-search-form",inputId:"repair-address-input",buttonId:"repair-search-btn",statusId:"repair-search-status",partnerType:"repair"});function Va(e){const t=document.getElementById("vehicle-modal"),a=document.getElementById("vehicle-modal-title"),s=document.getElementById("vehicle-modal-vin"),r=document.getElementById("vehicle-modal-body"),n=document.getElementById("vehicle-modal-columns-toggle"),l=document.getElementById("vehicle-modal-columns-panel");if(!t||!a||!r)return;const o=Ct.getRepairVehicleVin(e);t.dataset.vehicleId=e.id,n?.classList.remove("hidden"),l?.classList.add("hidden"),a.textContent=`${e.model||"Vehicle"} ${e.year||""} • ${e.vin||""}`,s&&(s.textContent=o?`VIN: ${o}`:"");const{headers:d,hidden:p}=As(),c=d.map(i=>{const m=La[i]||i,C=ks[i.toLowerCase()],h=!!C,f=e.details?.[i]||e[i]||e[i.toLowerCase()]||"—";return`
          <tr class="border-b border-slate-800/80 ${p.has(i)?"hidden":""}" draggable="true" data-header="${i}">
            <th class="text-left text-xs font-semibold text-slate-300 py-2 pr-3">
              <span class="inline-flex items-center gap-2">
                <span class="text-slate-600 text-sm">⋮⋮</span>
                ${m}
              </span>
            </th>
            <td class="text-xs text-slate-100 py-2">
              <div class="flex items-center justify-between gap-2">
                <span data-field-value>${f}</span>
                ${h?`
                  <button type="button" class="rounded border border-amber-400/40 px-2 py-1 text-[10px] font-semibold text-amber-200 hover:border-amber-300 hover:text-amber-100 transition-colors" data-edit-field="${C}" data-edit-header="${i}">Edit</button>
                `:""}
              </div>
            </td>
          </tr>
        `}).join("");r.innerHTML=`<table class="w-full text-left">${c}</table>`,t.classList.remove("hidden"),t.classList.add("flex"),Ns(d,p),zn(),Pn(e)}function Bn(e){const t=document.getElementById("vehicle-modal"),a=document.getElementById("vehicle-modal-title"),s=document.getElementById("vehicle-modal-vin"),r=document.getElementById("vehicle-modal-body"),n=document.getElementById("vehicle-modal-columns-toggle"),l=document.getElementById("vehicle-modal-columns-panel");if(!t||!a||!r)return;t.repairModalController&&t.repairModalController.abort();const o=new AbortController;t.repairModalController=o;const{signal:d}=o,p=Ct.getRepairVehicleVin(e);t.dataset.vehicleId=e.id,a.textContent="Repair Management",s&&(s.textContent=p?`VIN: ${p}`:""),n?.classList.add("hidden"),l?.classList.add("hidden"),r.innerHTML=`
        <div class="space-y-4">
          <div class="sticky top-0 z-10 -mx-4 border-b border-slate-800 bg-slate-950/95 px-4 pb-3 pt-1 backdrop-blur">
            <div class="inline-flex rounded-lg border border-slate-800 bg-slate-950/70 p-1 text-[11px] font-semibold text-slate-300">
              <button type="button" class="repair-tab-btn rounded-md px-3 py-1.5 text-white bg-slate-800/80" data-tab="history">History</button>
              <button type="button" class="repair-tab-btn rounded-md px-3 py-1.5 text-slate-400 hover:text-white" data-tab="new-entry">New Entry</button>
            </div>
          </div>
          <div class="repair-tab-panel" data-tab-panel="history">
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <div class="flex flex-wrap items-center justify-between gap-3 pb-3">
                <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400">Repair History</p>
                <div class="flex flex-wrap items-center gap-2">
                  <input type="text" class="w-48 rounded border border-slate-700 bg-slate-900 px-2 py-1 text-[10px] text-slate-200 placeholder-slate-500" placeholder="Search notes, status, company" data-repair-search />
                  <div class="relative">
                  <button type="button" class="rounded border border-slate-700 bg-slate-900 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200 hover:border-slate-500" data-repair-columns-toggle>
                    Columns
                  </button>
                  <div class="absolute right-0 z-10 mt-2 hidden w-64 rounded-lg border border-slate-800 bg-slate-950/95 p-3 text-[11px] text-slate-200 shadow-xl" data-repair-columns-panel>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show columns</p>
                    <div class="mt-2 grid gap-2" data-repair-columns-list></div>
                  </div>
                  </div>
                </div>
              </div>
              <table class="w-full text-left text-[11px] text-slate-200">
                <thead class="text-[10px] uppercase text-slate-500" data-repair-history-head></thead>
                <tbody class="divide-y divide-slate-800/80" data-repair-history-body>
                  <tr data-repair-empty>
                    <td class="py-2 pr-3 text-slate-400" colspan="1">Loading history...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="repair-tab-panel hidden" data-tab-panel="new-entry">
            <form class="space-y-3 rounded-lg border border-slate-800 bg-slate-950/70 p-4 text-[11px] text-slate-200" data-repair-form>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Status</span>
                  <input type="text" name="status" placeholder="Pending" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">DOC</span>
                  <input type="text" name="doc" placeholder="DOC-12345" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Date</span>
                  <input type="date" name="cs_contact_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Shipping Date</span>
                  <input type="date" name="shipping_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">POC Name</span>
                  <input type="text" name="poc_name" placeholder="Primary contact" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">POC Phone</span>
                  <input type="tel" name="poc_phone" placeholder="(555) 555-5555" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Customer Availability</span>
                  <input type="text" name="customer_availability" placeholder="Mon-Fri afternoons" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Installer Request Date</span>
                  <input type="date" name="installer_request_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Installation Company</span>
                  <input type="text" name="installation_company" placeholder="Techloc Installers" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Technician Availability</span>
                  <input type="date" name="technician_availability_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Installation Place</span>
                  <input type="text" name="installation_place" placeholder="123 Main St" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1 block">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Cost</span>
                  <input type="text" name="repair_price" placeholder="$0.00" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1 block">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Notes</span>
                  <input type="text" name="repair_notes" placeholder="Internal notes..." class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="flex items-center justify-between gap-3">
                <p class="text-[10px] text-slate-400" data-repair-status></p>
                <button type="submit" data-repair-submit class="rounded-lg border border-blue-400/50 bg-blue-500/20 px-4 py-1.5 text-[11px] font-semibold text-blue-100 hover:bg-blue-500/30 transition-colors">Save entry</button>
              </div>
            </form>
          </div>
        </div>
      `;const c=r.querySelectorAll(".repair-tab-btn"),i=r.querySelectorAll(".repair-tab-panel"),m=C=>{c.forEach(h=>{const f=h.dataset.tab===C;h.classList.toggle("bg-slate-800/80",f),h.classList.toggle("text-white",f),h.classList.toggle("text-slate-400",!f)}),i.forEach(h=>{h.classList.toggle("hidden",h.dataset.tabPanel!==C)})};c.forEach(C=>{C.addEventListener("click",()=>m(C.dataset.tab),{signal:d})}),m("history"),Ct.setupRepairHistoryUI({vehicle:e,body:r,signal:d,setActiveTab:m}),t.classList.remove("hidden"),t.classList.add("flex")}function zn(){const e=document.getElementById("vehicle-modal");if(!e)return;const t=e.querySelectorAll("tr[data-header]");let a=null;t.forEach(s=>{s.addEventListener("dragstart",r=>{a=s,s.classList.add("opacity-50"),r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",s.dataset.header||"")}),s.addEventListener("dragend",()=>{s.classList.remove("opacity-50"),a=null}),s.addEventListener("dragover",r=>{r.preventDefault(),r.dataTransfer.dropEffect="move"}),s.addEventListener("drop",r=>{if(r.preventDefault(),!a||a===s)return;const n=s.parentElement;if(!n)return;const l=[...n.querySelectorAll("tr[data-header]")],o=l.indexOf(a),d=l.indexOf(s);o<d?n.insertBefore(a,s.nextSibling):n.insertBefore(a,s);const p=kt();p.order=[...n.querySelectorAll("tr[data-header]")].map(c=>c.dataset.header),Sa(p)})})}async function Pn(e){const t=document.getElementById("vehicle-modal");if(!t)return;t.querySelectorAll("[data-edit-field]").forEach(s=>{let r=!1;const n=async()=>{if(r)return;const l=s.dataset.editField,o=s.dataset.editHeader,d=s.closest("td"),p=d?.querySelector("[data-field-value]");if(!d||!p)return;const c=d.querySelector("input[data-edit-input]"),i=c?c.value.trim():"";r=!0,s.disabled=!0,s.textContent="Saving...";const m=ye("Saving...");try{if(!_||!o||e?.id===void 0)throw new Error("Supabase unavailable");const{error:C}=await _.from(We.vehicles).update({[o]:i}).eq("id",e.id);if(C)throw C;p.textContent=i||"—",s.dataset.editing="false",c&&c.remove(),e?.details&&(e.details[o]=i),l&&e&&(e[l]=i),te();return}catch(C){console.warn("Failed to update vehicle field:",C),alert(C?.message||"Failed to save vehicle update.")}finally{m(),r=!1,s.disabled=!1,s.textContent=s.dataset.editing==="true"?"Save":"Edit"}};s.onclick=async()=>{const l=s.closest("td"),o=l?.querySelector("[data-field-value]");if(!l||!o)return;if(s.dataset.editing==="true"){await n();return}const d=o.textContent==="—"?"":o.textContent,p=document.createElement("input");p.type="text",p.value=d,p.dataset.editInput="true",p.className="flex-1 rounded border border-slate-700 bg-slate-900 px-2 py-1 text-[10px] text-slate-100",o.textContent="",o.appendChild(p),s.dataset.editing="true",s.textContent="Save",p.focus(),p.addEventListener("keydown",c=>{c.key==="Enter"&&(c.preventDefault(),n())})}})}function oa(){const e=document.getElementById("vehicle-modal");if(!e)return;e.repairModalController&&(e.repairModalController.abort(),e.repairModalController=null),e.classList.add("hidden"),e.classList.remove("flex"),document.getElementById("vehicle-modal-columns-panel")?.classList.add("hidden")}function On(){const e=document.querySelector(".vehicle-popup button[data-view-more-popup]");e&&e.addEventListener("click",()=>{const t=re,a=J.find(s=>s.id===t);a&&Va(a)})}function Pt(e){return e==="reseller"?qe:e==="repair"?Ke:e==="custom"?D?se.filter(t=>t?.categoryKey===D):se:ne}function Ye(){const e=Ot();if(e.length)return e[0];const t=Ea[ga];if(t&&O(t))return t;const[a]=Ms();return a||null}function Ot(){return Re.filter(e=>Ue(e))}function Rn(e,t,a){if(!e||!t.length)return null;let s=null,r=1/0;return t.forEach(n=>{const l=Ee(e.lat,e.lng,n.lat,n.lng);l<r&&(r=l,s=n)}),s?{entry:s,distance:r,type:a}:null}function Fn(e,t,a,s,r,n={}){if(!e||!t||!a)return null;const{dashArray:l="6 4",weight:o=3,opacity:d=.85}=n;L.polyline([[t.lat,t.lng],[a.lat,a.lng]],{color:r,weight:o,opacity:d,dashArray:l}).addTo(e);const p=(t.lat+a.lat)/2,c=(t.lng+a.lng)/2,i=L.marker([p,c],{icon:L.divIcon({className:"distance-label-wrapper",html:`<div class="distance-label" style="--line-color:${r}">${s.toFixed(1)} mi</div>`,iconSize:[0,0],iconAnchor:[0,0]}),interactive:!1});return i.addTo(e),i}function de(e,{forceType:t=null}={}){Be?.clearLayers(),ze?.clearLayers();const a=Fe();if(!e||!a&&!!!t)return;Ie={lat:e.lat,lng:e.lng,name:e.name||e.customer||""};const r=Ot();(t?[t]:r).forEach(l=>{const o=Pt(l);if(!o.length)return;const d=It(o,l),c=za(l)||Rn(e,d,l)?.entry;if(!c)return;const i=dt(c);let m=me[l]||"#38bdf8";if(l==="custom"||l.startsWith("custom-")){const f=c.categoryKey||D,v=Z.get(f);v&&(m=v.color)}else m=$a(c,m);L.marker([c.lat,c.lng],{icon:pt(m,{unauthorized:i})}).addTo(Be).on("click",f=>{f.originalEvent.handledByMarker=!0,ge?.setState?.(ct[l]||"left",!0),Se[l]=c,Ba(l,c),ka(c),g.flyTo([c.lat,c.lng],15,{duration:1.2})});const h=Ee(e.lat,e.lng,c.lat,c.lng);Fn(ze,e,c,Math.max(h,0),m,{dashArray:"6 4",weight:3,opacity:.85})})}function jn(){const e=document.getElementById("map-layout"),t=document.getElementById("left-sidebar"),a=document.getElementById("right-sidebar");if(!e||!t||!a)return;const s=document.documentElement.style,r=260,n=720;let l=null,o=!1;const d=v=>Math.min(Math.max(v,r),n),p=(v,E)=>{s.setProperty(v==="left"?"--left-sidebar-width":"--right-sidebar-width",`${E}px`),g&&!o&&(o=!0,requestAnimationFrame(()=>{g.invalidateSize(),o=!1}))},c=v=>{if(!l)return;const E=e.getBoundingClientRect();if(l==="left"){const x=d(v-E.left);p("left",x)}if(l==="right"){const x=d(E.right-v);p("right",x)}},i=v=>c(v.clientX),m=v=>{const E=v.touches?.[0];E&&c(E.clientX)},C=()=>{l=null,document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",C),document.removeEventListener("touchmove",m),document.removeEventListener("touchend",C)},h=(v,E)=>{E.preventDefault(),l=v,document.addEventListener("mousemove",i),document.addEventListener("mouseup",C),document.addEventListener("touchmove",m,{passive:!1}),document.addEventListener("touchend",C)},f=(v,E)=>{const x=v.querySelector(".resize-handle");x&&(x.addEventListener("mousedown",u=>h(E,u)),x.addEventListener("touchstart",u=>h(E,u),{passive:!1}))};f(t,"left"),f(a,"right")}const Vn=window.location.pathname.toLowerCase().includes("vehicles.html"),Dn=!Vn;function Un(){const e=document.getElementById("left-sidebar"),t=document.getElementById("right-sidebar"),a=document.getElementById("reseller-sidebar"),s=document.getElementById("repair-sidebar"),r=document.getElementById("dynamic-service-sidebar"),n=document.getElementById("open-left-sidebar"),l=document.getElementById("open-right-sidebar"),o=document.getElementById("open-reseller-sidebar"),d=document.getElementById("open-repair-sidebar"),p=vt||document.querySelector("#custom-category-toggles .sidebar-toggle-btn"),c=document.getElementById("collapse-left"),i=document.getElementById("collapse-right"),m=document.getElementById("collapse-reseller"),C=document.getElementById("collapse-repair"),h=document.getElementById("collapse-dynamic"),f=12,v=12,E=()=>{const I=be;if(He=Ue("tech"),at=Ue("reseller"),st=Ue("repair"),be=Ue("custom"),He?ae&&g&&!g.hasLayer(ae)&&ae.addTo(g):(g?.hasLayer(ae)&&g.removeLayer(ae),rt?.clearLayers()),at?ve&&g&&!g.hasLayer(ve)&&ve.addTo(g):ve?.clearLayers(),st?Le&&g&&!g.hasLayer(Le)&&Le.addTo(g):Le?.clearLayers(),be?$e&&g&&!g.hasLayer($e)&&($e.addTo(g),Z.forEach(({layer:w})=>w&&!g.hasLayer(w)&&w.addTo(g))):($e?.clearLayers?.(),Z.forEach(({layer:w})=>w?.clearLayers?.())),be!==I&&be&&Qe(D,se),ga=K.find(w=>{const M=k[w];return M?.sidebar&&!M.sidebar.classList.contains(M.collapsedClass)})||null,we(),!Fe())Be?.clearLayers(),ze?.clearLayers();else{const w=le();w&&de(w,{forceType:Ye()})}},x=I=>I?.getBoundingClientRect().width||0,k=Object.fromEntries(Object.entries({left:{sidebar:e,toggle:n,collapse:c,collapsedClass:"collapsed-left",group:"left"},reseller:{sidebar:a,toggle:o,collapse:m,collapsedClass:"collapsed-reseller",group:"left",type:"reseller"},repair:{sidebar:s,toggle:d,collapse:C,collapsedClass:"collapsed-repair",group:"left",type:"repair"},custom:{sidebar:r,toggle:p,collapse:h,collapsedClass:"collapsed-dynamic",group:"left",type:"custom"},right:{sidebar:t,toggle:l,collapse:i,collapsedClass:"collapsed-right",group:"right"}}).filter(([,I])=>!I.sidebar||!I.toggle?!1:I.type?O(I.type):!0)),R=()=>{g&&setTimeout(()=>g.invalidateSize(),320)},K=Object.keys(k).filter(I=>k[I]?.group==="left"),G=()=>{const I=K.map(W=>k[W]).find(W=>W?.sidebar&&!W.sidebar.classList.contains(W.collapsedClass)),w=I?x(I.sidebar)+f:f;K.forEach(W=>{const oe=k[W]?.toggle;oe&&(oe.style.left=`${w}px`)});const M=document.getElementById("custom-toggle-slot");M&&(M.style.left=`${w}px`),document.querySelectorAll("#custom-category-toggles .sidebar-toggle-btn").forEach(W=>{W.style.left=`${w}px`});const B=k.right?.sidebar?.classList.contains(k.right.collapsedClass)?v:x(k.right.sidebar)+v,Q=document.getElementById("right-toggle-group");Q&&(Q.style.right=`${B}px`)},q=(I,w)=>{const M=k[I];if(!M?.sidebar||!M?.toggle)return!1;const V=M.sidebar.classList.contains(M.collapsedClass),B=!w;return B&&!V?(M.sidebar.classList.add(M.collapsedClass),M.toggle.classList.remove("active"),M.toggle.setAttribute("aria-pressed","false")):!B&&V&&(M.sidebar.classList.remove(M.collapsedClass),M.toggle.classList.add("active"),M.toggle.setAttribute("aria-pressed","true")),V!==B},F=(I,w)=>{if(q(I,w)){if(w&&k[I]?.group==="left"){K.forEach(B=>{B!==I&&q(B,!1)});const V=le();if(V){const B=k[I].type||Ea[I];setTimeout(()=>{de(V,{forceType:B})},50)}}G(),E(),R()}};ge={setState:F,updateTogglePositions:G},Object.entries(k).forEach(([I,w])=>{w.toggle&&w.toggle.addEventListener("click",()=>F(I,!0)),w.collapse&&w.collapse.addEventListener("click",()=>F(I,!1)),F(I,Dn)}),G(),window.addEventListener("resize",G)}document.addEventListener("DOMContentLoaded",()=>{(async()=>{await cs(),Ws(),await Ts(),ha(),O("tech")&&Gs(),Ys(),Js(),Qs(),await en(),jn(),Un(),un(),gn(),yn(),En(),gt(),[{id:"tech-filter",type:"tech"},{id:"reseller-filter",type:"reseller"},{id:"repair-filter",type:"repair"},{id:"dynamic-service-filter",type:"custom"}].filter(({type:a})=>O(a)).forEach(({id:a,type:s})=>{const r=document.getElementById(a);r&&r.addEventListener("input",()=>{lt[s]=r.value,we();const n=le();n&&de(n,{forceType:Fe()?Ye():null})})}),dn();let t;document.getElementById("vehicle-search").addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>te(),250)}),document.getElementById("clear-selection")?.addEventListener("click",()=>St()),document.getElementById("vehicle-modal-close")?.addEventListener("click",oa),document.getElementById("vehicle-modal-columns-toggle")?.addEventListener("click",()=>{const a=document.getElementById("vehicle-modal-columns-panel");a&&a.classList.toggle("hidden")}),document.getElementById("vehicle-modal")?.addEventListener("click",a=>{a.target.id==="vehicle-modal"&&oa()}),setInterval(async()=>{if(_)try{await _.auth.getSession()}catch{}},5*60*1e3),window.addEventListener("auth:role-ready",()=>te())})()});document.addEventListener("DOMContentLoaded",()=>{ns()});
