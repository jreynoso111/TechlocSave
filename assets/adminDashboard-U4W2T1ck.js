import{s as v}from"./constellation-uI2meXO3.js";import"./admin-auth-DJpBhotk.js";import{r as te}from"./Header-CYr_2qJu.js";import{l as ne,s as re,p as ae}from"./backgroundPreference-DPAtw2vm.js";function se(e){const t=document.getElementById(e);if(!t)return;const a=window.location.pathname.split("/").pop()||"index.html",r=[{name:"Dashboard",href:"index.html",id:"admin-nav-index"},{name:"Profiles",href:"profiles.html",id:"admin-nav-profiles",adminOnly:!0},{name:"Titles",href:"titles.html",id:"admin-nav-titles"},{name:"Vehicles",href:"vehicles.html",id:"admin-nav-vehicles"},{name:"Analytics",href:"analytics.html",id:"admin-nav-analytics"}].map(i=>{const l=a===i.href,m=i.adminOnly?"data-admin-only":"",E=l?"rounded-lg border border-blue-500 bg-blue-600/90 text-white shadow shadow-blue-500/30":"rounded-lg border border-slate-800/60 text-slate-300 hover:bg-slate-800 hover:text-white";return`
      <a href="${i.href}" ${m} id="${i.id}"
        class="px-4 py-2 text-xs font-semibold transition ${E}">
        ${i.name}
      </a>
    `}).join("");t.innerHTML=`
    <nav class="border-b border-slate-800 bg-slate-900/70 backdrop-blur">
      <div class="ml-0 mr-auto flex max-w-[1400px] flex-wrap items-center justify-between gap-2 px-6 py-3 lg:px-10">
        <span class="text-[11px] font-semibold uppercase tracking-[0.18em] text-blue-200">Admin navigation</span>
        <div class="flex flex-wrap items-center gap-1">
          ${r}
        </div>
      </div>
    </nav>
  `,window.dispatchEvent(new CustomEvent("adminHeader:rendered"))}te("header-root");se("admin-header-root");function H(e){return(e||"").toString().replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim().replace(/\s+/g," ").toLowerCase().replace(/\.$/,"")}const F="DealsJP1",G="NS-Invoices&pays",oe=["Date","Due Date/Receive By","Type","Document Number","Amount","Amount Remaining","Stock No","Payment Through","Invoice Type","Status","Name","Subsidiary","TAM Legacy Stock #","Payment Method"],K=["Serial","Year","Make","Model","Color","Customer","Vehicle Status","VIN","Date","address","Lat","Long"],j=200,ie=50,Z=(()=>{const e=new Map;return K.forEach(t=>{e.set(H(t),t)}),e.set("serial #","Serial"),e.set("serial#","Serial"),e})(),le=["Deal Status","Deal Date","HOLD","Current Stock No","Customer","Brand","Model","Model Year","VIN","Corrected VIN","Vehicle Status","Mileage","Driver License #","Inventory Preparation Status","Inventory Preparation Status Changed On","Inventory Preparation Status Changed By","Physical Location","Physical Location Last Changed on","ENTITY","Retail Price On Contract","Cash Down","Total due on Deal","Amount","Reg. Contract Payment","Payment Schedule","Total Payments in Months","Number OF Schedule Remaining","Lead Source","Date of Birth","TAM Legacy Created Date","Payment Schedule Start","Last Payment Date","TAM Legacy Stock #","Trade In VIN","Trade In Amount","Sales Person","Subsidiary","Location","Lease End Date","Bucket","Bucket Sub Type","Payment Schedule_1","Lease Term","Regular Amount","Total Contract Scheduled Amount","Inventory Valuation Value","Sales Channel","Partner Name","Remaining Scheduled Payments To Invoice","Deposit","PassTime Serial No","PassTime Vehicle Status","EFT Available","Primary Payment Mode","Secondary Payment Mode","Plate Number","Number OF Schedule Remaining_1","Mobile Phone","Encore Serial Number","Encore Serial #2","GPS Serial No","Plate Number_1","Current Title Number","Current Title Subsidiary","Current Title Physical Location","Title In Date","Title Out Date","Financing Company","Broker","Return Type","Actual System Return Date","Returned By"],Y=[{table:"Services",scope:"Partners",title:"Service Providers",description:"Unified services directory filtered by category values.",displayName:"Services"},{table:"vehicles",scope:"Fleet",title:"Vehicles",description:"Live vehicle and asset records.",displayName:"Vehicles"},{table:F,scope:"Sales",title:"Active Deals",description:"Imported deals data (VIN + Stock No).",displayName:"Deals"},{table:"Titles",scope:"Compliance",title:"Titles table",description:"Lifecycle tracking for vehicle titles.",displayName:"Titles"},{table:G,scope:"Finance",title:"NS Invoices & Payments",description:"NetSuite feed mapped by Document Number.",displayName:"NS Invoices"},{table:"PT-LastPing",scope:"Telematics",title:"Import Last Ping",description:"Latest PassTime ping uploads (Serial required).",displayName:"PT Last Ping"}],ce="administrator",U=()=>(window.currentUserRole||"").toLowerCase()===ce,O=e=>{if(e==null)return null;const t=typeof e=="string"?e.replace(/,/g,"").trim():e,n=Number(t);return Number.isFinite(n)?n:null},q=e=>{if(e==null)return null;const t=String(e).trim().toUpperCase();return t===""?null:t},J=(e={})=>Object.entries(e).reduce((t,[n,a])=>{const s=H(n);return s&&(t[s]=typeof a=="string"?a.trim():a),t},{}),R=e=>{if(e==null)return null;if(typeof e=="string"){const t=e.trim();return t===""?null:t}return e},de=e=>{if(!e)return"Unknown error";const t=[e.message,e.code,e.details,e.hint].filter(Boolean).join(" | "),n=(()=>{try{return JSON.stringify(e,null,2)}catch{return""}})();return[t,n].filter(Boolean).join(`

`)},V=(e,t="")=>{const n=document.getElementById("pt-error-box"),a=document.getElementById("pt-error-pre");if(!n||!a)return;const s=new Date().toLocaleString(),r=t?`Context: ${t}
`:"",i=de(e);a.textContent=`${r}Timestamp: ${s}

${i}`,n.classList.remove("hidden")},ue=(e={})=>{const t=s=>R(s),n=s=>{const r=O(s);return r!==null?r:t(s)},a={Serial:t(e?.Serial),Year:n(e?.Year),Make:t(e?.Make),Model:t(e?.Model),Color:t(e?.Color),Customer:t(e?.Customer),"Vehicle Status":t(e?.["Vehicle Status"]),VIN:t(e?.VIN),Date:t(e?.Date),address:t(e?.address),Lat:n(e?.Lat),Long:n(e?.Long)};return Object.entries(a).reduce((s,[r,i])=>(i==null||typeof i=="string"&&i===""||(s[r]=i),s),{})},Q=(e=[])=>{const t=new Set;return e.forEach(n=>{const a=Z.get(H(n))||n;t.add(a)}),t},me=(e={})=>{const t={};return Object.entries(e||{}).forEach(([n,a])=>{const s=Z.get(H(n))||n;t[s]=a}),t},ee=(e=[])=>{const t=new Map;return e.forEach(n=>{const a=H(n);t.set(a,n)}),t},pe=(e={},t)=>{const n={};return t.forEach((a,s)=>{if(!a)return;let r=e[s];if(r===void 0)return;if(s==="amount"||s==="amount remaining"){const l=O(r);r=l!==null?l:r}const i=R(r);i!==null&&(n[a]=i)}),n},z=e=>{const t=(e?.message||"").toLowerCase();return t.includes("row-level")||t.includes("rls")||t.includes("permission")},fe=async e=>{if(!v)return{rows:0,columns:0,lastUpdated:null,restricted:!0,message:"Client unavailable"};try{const{count:t,error:n}=await v.from(e.table).select("*",{count:"exact",head:!0});if(n)return{rows:0,columns:0,lastUpdated:null,restricted:!0,message:n.message||"Restricted"};const{data:a,error:s}=await v.from(e.table).select("*").limit(1);if(s)return{rows:t||0,columns:0,lastUpdated:null,restricted:!0,message:s.message||"Restricted"};let r=0,i=null;return a&&a.length>0&&(r=Object.keys(a[0]).length,i=a[0].created_at||a[0].updated_at||null),{rows:t||0,columns:r,lastUpdated:i,restricted:!1}}catch(t){return{rows:0,columns:0,lastUpdated:null,restricted:!0,message:t.message}}},ge=e=>{const t=document.getElementById("activity-log");if(t){if(t.innerHTML="",e.length===0){t.innerHTML='<li class="text-slate-500 italic text-xs">No recent activity detected.</li>';return}e.slice(0,4).forEach(n=>{const a=document.createElement("li");a.className="flex items-center justify-between gap-3 rounded-lg border border-slate-800 bg-slate-950/60 px-3 py-2",a.innerHTML=`
          <div class="flex items-center gap-2">
             <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
             <span class="font-semibold text-white text-xs">${n.table} verified</span>
          </div>
          <span class="text-[10px] uppercase tracking-wide text-slate-400">${n.rows} rows</span>
        `,t.appendChild(a)})}},he=e=>{const n=document.getElementById("dataset-card-template").content.firstElementChild.cloneNode(!0),a={scope:n.querySelector("[data-dataset-scope]"),title:n.querySelector("[data-dataset-title]"),description:n.querySelector("[data-dataset-description]"),status:n.querySelector("[data-dataset-status]"),rows:n.querySelector("[data-dataset-rows]"),columns:n.querySelector("[data-dataset-columns]"),signal:n.querySelector("[data-dataset-signal]")};return a.scope.textContent=e.scope,a.title.textContent=e.title,a.description.textContent=e.description,{card:n,els:a}},W=(e,t)=>{e.rows.textContent=t.rows?t.rows.toLocaleString():"--",e.columns.textContent=t.columns||"--",t.restricted?(e.status.textContent="Restricted",e.status.className="rounded-full border border-amber-600 bg-amber-600/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-amber-200",e.signal.textContent=t.message?`Access limited: ${t.message}`:"Access limited by security policy."):t.rows>0?(e.status.textContent="Active",e.status.className="rounded-full border border-emerald-600 bg-emerald-600/10 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-200",e.signal.textContent=`Connected to live table. ${t.columns} fields mapped.`):(e.status.textContent="Empty",e.signal.textContent="Table exists but contains no records.")},be=()=>{let e=document.getElementById("toast-container");return e||(e=document.createElement("div"),e.id="toast-container",e.className="fixed bottom-6 right-6 z-50 flex flex-col gap-3",document.body.appendChild(e)),e},f=(e,t="info")=>{const n=be(),a=document.createElement("div"),s=t==="success"?"border-emerald-500/60 bg-emerald-500/10 text-emerald-50 shadow-emerald-500/30":"border-red-500/60 bg-red-500/10 text-red-50 shadow-red-500/30";a.className=`flex min-w-[260px] max-w-sm items-start gap-3 rounded-xl border px-4 py-3 text-sm shadow-xl backdrop-blur ${s}`;const r=document.createElement("span");r.className=`mt-0.5 h-2.5 w-2.5 rounded-full ${t==="success"?"bg-emerald-400":"bg-red-400"}`;const i=document.createElement("p");i.className="whitespace-pre-line font-semibold leading-relaxed",i.textContent=e,a.appendChild(r),a.appendChild(i),n.appendChild(a),setTimeout(()=>{a.classList.add("opacity-0","translate-y-2","transition","duration-300"),setTimeout(()=>a.remove(),320)},4200)},ye=async(e,t=0)=>{if(!v)throw new Error("Supabase client unavailable.");if(!U())throw new Error("Only administrators can upload deals data.");const n=document.getElementById("deals-upload-button"),a=document.getElementById("deals-progress"),s=document.getElementById("deals-progress-bar"),r=document.getElementById("deals-progress-label"),i=document.getElementById("deals-progress-count"),l=(g,o)=>{a&&a.classList.remove("hidden"),s&&(s.style.width=`${Math.max(0,Math.min(100,g))}%`),r&&(r.textContent=o),i&&(i.textContent=`${Math.round(Math.max(0,Math.min(100,g)))}%`)},m=ee(le),E=m.get("current stock no"),S=m.get("deal status"),p=m.get("vehicle status"),x=g=>{if(typeof g!="string")return"";const o=g.trim().toUpperCase();return o==="FINANCE-EX"||o==="FINANCE EXT"||o==="FINANCE-EXT"?"FINANCE-EXT":""};if(!E||!S||!p){f("Local configuration error: missing required Deal columns.","error");return}l(0,"Preparing & deduplicating rows...");const C=new Map;let k=0,T=0,D=0;e.forEach(g=>{const o=J(g),c=o["sales channel"],d=x(c);if(d!=="FINANCE-EXT"){k+=1;return}d&&(o["sales channel"]=d);const u=q(o["current stock no"]),b=R(o.vin);if(!u||!b){T+=1;return}const h={};Object.entries(o).forEach(([w,A])=>{const B=m.get(w),_=R(A);!B||_==null||(h[B]=_)}),h[E]=u,h[S]=R(o["deal status"])??null,h[p]=R(o["vehicle status"])??null;const N=`${b}_${u}`;C.has(N)&&D++,C.set(N,h)});const y=Array.from(C.values());if(!y.length){l(0,"No finance rows detected."),f(`No valid FINANCE rows detected.
Check "Current Stock No." and "Sales Channel".`,"error");return}const I=500;let M=0;const P=Math.ceil(y.length/I);let L=0;for(let g=0;g<y.length;g+=I){const o=y.slice(g,g+I),c=Math.floor(g/I)+1;n&&(n.innerHTML=`<span class="animate-pulse">Uploading batch ${c}/${P}...</span>`),l(L/y.length*100,`Uploading batch ${c} of ${P}...`);const{data:d,error:u}=await v.from(F).upsert(o,{onConflict:"Current Stock No",ignoreDuplicates:!1}).select();if(u){if(console.error("Supabase upsert error:",u),z(u)){f("Upload blocked by security policy (RLS).","error");return}throw u}M+=d?d.length:0,L+=o.length,l(L/y.length*100,`Uploaded ${Math.min(L,y.length)} of ${y.length} rows...`),await new Promise(b=>setTimeout(b,0))}const $=`Completed.
Total rows processed: `+e.length+`
Processed (Unique Finance): `+y.length+`
Upserted: `+M+`
Skipped (Invalid Sales Channel): `+k+`
Skipped (Missing Stock No or VIN): `+T+`
Duplicates Removed: `+D+`
Errors: `+t;f($,"success"),l(100,"Upload complete.")},Se=async()=>{const e=new Set,t=1e3;let n=0;for(;;){const a=n+t-1,{data:s,error:r}=await v.from(F).select('"Current Stock No"',{head:!1}).range(n,a);if(r)throw r;if((s||[]).forEach(i=>{const l=q(i?.["Current Stock No"]);l&&e.add(l)}),!s||s.length<t)break;n+=t}return e},we=async(e,t=0)=>{if(!v)throw new Error("Supabase client unavailable.");if(!U())throw new Error("Only administrators can upload invoice data.");const n=document.getElementById("ns-invoices-upload-button"),a=document.getElementById("ns-invoices-progress"),s=document.getElementById("ns-invoices-progress-bar"),r=document.getElementById("ns-invoices-progress-label"),i=document.getElementById("ns-invoices-progress-count"),l=(g,o)=>{a&&a.classList.remove("hidden"),s&&(s.style.width=`${Math.max(0,Math.min(100,g))}%`),r&&(r.textContent=o),i&&(i.textContent=`${Math.round(Math.max(0,Math.min(100,g)))}%`)},m=ee(oe),E=m.get("document number"),S="Stock No,Document Number,Date";if(!E){f('Local configuration error: "Document Number" missing from invoice columns.',"error");return}l(0,"Loading Deals stock numbers...");let p;try{p=await Se()}catch(g){console.error("Supabase fetch error (Deals stock numbers):",g),f("Unable to load Deals stock numbers for validation.","error"),l(0,"Failed to load Deals stock numbers.");return}if(!p.size){f("No Deals stock numbers found. Upload stopped.","error"),l(0,"No Deals stock numbers found.");return}l(5,"Clearing previous invoice data...");const{error:x}=await v.rpc("truncate_ns_invoices");if(x){console.error("Supabase truncate error:",x),f("Cannot clear previous NS invoices: "+x.message,"error");return}l(5,"Preparing invoice rows...");const C=new Map;let k=0,T=0,D=0;e.forEach(g=>{const o=J(g),c=o["document number"],d=o["stock no"]||o["stock number"]||o["tam legacy stock #"],u=q(d);if(!c){k++;return}if(!u||!p.has(u)){D++;return}const b=pe(o,m);b[E]||(b[E]=c),m.has("stock no")&&u&&(b[m.get("stock no")]=u);const h=`${c}_${u}`;C.has(h)&&T++,C.set(h,b)});const y=Array.from(C.values());if(!y.length){l(0,"No valid invoice rows found."),f("No valid rows detected. Each row must include a Document Number value.","error");return}const I=1e3;let M=0;const P=Math.ceil(y.length/I);let L=0;for(let g=0;g<y.length;g+=I){const o=y.slice(g,g+I),c=Math.floor(g/I)+1;n&&(n.innerHTML=`<span class="animate-pulse">Uploading batch ${c}/${P}...</span>`),l(L/y.length*100,`Uploading batch ${c} of ${P}...`);const{data:d,error:u}=await v.from(G).upsert(o,{onConflict:S,ignoreDuplicates:!0}).select();if(u){if(console.error("Supabase upsert error:",u),z(u)){f("Upload blocked by security policy (RLS).","error");return}throw u}M+=d?d.length:0,L+=o.length,l(L/y.length*100,`Uploaded ${Math.min(L,y.length)} of ${y.length} rows...`)}const $=`Completed.
Processed (Unique): `+y.length+`
Upserted: `+M+`
Skipped (Missing Document Number): `+k+`
Rejected (Stock No not in DealsJP1): `+D+`
Duplicates Removed: `+T+`
Errors: `+t;f($,"success"),l(100,"Upload complete.")},Ne=()=>{const e=document.getElementById("deals-upload-form"),t=document.getElementById("deals-file"),n=document.getElementById("deals-upload-button"),a=()=>{const r=U();t&&(t.disabled=!r),n&&(n.disabled=!r);const i=r?"":"Administrator access required";return t&&(t.title=i),n&&(n.title=i),r};if(!e||!t||!n)return;const s=()=>a();s(),window.addEventListener("auth:role-updated",s),n.addEventListener("click",r=>{if(r.preventDefault(),!a()){f("Only administrators can upload deals data.","error");return}const i=t.files?.[0];if(!i){f("Please select a CSV file to upload.","error");return}n.disabled=!0,n.innerHTML='<span class="animate-pulse">Reading file…</span>',window.Papa.parse(i,{header:!0,skipEmptyLines:!0,transformHeader:l=>l.trim(),worker:!1,complete:async l=>{try{const m=l.errors?.length||0;n.innerHTML='<span class="animate-pulse">Processing…</span>',await ye(l.data||[],m)}catch(m){console.error("Upload failed:",m),f("Upload failed: "+m.message,"error")}finally{n.disabled=!1,n.innerHTML='<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload</span>',lucide.createIcons()}},error:l=>{f("CSV parse error: "+l.message,"error"),n.disabled=!1,n.innerHTML='<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload</span>',lucide.createIcons()}})})},ve=()=>{const e=document.getElementById("ns-invoices-upload-form"),t=document.getElementById("ns-invoices-file"),n=document.getElementById("ns-invoices-upload-button"),a=()=>{const r=U();t&&(t.disabled=!r),n&&(n.disabled=!r);const i=r?"":"Administrator access required";return t&&(t.title=i),n&&(n.title=i),r};if(!e||!t||!n)return;const s=()=>a();s(),window.addEventListener("auth:role-updated",s),n.addEventListener("click",r=>{if(r.preventDefault(),!a()){f("Only administrators can upload invoice data.","error");return}const i=t.files?.[0];if(!i){f("Please select a CSV file to upload.","error");return}n.disabled=!0,n.innerHTML='<span class="animate-pulse">Reading file…</span>',window.Papa.parse(i,{header:!0,skipEmptyLines:!0,transformHeader:l=>l.trim(),worker:!1,complete:async l=>{try{const m=l.errors?.length||0;n.innerHTML='<span class="animate-pulse">Processing…</span>',await we(l.data||[],m)}catch(m){console.error("Upload failed:",m),f("Upload failed: "+m.message,"error")}finally{n.disabled=!1,n.innerHTML='<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload</span>',lucide.createIcons()}},error:l=>{f("CSV parse error: "+l.message,"error"),n.disabled=!1,n.innerHTML='<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload</span>',lucide.createIcons()}})})},Ee=()=>{const e=document.getElementById("pt-ping-upload-form"),t=document.getElementById("pt-ping-file"),n=document.getElementById("pt-ping-upload-button"),a=document.getElementById("pt-ping-status"),s=l=>{a&&(a.textContent=l)},r=()=>{const l=U();t&&(t.disabled=!l),n&&(n.disabled=!l);const m=l?"":"Administrator access required";return t&&(t.title=m),n&&(n.title=m),l};if(!e||!t||!n)return;const i=()=>r();i(),window.addEventListener("auth:role-updated",i),n.addEventListener("click",async l=>{if(l.preventDefault(),!r()){f("Only administrators can upload PT ping data.","error");return}if(!await ke())return;const E=t.files?.[0];if(!E){f("Please select a CSV or XLSX file to upload.","error");return}n.disabled=!0,n.innerHTML='<span class="animate-pulse">Preparing rows…</span>',s("Parsing file...");try{const{rows:S,headers:p,errors:x}=await Ie(E),C=Q(p);console.log("RAW HEADERS:",p),console.log("NORMALIZED HEADERS:",Array.from(C));const{valid:k,missing:T}=Pe(C);if(!k){s("Missing headers: "+T.join(", ")),f("Missing required headers: "+T.join(", "),"error");return}n.innerHTML='<span class="animate-pulse">Processing…</span>',await Me(S||[],x?.length||0)}catch(S){console.error("PT Last Ping upload failed:",S),f("Upload failed: "+S.message,"error"),s("Upload failed: "+S.message),V(S,"PT Last Ping upload failed")}finally{n.disabled=!1,n.innerHTML='<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload</span>',lucide.createIcons()}})},Ce=async()=>{const e=document.getElementById("datasets"),t=Y.map(r=>{const{card:i,els:l}=he(r);return e.appendChild(i),{dataset:r,els:l}}),n=await Promise.all(t.map(async({dataset:r,els:i})=>{try{const l=await fe(r);return W(i,l),{stats:l,dataset:r}}catch(l){const m={rows:0,columns:0,lastUpdated:null,restricted:!0,message:l.message};return W(i,m),{stats:m,dataset:r}}})),a=n.reduce((r,{stats:i})=>r+(i.rows||0),0),s=n.filter(({stats:r})=>(r.rows||0)>0&&!r.restricted).map(({stats:r,dataset:i})=>({...r,table:i.displayName}));document.getElementById("dataset-count").textContent=Y.length,document.getElementById("records-count").textContent=a.toLocaleString(),ge(s),lucide.createIcons()},De=()=>window.XLSX?Promise.resolve():new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load XLSX parser.")),document.head.appendChild(n)}),Ie=async e=>{const n=(e?.name||"").toLowerCase();if(n.endsWith(".csv"))return new Promise((a,s)=>{window.Papa.parse(e,{header:!0,skipEmptyLines:!0,transformHeader:r=>(r||"").toString().replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim(),worker:!1,complete:r=>{const i=r.meta?.fields||[];a({rows:r.data||[],headers:i,errors:r.errors||[]})},error:r=>s(r)})});if(n.endsWith(".xlsx")){await De();const a=await e.arrayBuffer(),s=window.XLSX.read(a,{type:"array"}),r=s.SheetNames[0],i=s.Sheets[r],l=window.XLSX.utils.sheet_to_json(i,{header:1,blankrows:!1}),m=(l[0]||[]).map(S=>(S==null?"":String(S)).replace(/^\uFEFF/,"").replace(/\u00A0/g," ").trim());return{rows:l.slice(1).map(S=>{const p={};return m.forEach((x,C)=>{p[x]=S[C]}),p}),headers:m,errors:[]}}throw new Error("Unsupported file type. Please upload CSV or XLSX.")},Pe=(e=[])=>{const t=e instanceof Set?e:Q(e),n=[];return t.has("Serial")||n.push("Serial"),t.has("Date")||n.push("Date"),{valid:n.length===0,missing:n}},xe=e=>{const t=Number(e);if(!Number.isFinite(t))return null;const n=new Date((t-25569)*86400*1e3),a=n.getTime();return Number.isNaN(a)?null:n.toISOString()},Le=e=>{if(e instanceof Date)return Number.isNaN(e.getTime())?null:e.toISOString();if(typeof e=="number"||typeof e=="string"&&e.trim()!==""&&Number.isFinite(Number(e)))return xe(e);if(typeof e=="string"){const t=new Date(e.trim());return Number.isNaN(t.getTime())?null:t.toISOString()}return null},Te=(e={})=>{const t=me(e),n={};return K.forEach(a=>{let s=t[a];if(typeof s=="string"&&(s=s.trim()),a==="Lat"||a==="Long"||a==="Year"){const r=O(s);s=r!==null?r:s}if(a==="Date"){const r=Le(s),i=s!=null&&`${s}`.trim()!=="";r?n.Date=r:i&&(n.__invalidDate=!0);return}s===""&&(s=null),s!=null&&(n[a]=s)}),n},ke=async()=>{try{const{data:e,error:t}=await v.auth.getSession();if(t)throw t;return e?.session?!0:(f("You must be signed in to upload PT Last Ping data.","error"),!1)}catch(e){return console.error("Session check failed:",e),f("Unable to verify session. Please sign in again.","error"),V(e,"Session validation failed"),!1}},Me=async(e,t=0)=>{if(!v)throw new Error("Supabase client unavailable.");if(!U())throw new Error("Only administrators can upload PT ping data.");const n=o=>{if(!o&&o!==0)return null;const c=String(o).trim().toUpperCase();return c?c.slice(-6):null},a=async()=>{const o=new Set,c=1e3;let d=0;for(;;){const u=d+c-1,{data:b,error:h}=await v.from(F).select("VIN",{head:!1}).range(d,u);if(h)throw h;if((b||[]).forEach(N=>{const w=n(N?.VIN);w&&o.add(w)}),!b||b.length<c)break;d+=c}return o},s=document.getElementById("pt-ping-upload-button"),r=document.getElementById("pt-ping-status"),i=document.getElementById("pt-error-box"),l=document.getElementById("pt-error-pre"),m=[],E=(e||[]).map(Te),S=new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",hour12:!1}),p={inserted:0,batches:0,rejectedMissingRequired:0,rejectedInvalidDate:0,skippedDeduplication:0,skippedSupabaseDuplicates:0,rejectedNoMatchVin:0},x=async(o=[])=>{if(o.length)try{const{error:c}=await v.rpc("recalc_pt_lastping_moved_2d_for_serials",{serials:o});if(c){if(c.code==="42883"){console.warn("RPC recalc_pt_lastping_moved_2d_for_serials unavailable; continuing upload.",c);return}console.warn("RPC recalc_pt_lastping_moved_2d_for_serials failed; continuing upload.",c)}}catch(c){console.warn("RPC recalc_pt_lastping_moved_2d_for_serials threw; continuing upload.",c)}},C=o=>{const c=new Date(o);if(Number.isNaN(c.getTime()))return{readDay:null,dayHalf:null};const d=S.formatToParts(c).reduce((B,_)=>(_.type!=="literal"&&(B[_.type]=_.value),B),{}),{year:u,month:b,day:h}=d,N=Number(d.hour);if(!u||!b||!h||Number.isNaN(N))return{readDay:null,dayHalf:null};const w=`${u}-${b}-${h}`,A=N<12?0:1;return{readDay:w,dayHalf:A}},k=(o,c)=>{if(!o||!c)return null;const{readDay:d,dayHalf:u}=C(c);return!d||u===null?null:`${o}__${d}__${u}`},T=o=>{const c=new Map;return o.forEach(({row:d,readDay:u,dayHalf:b},h)=>{const N=d?.Serial,w=d?.Date,A=k(N,w)||`${N}__${u}__${b}`,B=new Date(w).getTime(),_=c.get(A);if(_){p.skippedDeduplication+=1;const X=new Date(_.row?.Date).getTime();!Number.isNaN(B)&&(Number.isNaN(X)||B>=X)&&c.set(A,{row:d,index:h});return}c.set(A,{row:d,index:h})}),Array.from(c.values()).sort((d,u)=>d.index-u.index).map(d=>d.row)},D=o=>{r&&(r.textContent=o)};(()=>{i&&i.classList.add("hidden"),l&&(l.textContent="")})(),D(`Validating ${E.length} rows (Serial and Date required)...`);let I;try{D("Loading reference VINs..."),I=await a()}catch(o){console.error("Failed to load Deals VINs",o),f("Unable to load Deals VINs for validation.","error"),D("VIN validation unavailable."),V(o,"Deals VIN fetch failed");return}const M=[];if(E.forEach(o=>{const c=o?.Serial,d=o?.Date;if(o?.__invalidDate){p.rejectedInvalidDate+=1;const{__invalidDate:N,...w}=o;m.push({...w,error:"Invalid Date"});return}if(!c||`${c}`.trim()===""||!d||`${d}`.trim()===""){p.rejectedMissingRequired+=1;const{__invalidDate:N,...w}=o;m.push({...w,error:"Missing Serial or Date"});return}const{readDay:u,dayHalf:b}=C(d);if(!u||b===null){p.rejectedInvalidDate+=1;const{__invalidDate:N,...w}=o;m.push({...w,error:"Invalid Date bucket"});return}const h=n(o?.VIN);if(!h||!I.has(h)){p.rejectedNoMatchVin+=1;const{__invalidDate:N,...w}=o;m.push({...w,error:"VIN not in Deals (last 6 mismatch)"});return}delete o.__invalidDate,M.push({row:o,readDay:u,dayHalf:b})}),!M.length){D("No rows contained both Serial and Date values."),f("No rows contained both Serial and Date values.","error");return}const P=T(M),L=Math.ceil(P.length/j),$=Array.from(new Set(P.map(o=>o?.Serial).filter(Boolean)));for(let o=0;o<P.length;o+=j){const c=Math.floor(o/j)+1,d=o+j,u=P.slice(o,d).map(ue);D(`Uploading batch ${c} of ${L} (${Math.min(d,P.length)} of ${P.length})...`);const{data:b,error:h}=await v.from("PT-LastPing").upsert(u,{onConflict:'"Serial",read_day,day_half',ignoreDuplicates:!0}).select();if(h){if(console.error("Supabase insert error:",{error:h,batchNumber:c}),z(h)){f("Upload blocked by security policy (RLS).","error"),D("Upload blocked by security policy (RLS)."),V(h,`Batch ${c} blocked`);return}throw f("Upload failed","error"),D("Upload failed: "+(h?.message||"Unknown error")),V(h,`Batch ${c} failed`),h}const N=Array.isArray(b)?b.length:0;p.batches+=1,p.inserted+=N,p.skippedSupabaseDuplicates+=Math.max(0,u.length-N),await new Promise(w=>setTimeout(w,ie))}await x($);const g=`Completed.
Batches: `+p.batches+`
Inserted: `+p.inserted+`
Rejected (missing Serial/Date): `+p.rejectedMissingRequired+`
Rejected (invalid Date): `+p.rejectedInvalidDate+`
Skipped duplicates (client half-day bucket): `+p.skippedDeduplication+`
Skipped duplicates (Supabase conflicts): `+p.skippedSupabaseDuplicates+`
Rejected (VIN not in Deals): `+p.rejectedNoMatchVin+`
Errors: `+t;D(`Upload complete. Inserted: ${p.inserted} Skipped (client dedup): ${p.skippedDeduplication} Skipped (Supabase): ${p.skippedSupabaseDuplicates} Rejected: ${p.rejectedMissingRequired+p.rejectedInvalidDate+p.rejectedNoMatchVin}`),f(g,"success"),s&&(s.innerHTML='<i data-lucide="upload-cloud" class="h-4 w-4"></i><span>Upload</span>'),lucide.createIcons()},_e=async()=>{const e=await ne();re({canvasId:"constellation-canvas",controlButton:document.querySelector("[data-bg-control]"),controlMenu:document.querySelector("[data-bg-menu]"),statusLabel:document.querySelector("[data-bg-status]"),initialMode:e,onModeChange:ae})};_e().catch(e=>console.error("Unable to initialize background manager",e));Ce();Ne();ve();Ee();const Be=async()=>{if(!v?.auth?.getSession)return;const{data:e}=await v.auth.getSession();e?.session||(window.location.href="../login.html")};Be();
