import{s as P,S as A,a as L}from"./constellation-uI2meXO3.js";const q="/pages/login.html",B="/index.html",d=P||window.supabaseClient||(window.supabase?.createClient&&A&&L?window.supabase.createClient(A,L,{auth:{persistSession:!0,autoRefreshToken:!0}}):null);if(!d){console.error("Supabase client not initialized. Verify the Supabase library and credentials.");const e=typeof document<"u"?document.querySelector("[data-auth-loading]"):null;throw e&&(e.classList.remove("hidden"),e.innerHTML='<div class="rounded-2xl border border-red-700/60 bg-red-900/40 px-4 py-3 text-sm text-red-50 shadow-lg shadow-red-900/50"><p class="font-semibold">Unable to reach Supabase.</p><p class="text-red-100">Check your connection and credentials, then refresh.</p></div>'),new Error("Supabase client unavailable")}window.supabaseClient=d;let u=null,b=!1,f=null,l=null,c=null;const g=new Set,S=(e,t)=>window.dispatchEvent(new CustomEvent("auth:role-updated",{detail:{role:e??null,status:t??null}})),w=()=>{window.location.href=q},O=()=>{window.location.href=B},I=e=>{g.forEach(t=>t(e))},x=e=>["administrator","moderator"].includes(String(e||"").toLowerCase()),y=e=>{u=e,I(e)},E=async e=>{if(window.currentUserRole&&window.currentUserStatus)return{role:window.currentUserRole,status:window.currentUserStatus};if(l&&c)return window.currentUserRole=l,window.currentUserStatus=c,S(l,c),{role:l,status:c};const t=e?.user?.id;if(!t)return window.currentUserRole="user",window.currentUserStatus="active",S("user","active"),{role:"user",status:"active"};const{data:n,error:s}=await d.from("profiles").select("role, status").eq("id",t).single();if(s)return console.warn("Unable to fetch user role",s),{role:"user",status:"active"};const a=(n?.role||"user").toLowerCase(),r=(n?.status||"active").toLowerCase();return l=a,c=r,window.currentUserRole=a,window.currentUserStatus=r,S(a,r),{role:a,status:r}},U=e=>{document.querySelectorAll("[data-admin-only]").forEach(n=>{e==="administrator"?(n.classList.remove("hidden"),n.removeAttribute("aria-hidden")):(n.classList.add("hidden"),n.setAttribute("aria-hidden","true"))})},v=e=>!!e,i=(()=>{const e=window.location.pathname.toLowerCase();return{isAdminRoute:e.includes("/admin/"),isAdminDashboard:e.endsWith("/admin/index.html")||e.endsWith("/admin/")||e.endsWith("admin/index.html"),isControlView:e.endsWith("/vehicles.html")||e.endsWith("vehicles.html"),isLoginPage:e.endsWith("/login.html")||e.endsWith("login.html"),isProfilesPage:e.includes("/admin/profiles.html")}})(),p=()=>f||(f=(async()=>{try{const{data:e}=await d.auth.getSession();y(e?.session??null)}catch(e){console.error("Session prefetch error",e),y(null)}finally{b=!0}d.auth.onAuthStateChange((e,t)=>{y(t),t||(l=null,c=null,window.currentUserRole=null,window.currentUserStatus=null,S(null,null)),e==="SIGNED_OUT"&&(i.isAdminRoute||i.isControlView)&&!i.isLoginPage&&w()})})(),f),N=()=>new Promise((e,t)=>{let n=!1;const s=()=>{n=!0,g.delete(h)},a=o=>{s(),e(o)},r=async o=>{s(),await d.auth.signOut(),w(),t(new Error(o))},h=o=>{if(v(o)){a(o);return}o===null&&b&&!n&&r("No active Supabase session")};p().then(()=>{if(v(u)){a(u);return}g.add(h),h(u)}).catch(o=>{console.error("Authentication initialization failed",o),r("Initialization failed")})}),V=async()=>await N(),R=()=>document.querySelector("[data-admin-logout]"),C=()=>{const e=R();e&&(e.classList.remove("hidden"),e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async()=>{const{error:t}=await d.auth.signOut();if(t){console.error("Supabase sign out error",t);return}w()})))},z=()=>new Promise(e=>{if(document.readyState!=="loading"){e();return}document.addEventListener("DOMContentLoaded",()=>e(),{once:!0})}),W=()=>new Promise(e=>{if(document.readyState==="complete"){e();return}window.addEventListener("load",()=>e(),{once:!0})}),k=()=>{document.querySelectorAll("[data-auth-protected]").forEach(n=>{n.classList.add("hidden"),n.setAttribute("aria-hidden","true")});const t=document.querySelector("[data-auth-loading]");t&&t.classList.remove("hidden")},D=()=>{const e=document.querySelector("[data-auth-loading]");e&&e.remove(),document.querySelectorAll("[data-auth-protected]").forEach(s=>{s.classList.remove("hidden"),s.removeAttribute("aria-hidden")}),document.querySelectorAll("[data-auth-visible]").forEach(s=>s.classList.remove("hidden"))},G=async(e=null)=>{await z(),await p();const t=document.querySelectorAll("[data-auth-visible]"),n=document.querySelectorAll("[data-auth-guest]");if(!t.length&&!n.length)return;const s=e??u,a=v(s),{role:r,status:h}=a?await E(s):{role:"user",status:"active"};if(h==="suspended"&&(i.isAdminRoute||i.isControlView)){await d.auth.signOut(),w();return}if(U(r),a)t.forEach(o=>o.classList.remove("hidden")),n.forEach(o=>o.classList.add("hidden")),C();else{t.forEach(m=>m.classList.add("hidden")),n.forEach(m=>m.classList.remove("hidden"));const o=R();o&&o.classList.add("hidden")}},T=async()=>{await z(),k();const e=await V(),{role:t,status:n}=await E(e);return C(),U(t),n==="suspended"?(await d.auth.signOut(),w(),e):i.isAdminRoute&&!x(t)?(O(),e):(await W(),i.isAdminDashboard&&(window.adminAuthReady=!0,window.dispatchEvent(new Event("admin:auth-ready"))),D(),e)},_=()=>{const e=t=>G(t).catch(n=>console.error("Navigation auth sync failed",n));g.add(e),p().then(()=>e(u)).catch(t=>console.error("Navigation initialization failed",t))},F=()=>{p(),(i.isAdminRoute||i.isControlView)&&!i.isLoginPage&&T().catch(e=>console.error("Authentication guard failed",e)),_()};F();
