<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc â€¢ Inventory Control</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet" />

  <script src="https://unpkg.com/lucide@latest"></script>
  <script type="module" src="../assets/scripts/authManager.js"></script>

  <style>
    :root {
      --pad-1: 0.5rem;
      --pad-2: 0.75rem;
      --gap-1: 0.5rem;
      --gap-2: 0.75rem;
      --radius: 0.75rem;
      --text-xs: 0.7rem;
      --text-sm: 0.8rem;
      --text-base: 0.9rem;
    }

    html {
      font-size: 14px;
    }

    body[data-density="compact"] .p-4 {
      padding: var(--pad-2) !important;
    }

    body[data-density="compact"] .p-6 {
      padding: calc(var(--pad-2) + 0.25rem) !important;
    }

    body[data-density="compact"] .py-6 {
      padding-top: calc(var(--pad-2) + 0.25rem) !important;
      padding-bottom: calc(var(--pad-2) + 0.25rem) !important;
    }

    body[data-density="compact"] .py-8 {
      padding-top: calc(var(--pad-2) + 0.5rem) !important;
      padding-bottom: calc(var(--pad-2) + 0.5rem) !important;
    }

    body[data-density="compact"] .gap-4 {
      gap: var(--gap-2) !important;
    }

    body[data-density="compact"] .gap-6 {
      gap: calc(var(--gap-2) + 0.5rem) !important;
    }

    body[data-density="compact"] .rounded-3xl {
      border-radius: 1rem !important;
    }

    body[data-density="compact"] .rounded-2xl {
      border-radius: var(--radius) !important;
    }

    body[data-density="compact"] .h-9 {
      height: 2rem !important;
    }

    body[data-density="compact"] .h-16 {
      height: 3rem !important;
    }

    body[data-density="compact"] .text-xl {
      font-size: calc(var(--text-base) + 0.125rem) !important;
      line-height: 1.4 !important;
    }

    body[data-density="compact"] .text-lg {
      font-size: var(--text-base) !important;
      line-height: 1.4 !important;
    }

    body[data-density="compact"] .text-base {
      font-size: var(--text-sm) !important;
    }

    body[data-density="compact"] .text-sm {
      font-size: var(--text-xs) !important;
    }

    .resize-handle {
      cursor: col-resize;
    }

    .resize-handle-row {
      cursor: row-resize;
    }

    .column-resizer {
      touch-action: none;
    }

    body.select-none {
      user-select: none;
    }

    body.resize-col {
      cursor: col-resize;
    }

    body.resize-row {
      cursor: row-resize;
    }

    .scrollbar-hidden {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .scrollbar-hidden::-webkit-scrollbar {
      display: none;
    }

    #inventory-table-scroll-top {
      position: sticky;
      top: 0;
      z-index: 5;
      height: 12px;
      background: rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(30, 41, 59, 0.7);
      border-radius: 12px;
    }

    #inventory-table-scroll-top-inner {
      height: 12px;
    }

    [data-bar-chart] {
      grid-auto-flow: column;
      grid-auto-columns: minmax(var(--chart-col-min, 88px), 1fr);
      grid-template-columns: none;
      overflow-x: auto;
    }
  </style>

  <link rel="stylesheet" href="../assets/visuals/theme.css" />
</head>

<body class="min-h-screen bg-slate-950 font-sans text-slate-50" data-density="compact">
  <div class="pointer-events-none fixed inset-0 z-10 opacity-50 mix-blend-screen">
    <canvas id="constellation-canvas" class="h-full w-full"></canvas>
  </div>
  <div id="inventory-loading" class="fixed inset-0 z-40 flex items-center justify-center bg-slate-950/95">
    <div
      class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900 px-6 py-4 text-slate-200 shadow-xl shadow-slate-900/60">
      <span class="text-xl">ðŸšš</span>
      <div>
        <p class="text-[10px] font-semibold uppercase tracking-[0.2em] text-blue-200">Inventory Control</p>
        <p class="text-sm font-semibold text-white">Loading Inventory</p>
      </div>
    </div>
  </div>

  <div id="header-root" data-title="Inventory Control"></div>
  <script type="module">
    import { renderHeader } from '../assets/components/Header.js';
    renderHeader('header-root');
  </script>
  <script type="module" src="../assets/scripts/authManager.js"></script>

  <main class="relative z-20 mx-auto flex w-full max-w-[96%] flex-1 flex-col gap-3 px-4 py-4">

    <!-- Debug banner (solo aparece si hay error) -->
    <section id="debug-banner" class="hidden rounded-3xl border border-rose-800/60 bg-rose-950/40 p-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-[10px] uppercase tracking-[0.3em] text-rose-200/80">Data / Supabase Debug</p>
          <h3 class="text-lg font-bold text-white">No se pudieron cargar datos</h3>
          <p id="debug-text" class="mt-1 text-sm text-rose-100/80"></p>
        </div>
        <button id="debug-copy" type="button"
          class="rounded-full border border-rose-400/30 bg-rose-900/30 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-rose-100 transition hover:border-rose-300 hover:text-white">
          Copy error
        </button>
      </div>
      <pre id="debug-pre"
        class="mt-4 max-h-64 overflow-auto rounded-2xl border border-rose-400/20 bg-black/30 p-3 text-xs text-rose-100/90"></pre>
    </section>

    <section class="p-3">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-blue-300">Inventory Intelligence</p>
          <h2 class="text-xl font-black text-white md:text-2xl">Fleet Asset Visibility</h2>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div
            class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs font-semibold text-slate-200">
            <span id="connection-dot"
              class="h-2.5 w-2.5 rounded-full bg-amber-400 shadow-[0_0_10px_rgba(251,191,36,0.8)]"></span>
            <span id="connection-status">Bootingâ€¦</span>
          </div>
          <div id="unit-type-filters"
            class="mt-2 flex w-full justify-center md:mt-0 md:w-auto md:flex-1 md:justify-center"></div>
          <div id="vehicle-status-filters"
            class="mt-2 flex w-full justify-center md:mt-0 md:w-auto md:flex-1 md:justify-center"></div>
          <div class="relative">
            <button id="sales-channel-toggle" type="button"
              class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200"
              aria-expanded="false">
              <span id="sales-channel-label">Sales Channel</span>
              <span id="sales-channel-summary"
                class="rounded-full border border-slate-700 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300">0</span>
            </button>
            <div id="sales-channel-panel"
              class="absolute right-0 z-40 mt-2 hidden w-56 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg">
              <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Choose channels</p>
              <div id="sales-channel-options" class="mt-2 grid gap-2"></div>
            </div>
          </div>
          <label
            class="flex items-center gap-2 rounded-2xl border border-emerald-500/40 bg-emerald-500/10 px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-emerald-200">
            <span>Last Deal</span>
            <select id="last-deal-select"
              class="h-6 rounded-full border border-emerald-500/40 bg-emerald-500/10 px-2 py-0.5 text-[10px] font-semibold text-emerald-200">
              <option value="true">TRUE</option>
              <option value="false">FALSE</option>
              <option value="all">ALL</option>
            </select>
          </label>
        </div>
      </div>



      <div id="deal-alerts-layout" class="mt-3 flex flex-col gap-3 lg:flex-row" aria-live="polite">
        <div id="deal-status-panel" class="flex-1">
          <div id="deal-charts-layout" class="flex flex-col gap-3 lg:flex-row lg:items-stretch">
            <div id="status-primary-card"
              class="flex h-full min-h-[220px] flex-col rounded-3xl border border-slate-800 bg-slate-900/60 p-3 shadow-dashboard lg:flex-1"
              data-chart-id="status-primary">
              <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex flex-wrap items-center gap-3">
                  <label
                    class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
                    Segment
                    <select
                      class="h-7 rounded-lg border border-slate-800 bg-slate-950/70 px-2 text-[10px] font-semibold text-slate-200"
                      data-segment-select data-chart-id="status-primary"></select>
                  </label>
                  <div class="relative">
                    <button type="button"
                      class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/70 px-2 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200"
                      data-segment-filter-toggle data-chart-id="status-primary" aria-expanded="false">
                      Fields
                      <span
                        class="rounded-full border border-slate-800 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300"
                        data-segment-filter-count data-chart-id="status-primary">All</span>
                    </button>
                    <div
                      class="absolute left-0 z-40 mt-2 hidden w-60 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg"
                      data-segment-filter-panel data-chart-id="status-primary">
                      <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show fields</p>
                      <div
                        class="mt-2 flex flex-wrap gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-300">
                        <button type="button"
                          class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                          data-segment-select-all data-chart-id="status-primary">Show all</button>
                        <button type="button"
                          class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                          data-segment-clear-all data-chart-id="status-primary">Hide all</button>
                      </div>
                      <div class="mt-2 grid gap-2" data-segment-filter-options data-chart-id="status-primary"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-2 grid flex-1 items-end gap-2" style="--chart-col-min: 88px;" data-bar-chart
                data-chart-id="status-primary" aria-label="Units by deal status chart"></div>
            </div>
            <div id="chart-resizer" class="resize-handle hidden w-2 items-stretch justify-center lg:flex">
              <span class="h-full w-0.5 rounded-full bg-slate-800"></span>
            </div>
            <div id="status-secondary-card"
              class="flex h-full min-h-[220px] flex-col rounded-3xl border border-slate-800 bg-slate-900/60 p-3 shadow-dashboard lg:flex-1"
              data-chart-id="status-secondary">
              <div class="flex flex-wrap items-center justify-end gap-3">
                <label
                  class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
                  Segment
                  <select
                    class="h-7 rounded-lg border border-slate-800 bg-slate-950/70 px-2 text-[10px] font-semibold text-slate-200"
                    data-segment-select data-chart-id="status-secondary"></select>
                </label>
                <div class="relative">
                  <button type="button"
                    class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/70 px-2 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200"
                    data-segment-filter-toggle data-chart-id="status-secondary" aria-expanded="false">
                    Fields
                    <span
                      class="rounded-full border border-slate-800 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300"
                      data-segment-filter-count data-chart-id="status-secondary">All</span>
                  </button>
                  <div
                    class="absolute right-0 z-40 mt-2 hidden w-60 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg"
                    data-segment-filter-panel data-chart-id="status-secondary">
                    <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show fields</p>
                    <div
                      class="mt-2 flex flex-wrap gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-300">
                      <button type="button"
                        class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                        data-segment-select-all data-chart-id="status-secondary">Show all</button>
                      <button type="button"
                        class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                        data-segment-clear-all data-chart-id="status-secondary">Hide all</button>
                    </div>
                    <div class="mt-2 grid gap-2" data-segment-filter-options data-chart-id="status-secondary"></div>
                  </div>
                </div>
              </div>
              <div class="mt-2 grid flex-1 items-end gap-2" style="--chart-col-min: 88px;" data-bar-chart
                data-chart-id="status-secondary" aria-label="Units by deal status chart"></div>
            </div>
          </div>
        </div>

        <div id="panel-resizer" class="resize-handle hidden w-2 items-stretch justify-center lg:flex">
          <span class="h-full w-0.5 rounded-full bg-slate-800"></span>
        </div>

        <div id="alerts-panel"
          class="rounded-3xl border border-slate-800 bg-slate-900/60 p-4 shadow-dashboard lg:w-[300px]"
          data-collapsed="false">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Alerts</p>
              <h3 class="text-lg font-bold text-white">Priority Actions</h3>
            </div>
            <div class="flex items-center gap-2">
              <span
                class="rounded-full border border-amber-500/40 bg-amber-500/10 px-3 py-1 text-[10px] font-semibold uppercase text-amber-200">live</span>
              <button id="alerts-toggle" type="button"
                class="flex h-8 w-8 items-center justify-center rounded-full border border-slate-700 bg-slate-950/60 text-slate-200 transition hover:border-blue-500 hover:text-white"
                aria-expanded="true" aria-controls="alerts-list alerts-badges">
                <i data-lucide="chevron-up" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
          <div id="alerts-badges" class="mt-3 hidden flex flex-wrap gap-2 text-xs text-slate-200">
            <span
              class="inline-flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-2 py-1 text-[11px] font-semibold text-slate-200">
              <i data-lucide="satellite" class="h-3.5 w-3.5 text-amber-300"></i>
              3
            </span>
            <span
              class="inline-flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-2 py-1 text-[11px] font-semibold text-slate-200">
              <i data-lucide="lifebuoy" class="h-3.5 w-3.5 text-rose-300"></i>
              1
            </span>
            <span
              class="inline-flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-2 py-1 text-[11px] font-semibold text-slate-200">
              <i data-lucide="activity" class="h-3.5 w-3.5 text-blue-300"></i>
              2
            </span>
          </div>
          <ul id="alerts-list" class="mt-3 space-y-2 text-xs text-slate-200">
            <li
              class="flex h-9 items-center gap-3 rounded-xl border border-slate-800 bg-transparent px-2 py-1.5 text-slate-200 transition hover:bg-slate-900/40">
              <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-slate-900/70 text-amber-300">
                <i data-lucide="satellite" class="h-4 w-4"></i>
              </span>
              <div class="min-w-0 flex-1">
                <p class="truncate text-[11px] font-semibold text-white">GPS Offline Cluster</p>
                <p class="truncate text-[10px] text-slate-400">Auto-highlights via toggle filter.</p>
              </div>
              <span
                class="rounded-lg border border-amber-500/40 bg-amber-500/10 px-2 py-1 text-[10px] font-semibold uppercase text-amber-200">live</span>
            </li>
            <li
              class="flex h-9 items-center gap-3 rounded-xl border border-slate-800 bg-transparent px-2 py-1.5 text-slate-200 transition hover:bg-slate-900/40">
              <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-slate-900/70 text-rose-300">
                <i data-lucide="lifebuoy" class="h-4 w-4"></i>
              </span>
              <div class="min-w-0 flex-1">
                <p class="truncate text-[11px] font-semibold text-white">Recovery Dispatch</p>
                <p class="truncate text-[10px] text-slate-400">Click a row to open details drawer.</p>
              </div>
              <span
                class="rounded-lg border border-rose-500/40 bg-rose-500/10 px-2 py-1 text-[10px] font-semibold uppercase text-rose-200">queue</span>
            </li>
            <li
              class="flex h-9 items-center gap-3 rounded-xl border border-slate-800 bg-transparent px-2 py-1.5 text-slate-200 transition hover:bg-slate-900/40">
              <span class="flex h-7 w-7 items-center justify-center rounded-lg bg-slate-900/70 text-blue-300">
                <i data-lucide="activity" class="h-4 w-4"></i>
              </span>
              <div class="min-w-0 flex-1">
                <p class="truncate text-[11px] font-semibold text-white">Utilization Dip</p>
                <p class="truncate text-[10px] text-slate-400">Review deal status bars to spot shifts.</p>
              </div>
              <span
                class="rounded-lg border border-blue-500/40 bg-blue-500/10 px-2 py-1 text-[10px] font-semibold uppercase text-blue-200">watch</span>
            </li>
          </ul>
        </div>
      </div>

      <div id="panel-height-resizer"
        class="resize-handle resize-handle-row mt-2 hidden h-2 w-full items-center justify-center lg:flex">
        <span class="h-0.5 w-full rounded-full bg-slate-800"></span>
      </div>
    </section>

    <section class="p-3">
      <div class="grid gap-3 lg:grid-cols-2">
        <div id="status-tertiary-card"
          class="flex min-h-[220px] flex-col rounded-3xl border border-slate-800 bg-slate-900/60 p-3 shadow-dashboard"
          data-chart-id="status-tertiary" data-collapsed="false" data-full-chart-card>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <label class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
              Segment
              <select
                class="h-7 rounded-lg border border-slate-800 bg-slate-950/70 px-2 text-[10px] font-semibold text-slate-200"
                data-segment-select data-chart-id="status-tertiary"></select>
            </label>
            <div class="flex flex-wrap items-center gap-2">
              <div class="relative">
                <button type="button"
                  class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/70 px-2 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200"
                  data-segment-filter-toggle data-chart-id="status-tertiary" aria-expanded="false">
                  Fields
                  <span
                    class="rounded-full border border-slate-800 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300"
                    data-segment-filter-count data-chart-id="status-tertiary">All</span>
                </button>
                <div
                  class="absolute right-0 z-40 mt-2 hidden w-60 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg"
                  data-segment-filter-panel data-chart-id="status-tertiary">
                  <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show fields</p>
                  <div
                    class="mt-2 flex flex-wrap gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-300">
                    <button type="button"
                      class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                      data-segment-select-all data-chart-id="status-tertiary">Show all</button>
                    <button type="button"
                      class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                      data-segment-clear-all data-chart-id="status-tertiary">Hide all</button>
                  </div>
                  <div class="mt-2 grid gap-2" data-segment-filter-options data-chart-id="status-tertiary"></div>
                </div>
              </div>
              <button type="button"
                class="flex h-8 w-8 items-center justify-center rounded-full border border-slate-800 bg-slate-950/60 text-slate-200 transition hover:border-blue-500 hover:text-white"
                data-full-chart-toggle data-full-chart-target="status-tertiary-body" aria-expanded="true"
                aria-controls="status-tertiary-body">
                <i data-lucide="chevron-up" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
          <div id="status-tertiary-body" class="mt-2 grid flex-1 items-end gap-2" style="--chart-col-min: 96px;"
            data-bar-chart data-chart-id="status-tertiary" data-full-chart-body aria-label="Units by deal status chart">
          </div>
        </div>
        <div id="status-tertiary-secondary-card"
          class="flex min-h-[220px] flex-col rounded-3xl border border-slate-800 bg-slate-900/60 p-3 shadow-dashboard"
          data-chart-id="status-tertiary-2" data-collapsed="false" data-full-chart-card>
          <div class="flex flex-wrap items-center justify-between gap-3">
            <label class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
              Segment
              <select
                class="h-7 rounded-lg border border-slate-800 bg-slate-950/70 px-2 text-[10px] font-semibold text-slate-200"
                data-segment-select data-chart-id="status-tertiary-2"></select>
            </label>
            <div class="flex flex-wrap items-center gap-2">
              <div class="relative">
                <button type="button"
                  class="flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/70 px-2 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200"
                  data-segment-filter-toggle data-chart-id="status-tertiary-2" aria-expanded="false">
                  Fields
                  <span
                    class="rounded-full border border-slate-800 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300"
                    data-segment-filter-count data-chart-id="status-tertiary-2">All</span>
                </button>
                <div
                  class="absolute right-0 z-40 mt-2 hidden w-60 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg"
                  data-segment-filter-panel data-chart-id="status-tertiary-2">
                  <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show fields</p>
                  <div
                    class="mt-2 flex flex-wrap gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-300">
                    <button type="button"
                      class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                      data-segment-select-all data-chart-id="status-tertiary-2">Show all</button>
                    <button type="button"
                      class="rounded-full border border-slate-800 px-2 py-1 transition hover:text-white"
                      data-segment-clear-all data-chart-id="status-tertiary-2">Hide all</button>
                  </div>
                  <div class="mt-2 grid gap-2" data-segment-filter-options data-chart-id="status-tertiary-2"></div>
                </div>
              </div>
              <button type="button"
                class="flex h-8 w-8 items-center justify-center rounded-full border border-slate-800 bg-slate-950/60 text-slate-200 transition hover:border-blue-500 hover:text-white"
                data-full-chart-toggle data-full-chart-target="status-tertiary-secondary-body" aria-expanded="true"
                aria-controls="status-tertiary-secondary-body">
                <i data-lucide="chevron-up" class="h-4 w-4"></i>
              </button>
            </div>
          </div>
          <div id="status-tertiary-secondary-body" class="mt-2 grid flex-1 items-end gap-2"
            style="--chart-col-min: 96px;" data-bar-chart data-chart-id="status-tertiary-2" data-full-chart-body
            aria-label="Units by deal status chart"></div>
        </div>
      </div>

      <div id="full-chart-height-resizer"
        class="resize-handle resize-handle-row mt-2 hidden h-2 w-full items-center justify-center lg:flex">
        <span class="h-0.5 w-full rounded-full bg-slate-800"></span>
      </div>
    </section>

    <section class="p-4">
      <div class="flex flex-col gap-2">
        <div
          class="sticky top-0 z-10 mb-2 flex flex-wrap items-center gap-2 rounded-2xl border border-slate-800 bg-slate-950/80 px-2 py-2 text-xs font-semibold text-slate-200 backdrop-blur md:flex-nowrap">
          <div class="rounded-xl border border-slate-800/70 bg-slate-900/40 px-2 py-1">
            <div class="relative">
              <button id="column-chooser-toggle" type="button" data-pill-control
                class="h-7 text-xs font-semibold uppercase tracking-[0.2em] text-slate-200 transition hover:border-blue-500 hover:text-white"
                aria-haspopup="true" aria-expanded="false">
                Columns
              </button>
              <div id="column-chooser"
                class="absolute left-0 z-40 mt-2 hidden w-52 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg">
                <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show columns</p>
                <div id="column-chooser-options" class="mt-2 grid max-h-[48rem] gap-2 overflow-y-auto pr-1"></div>
              </div>
            </div>
          </div>
          <div class="rounded-xl border border-emerald-500/30 bg-emerald-500/10 px-2 py-1">
            <button id="export-csv" type="button" data-pill-control
              class="h-7 text-xs font-semibold uppercase tracking-[0.2em] text-emerald-200 transition hover:border-emerald-400 hover:text-white"
              aria-label="Export filtered rows to CSV">
              Export
            </button>
          </div>
          <div class="rounded-xl border border-rose-500/30 bg-rose-500/10 px-2 py-1">
            <button id="erase-filters" type="button" data-pill-control
              class="h-7 text-xs font-semibold uppercase tracking-[0.2em] text-rose-200 transition hover:border-rose-400 hover:text-white">
              Erase Filters
            </button>
          </div>
          <label class="inline-flex items-center gap-2 text-xs font-semibold text-slate-200">
            <span class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Per page</span>
            <select id="table-per-page"
              class="h-7 rounded-xl border border-slate-700 bg-slate-950/60 px-2 text-[11px] font-semibold text-slate-200">
              <option value="8">8</option>
              <option value="15">15</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </label>
          <span id="table-summary"
            class="rounded-xl border border-slate-700 bg-slate-950/60 px-2 py-1 text-[11px] font-semibold text-slate-200">0
            assets</span>
          <div class="flex items-center gap-1 text-[11px] font-semibold text-slate-200">
            <button id="table-prev" type="button" data-pill-control
              class="h-9 w-9 text-slate-200 transition hover:border-blue-500 hover:text-white"
              aria-label="Previous page">
              <i data-lucide="chevron-left" class="h-4 w-4"></i>
            </button>
            <span id="table-page" class="text-[11px] text-slate-300">Page 1</span>
            <button id="table-next" type="button" data-pill-control
              class="h-9 w-9 text-slate-200 transition hover:border-blue-500 hover:text-white" aria-label="Next page">
              <i data-lucide="chevron-right" class="h-4 w-4"></i>
            </button>
            <label class="inline-flex items-center gap-1">
              <i data-lucide="hash" class="h-3 w-3 text-slate-400"></i>
              <input id="table-go-to" type="number" min="1"
                class="h-7 w-14 rounded-xl border border-slate-700 bg-slate-950/60 px-2 text-[11px] font-semibold text-slate-200" />
            </label>
          </div>
          <div class="flex items-center gap-2 md:ml-auto">
            <div
              class="inline-flex h-9 items-center gap-3 rounded-2xl border border-slate-800/70 bg-slate-950/40 px-3 text-xs font-semibold text-slate-200 shadow-none">
              <span class="h-2 w-2 rounded-full bg-emerald-400/80"></span>
              <span class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Active Units</span>
              <span class="text-sm font-black text-white" data-metric="active">--</span>
            </div>
            <div
              class="inline-flex h-9 items-center gap-3 rounded-2xl border border-slate-800/70 bg-slate-950/40 px-3 text-xs font-semibold text-slate-200 shadow-none">
              <span class="h-2 w-2 rounded-full bg-amber-400/80"></span>
              <span class="text-[10px] uppercase tracking-[0.3em] text-slate-400">On Hold</span>
              <span class="text-sm font-black text-white" data-metric="hold">--</span>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-0">
        <div id="inventory-table-scroll-top" class="mb-2 overflow-x-auto">
          <div id="inventory-table-scroll-top-inner"></div>
        </div>
        <div id="inventory-table-scroll" class="scrollbar-hidden overflow-x-auto">
          <table class="min-w-full table-fixed text-left text-sm text-slate-200" aria-label="Filtered inventory table">
            <colgroup id="inventory-table-cols"></colgroup>
            <thead id="inventory-table-head" class="text-[10px] uppercase tracking-[0.3em] text-slate-400"></thead>
            <tbody id="inventory-table" class="divide-y divide-slate-800"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <aside id="row-drawer"
    class="fixed right-0 top-0 z-40 flex h-full w-80 translate-x-full flex-col gap-4 border-l border-slate-800 bg-slate-950/95 p-4 shadow-2xl transition-transform">
    <div class="flex items-center justify-between">
      <h4 class="text-lg font-bold text-white">Vehicle Details</h4>
      <button id="drawer-close" type="button"
        class="rounded-full border border-slate-700 bg-slate-900/80 px-3 py-1 text-xs font-semibold text-slate-200">Close</button>
    </div>
    <div class="space-y-3 text-sm text-slate-200">
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">VIN</p>
        <p id="drawer-vin" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Status</p>
        <p id="drawer-status" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">GPS Status</p>
        <p id="drawer-gps-status" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">GPS Review</p>
        <p id="drawer-gps-flag" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Completion</p>
        <p id="drawer-completion" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Location</p>
        <p id="drawer-location" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Unit</p>
        <p id="drawer-unit" class="font-semibold text-white">-</p>
      </div>
      <div>
        <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Flags</p>
        <p id="drawer-flags" class="font-semibold text-white">-</p>
      </div>
    </div>
    <div>
      <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Timeline</p>
      <ul id="drawer-timeline" class="mt-2 space-y-2 text-xs text-slate-300"></ul>
    </div>
  </aside>

  <script type="module">
    import { createConstellationBackground } from '../assets/scripts/constellation.js';
    createConstellationBackground();
  </script>

  <script type="module">
    // ==========================================================
    // 1) SUPABASE CLIENT (robusto)
    // - Primero intenta importar tu supabaseClient.js
    // - Si falla, crea el cliente aquÃ­ con URL/KEY
    // ==========================================================

    const createLucideSvg = (name, className = '') => {
      const iconDef = lucide?.icons?.[name];
      if (!iconDef) return null;
      const svgString = iconDef.toSvg({ class: className, 'data-lucide': name, 'data-lucide-initialized': 'true' });
      const wrapper = document.createElement('span');
      wrapper.innerHTML = svgString;
      return wrapper.firstElementChild;
    };

    const initializeLucideIcons = (root = document) => {
      if (!lucide?.icons) return;
      const icons = [];
      if (root.matches?.('[data-lucide]')) icons.push(root);
      root.querySelectorAll?.('[data-lucide]').forEach((icon) => icons.push(icon));
      icons.forEach((icon) => {
        if (icon.getAttribute('data-lucide-initialized') === 'true') return;
        const name = icon.getAttribute('data-lucide');
        const className = icon.getAttribute('class') || '';
        const svgEl = createLucideSvg(name, className);
        if (svgEl) icon.replaceWith(svgEl);
      });
    };

    const updateLucideIcon = (icon, name) => {
      if (!icon) return;
      icon.setAttribute('data-lucide', name);
      icon.removeAttribute('data-lucide-initialized');
      initializeLucideIcons(icon);
    };

    initializeLucideIcons();

    const PILL_CLASSES = 'rounded-xl border border-slate-700 bg-slate-950/60 px-2 py-1 text-[10px] hover:bg-slate-900/60';
    // âœ… Fallback: pega tus credenciales si tu mÃ³dulo no exporta bien.
    //    (Anon key es pÃºblica, pero igual cuida RLS.)
    const SUPABASE_URL = 'https://ewgtclzscwbokxmzxbcu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3Z3RjbHpzY3dib2t4bXp4YmN1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODA3MzIsImV4cCI6MjA4MDY1NjczMn0.QkM72rVeBpm6uGgBVdG4ulIzEg3V_7T8usqvIf6vBto';

    const showDebug = (title, detail, obj) => {
      const banner = document.getElementById('debug-banner');
      const text = document.getElementById('debug-text');
      const pre = document.getElementById('debug-pre');
      banner.classList.remove('hidden');
      text.textContent = `${title} â€” ${detail || ''}`.trim();
      pre.textContent = obj ? JSON.stringify(obj, null, 2) : '';
      document.getElementById('debug-copy').onclick = async () => {
        const payload = `${title}\n${detail || ''}\n\n${pre.textContent}`.trim();
        try { await navigator.clipboard.writeText(payload); } catch { }
      };
    };

    const setConnectionStatus = (status) => {
      const statusEl = document.getElementById('connection-status');
      const dotEl = document.getElementById('connection-dot');
      statusEl.textContent = status;

      dotEl.className = 'h-2.5 w-2.5 rounded-full';
      if (status === 'Live') dotEl.classList.add('bg-emerald-400', 'shadow-[0_0_10px_rgba(52,211,153,0.8)]');
      else if (status.includes('Reconnect')) dotEl.classList.add('bg-amber-400', 'shadow-[0_0_10px_rgba(251,191,36,0.8)]');
      else dotEl.classList.add('bg-slate-500');
    };

    let supabaseClient = null;

    const getSupabaseClient = async () => {
      // Try import your module (best option)
      try {
        const mod = await import('../assets/scripts/supabaseClient.js');
        // common patterns: export const supabase; export default supabase;
        supabaseClient = mod.supabase || mod.default || null;
        if (supabaseClient?.from) return supabaseClient;
        throw new Error('supabaseClient.js loaded but did not export a Supabase client (expected export const supabase = createClient(...)).');
      } catch (e) {
        // Fallback: create client here
        if (SUPABASE_URL && SUPABASE_ANON_KEY) {
          supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          return supabaseClient;
        }
        showDebug(
          'Supabase client not available',
          'Tu import fallÃ³ y el fallback no tiene URL/KEY. Revisa supabaseClient.js export o pega credenciales aquÃ­.',
          { error: String(e) }
        );
        return null;
      }
    };

    // ==========================================================
    // 2) DASHBOARD STATE + HELPERS (tu lÃ³gica con mejoras mÃ­nimas)
    // ==========================================================

    const DashboardState = {
      filters: {
        dateRange: { start: '', end: '' },
        dateKey: '',
        salesChannels: ['Finance-EX'],
        salesChannelKey: '',
        lastLeadKey: '',
        lastLeadSelection: true,
        lastLeadFilterActive: false,
        categoryFilters: {},
        columnFilters: {},
        chartFilters: {},
        unitTypeKey: '',
        unitTypeSelection: [],
        vehicleStatusKey: '',
        vehicleStatusSelection: [],
      },
      vehiclesRaw: new Map(),
      schema: [],
      table: {
        page: 1,
        perPage: 8,
        sort: { key: '', direction: 'asc' },
        columns: {},
        columnOrder: [],
        columnWidths: {},
        columnLabels: {},
      },
      derived: {
        filtered: [],
        kpis: { active: 0, hold: 0 },
        statusBars: [],
      },
      chartSegments: {},
      chartVisibility: {},
      chartVisibilityOptions: {},
      realtime: { channel: null },
      layout: { alertsPanelWidth: null, chartSplitWidth: null, dealPanelHeight: null, fullChartHeight: null, fullChartCollapsed: false },
      preferences: {
        userId: null,
        config: null,
        saveTimer: null,
      },
      ui: { isLoading: true },
    };

    const DEAL_STATUS_COLORS = [
      'from-emerald-400 to-green-500',
      'from-blue-400 to-indigo-500',
      'from-amber-400 to-orange-500',
      'from-rose-400 to-red-500',
      'from-teal-400 to-cyan-500',
      'from-slate-400 to-slate-500',
    ];
    const DEAL_STATUS_COLORS_ALT = [
      'from-fuchsia-400 to-purple-500',
      'from-cyan-400 to-sky-500',
      'from-lime-400 to-emerald-500',
      'from-orange-400 to-amber-500',
      'from-pink-400 to-rose-500',
      'from-violet-400 to-indigo-500',
    ];
    const DEFAULT_SEGMENT_KEY = 'dealStatus';

    const COLUMN_STORAGE_KEY = 'inventoryControlTableColumns';
    const PREFERENCES_STORAGE_KEY = 'inventoryControlPreferences';
    const CONFIG_TABLE = 'user_table_configs';
    const CONFIG_TABLE_NAME = 'Inventory Control';

    const formatDate = (value) => {
      if (!value) return '--';
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return '--';
      return parsed.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' });
    };
    const formatNumber = (value) => new Intl.NumberFormat('en-US').format(value);
    const MILEAGE_COLUMNS = new Set(['mileage']);
    const CURRENCY_COLUMNS = new Set([
      'price on contract',
      'scheduled amount',
      'open balance',
      'regular amount',
    ]);
    const formatMileage = (value) => {
      if (value === null || value === undefined || value === '') return '--';
      const numeric = Number(String(value).replace(/,/g, ''));
      if (!Number.isFinite(numeric)) return value;
      return formatNumber(numeric);
    };
    const formatCurrency = (value) => {
      if (value === null || value === undefined || value === '') return '--';
      const numeric = Number(String(value).replace(/[$,]/g, ''));
      if (!Number.isFinite(numeric)) return value;
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(numeric);
    };

    const formatRelativeTime = (timestamp) => {
      if (!timestamp) return 'Updated --';
      const diffSeconds = Math.max(0, Math.round((Date.now() - timestamp) / 1000));
      if (diffSeconds < 60) return `Updated ${diffSeconds}s ago`;
      const minutes = Math.floor(diffSeconds / 60);
      if (minutes < 60) return `Updated ${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `Updated ${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `Updated ${days}d ago`;
    };

    const formatColumnLabel = (key) => key.replace(/_/g, ' ');
    const getColumnLabel = (key) =>
      DashboardState.table.columnLabels?.[key]
      || DashboardState.schema.find((col) => col.key === key)?.label
      || formatColumnLabel(key);
    const applyColumnLabelOverrides = () => {
      if (!DashboardState.schema.length) return;
      DashboardState.schema = DashboardState.schema.map((col) => ({
        ...col,
        label: DashboardState.table.columnLabels?.[col.key] || formatColumnLabel(col.key),
      }));
    };
    const setColumnLabelOverride = (key, label) => {
      const trimmed = label?.trim() || '';
      if (!DashboardState.table.columnLabels || typeof DashboardState.table.columnLabels !== 'object') {
        DashboardState.table.columnLabels = {};
      }
      if (trimmed) {
        DashboardState.table.columnLabels[key] = trimmed;
      } else {
        delete DashboardState.table.columnLabels[key];
      }
      const column = DashboardState.schema.find((col) => col.key === key);
      if (column) column.label = trimmed || formatColumnLabel(key);
    };

    const inferColumnType = (values) => {
      let sawString = false;
      let sawNumber = false;
      let sawBoolean = false;
      let sawDate = false;

      values.forEach((value) => {
        if (value === null || value === undefined || value === '') return;
        if (typeof value === 'boolean') {
          sawBoolean = true;
          return;
        }
        if (typeof value === 'number' && !Number.isNaN(value)) {
          sawNumber = true;
          return;
        }
        if (value instanceof Date) {
          sawDate = true;
          return;
        }
        if (typeof value === 'string') {
          const trimmed = value.trim();
          const parsed = Date.parse(trimmed);
          if (!Number.isNaN(parsed) && /[-/T:]/.test(trimmed)) {
            sawDate = true;
            return;
          }
          if (trimmed && !Number.isNaN(Number(trimmed))) {
            sawNumber = true;
            return;
          }
          sawString = true;
          return;
        }
        sawString = true;
      });

      if (sawString) return 'string';
      if (sawDate && !sawNumber && !sawBoolean) return 'date';
      if (sawNumber && !sawBoolean) return 'number';
      if (sawBoolean && !sawNumber) return 'boolean';
      if (sawDate) return 'date';
      if (sawNumber) return 'number';
      if (sawBoolean) return 'boolean';
      return 'string';
    };

    const DATE_COLUMNS = new Set([
      'Deal Date',
      'Calc. End',
      'Inv. Prep. Stat. On',
      'Oldest Invoice (Open)',
      'Last Payment date',
      'Last Ping',
    ]);
    const buildSchemaFromData = (rows) => {
      if (!rows?.length) return [];
      const sample = rows.slice(0, 50);
      return Object.keys(rows[0]).map((key) => {
        const values = sample.map((row) => row?.[key]);
        const override = DashboardState.table.columnLabels?.[key];
        return {
          key,
          label: override || formatColumnLabel(key),
          type: DATE_COLUMNS.has(key) ? 'date' : inferColumnType(values),
        };
      });
    };

    const getColumnValues = (rows, key) => rows.map((row) => row?.[key]).filter((v) => v !== null && v !== undefined && v !== '');

    const getUniqueValues = (rows, key) => {
      const values = new Set();
      rows.forEach((row) => {
        const value = row?.[key];
        if (value !== null && value !== undefined && value !== '') values.add(String(value));
      });
      return Array.from(values).sort((a, b) => a.localeCompare(b));
    };

    const detectDateKey = (schema) => {
      const preferred = schema.find((col) => col.type === 'date' && /created_at|created|updated_at|updated/i.test(col.key));
      if (preferred) return preferred.key;
      return schema.find((col) => col.type === 'date')?.key || '';
    };

    const detectSalesChannelKey = (schema) =>
      schema.find((col) => /sales channel/i.test(col.key))?.key || '';

    const detectLastLeadKey = (schema) =>
      schema.find((col) => /last\s*(lead|deal)/i.test(col.key) || /last\s*(lead|deal)/i.test(col.label))?.key || '';

    const detectUnitTypeKey = (schema) =>
      schema.find((col) => /unit\s*type/i.test(col.key) || /unit\s*type/i.test(col.label))?.key || '';

    const detectVehicleStatusKey = (schema) =>
      schema.find((col) => col.key === 'status')?.key
      || schema.find((col) => /vehicle\s*status/i.test(col.key) || /vehicle\s*status/i.test(col.label))?.key
      || '';

    const INV_PREP_STATUS_CLASSES = {
      'out for repo': 'bg-gradient-to-r from-pink-500/20 via-pink-400/10 to-pink-500/20 backdrop-blur-sm',
      'passtime unavailable': 'bg-gradient-to-r from-amber-700/25 via-amber-500/10 to-amber-700/25 backdrop-blur-sm',
      accident: 'bg-gradient-to-r from-orange-500/25 via-orange-400/10 to-orange-500/25 backdrop-blur-sm',
      'not stock': 'bg-gradient-to-r from-slate-500/25 via-slate-400/10 to-slate-500/25 backdrop-blur-sm',
      stolen: 'bg-gradient-to-r from-red-500/25 via-red-400/10 to-red-500/25 backdrop-blur-sm',
      'm&t repo title in process': 'bg-gradient-to-r from-blue-600/25 via-blue-500/10 to-blue-600/25 backdrop-blur-sm',
      'repoed on hold': 'bg-gradient-to-r from-blue-700/25 via-blue-500/10 to-blue-700/25 backdrop-blur-sm',
      'third party repair shop': 'bg-gradient-to-r from-yellow-300/20 via-yellow-200/10 to-yellow-300/20 backdrop-blur-sm',
      'available for deals': 'bg-gradient-to-r from-emerald-400/20 via-emerald-300/10 to-emerald-400/20 backdrop-blur-sm',
    };

    const detectInvPrepStatusKey = (schema) =>
      schema.find((col) =>
        /inv\.?\s*prep\.?\s*stat/i.test(col.key)
        || /inv\.?\s*prep\.?\s*stat/i.test(col.label)
        || /inventory\s*preparation\s*status/i.test(col.key)
        || /inventory\s*preparation\s*status/i.test(col.label)
      )?.key || '';

    const getInvPrepStatusValue = (item, key) => {
      const value = key ? item?.[key] : undefined;
      if (value !== undefined && value !== null && value !== '') return String(value);
      const fallback = item?.prepStatus ?? item?.['Inventory Preparation Status'] ?? item?.['Inv. Prep. Stat'];
      return fallback !== undefined && fallback !== null && fallback !== '' ? String(fallback) : '';
    };

    const getInvPrepStatusRowClass = (status) => {
      if (!status) return '';
      const normalized = String(status).trim().toLowerCase();
      return INV_PREP_STATUS_CLASSES[normalized] || '';
    };

    const detectTruthyColumnValue = (rows, key) => {
      if (!key) return '';
      const truthyRow = rows.find((row) => normalizeBoolean(row?.[key]));
      if (truthyRow) return String(truthyRow[key]);
      const truthyValue = getUniqueValues(rows, key).find((value) => normalizeBoolean(value));
      return truthyValue || '';
    };

    const detectCategoryKeys = (schema, rows, excludeKeys) => {
      const candidates = schema
        .filter((col) => !excludeKeys.includes(col.key))
        .filter((col) => ['string', 'number', 'boolean'].includes(col.type))
        .map((col) => ({
          key: col.key,
          label: col.label,
          values: getUniqueValues(rows, col.key),
        }))
        .filter((entry) => entry.values.length > 0 && entry.values.length <= 50)
        .sort((a, b) => b.values.length - a.values.length);

      return candidates.slice(0, 4);
    };

    const getVehicleKey = (vehicle) => vehicle.id ?? '';
    const normalizeBoolean = (value) => {
      if (typeof value === 'boolean') return value;
      if (typeof value === 'number') return value !== 0;
      if (typeof value === 'string') {
        const normalized = value.trim().toLowerCase();
        return ['true', 'yes', 'y', '1'].includes(normalized);
      }
      return Boolean(value);
    };
    const normalizeStatus = (value) => {
      const raw = String(value ?? '').trim();
      if (!raw) return 'Active';
      const normalized = raw.toLowerCase();
      if (normalized.includes('hold')) return 'On Hold';
      if (normalized.includes('transit')) return 'In Transit';
      if (normalized.includes('recover')) return 'Recovery';
      if (normalized.includes('ready')) return 'Ready';
      if (normalized.includes('write')) return 'Write-Off';
      if (normalized.includes('active')) return 'Active';
      return 'Active';
    };
    const normalizePhysicalLocation = (value) => {
      if (value === null || value === undefined) return value;
      if (typeof value !== 'string') return value;
      const trimmed = value.trim();
      if (!trimmed) return trimmed;
      const normalized = trimmed.toUpperCase();
      if (normalized === 'COPART' || normalized === 'CO PART - PENDING FUNDING' || normalized === 'CO PART- PENDING FUNDING') {
        return 'COPART';
      }
      if (normalized === 'EXTERNAL DEALER FOR FINANCE EXTERNAL DEAL') {
        return 'External Dealer';
      }
      if (normalized === 'HOUSBY TRUCK & EQUIPMENT SOLUTIONS, LLC') {
        return 'HOUSBY';
      }
      return trimmed;
    };
    const getField = (row, ...keys) => {
      for (const key of keys) {
        const value = row?.[key];
        if (value !== undefined && value !== null && value !== '') return value;
      }
      return '';
    };
    const normalizeVehicle = (vehicle) => {
      const updatedAt = getField(vehicle, 'Updated At', 'Updated', 'Last Updated');
      const createdAt = getField(vehicle, 'Created At');
      const dateValue = getField(vehicle, 'Date') || updatedAt || createdAt;
      const vin = getField(vehicle, 'VIN');
      const uniqueId = vehicle.id || getField(vehicle, 'Current Stock No') || vin;
      const physicalLocation = getField(vehicle, 'Physical Location');
      const normalizedPhysicalLocation = normalizePhysicalLocation(physicalLocation);
      return {
        ...vehicle,
        id: uniqueId || null,
        stockNo: getField(vehicle, 'Current Stock No'),
        vin,
        status: normalizeStatus(getField(vehicle, 'Vehicle Status')),
        hold: normalizeBoolean(getField(vehicle, 'HOLD')),
        isLastDeal: normalizeBoolean(getField(vehicle, 'Last Deal', 'last_deal')),
        brand: getField(vehicle, 'Brand'),
        model: getField(vehicle, 'Model'),
        modelYear: getField(vehicle, 'Model Year'),
        dealStatus: getField(vehicle, 'Deal Status'),
        gpsStatus: getField(vehicle, 'gps_status'),
        gpsFlag: getField(vehicle, 'gps_review_flag'),
        completion: getField(vehicle, 'Deal Completion'),
        psrCategory: getField(vehicle, 'PSR Category'),
        prepStatus: getField(vehicle, 'Inventory Preparation Status'),
        createdAt: createdAt ? String(createdAt).slice(0, 10) : '',
        updatedAt: updatedAt ? String(updatedAt).slice(0, 10) : '',
        date: dateValue ? String(dateValue).slice(0, 10) : '',
        lastEventAt: vehicle.lastEventAt || (updatedAt ? new Date(updatedAt).getTime() : null),
        'Physical Location': normalizedPhysicalLocation,
      };
    };

    const getOrderedColumns = (columns) => {
      const order = DashboardState.table.columnOrder;
      if (!Array.isArray(order) || !order.length) return columns;
      const byKey = new Map(columns.map((col) => [col.key, col]));
      const ordered = order.map((key) => byKey.get(key)).filter(Boolean);
      columns.forEach((col) => {
        if (!order.includes(col.key)) ordered.push(col);
      });
      return ordered;
    };

    const buildPreferencesPayload = () => ({
      table: {
        columns: DashboardState.table.columns,
        columnOrder: DashboardState.table.columnOrder,
        columnWidths: DashboardState.table.columnWidths,
        sort: DashboardState.table.sort,
        perPage: DashboardState.table.perPage,
        columnLabels: DashboardState.table.columnLabels,
      },
      chart: {
        chartSegments: DashboardState.chartSegments,
        chartVisibility: DashboardState.chartVisibility,
      },
      filters: {
        dateRange: DashboardState.filters.dateRange,
        salesChannels: DashboardState.filters.salesChannels,
        lastLeadSelection: DashboardState.filters.lastLeadSelection,
        categoryFilters: DashboardState.filters.categoryFilters,
        columnFilters: DashboardState.filters.columnFilters,
        chartFilters: DashboardState.filters.chartFilters,
        unitTypeSelection: DashboardState.filters.unitTypeSelection,
        vehicleStatusSelection: DashboardState.filters.vehicleStatusSelection,
      },
      layout: {
        alertsPanelWidth: DashboardState.layout.alertsPanelWidth,
        chartSplitWidth: DashboardState.layout.chartSplitWidth,
        dealPanelHeight: DashboardState.layout.dealPanelHeight,
        fullChartHeight: DashboardState.layout.fullChartHeight,
        fullChartCollapsed: DashboardState.layout.fullChartCollapsed,
      },
    });

    const applyPreferences = (config) => {
      if (!config || typeof config !== 'object') return;
      if (config.table?.sort) DashboardState.table.sort = config.table.sort;
      if (typeof config.table?.perPage === 'number') DashboardState.table.perPage = config.table.perPage;
      if (Array.isArray(config.table?.columnOrder)) DashboardState.table.columnOrder = config.table.columnOrder;
      if (config.table?.columnWidths) DashboardState.table.columnWidths = config.table.columnWidths;
      if (config.table?.columnLabels && typeof config.table.columnLabels === 'object') {
        DashboardState.table.columnLabels = config.table.columnLabels;
      }
      applyColumnLabelOverrides();
      if (config.chart?.chartSegments && typeof config.chart.chartSegments === 'object') {
        DashboardState.chartSegments = { ...config.chart.chartSegments };
      }
      if (config.chart?.chartVisibility && typeof config.chart.chartVisibility === 'object') {
        DashboardState.chartVisibility = { ...config.chart.chartVisibility };
      }
      if (config.chart?.segmentKey && (!config.chart.chartSegments || typeof config.chart.chartSegments !== 'object')) {
        DashboardState.chartSegments = { default: config.chart.segmentKey };
      }
      if (config.filters?.dateRange) DashboardState.filters.dateRange = { ...DashboardState.filters.dateRange, ...config.filters.dateRange };
      if (Array.isArray(config.filters?.salesChannels)) DashboardState.filters.salesChannels = config.filters.salesChannels;
      if (config.filters?.lastLeadSelection === 'all' || typeof config.filters?.lastLeadSelection === 'boolean') {
        DashboardState.filters.lastLeadSelection = config.filters.lastLeadSelection;
      }
      if (config.filters?.categoryFilters) DashboardState.filters.categoryFilters = config.filters.categoryFilters;
      if (config.filters?.columnFilters) DashboardState.filters.columnFilters = config.filters.columnFilters;
      if (config.filters?.chartFilters && typeof config.filters?.chartFilters === 'object') {
        DashboardState.filters.chartFilters = Object.entries(config.filters.chartFilters).reduce((acc, [chartId, filter]) => {
          if (!filter || typeof filter !== 'object') return acc;
          const key = filter.key || DEFAULT_SEGMENT_KEY;
          const values = Array.isArray(filter.values)
            ? filter.values.map((value) => String(value))
            : (filter.value ? [String(filter.value)] : []);
          if (!values.length) return acc;
          acc[chartId] = { key, values };
          return acc;
        }, {});
      }
      if (!Object.keys(DashboardState.filters.chartFilters || {}).length && config.filters?.chartFilter && typeof config.filters.chartFilter === 'object') {
        const fallbackKey = config.filters.chartFilter.key || DEFAULT_SEGMENT_KEY;
        const fallbackValue = config.filters.chartFilter.value;
        DashboardState.filters.chartFilters = fallbackValue
          ? { default: { key: fallbackKey, values: [String(fallbackValue)] } }
          : {};
      }
      if (Array.isArray(config.filters?.unitTypeSelection)) {
        DashboardState.filters.unitTypeSelection = config.filters.unitTypeSelection.map((value) => String(value));
      } else if (typeof config.filters?.unitTypeSelection === 'string') {
        DashboardState.filters.unitTypeSelection = [config.filters.unitTypeSelection];
      }
      if (Array.isArray(config.filters?.vehicleStatusSelection)) {
        DashboardState.filters.vehicleStatusSelection = config.filters.vehicleStatusSelection.map((value) => String(value));
      } else if (typeof config.filters?.vehicleStatusSelection === 'string') {
        DashboardState.filters.vehicleStatusSelection = [config.filters.vehicleStatusSelection];
      }
      if (typeof config.layout?.alertsPanelWidth === 'number') DashboardState.layout.alertsPanelWidth = config.layout.alertsPanelWidth;
      if (typeof config.layout?.chartSplitWidth === 'number') DashboardState.layout.chartSplitWidth = config.layout.chartSplitWidth;
      if (typeof config.layout?.dealPanelHeight === 'number') DashboardState.layout.dealPanelHeight = config.layout.dealPanelHeight;
      if (typeof config.layout?.fullChartHeight === 'number') DashboardState.layout.fullChartHeight = config.layout.fullChartHeight;
      if (typeof config.layout?.fullChartCollapsed === 'boolean') DashboardState.layout.fullChartCollapsed = config.layout.fullChartCollapsed;
    };

    const fetchTableConfig = async (userId) => {
      if (!supabaseClient?.from || !userId) return null;
      const { data, error } = await supabaseClient
        .from(CONFIG_TABLE)
        .select('config')
        .eq('user_id', userId)
        .eq('table_name', CONFIG_TABLE_NAME)
        .maybeSingle();
      if (error) return null;
      return data?.config || null;
    };

    const fetchAdminUserId = async () => {
      if (!supabaseClient?.from) return null;
      const { data, error } = await supabaseClient
        .from('profiles')
        .select('id')
        .eq('role', 'administrator')
        .limit(1)
        .maybeSingle();
      if (error) return null;
      return data?.id || null;
    };

    const loadDashboardPreferences = async () => {
      let config = null;
      if (supabaseClient?.auth) {
        const { data } = await supabaseClient.auth.getSession();
        const userId = data?.session?.user?.id || null;
        DashboardState.preferences.userId = userId;
        if (userId) {
          config = await fetchTableConfig(userId);
          if (!config) {
            const adminId = await fetchAdminUserId();
            if (adminId) config = await fetchTableConfig(adminId);
          }
        }
      }

      if (!config) {
        try {
          const raw = localStorage.getItem(PREFERENCES_STORAGE_KEY);
          config = raw ? JSON.parse(raw) : null;
        } catch { }
      }

      if (config) {
        DashboardState.preferences.config = config;
        applyPreferences(config);
      }
    };

    const applyLayoutPreferencesToDom = () => {
      const alertsPanel = document.getElementById('alerts-panel');
      const dealPanel = document.getElementById('deal-status-panel');
      const primaryChart = document.getElementById('status-primary-card');
      const secondaryChart = document.getElementById('status-secondary-card');
      const fullWidthCharts = document.querySelectorAll('[data-full-chart-card]');
      const fullWidthChartBodies = document.querySelectorAll('[data-full-chart-body]');
      const fullWidthChartToggles = document.querySelectorAll('[data-full-chart-toggle]');
      const fullWidthChartResizer = document.getElementById('full-chart-height-resizer');
      if (!alertsPanel || !dealPanel) return;
      if (typeof DashboardState.layout.alertsPanelWidth === 'number' && window.innerWidth >= 1024) {
        alertsPanel.style.flex = `0 0 ${DashboardState.layout.alertsPanelWidth}px`;
        dealPanel.style.flex = '1 1 auto';
      }
      if (typeof DashboardState.layout.chartSplitWidth === 'number' && window.innerWidth >= 1024 && primaryChart && secondaryChart) {
        primaryChart.style.flex = `0 0 ${DashboardState.layout.chartSplitWidth}px`;
        secondaryChart.style.flex = '1 1 auto';
      }
      if (typeof DashboardState.layout.fullChartHeight === 'number' && fullWidthCharts.length) {
        fullWidthCharts.forEach((chart) => {
          chart.style.height = `${DashboardState.layout.fullChartHeight}px`;
        });
      }
      if (fullWidthCharts.length && fullWidthChartBodies.length && fullWidthChartToggles.length && fullWidthChartResizer) {
        const fullChartMinHeight = '220px';
        const isCollapsed = Boolean(DashboardState.layout.fullChartCollapsed);
        fullWidthCharts.forEach((chart) => {
          chart.dataset.collapsed = String(isCollapsed);
        });
        fullWidthChartBodies.forEach((body) => body.classList.toggle('hidden', isCollapsed));
        fullWidthChartResizer.classList.toggle('hidden', isCollapsed);
        fullWidthChartToggles.forEach((toggle) => {
          toggle.setAttribute('aria-expanded', String(!isCollapsed));
          const icon = toggle.querySelector('i[data-lucide]');
          if (icon) icon.setAttribute('data-lucide', isCollapsed ? 'chevron-down' : 'chevron-up');
        });
        if (isCollapsed) {
          fullWidthCharts.forEach((chart) => {
            chart.style.height = '';
            chart.style.minHeight = '0px';
          });
        }
        if (!isCollapsed) {
          fullWidthCharts.forEach((chart) => {
            chart.style.minHeight = fullChartMinHeight;
          });
        }
      }
      if (typeof DashboardState.layout.dealPanelHeight === 'number' && window.innerWidth >= 1024) {
        const heightValue = `${DashboardState.layout.dealPanelHeight}px`;
        dealPanel.style.height = heightValue;
        alertsPanel.style.height = heightValue;
        if (primaryChart) primaryChart.style.height = heightValue;
        if (secondaryChart) secondaryChart.style.height = heightValue;
      }
    };

    const persistDashboardPreferences = async () => {
      const payload = buildPreferencesPayload();
      try {
        localStorage.setItem(PREFERENCES_STORAGE_KEY, JSON.stringify(payload));
        localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(DashboardState.table.columns));
      } catch { }

      if (!supabaseClient?.from || !DashboardState.preferences.userId) return;

      await supabaseClient
        .from(CONFIG_TABLE)
        .upsert(
          { user_id: DashboardState.preferences.userId, table_name: CONFIG_TABLE_NAME, config: payload },
          { onConflict: 'user_id, table_name' }
        );
    };

    const schedulePersistPreferences = () => {
      if (DashboardState.preferences.saveTimer) window.clearTimeout(DashboardState.preferences.saveTimer);
      DashboardState.preferences.saveTimer = window.setTimeout(() => {
        persistDashboardPreferences();
      }, 500);
    };

    const getCurrentDataset = () => Array.from(DashboardState.vehiclesRaw.values());
    const setVehiclesFromArray = (vehicles) => {
      DashboardState.vehiclesRaw.clear();
      vehicles.forEach((vehicle) => {
        const normalized = normalizeVehicle(vehicle);
        const key = getVehicleKey(normalized);
        if (key) DashboardState.vehiclesRaw.set(key, normalized);
      });
    };

    const setupFilters = ({ preserveSelections = false } = {}) => {
      const dataset = getCurrentDataset();
      const schema = DashboardState.schema;
      if (!schema.length) return;

      const dateKey = detectDateKey(schema);
      const salesChannelKey = detectSalesChannelKey(schema);
      const lastLeadKey = detectLastLeadKey(schema);
      const unitTypeKey = detectUnitTypeKey(schema);
      const vehicleStatusKey = detectVehicleStatusKey(schema);
      const categoryKeys = detectCategoryKeys(schema, dataset, [dateKey, salesChannelKey, unitTypeKey, vehicleStatusKey].filter(Boolean));

      if (!preserveSelections) {
        DashboardState.filters.categoryFilters = {};
        DashboardState.filters.columnFilters = {};
        DashboardState.filters.unitTypeSelection = [];
        DashboardState.filters.vehicleStatusSelection = [];
      }

      DashboardState.filters.dateKey = dateKey;
      DashboardState.filters.salesChannelKey = salesChannelKey;
      DashboardState.filters.lastLeadKey = lastLeadKey;
      DashboardState.filters.unitTypeKey = unitTypeKey;
      DashboardState.filters.vehicleStatusKey = vehicleStatusKey;

      const builder = document.getElementById('filter-builder');
      const categoryBlock = document.getElementById('filter-category-block');
      const dateRangeBlock = document.getElementById('filter-date-range');
      const salesChannelOptions = document.getElementById('sales-channel-options');
      const salesChannelSummary = document.getElementById('sales-channel-summary');
      const salesChannelLabel = document.getElementById('sales-channel-label');
      const lastDealSelect = document.getElementById('last-deal-select');
      const lastDealKey = lastLeadKey;

      if (!builder && !categoryBlock && !dateRangeBlock && !preserveSelections) {
        DashboardState.filters.dateRange = { start: '', end: '' };
      }

      if (categoryBlock) categoryBlock.innerHTML = '';
      if (dateRangeBlock) dateRangeBlock.innerHTML = '';

      if (categoryBlock && categoryKeys.length) {
        categoryKeys.forEach((entry) => {
          const currentValue = preserveSelections ? (DashboardState.filters.categoryFilters[entry.key] || 'all') : 'all';
          DashboardState.filters.categoryFilters[entry.key] = currentValue;
          categoryBlock.insertAdjacentHTML('beforeend', `
            <label class="col-span-12 flex flex-col gap-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400 sm:col-span-6 lg:col-span-3">
              ${entry.label}
              <select data-filter-category="${entry.key}" class="h-9 rounded-xl border border-slate-800 bg-slate-950/70 px-3 text-sm font-semibold text-white">
                <option value="all">All ${entry.label}</option>
                ${entry.values.map((value) => `<option value="${value}" ${value === currentValue ? 'selected' : ''}>${value}</option>`).join('')}
              </select>
            </label>
          `);
        });
      }

      if (dateRangeBlock && dateKey) {
        const dateValues = getColumnValues(dataset, dateKey)
          .map((value) => new Date(value))
          .filter((value) => !Number.isNaN(value.getTime()))
          .map((value) => value.toISOString().slice(0, 10))
          .sort();

        if (dateValues.length && !preserveSelections) {
          const latest = new Date(dateValues[dateValues.length - 1]);
          const startDate = new Date(latest);
          startDate.setDate(startDate.getDate() - 29);
          DashboardState.filters.dateRange = { start: startDate.toISOString().slice(0, 10), end: '' };
        } else if (!dateValues.length) {
          DashboardState.filters.dateRange = { start: '', end: '' };
        } else {
          DashboardState.filters.dateRange.end = '';
        }

        dateRangeBlock.innerHTML = `
          <div class="grid gap-2 sm:grid-cols-2">
            <label class="flex items-center gap-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400">
              <span>Start</span>
              <input id="filter-start-date" type="date" value="${DashboardState.filters.dateRange.start || ''}" class="h-8 flex-1 rounded-xl border border-slate-800 bg-slate-950/70 px-2 text-[11px] font-semibold text-white" />
            </label>
          </div>
        `;
      }

      if (salesChannelOptions && salesChannelSummary) {
        if (salesChannelKey) {
          const channelValues = getUniqueValues(dataset, salesChannelKey);
          const preferredValues = ['Finance-EX', 'Finance-EXT', 'Finance-ext', 'Finance-Ext'];
          const existingSelections = DashboardState.filters.salesChannels.filter((value) => channelValues.includes(value));
          if (!preserveSelections || !existingSelections.length) {
            const selections = preferredValues.filter((value) => channelValues.includes(value));
            if (selections.length) {
              DashboardState.filters.salesChannels = selections;
            } else {
              const nonFinance = channelValues.find((value) => value.toUpperCase() !== 'FINANCE');
              DashboardState.filters.salesChannels = nonFinance ? [nonFinance] : [...channelValues];
            }
          } else {
            DashboardState.filters.salesChannels = existingSelections;
          }
          salesChannelOptions.innerHTML = (channelValues.length ? channelValues : [''])
            .map((value) => `
              <label class="flex items-center gap-2 text-xs">
                <input type="checkbox" value="${value}" class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950" ${DashboardState.filters.salesChannels.includes(value) ? 'checked' : ''} />
                <span>${value || 'Unknown'}</span>
              </label>
            `).join('');
          const count = DashboardState.filters.salesChannels.filter(Boolean).length;
          salesChannelSummary.textContent = count ? String(count) : '0';
          if (salesChannelLabel) {
            salesChannelLabel.textContent = count === 1 ? DashboardState.filters.salesChannels[0] : 'Sales Channel';
          }
        } else {
          DashboardState.filters.salesChannels = [];
          salesChannelOptions.innerHTML = '<p class="text-[10px] text-slate-400">No channels available.</p>';
          salesChannelSummary.textContent = '0';
          if (salesChannelLabel) salesChannelLabel.textContent = 'Sales Channel';
        }
      }

      if (lastDealSelect) {
        if (lastDealKey) {
          const existingEntry = DashboardState.filters.columnFilters[lastDealKey];
          if (!preserveSelections) {
            DashboardState.filters.lastLeadSelection = true;
          }
          if (preserveSelections && existingEntry?.select && existingEntry.select !== 'all') {
            DashboardState.filters.lastLeadSelection = normalizeBoolean(existingEntry.select);
          } else if (preserveSelections && existingEntry?.select === 'all') {
            DashboardState.filters.lastLeadSelection = 'all';
          }
          DashboardState.filters.lastLeadFilterActive = DashboardState.filters.lastLeadSelection !== 'all';
          DashboardState.filters.columnFilters[lastDealKey] = {
            select: DashboardState.filters.lastLeadSelection === 'all'
              ? 'all'
              : (DashboardState.filters.lastLeadSelection ? 'true' : 'false'),
            search: '',
          };
        } else if (!preserveSelections) {
          DashboardState.filters.lastLeadFilterActive = false;
        }
        lastDealSelect.disabled = !lastDealKey;
        lastDealSelect.classList.toggle('opacity-50', !lastDealKey);
        lastDealSelect.classList.toggle('cursor-not-allowed', !lastDealKey);
        lastDealSelect.value = DashboardState.filters.lastLeadSelection === 'all'
          ? 'all'
          : (DashboardState.filters.lastLeadSelection ? 'true' : 'false');
      }

      categoryBlock?.classList.toggle('hidden', categoryKeys.length === 0);
      dateRangeBlock?.classList.toggle('hidden', !dateKey);
      builder?.classList.toggle('opacity-50', DashboardState.ui.isLoading);
    };

    const applyFilters = ({ ignoreChartFilter = false, ignoreChartId = null } = {}) => {
      const { filters } = DashboardState;

      return getCurrentDataset().filter((item) => {
        if (filters.lastLeadFilterActive && filters.lastLeadSelection !== 'all' && item.isLastDeal !== filters.lastLeadSelection) return false;
        const dateValue = filters.dateKey ? item[filters.dateKey] : null;
        const parsedDate = dateValue ? new Date(dateValue) : null;
        const dateString = parsedDate && !Number.isNaN(parsedDate.getTime()) ? parsedDate.toISOString().slice(0, 10) : '';
        const inDateRange = !filters.dateKey || (
          (!filters.dateRange.start || dateString >= filters.dateRange.start) &&
          (!filters.dateRange.end || dateString <= filters.dateRange.end)
        );

        if ((filters.dateRange.start || filters.dateRange.end) && !dateString) return false;

        const categoryMatch = Object.entries(filters.categoryFilters || {}).every(([key, value]) => {
          if (value === 'all') return true;
          return String(item[key] ?? '') === value;
        });

        const salesChannelMatch = !filters.salesChannelKey || !filters.salesChannels.length
          || filters.salesChannels.includes(String(item[filters.salesChannelKey] ?? ''));

        const unitTypeSelections = Array.isArray(filters.unitTypeSelection) ? filters.unitTypeSelection : [];
        const unitTypeMatch = !filters.unitTypeKey
          || !unitTypeSelections.length
          || unitTypeSelections.includes(String(item[filters.unitTypeKey] ?? ''));

        const vehicleStatusSelections = Array.isArray(filters.vehicleStatusSelection)
          ? filters.vehicleStatusSelection
          : [];
        const vehicleStatusMatch = !filters.vehicleStatusKey
          || !vehicleStatusSelections.length
          || vehicleStatusSelections.includes(String(item[filters.vehicleStatusKey] ?? ''));

        const columnMatch = Object.entries(filters.columnFilters || {}).every(([key, entry]) => {
          if (!entry) return true;
          const value = item[key];
          const valueString = String(value ?? '');
          if (filters.lastLeadKey && key === filters.lastLeadKey && filters.lastLeadFilterActive) {
            if (entry.select && entry.select !== 'all') {
              const desired = normalizeBoolean(entry.select);
              if (normalizeBoolean(value) !== desired) return false;
            }
          } else if (entry.select && entry.select !== 'all' && valueString !== entry.select) {
            return false;
          }
          if (entry.search && !valueString.toLowerCase().includes(entry.search)) return false;
          return true;
        });

        const activeChartFilters = !ignoreChartFilter && filters.chartFilters
          ? Object.entries(filters.chartFilters)
            .filter(([chartId]) => !ignoreChartId || chartId !== ignoreChartId)
            .map(([, filter]) => filter)
          : [];
        const chartMatch = ignoreChartFilter || !activeChartFilters.length
          || activeChartFilters.every((filter) => {
            const values = Array.isArray(filter.values) ? filter.values : [];
            if (!values.length) return true;
            return values.includes(getSegmentLabel(item[filter.key]));
          });

        return inDateRange && categoryMatch && salesChannelMatch && unitTypeMatch && vehicleStatusMatch && columnMatch && chartMatch;
      });
    };

    const getSegmentLabel = (value) => String(value ?? '').trim() || 'Unassigned';
    const getSegmentOptions = () => {
      const options = [{ key: 'dealStatus', label: 'Deal Status' }];
      const seen = new Set(options.map((opt) => opt.key));
      DashboardState.schema
        .filter((col) => ['string', 'number', 'boolean'].includes(col.type))
        .forEach((col) => {
          if (seen.has(col.key)) return;
          seen.add(col.key);
          options.push({ key: col.key, label: col.label || formatColumnLabel(col.key) });
        });
      return options;
    };

    const ensureChartVisibilityState = (chartId, segmentKey) => {
      if (!DashboardState.chartVisibility[chartId]) DashboardState.chartVisibility[chartId] = {};
      if (!Array.isArray(DashboardState.chartVisibility[chartId][segmentKey])) {
        DashboardState.chartVisibility[chartId][segmentKey] = [];
      }
      return DashboardState.chartVisibility[chartId][segmentKey];
    };

    const setChartHiddenValues = (chartId, segmentKey, values) => {
      if (!DashboardState.chartVisibility[chartId]) DashboardState.chartVisibility[chartId] = {};
      DashboardState.chartVisibility[chartId][segmentKey] = values;
      const activeFilters = DashboardState.filters.chartFilters || {};
      Object.entries(activeFilters).forEach(([filterChartId, filter]) => {
        if (filter.key !== segmentKey) return;
        const currentValues = Array.isArray(filter.values) ? filter.values : [];
        const nextValues = currentValues.filter((value) => !values.includes(value));
        if (!nextValues.length) {
          delete DashboardState.filters.chartFilters[filterChartId];
        } else {
          DashboardState.filters.chartFilters[filterChartId] = { key: segmentKey, values: nextValues };
        }
      });
    };

    const renderSegmentFieldOptions = (chartId, segmentKey, segmentValues) => {
      const panel = document.querySelector(`[data-segment-filter-panel][data-chart-id="${chartId}"]`);
      const optionsContainer = document.querySelector(`[data-segment-filter-options][data-chart-id="${chartId}"]`);
      const summary = document.querySelector(`[data-segment-filter-count][data-chart-id="${chartId}"]`);
      if (!panel || !optionsContainer || !summary) return;

      panel.dataset.segmentKey = segmentKey;
      if (!DashboardState.chartVisibilityOptions[chartId]) DashboardState.chartVisibilityOptions[chartId] = {};
      DashboardState.chartVisibilityOptions[chartId][segmentKey] = segmentValues;

      const hiddenValues = ensureChartVisibilityState(chartId, segmentKey);
      const hiddenSet = new Set(hiddenValues);
      const hiddenVisibleCount = segmentValues.reduce((count, value) => count + (hiddenSet.has(value) ? 1 : 0), 0);
      setChartHiddenValues(chartId, segmentKey, hiddenValues.slice());

      const visibleCount = Math.max(0, segmentValues.length - hiddenVisibleCount);
      summary.textContent = segmentValues.length ? `${visibleCount}/${segmentValues.length}` : '0';

      if (!segmentValues.length) {
        optionsContainer.innerHTML = '<p class="text-[11px] text-slate-400">No fields available.</p>';
        return;
      }

      optionsContainer.innerHTML = segmentValues.map((value) => {
        const safeValue = String(value);
        const safeValueAttr = safeValue.replace(/"/g, '&quot;');
        const isChecked = !hiddenValues.includes(safeValue);
        return `
          <label class="flex items-center gap-2 rounded-xl border border-slate-800 bg-slate-950/60 px-2 py-1 text-[11px] font-semibold text-slate-200">
            <input type="checkbox" class="h-3.5 w-3.5 rounded border-slate-700 bg-slate-950 text-blue-400" data-segment-field-checkbox data-chart-id="${chartId}" data-segment-key="${segmentKey}" value="${safeValueAttr}" ${isChecked ? 'checked' : ''} />
            <span class="truncate">${safeValue}</span>
          </label>
        `;
      }).join('');
    };

    const renderUnitTypeFilters = () => {
      const container = document.getElementById('unit-type-filters');
      if (!container) return;
      const unitTypeKey = DashboardState.filters.unitTypeKey;
      if (!unitTypeKey) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      const values = getUniqueValues(getCurrentDataset(), unitTypeKey);
      const selections = Array.isArray(DashboardState.filters.unitTypeSelection)
        ? DashboardState.filters.unitTypeSelection.filter((value) => values.includes(value))
        : [];
      DashboardState.filters.unitTypeSelection = selections;
      if (!values.length) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      container.classList.remove('hidden');
      const optionHtml = values.map((value) => `
        <label class="flex items-center gap-2 text-xs">
          <input type="checkbox" value="${value}" class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950" ${selections.includes(value) ? 'checked' : ''} />
          <span>${value}</span>
        </label>
      `).join('');
      const count = selections.length;
      const labelText = count === 1 ? selections[0] : 'Unit Type';
      container.innerHTML = `
        <div class="relative">
          <button id="unit-type-toggle" type="button" class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200" aria-expanded="false">
            <span id="unit-type-label">${labelText}</span>
            <span id="unit-type-summary" class="rounded-full border border-slate-700 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300">${count}</span>
          </button>
          <div id="unit-type-panel" class="absolute left-1/2 z-40 mt-2 hidden w-56 max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg">
            <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Choose unit types</p>
            <div id="unit-type-options" class="mt-2 grid gap-2">
              ${optionHtml}
            </div>
          </div>
        </div>
      `;
    };

    const renderVehicleStatusFilters = () => {
      const container = document.getElementById('vehicle-status-filters');
      if (!container) return;
      const vehicleStatusKey = DashboardState.filters.vehicleStatusKey;
      if (!vehicleStatusKey) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      const values = getUniqueValues(getCurrentDataset(), vehicleStatusKey);
      const selections = Array.isArray(DashboardState.filters.vehicleStatusSelection)
        ? DashboardState.filters.vehicleStatusSelection.filter((value) => values.includes(value))
        : [];
      DashboardState.filters.vehicleStatusSelection = selections;
      if (!values.length) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      container.classList.remove('hidden');
      const optionHtml = values.map((value) => `
        <label class="flex items-center gap-2 text-xs">
          <input type="checkbox" value="${value}" class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950" ${selections.includes(value) ? 'checked' : ''} />
          <span>${value}</span>
        </label>
      `).join('');
      const count = selections.length;
      const labelText = count === 1 ? selections[0] : 'Vehicle Status';
      container.innerHTML = `
        <div class="relative">
          <button id="vehicle-status-toggle" type="button" class="flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200" aria-expanded="false">
            <span id="vehicle-status-label">${labelText}</span>
            <span id="vehicle-status-summary" class="rounded-full border border-slate-700 bg-slate-950/80 px-2 py-0.5 text-[10px] font-semibold text-slate-300">${count}</span>
          </button>
          <div id="vehicle-status-panel" class="absolute left-1/2 z-40 mt-2 hidden w-56 max-w-[calc(100vw-2rem)] -translate-x-1/2 rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-xs text-slate-200 shadow-lg">
            <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Choose vehicle status</p>
            <div id="vehicle-status-options" class="mt-2 grid gap-2">
              ${optionHtml}
            </div>
          </div>
        </div>
      `;
    };

    const renderSegmentOptions = () => {
      const selects = document.querySelectorAll('[data-segment-select]');
      if (!selects.length) return;
      const options = getSegmentOptions();
      const fallbackKey = options[0]?.key || DEFAULT_SEGMENT_KEY;
      const optionsHtml = options
        .map((opt) => `<option value="${opt.key}">${opt.label}</option>`)
        .join('');
      selects.forEach((select) => {
        const chartId = select.dataset.chartId || 'default';
        const storedValue = DashboardState.chartSegments[chartId] || DashboardState.chartSegments.default;
        const nextValue = options.some((opt) => opt.key === storedValue) ? storedValue : fallbackKey;
        DashboardState.chartSegments[chartId] = nextValue;
        select.innerHTML = optionsHtml;
        select.value = nextValue;
      });
    };

    const computeDerivedState = () => {
      const filtered = applyFilters();
      const uniqueRecords = Array.from(
        filtered.reduce((acc, item) => {
          const key = item.stockNo || item.vin || item.id;
          if (!key) return acc;
          if (!acc.has(key)) acc.set(key, item);
          return acc;
        }, new Map()).values()
      );
      const activeCount = uniqueRecords.filter((i) => i.status === 'Active').length;
      const holdCount = uniqueRecords.filter((i) => i.hold || i.status === 'On Hold').length;

      DashboardState.derived = {
        filtered,
        kpis: { active: activeCount, hold: holdCount },
      };
    };

    const renderKpis = () => {
      const { kpis } = DashboardState.derived;
      const isLoading = DashboardState.ui.isLoading;
      const active = document.querySelector('[data-metric="active"]');
      const hold = document.querySelector('[data-metric="hold"]');
      [active, hold].forEach((el) => el.classList.toggle('animate-pulse', isLoading));

      if (isLoading) {
        active.textContent = hold.textContent = '...';
        return;
      }
      active.textContent = formatNumber(kpis.active);
      hold.textContent = formatNumber(kpis.hold);
    };

    const renderStatusBars = () => {
      const containers = document.querySelectorAll('[data-bar-chart]');
      renderSegmentOptions();
      containers.forEach((container) => {
        const chartId = container.dataset.chartId || 'default';
        const segmentKey = DashboardState.chartSegments[chartId] || DashboardState.chartSegments.default || DEFAULT_SEGMENT_KEY;
        const palette = chartId === 'status-secondary' ? DEAL_STATUS_COLORS_ALT : DEAL_STATUS_COLORS;
        if (DashboardState.ui.isLoading) {
          renderSegmentFieldOptions(chartId, segmentKey, []);
          container.innerHTML = Array.from({ length: 6 }).map(() => `
            <div class="flex h-full flex-col items-center justify-end">
              <span class="mb-1 text-[11px] font-semibold text-slate-500">...</span>
              <div class="h-full min-h-[140px] w-8 rounded-full bg-slate-800/70 overflow-hidden">
                <div class="h-full w-full animate-pulse bg-slate-700/70"></div>
              </div>
              <span class="mt-2 text-[10px] uppercase tracking-[0.2em] text-slate-500">...</span>
            </div>
          `).join('');
          return;
        }

        const dataset = DashboardState.derived.filtered;
        const segmentDataset = applyFilters({ ignoreChartId: chartId });
        const uniqueRecords = Array.from(
          dataset.reduce((acc, item) => {
            const key = item.stockNo || item.vin || item.id;
            if (!key) return acc;
            if (!acc.has(key)) acc.set(key, item);
            return acc;
          }, new Map()).values()
        );
        const segmentRecords = Array.from(
          segmentDataset.reduce((acc, item) => {
            const key = item.stockNo || item.vin || item.id;
            if (!key) return acc;
            if (!acc.has(key)) acc.set(key, item);
            return acc;
          }, new Map()).values()
        );
        const dealStatusCounts = uniqueRecords.reduce((acc, item) => {
          const key = getSegmentLabel(item[segmentKey]);
          acc[key] = (acc[key] || 0) + 1;
          return acc;
        }, {});
        const segmentValues = Array.from(
          new Set(segmentRecords.map((item) => getSegmentLabel(item[segmentKey])))
        ).sort((a, b) => a.localeCompare(b));
        renderSegmentFieldOptions(chartId, segmentKey, segmentValues);
        const hiddenValues = ensureChartVisibilityState(chartId, segmentKey);
        const hiddenSet = new Set(hiddenValues);
        const statusCounts = Object.entries(dealStatusCounts)
          .reduce((acc, [status, count]) => {
            acc[status] = count;
            return acc;
          }, {});
        const statusList = segmentValues
          .filter((status) => !hiddenSet.has(status))
          .map((status) => ({ status, count: statusCounts[status] || 0 }))
          .sort((a, b) => a.status.localeCompare(b.status));
        const maxCount = Math.max(1, ...statusList.map((i) => i.count));
        const statusBars = statusList.map((i, index) => ({
          ...i,
          percentage: Math.round((i.count / maxCount) * 100),
          color: palette[index % palette.length],
        }));

        if (!statusBars.length) {
          container.innerHTML = segmentValues.length
            ? '<p class="col-span-6 text-center text-xs text-slate-400">All fields are hidden.</p>'
            : '<p class="col-span-6 text-center text-xs text-slate-400">No vehicles match current filters.</p>';
          return;
        }

        container.innerHTML = statusBars.map((item) => {
          const activeFilter = DashboardState.filters.chartFilters?.[chartId];
          const activeValues = Array.isArray(activeFilter?.values) ? activeFilter.values : [];
          const isActive = activeFilter
            && activeFilter.key === segmentKey
            && activeValues.includes(item.status);
          const isDisabled = activeFilter && activeValues.length > 0 && !isActive;
          const activeClass = isActive ? 'ring-2 ring-blue-400/70 bg-slate-900/50' : '';
          const dimClass = isDisabled ? 'opacity-40 grayscale cursor-not-allowed' : '';
          const hoverClass = isDisabled ? '' : 'hover:bg-slate-900/60';
          const countClass = isDisabled ? 'text-slate-500' : 'text-slate-200';
          const labelClass = isDisabled ? 'text-slate-500' : 'text-slate-400';
          const disabledAttr = isDisabled ? 'disabled aria-disabled="true"' : '';
          return `
          <button type="button" data-status="${item.status}" data-segment-key="${segmentKey}" data-chart-id="${chartId}" class="group flex h-full flex-col items-center justify-end rounded-2xl px-1 py-1 transition ${hoverClass} ${activeClass} ${dimClass}" ${disabledAttr}>
            <span class="mb-1 text-[11px] font-semibold ${countClass}">${item.count}</span>
            <div class="flex h-full min-h-[140px] w-8 items-end rounded-full bg-slate-800/70">
              <div class="bar-fill w-full rounded-full bg-gradient-to-t ${item.color}" style="height: 0%;" data-height="${item.percentage}%"></div>
            </div>
            <span class="mt-2 text-[10px] uppercase tracking-[0.2em] transition duration-200 ease-out group-hover:scale-110 group-hover:text-slate-100 ${labelClass}">${item.status}</span>
          </button>
        `;
        }).join('');
        requestAnimationFrame(() => {
          container.querySelectorAll('.bar-fill').forEach((bar) => {
            const targetHeight = bar.dataset.height;
            if (targetHeight) bar.style.height = targetHeight;
          });
        });
      });
    };


    const renderActiveFilters = () => {
      const chipsContainer = document.getElementById('active-filters');
      if (!chipsContainer) return;
      const { filters } = DashboardState;
      const chips = [];

      if (filters.dateRange.start) chips.push(`Date: From ${filters.dateRange.start}`);
      if (filters.salesChannelKey && filters.salesChannels.length) {
        chips.push(`${getColumnLabel(filters.salesChannelKey)}: ${filters.salesChannels.join(', ')}`);
      }
      const unitTypeSelections = Array.isArray(filters.unitTypeSelection) ? filters.unitTypeSelection : [];
      if (filters.unitTypeKey && unitTypeSelections.length) {
        chips.push(`${getColumnLabel(filters.unitTypeKey)}: ${unitTypeSelections.join(', ')}`);
      }
      const vehicleStatusSelections = Array.isArray(filters.vehicleStatusSelection)
        ? filters.vehicleStatusSelection
        : [];
      if (filters.vehicleStatusKey && vehicleStatusSelections.length) {
        chips.push(`${getColumnLabel(filters.vehicleStatusKey)}: ${vehicleStatusSelections.join(', ')}`);
      }
      Object.entries(filters.categoryFilters || {}).forEach(([key, value]) => {
        if (value !== 'all') chips.push(`${getColumnLabel(key)}: ${value}`);
      });
      Object.values(filters.chartFilters || {}).forEach((filter) => {
        const values = Array.isArray(filter.values) ? filter.values : [];
        if (!values.length) return;
        chips.push(`${getColumnLabel(filter.key)}: ${values.join(', ')}`);
      });

      chipsContainer.innerHTML = chips.length
        ? chips.map((c) => `<span class="${PILL_CLASSES} whitespace-nowrap text-slate-200">${c}</span>`).join('')
        : '<span class="text-slate-400">No active filters</span>';
    };

    const renderTableHead = () => {
      const head = document.getElementById('inventory-table-head');
      const visibleColumns = getOrderedColumns(DashboardState.schema)
        .filter((c) => DashboardState.table.columns[c.key]);
      const sortState = DashboardState.table.sort;
      const colgroup = document.getElementById('inventory-table-cols');
      const dataset = getCurrentDataset();

      if (!visibleColumns.length) {
        head.innerHTML = '<tr><th class="px-3 py-2 text-left text-[10px] uppercase tracking-[0.3em] text-slate-400">No columns</th></tr>';
        if (colgroup) colgroup.innerHTML = '';
        return;
      }

      if (colgroup) {
        colgroup.innerHTML = visibleColumns.map((c) => {
          const width = DashboardState.table.columnWidths[c.key];
          const style = typeof width === 'number' ? ` style="width: ${width}px"` : '';
          return `<col data-col-key="${c.key}"${style} />`;
        }).join('');
      }

      head.innerHTML = `
        <tr>${visibleColumns.map((c) => {
        const isSorted = sortState.key === c.key;
        const indicator = isSorted ? (sortState.direction === 'asc' ? 'â–²' : 'â–¼') : '';
        const width = DashboardState.table.columnWidths[c.key];
        const style = typeof width === 'number' ? ` style="width: ${width}px"` : '';
        const values = getUniqueValues(dataset, c.key).slice(0, 50);
        const entry = DashboardState.filters.columnFilters[c.key] || { select: 'all', search: '' };
        DashboardState.filters.columnFilters[c.key] = entry;
        return `
              <th class="relative px-3 py-2" data-col-key="${c.key}" draggable="true"${style}>
                <div class="flex items-center gap-2">
                  <button type="button" data-sort="${c.key}" class="flex items-center gap-1 text-left text-[10px] uppercase tracking-[0.3em] text-slate-400" aria-label="Sort by ${c.label}">
                    <span class="whitespace-normal break-words">${c.label}</span>
                    <span class="text-[10px] text-blue-300">${indicator}</span>
                  </button>
                  <button type="button" data-column-filter-toggle="${c.key}" class="inline-flex h-5 w-5 items-center justify-center rounded-full border border-slate-800 bg-slate-950/70 text-slate-300 transition hover:text-white" aria-label="Filter ${c.label}">
                    <i data-lucide="sliders-horizontal" class="h-3 w-3"></i>
                  </button>
                </div>
                <div class="column-filter-panel absolute left-0 top-full z-40 mt-2 hidden w-56 max-w-[calc(100vw-2rem)] rounded-2xl border border-slate-800 bg-slate-950/95 p-3 text-[10px] font-semibold text-slate-200 shadow-lg" data-column-filter-panel="${c.key}">
                  <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">${c.label}</p>
                  <div class="mt-2 grid gap-1">
                    <select data-column-filter="${c.key}" class="h-7 rounded-lg border border-slate-800 bg-slate-950/70 px-2 text-[10px] font-semibold text-slate-200">
                      <option value="all">All</option>
                      ${values.map((value) => `<option value="${value}" ${entry.select === value ? 'selected' : ''}>${value}</option>`).join('')}
                    </select>
                    <input type="search" data-column-search="${c.key}" value="${entry.search || ''}" placeholder="Search" class="h-7 rounded-lg border border-slate-800 bg-slate-950/70 px-2 text-[10px] font-semibold text-slate-200" />
                  </div>
                </div>
                <span class="column-resizer absolute right-0 top-2 h-4 w-2 cursor-col-resize rounded-full bg-slate-800/60 transition hover:bg-slate-500/80" data-resize-handle="${c.key}"></span>
              </th>
            `;
      }).join('')
        }</tr>
      `;
    };

    const renderTable = () => {
      const tableBody = document.getElementById('inventory-table');
      const visibleColumns = getOrderedColumns(DashboardState.schema)
        .filter((c) => DashboardState.table.columns[c.key]);
      const columnCount = Math.max(1, visibleColumns.length);
      const invPrepKey = detectInvPrepStatusKey(DashboardState.schema);

      if (DashboardState.ui.isLoading) {
        tableBody.innerHTML = Array.from({ length: DashboardState.table.perPage }).map(() => `
          <tr class="text-xs">
            <td class="px-3 py-3" colspan="${columnCount}">
              <div class="h-3 w-full rounded-full bg-slate-800/70 animate-pulse"></div>
            </td>
          </tr>
        `).join('');
        return;
      }

      if (!visibleColumns.length) {
        tableBody.innerHTML = `<tr><td class="px-3 py-6 text-center text-sm text-slate-400" colspan="${columnCount}">No columns available.</td></tr>`;
        return;
      }

      const sortedRows = [...DashboardState.derived.filtered].sort((a, b) => {
        const { key, direction } = DashboardState.table.sort;
        const column = DashboardState.schema.find((c) => c.key === key);
        if (!column) return 0;

        const getValue = (item) => item[key];

        const va = getValue(a);
        const vb = getValue(b);

        let comparison = 0;
        if (column.type === 'date') {
          const getDateValue = (value) => {
            if (value === null || value === undefined || value === '') return 0;
            if (value instanceof Date) {
              const time = value.getTime();
              return Number.isNaN(time) ? 0 : time;
            }
            if (typeof value === 'number') {
              return Number.isFinite(value) ? value : 0;
            }
            const parsed = Date.parse(String(value));
            return Number.isNaN(parsed) ? 0 : parsed;
          };
          const da = getDateValue(va);
          const db = getDateValue(vb);
          comparison = da - db;
        } else if (column.type === 'number') {
          comparison = (Number(va) || 0) - (Number(vb) || 0);
        } else if (column.type === 'boolean') {
          comparison = (va ? 1 : 0) - (vb ? 1 : 0);
        } else {
          comparison = String(va ?? '').localeCompare(String(vb ?? ''), undefined, { sensitivity: 'base' });
        }

        if (comparison === 0) return 0;
        return direction === 'asc' ? comparison : -comparison;
      });

      const totalRows = sortedRows.length;
      const totalPages = Math.max(1, Math.ceil(totalRows / DashboardState.table.perPage));
      const currentPage = Math.min(DashboardState.table.page, totalPages);
      DashboardState.table.page = currentPage;

      const startIndex = (currentPage - 1) * DashboardState.table.perPage;
      const pageItems = sortedRows.slice(startIndex, startIndex + DashboardState.table.perPage);
      const rangeStart = totalRows ? startIndex + 1 : 0;
      const rangeEnd = totalRows ? startIndex + pageItems.length : 0;

      const rowsHtml = pageItems.map((item) => {
        const prepStatus = getInvPrepStatusValue(item, invPrepKey);
        const prepClass = getInvPrepStatusRowClass(prepStatus);
        const cells = visibleColumns.map((col) => {
          let value = item[col.key];

          if (col.type === 'boolean') value = value ? 'Yes' : 'No';
          else if (col.type === 'date') value = value ? formatDate(value) : '--';
          else if (MILEAGE_COLUMNS.has(col.key.toLowerCase()) || col.label?.toLowerCase() === 'mileage') {
            value = formatMileage(value);
          } else if (
            CURRENCY_COLUMNS.has(col.key.toLowerCase())
            || (col.label && CURRENCY_COLUMNS.has(col.label.toLowerCase()))
          ) {
            value = formatCurrency(value);
          }

          if (value === null || value === undefined || value === '') value = '--';

          const width = DashboardState.table.columnWidths[col.key];
          const style = typeof width === 'number' ? ` style="width: ${width}px"` : '';
          return `<td class="px-3 py-2 whitespace-normal break-words"${style}>${value}</td>`;
        }).join('');

        return `<tr class="text-xs ${prepClass} hover:bg-slate-900/60 cursor-pointer transition" data-row-key="${getVehicleKey(item)}">${cells}</tr>`;
      }).join('');

      tableBody.innerHTML = rowsHtml || `<tr><td class="px-3 py-6 text-center text-sm text-slate-400" colspan="${columnCount}">No vehicles match current filters.</td></tr>`;

      document.getElementById('table-summary').textContent = `${formatNumber(rangeStart)}â€“${formatNumber(rangeEnd)} of ${formatNumber(totalRows)}`;
      document.getElementById('table-page').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('table-prev').disabled = currentPage <= 1;
      document.getElementById('table-next').disabled = currentPage >= totalPages;
      const goToInput = document.getElementById('table-go-to');
      if (goToInput) {
        goToInput.max = String(totalPages);
        goToInput.value = String(currentPage);
      }
      const perPageSelect = document.getElementById('table-per-page');
      if (perPageSelect) {
        perPageSelect.value = String(DashboardState.table.perPage);
      }
    };

    const renderDashboard = () => {
      renderUnitTypeFilters();
      renderVehicleStatusFilters();
      computeDerivedState();
      renderUnitTypeFilters();
      renderVehicleStatusFilters();
      renderKpis();
      renderStatusBars();
      renderTableHead();
      renderTable();
      renderActiveFilters();
      syncTopScrollbar();
      lucide?.createIcons?.();
      const loadingOverlay = document.getElementById('inventory-loading');
      if (loadingOverlay) {
        loadingOverlay.classList.toggle('hidden', !DashboardState.ui.isLoading);
      }
    };

    const initializeTablePreferences = () => {
      let saved = DashboardState.preferences.config?.table?.columns || {};
      if (!Object.keys(saved).length) {
        try {
          const stored = localStorage.getItem(COLUMN_STORAGE_KEY);
          saved = stored ? JSON.parse(stored) : {};
        } catch {
          saved = {};
        }
      }
      const defaults = DashboardState.schema.reduce((acc, c) => ((acc[c.key] = true), acc), {});
      DashboardState.table.columns = DashboardState.schema.reduce((acc, column) => {
        acc[column.key] = saved[column.key] ?? defaults[column.key] ?? true;
        return acc;
      }, {});
      if (!DashboardState.table.columnOrder.length) {
        DashboardState.table.columnOrder = DashboardState.schema.map((c) => c.key);
      } else {
        const known = new Set(DashboardState.schema.map((c) => c.key));
        DashboardState.table.columnOrder = DashboardState.table.columnOrder.filter((key) => known.has(key));
        DashboardState.schema.forEach((c) => {
          if (!DashboardState.table.columnOrder.includes(c.key)) {
            DashboardState.table.columnOrder.push(c.key);
          }
        });
      }
      if (!DashboardState.schema.some((c) => c.key === DashboardState.table.sort.key)) {
        DashboardState.table.sort = { key: DashboardState.schema[0]?.key || '', direction: 'asc' };
      }
      renderColumnChooser();
    };

    const renderColumnChooser = () => {
      const container = document.getElementById('column-chooser-options');
      if (!DashboardState.schema.length) {
        container.innerHTML = '<p class="text-xs text-slate-400">No columns available.</p>';
        return;
      }
      const sortedSchema = [...DashboardState.schema].sort((a, b) => a.label.localeCompare(b.label));
      container.innerHTML = sortedSchema.map((c) => `
        <label class="flex items-center gap-2 text-xs">
          <input type="checkbox" value="${c.key}" class="h-3.5 w-3.5 rounded border-slate-600 bg-slate-950" ${DashboardState.table.columns[c.key] ? 'checked' : ''} />
          <span class="flex-1">${c.label}</span>
          <button type="button" class="rounded-full border border-slate-700 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-300 transition hover:border-blue-500 hover:text-white" data-column-edit="${c.key}">
            Edit
          </button>
        </label>
      `).join('');
    };

    const openDrawer = (record) => {
      document.getElementById('drawer-vin').textContent = record.vin || '--';
      document.getElementById('drawer-status').textContent = record.status || '--';
      document.getElementById('drawer-gps-status').textContent = record.gpsStatus || '--';
      document.getElementById('drawer-gps-flag').textContent = record.gpsFlag ? `âš ï¸ ${record.gpsFlag}` : 'â€”';
      const completionValue = record.completion;
      let completionText = '--';
      if (completionValue !== null && completionValue !== undefined && completionValue !== '') {
        const rawCompletion = String(completionValue).trim();
        completionText = rawCompletion ? (rawCompletion.endsWith('%') ? rawCompletion : `${rawCompletion}%`) : '--';
      }
      document.getElementById('drawer-completion').textContent = completionText;
      document.getElementById('drawer-location').textContent = `${record.yard || '--'}, ${record.state || '--'}`;
      document.getElementById('drawer-unit').textContent = `${record.brand || '--'} ${record.unitType || ''}`.trim() || '--';

      const flags = [
        record.gpsOffline ? 'GPS Offline' : null,
        record.hold ? 'Hold' : null,
        record.lien ? 'Lien' : null,
        record.recoveryPriority ? 'Recovery Priority' : null,
      ].filter(Boolean).join(' â€¢ ');

      document.getElementById('drawer-flags').textContent = flags || 'None';

      const timeline = [
        { label: 'Created', value: record.createdAt || record.date },
        { label: 'Last updated', value: record.updatedAt || record.date },
      ];

      document.getElementById('drawer-timeline').innerHTML = timeline.map((e) => `
        <li class="flex items-center justify-between rounded-xl border border-slate-800 bg-slate-900/70 px-3 py-2">
          <span>${e.label}</span>
          <span class="text-slate-200">${e.value ? formatDate(e.value) : '--'}</span>
        </li>
      `).join('');

      document.getElementById('row-drawer').classList.remove('translate-x-full');
    };

    const closeDrawer = () => document.getElementById('row-drawer').classList.add('translate-x-full');

    const exportCsv = () => {
      const visibleColumns = DashboardState.schema.filter((c) => DashboardState.table.columns[c.key]);
      if (!visibleColumns.length) return;
      const rows = DashboardState.derived.filtered.map((item) =>
        visibleColumns.map((c) => {
          let value = item[c.key];
          if (c.type === 'boolean') value = value ? 'Yes' : 'No';
          if (c.type === 'date') value = value ? formatDate(value) : '';
          return `"${String(value ?? '').replace(/\"/g, '""')}"`;
        })
      );
      const header = visibleColumns.map((c) => `"${c.label}"`).join(',');
      const csv = [header, ...rows.map((r) => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'inventory-export.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    };

    let syncTopScrollbar = () => { };

    const bindFilterEvents = () => {
      const builder = document.getElementById('filter-builder');
      const resetFiltersButton = document.getElementById('reset-filters');
      const tablePrev = document.getElementById('table-prev');
      const tableNext = document.getElementById('table-next');
      const perPageSelect = document.getElementById('table-per-page');
      const goToInput = document.getElementById('table-go-to');
      const tableHead = document.getElementById('inventory-table-head');
      const inventoryTable = document.getElementById('inventory-table');
      const tableScroll = document.getElementById('inventory-table-scroll');
      const tableScrollTop = document.getElementById('inventory-table-scroll-top');
      const tableScrollTopInner = document.getElementById('inventory-table-scroll-top-inner');
      const salesChannelToggle = document.getElementById('sales-channel-toggle');
      const salesChannelPanel = document.getElementById('sales-channel-panel');
      const salesChannelOptions = document.getElementById('sales-channel-options');
      const salesChannelSummary = document.getElementById('sales-channel-summary');
      const salesChannelLabel = document.getElementById('sales-channel-label');
      const unitTypeFilters = document.getElementById('unit-type-filters');
      const unitTypeToggle = document.getElementById('unit-type-toggle');
      const unitTypePanel = document.getElementById('unit-type-panel');
      const unitTypeOptions = document.getElementById('unit-type-options');
      const unitTypeSummary = document.getElementById('unit-type-summary');
      const unitTypeLabel = document.getElementById('unit-type-label');
      const vehicleStatusFilters = document.getElementById('vehicle-status-filters');
      const vehicleStatusToggle = document.getElementById('vehicle-status-toggle');
      const vehicleStatusPanel = document.getElementById('vehicle-status-panel');
      const vehicleStatusOptions = document.getElementById('vehicle-status-options');
      const vehicleStatusSummary = document.getElementById('vehicle-status-summary');
      const vehicleStatusLabel = document.getElementById('vehicle-status-label');
      const lastDealSelect = document.getElementById('last-deal-select');
      const alertsToggle = document.getElementById('alerts-toggle');
      const alertsList = document.getElementById('alerts-list');
      const alertsBadges = document.getElementById('alerts-badges');
      const alertsPanel = document.getElementById('alerts-panel');
      const drawerClose = document.getElementById('drawer-close');
      const columnChooser = document.getElementById('column-chooser');
      const columnChooserToggle = document.getElementById('column-chooser-toggle');
      const columnChooserOptions = document.getElementById('column-chooser-options');
      const exportCsvButton = document.getElementById('export-csv');
      const segmentSelects = document.querySelectorAll('[data-segment-select]');
      const chartContainers = document.querySelectorAll('[data-bar-chart]');
      const segmentFilterToggles = document.querySelectorAll('[data-segment-filter-toggle]');
      const segmentFilterPanels = document.querySelectorAll('[data-segment-filter-panel]');
      const fullChartToggles = document.querySelectorAll('[data-full-chart-toggle]');
      const fullChartBodies = document.querySelectorAll('[data-full-chart-body]');
      const fullChartCards = document.querySelectorAll('[data-full-chart-card]');
      const fullChartResizer = document.getElementById('full-chart-height-resizer');

      const addListener = (element, event, handler, options) => {
        element?.addEventListener(event, handler, options);
      };

      const resetPagination = () => (DashboardState.table.page = 1);
      let activeDragKey = null;
      let resizing = null;

      if (tableScroll && tableScrollTop && tableScrollTopInner) {
        const tableElement = tableScroll.querySelector('table');
        const updateTopWidth = () => {
          if (!tableElement) return;
          tableScrollTopInner.style.width = `${tableElement.scrollWidth}px`;
        };

        const syncScroll = (source, target) => {
          if (target.scrollLeft === source.scrollLeft) return;
          target.scrollLeft = source.scrollLeft;
        };

        syncTopScrollbar = () => {
          updateTopWidth();
        };

        updateTopWidth();
        if (tableElement) {
          const resizeObserver = new ResizeObserver(updateTopWidth);
          resizeObserver.observe(tableElement);
          resizeObserver.observe(tableScroll);
        }
        addListener(tableScroll, 'scroll', () => syncScroll(tableScroll, tableScrollTop));
        addListener(tableScrollTop, 'scroll', () => syncScroll(tableScrollTop, tableScroll));
      }

      if (alertsToggle && alertsList && alertsBadges && alertsPanel) {
        addListener(alertsToggle, 'click', () => {
          const isCollapsed = alertsPanel.dataset.collapsed === 'true';
          const nextCollapsed = !isCollapsed;
          alertsPanel.dataset.collapsed = String(nextCollapsed);
          alertsList.classList.toggle('hidden', nextCollapsed);
          alertsBadges.classList.toggle('hidden', !nextCollapsed);
          alertsToggle.setAttribute('aria-expanded', String(!nextCollapsed));
          const icon = alertsToggle.querySelector('[data-lucide]');
          updateLucideIcon(icon, nextCollapsed ? 'chevron-down' : 'chevron-up');
        });
      }

      if (builder) {
        addListener(builder, 'change', (event) => {
          const target = event.target;
          if (target.matches('[data-filter-category]')) {
            const key = target.dataset.filterCategory;
            DashboardState.filters.categoryFilters[key] = target.value;
            resetPagination();
            renderDashboard();
            schedulePersistPreferences();
          }
          if (target.matches('#filter-start-date')) {
            DashboardState.filters.dateRange.start = document.getElementById('filter-start-date')?.value || '';
            DashboardState.filters.dateRange.end = '';
            resetPagination();
            renderDashboard();
            schedulePersistPreferences();
          }
        });
      }

      if (unitTypeFilters) {
        addListener(unitTypeFilters, 'click', (event) => {
          const toggle = event.target.closest('#unit-type-toggle');
          if (!toggle) return;
          const panel = unitTypeFilters.querySelector('#unit-type-panel');
          if (!panel) return;
          const isHidden = panel.classList.toggle('hidden');
          toggle.setAttribute('aria-expanded', String(!isHidden));
        });

        addListener(unitTypeFilters, 'change', (event) => {
          const input = event.target;
          if (!input.matches('input[type="checkbox"]')) return;
          const options = unitTypeFilters.querySelector('#unit-type-options');
          const summary = unitTypeFilters.querySelector('#unit-type-summary');
          const label = unitTypeFilters.querySelector('#unit-type-label');
          const checked = Array.from(options?.querySelectorAll('input[type="checkbox"]') || [])
            .filter((item) => item.checked)
            .map((item) => item.value);
          DashboardState.filters.unitTypeSelection = checked;
          if (summary) summary.textContent = String(checked.length);
          if (label) {
            label.textContent = checked.length === 1 ? checked[0] : 'Unit Type';
          }
          resetPagination();
          renderDashboard();
          schedulePersistPreferences();
        });
      }

      if (vehicleStatusFilters) {
        addListener(vehicleStatusFilters, 'click', (event) => {
          const toggle = event.target.closest('#vehicle-status-toggle');
          if (!toggle) return;
          const panel = vehicleStatusFilters.querySelector('#vehicle-status-panel');
          if (!panel) return;
          const isHidden = panel.classList.toggle('hidden');
          toggle.setAttribute('aria-expanded', String(!isHidden));
        });

        addListener(vehicleStatusFilters, 'change', (event) => {
          const input = event.target;
          if (!input.matches('input[type="checkbox"]')) return;
          const options = vehicleStatusFilters.querySelector('#vehicle-status-options');
          const summary = vehicleStatusFilters.querySelector('#vehicle-status-summary');
          const label = vehicleStatusFilters.querySelector('#vehicle-status-label');
          const checked = Array.from(options?.querySelectorAll('input[type="checkbox"]') || [])
            .filter((item) => item.checked)
            .map((item) => item.value);
          DashboardState.filters.vehicleStatusSelection = checked;
          if (summary) summary.textContent = String(checked.length);
          if (label) {
            label.textContent = checked.length === 1 ? checked[0] : 'Vehicle Status';
          }
          resetPagination();
          renderDashboard();
          schedulePersistPreferences();
        });
      }

      addListener(resetFiltersButton, 'click', () => {
        setupFilters();
        resetPagination();
        renderDashboard();
        schedulePersistPreferences();
      });

      addListener(tablePrev, 'click', () => { DashboardState.table.page = Math.max(1, DashboardState.table.page - 1); renderDashboard(); });
      addListener(tableNext, 'click', () => { DashboardState.table.page += 1; renderDashboard(); });

      addListener(perPageSelect, 'change', () => {
        DashboardState.table.perPage = Number(perPageSelect.value);
        DashboardState.table.page = 1;
        renderDashboard();
        schedulePersistPreferences();
      });

      addListener(goToInput, 'change', () => {
        const totalRows = DashboardState.derived.filtered.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / DashboardState.table.perPage));
        const desired = Math.min(Math.max(1, Number(goToInput.value) || 1), totalPages);
        DashboardState.table.page = desired;
        renderDashboard();
      });

      addListener(columnChooserOptions, 'click', (event) => {
        const editButton = event.target.closest('[data-column-edit]');
        if (!editButton) return;
        const key = editButton.dataset.columnEdit;
        if (!key) return;
        const currentLabel = getColumnLabel(key);
        const nextLabel = window.prompt('Edit column name', currentLabel);
        if (nextLabel === null) return;
        setColumnLabelOverride(key, nextLabel);
        renderDashboard();
        schedulePersistPreferences();
      });

      addListener(tableHead, 'click', (event) => {
        const button = event.target.closest('[data-sort]');
        if (!button) return;
        const key = button.dataset.sort;
        if (DashboardState.table.sort.key === key) DashboardState.table.sort.direction = DashboardState.table.sort.direction === 'asc' ? 'desc' : 'asc';
        else { DashboardState.table.sort.key = key; DashboardState.table.sort.direction = 'asc'; }
        renderDashboard();
        schedulePersistPreferences();
      });

      const closeColumnFilterPanels = (exceptKey = null) => {
        tableHead?.querySelectorAll('[data-column-filter-panel]').forEach((panel) => {
          if (panel.dataset.columnFilterPanel === exceptKey) return;
          panel.classList.add('hidden');
        });
      };

      addListener(tableHead, 'click', (event) => {
        const toggle = event.target.closest('[data-column-filter-toggle]');
        if (!toggle) return;
        event.preventDefault();
        event.stopPropagation();
        const key = toggle.dataset.columnFilterToggle;
        const panel = tableHead.querySelector(`[data-column-filter-panel="${key}"]`);
        if (!panel) return;
        const isHidden = panel.classList.toggle('hidden');
        closeColumnFilterPanels(isHidden ? null : key);
      });

      addListener(tableHead, 'dragstart', (event) => {
        if (resizing) return;
        const th = event.target.closest('th[data-col-key]');
        if (!th || event.target.closest('[data-resize-handle]')) return;
        activeDragKey = th.dataset.colKey;
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', activeDragKey);
      });

      addListener(tableHead, 'dragover', (event) => {
        if (!activeDragKey) return;
        const th = event.target.closest('th[data-col-key]');
        if (!th) return;
        event.preventDefault();
      });

      addListener(tableHead, 'drop', (event) => {
        if (!activeDragKey) return;
        const th = event.target.closest('th[data-col-key]');
        if (!th) return;
        event.preventDefault();
        const targetKey = th.dataset.colKey;
        if (targetKey && targetKey !== activeDragKey) {
          const order = DashboardState.table.columnOrder.slice();
          const fromIndex = order.indexOf(activeDragKey);
          const toIndex = order.indexOf(targetKey);
          if (fromIndex !== -1 && toIndex !== -1) {
            order.splice(fromIndex, 1);
            order.splice(toIndex, 0, activeDragKey);
            DashboardState.table.columnOrder = order;
            renderDashboard();
            schedulePersistPreferences();
          }
        }
        activeDragKey = null;
      });

      addListener(tableHead, 'dragend', () => {
        activeDragKey = null;
      });

      addListener(inventoryTable, 'click', (event) => {
        const row = event.target.closest('[data-row-key]');
        if (!row) return;
        const record = DashboardState.vehiclesRaw.get(row.dataset.rowKey);
        if (record) openDrawer(record);
      });

      addListener(tableHead, 'change', (event) => {
        const target = event.target;
        if (!target.matches('[data-column-filter]')) return;
        const key = target.dataset.columnFilter;
        const entry = DashboardState.filters.columnFilters[key] || { select: 'all', search: '' };
        entry.select = target.value;
        DashboardState.filters.columnFilters[key] = entry;
        if (DashboardState.filters.lastLeadKey && key === DashboardState.filters.lastLeadKey) {
          DashboardState.filters.lastLeadSelection = target.value === 'all' ? 'all' : normalizeBoolean(target.value);
          DashboardState.filters.lastLeadFilterActive = target.value !== 'all';
          const lastDealSelect = document.getElementById('last-deal-select');
          if (lastDealSelect) {
            lastDealSelect.value = DashboardState.filters.lastLeadSelection === 'all'
              ? 'all'
              : (DashboardState.filters.lastLeadSelection ? 'true' : 'false');
          }
          setupFilters({ preserveSelections: true });
        }
        resetPagination();
        renderDashboard();
        schedulePersistPreferences();
      });

      addListener(tableHead, 'keydown', (event) => {
        const target = event.target;
        if (!target.matches('[data-column-search]')) return;
        if (event.key !== 'Enter') return;
        event.preventDefault();
        const key = target.dataset.columnSearch;
        const entry = DashboardState.filters.columnFilters[key] || { select: 'all', search: '' };
        entry.search = target.value.trim().toLowerCase();
        DashboardState.filters.columnFilters[key] = entry;
        resetPagination();
        renderDashboard();
        schedulePersistPreferences();
      });

      const onResizeMove = (event) => {
        if (!resizing) return;
        const delta = event.clientX - resizing.startX;
        const nextWidth = Math.max(60, resizing.startWidth + delta);
        resizing.currentWidth = nextWidth;
        if (resizing.col) resizing.col.style.width = `${nextWidth}px`;
      };

      const onResizeEnd = () => {
        if (!resizing) return;
        if (resizing.handle?.hasPointerCapture(resizing.pointerId)) {
          resizing.handle.releasePointerCapture(resizing.pointerId);
        }
        if (typeof resizing.currentWidth === 'number') {
          DashboardState.table.columnWidths[resizing.key] = resizing.currentWidth;
        }
        resizing = null;
        document.body.classList.remove('select-none');
        window.removeEventListener('pointermove', onResizeMove);
        schedulePersistPreferences();
        renderDashboard();
        syncTopScrollbar();
      };

      addListener(tableHead, 'pointerdown', (event) => {
        const handle = event.target.closest('[data-resize-handle]');
        if (!handle) return;
        event.preventDefault();
        event.stopPropagation();
        const key = handle.dataset.resizeHandle;
        const th = handle.closest('th');
        if (!key || !th) return;
        const colgroup = document.getElementById('inventory-table-cols');
        const col = colgroup?.querySelector(`col[data-col-key="${key}"]`);
        if (!col) return;
        handle.setPointerCapture(event.pointerId);
        resizing = {
          key,
          startX: event.clientX,
          startWidth: col.getBoundingClientRect().width,
          currentWidth: col.getBoundingClientRect().width,
          handle,
          pointerId: event.pointerId,
          col,
        };
        document.body.classList.add('select-none');
        window.addEventListener('pointermove', onResizeMove);
        window.addEventListener('pointerup', onResizeEnd, { once: true });
      });

      addListener(drawerClose, 'click', closeDrawer);

      addListener(columnChooserToggle, 'click', () => {
        if (!columnChooser) return;
        const isHidden = columnChooser.classList.toggle('hidden');
        columnChooserToggle.setAttribute('aria-expanded', String(!isHidden));
      });

      document.addEventListener('click', (event) => {
        if (!columnChooser || !columnChooserToggle) return;
        if (columnChooser.classList.contains('hidden')) return;
        if (columnChooser.contains(event.target) || columnChooserToggle.contains(event.target)) return;
        columnChooser.classList.add('hidden');
      });

      document.addEventListener('click', (event) => {
        if (!tableHead) return;
        if (tableHead.contains(event.target)) return;
        closeColumnFilterPanels();
      });

      addListener(columnChooserOptions, 'change', (event) => {
        const input = event.target;
        if (!input.matches('input[type="checkbox"]')) return;
        DashboardState.table.columns[input.value] = input.checked;
        renderDashboard();
        schedulePersistPreferences();
      });

      addListener(exportCsvButton, 'click', exportCsv);
      document.getElementById('erase-filters')?.addEventListener('click', () => {
        setupFilters();
        DashboardState.filters.chartFilters = {};
        resetPagination();
        renderDashboard();
        schedulePersistPreferences();
      });

      const closeSegmentFilterPanels = (exceptChartId = null) => {
        segmentFilterPanels.forEach((panel) => {
          if (panel.dataset.chartId === exceptChartId) return;
          panel.classList.add('hidden');
          const toggle = document.querySelector(`[data-segment-filter-toggle][data-chart-id="${panel.dataset.chartId}"]`);
          toggle?.setAttribute('aria-expanded', 'false');
        });
      };

      segmentFilterToggles.forEach((toggle) => {
        toggle.addEventListener('click', (event) => {
          event.stopPropagation();
          const chartId = toggle.dataset.chartId || 'default';
          const panel = document.querySelector(`[data-segment-filter-panel][data-chart-id="${chartId}"]`);
          if (!panel) return;
          const isHidden = panel.classList.toggle('hidden');
          toggle.setAttribute('aria-expanded', String(!isHidden));
          closeSegmentFilterPanels(isHidden ? null : chartId);
        });
      });

      document.addEventListener('click', (event) => {
        if (event.target.closest('[data-segment-filter-panel]') || event.target.closest('[data-segment-filter-toggle]')) return;
        closeSegmentFilterPanels();
      });

      document.addEventListener('change', (event) => {
        const input = event.target;
        if (!input.matches('[data-segment-field-checkbox]')) return;
        const chartId = input.dataset.chartId || 'default';
        const segmentKey = input.dataset.segmentKey || DEFAULT_SEGMENT_KEY;
        const hiddenValues = ensureChartVisibilityState(chartId, segmentKey).slice();
        const value = input.value;
        if (input.checked) {
          const nextHidden = hiddenValues.filter((item) => item !== value);
          setChartHiddenValues(chartId, segmentKey, nextHidden);
        } else if (!hiddenValues.includes(value)) {
          hiddenValues.push(value);
          setChartHiddenValues(chartId, segmentKey, hiddenValues);
        }
        renderDashboard();
        schedulePersistPreferences();
      });

      document.addEventListener('click', (event) => {
        const selectAll = event.target.closest('[data-segment-select-all]');
        const clearAll = event.target.closest('[data-segment-clear-all]');
        if (!selectAll && !clearAll) return;
        const chartId = (selectAll || clearAll).dataset.chartId || 'default';
        const panel = document.querySelector(`[data-segment-filter-panel][data-chart-id="${chartId}"]`);
        const segmentKey = panel?.dataset.segmentKey || DEFAULT_SEGMENT_KEY;
        const values = DashboardState.chartVisibilityOptions?.[chartId]?.[segmentKey] || [];
        if (selectAll) {
          setChartHiddenValues(chartId, segmentKey, []);
        } else if (clearAll) {
          setChartHiddenValues(chartId, segmentKey, values.slice());
        }
        renderDashboard();
        schedulePersistPreferences();
      });

      if (salesChannelToggle && salesChannelPanel) {
        addListener(salesChannelToggle, 'click', () => {
          const isHidden = salesChannelPanel.classList.toggle('hidden');
          salesChannelToggle.setAttribute('aria-expanded', String(!isHidden));
        });
      }

      if (unitTypeToggle && unitTypePanel) {
        addListener(unitTypeToggle, 'click', () => {
          const isHidden = unitTypePanel.classList.toggle('hidden');
          unitTypeToggle.setAttribute('aria-expanded', String(!isHidden));
        });
      }

      if (vehicleStatusToggle && vehicleStatusPanel) {
        addListener(vehicleStatusToggle, 'click', () => {
          const isHidden = vehicleStatusPanel.classList.toggle('hidden');
          vehicleStatusToggle.setAttribute('aria-expanded', String(!isHidden));
        });
      }

      if (fullChartToggles.length && fullChartBodies.length && fullChartCards.length && fullChartResizer) {
        const setFullChartsCollapsed = (nextCollapsed) => {
          const fullChartMinHeight = '220px';
          fullChartCards.forEach((card) => {
            card.dataset.collapsed = String(nextCollapsed);
            if (nextCollapsed) {
              card.style.height = '';
              card.style.minHeight = '0px';
            } else if (typeof DashboardState.layout.fullChartHeight === 'number') {
              card.style.height = `${DashboardState.layout.fullChartHeight}px`;
              card.style.minHeight = fullChartMinHeight;
            } else {
              card.style.minHeight = fullChartMinHeight;
            }
          });
          fullChartBodies.forEach((body) => body.classList.toggle('hidden', nextCollapsed));
          fullChartResizer.classList.toggle('hidden', nextCollapsed);
          fullChartToggles.forEach((toggle) => {
            toggle.setAttribute('aria-expanded', String(!nextCollapsed));
            const icon = toggle.querySelector('[data-lucide]');
            updateLucideIcon(icon, nextCollapsed ? 'chevron-down' : 'chevron-up');
          });
          DashboardState.layout.fullChartCollapsed = nextCollapsed;
          schedulePersistPreferences();
        };

        fullChartToggles.forEach((toggle) => {
          addListener(toggle, 'click', () => {
            const isCollapsed = fullChartCards[0]?.dataset.collapsed === 'true';
            setFullChartsCollapsed(!isCollapsed);
          });
        });
      }

      document.addEventListener('click', (event) => {
        if (!salesChannelPanel || salesChannelPanel.classList.contains('hidden')) return;
        if (salesChannelPanel.contains(event.target) || salesChannelToggle?.contains(event.target)) return;
        salesChannelPanel.classList.add('hidden');
        salesChannelToggle?.setAttribute('aria-expanded', 'false');
      });

      document.addEventListener('click', (event) => {
        const panel = document.getElementById('unit-type-panel');
        const toggle = document.getElementById('unit-type-toggle');
        if (!panel || panel.classList.contains('hidden')) return;
        if (panel.contains(event.target) || toggle?.contains(event.target)) return;
        panel.classList.add('hidden');
        toggle?.setAttribute('aria-expanded', 'false');
      });

      document.addEventListener('click', (event) => {
        const panel = document.getElementById('vehicle-status-panel');
        const toggle = document.getElementById('vehicle-status-toggle');
        if (!panel || panel.classList.contains('hidden')) return;
        if (panel.contains(event.target) || toggle?.contains(event.target)) return;
        panel.classList.add('hidden');
        toggle?.setAttribute('aria-expanded', 'false');
      });

      addListener(salesChannelOptions, 'change', (event) => {
        const input = event.target;
        if (!input.matches('input[type="checkbox"]')) return;
        const checked = Array.from(salesChannelOptions.querySelectorAll('input[type="checkbox"]'))
          .filter((item) => item.checked)
          .map((item) => item.value);
        DashboardState.filters.salesChannels = checked;
        if (salesChannelSummary) salesChannelSummary.textContent = String(checked.length);
        if (salesChannelLabel) {
          salesChannelLabel.textContent = checked.length === 1 ? checked[0] : 'Sales Channel';
        }
        resetPagination();
        renderDashboard();
        schedulePersistPreferences();
      });

      addListener(lastDealSelect, 'change', () => {
        const { lastLeadKey } = DashboardState.filters;
        if (!lastLeadKey) return;
        const selectionValue = lastDealSelect.value;
        const nextSelection = selectionValue === 'all' ? 'all' : selectionValue === 'true';
        DashboardState.filters.lastLeadSelection = nextSelection;
        DashboardState.filters.lastLeadFilterActive = selectionValue !== 'all';
        DashboardState.filters.columnFilters[lastLeadKey] = {
          select: selectionValue,
          search: '',
        };
        resetPagination();
        renderDashboard();
        schedulePersistPreferences();
        setupFilters({ preserveSelections: true });
      });

      segmentSelects.forEach((select) => {
        select.addEventListener('change', (event) => {
          const chartId = event.target.dataset.chartId || 'default';
          DashboardState.chartSegments[chartId] = event.target.value || DEFAULT_SEGMENT_KEY;
          renderDashboard();
          schedulePersistPreferences();
        });
      });

      chartContainers.forEach((container) => {
        container.addEventListener('click', (event) => {
          const button = event.target.closest('button[data-status][data-segment-key]');
          if (!button) return;
          const chartId = container.dataset.chartId || 'default';
          const segmentKey = button.dataset.segmentKey;
          const status = button.dataset.status;
          const current = DashboardState.filters.chartFilters?.[chartId];
          if (!current || current.key !== segmentKey) {
            DashboardState.filters.chartFilters[chartId] = { key: segmentKey, values: [status] };
          } else {
            const nextValues = Array.isArray(current.values) ? current.values.slice() : [];
            const statusIndex = nextValues.indexOf(status);
            if (statusIndex >= 0) {
              nextValues.splice(statusIndex, 1);
            } else {
              nextValues.push(status);
            }
            if (nextValues.length) {
              DashboardState.filters.chartFilters[chartId] = { key: segmentKey, values: nextValues };
            } else {
              delete DashboardState.filters.chartFilters[chartId];
            }
          }
          resetPagination();
          renderDashboard();
          schedulePersistPreferences();
        });
      });
    };

    const initializeResizablePanels = () => {
      const container = document.getElementById('deal-alerts-layout');
      const handle = document.getElementById('panel-resizer');
      const dealPanel = document.getElementById('deal-status-panel');
      const alertsPanel = document.getElementById('alerts-panel');
      const chartsLayout = document.getElementById('deal-charts-layout');
      const chartHandle = document.getElementById('chart-resizer');
      const primaryChart = document.getElementById('status-primary-card');
      const secondaryChart = document.getElementById('status-secondary-card');
      const heightHandle = document.getElementById('panel-height-resizer');
      const fullChartCards = document.querySelectorAll('[data-full-chart-card]');
      const fullChartHandle = document.getElementById('full-chart-height-resizer');
      if (!container || !handle || !dealPanel || !alertsPanel) return;

      const minPanelWidth = 220;

      let startX = 0;
      let startAlertsWidth = 0;
      let isDragging = false;

      const onPointerMove = (event) => {
        if (!isDragging) return;
        const deltaX = event.clientX - startX;
        const containerWidth = container.getBoundingClientRect().width;
        const handleWidth = handle.getBoundingClientRect().width;
        const maxAlertsWidth = Math.max(minPanelWidth, containerWidth - minPanelWidth - handleWidth);
        const nextAlertsWidth = Math.min(maxAlertsWidth, Math.max(minPanelWidth, startAlertsWidth - deltaX));
        alertsPanel.style.flex = `0 0 ${nextAlertsWidth}px`;
        dealPanel.style.flex = '1 1 auto';
      };

      const stopDragging = () => {
        if (!isDragging) return;
        isDragging = false;
        document.body.classList.remove('select-none', 'resize-col');
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', stopDragging);
        DashboardState.layout.alertsPanelWidth = alertsPanel.getBoundingClientRect().width;
        schedulePersistPreferences();
      };

      if (typeof DashboardState.layout.alertsPanelWidth === 'number' && window.innerWidth >= 1024) {
        alertsPanel.style.flex = `0 0 ${DashboardState.layout.alertsPanelWidth}px`;
        dealPanel.style.flex = '1 1 auto';
      }

      handle.addEventListener('pointerdown', (event) => {
        if (window.innerWidth < 1024) return;
        isDragging = true;
        startX = event.clientX;
        startAlertsWidth = alertsPanel.getBoundingClientRect().width;
        document.body.classList.add('select-none', 'resize-col');
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', stopDragging);
      });

      if (chartsLayout && chartHandle && primaryChart && secondaryChart) {
        const minChartWidth = 220;
        let chartStartX = 0;
        let startPrimaryWidth = 0;
        let isChartDragging = false;

        const onChartMove = (event) => {
          if (!isChartDragging) return;
          const deltaX = event.clientX - chartStartX;
          const containerWidth = chartsLayout.getBoundingClientRect().width;
          const handleWidth = chartHandle.getBoundingClientRect().width;
          const maxPrimaryWidth = Math.max(minChartWidth, containerWidth - minChartWidth - handleWidth);
          const nextPrimaryWidth = Math.min(maxPrimaryWidth, Math.max(minChartWidth, startPrimaryWidth + deltaX));
          primaryChart.style.flex = `0 0 ${nextPrimaryWidth}px`;
          secondaryChart.style.flex = '1 1 auto';
        };

        const stopChartDragging = () => {
          if (!isChartDragging) return;
          isChartDragging = false;
          document.body.classList.remove('select-none', 'resize-col');
          window.removeEventListener('pointermove', onChartMove);
          window.removeEventListener('pointerup', stopChartDragging);
          DashboardState.layout.chartSplitWidth = primaryChart.getBoundingClientRect().width;
          schedulePersistPreferences();
        };

        if (typeof DashboardState.layout.chartSplitWidth === 'number' && window.innerWidth >= 1024) {
          primaryChart.style.flex = `0 0 ${DashboardState.layout.chartSplitWidth}px`;
          secondaryChart.style.flex = '1 1 auto';
        }

        chartHandle.addEventListener('pointerdown', (event) => {
          if (window.innerWidth < 1024) return;
          isChartDragging = true;
          chartStartX = event.clientX;
          startPrimaryWidth = primaryChart.getBoundingClientRect().width;
          document.body.classList.add('select-none', 'resize-col');
          window.addEventListener('pointermove', onChartMove);
          window.addEventListener('pointerup', stopChartDragging);
        });
      }

      if (heightHandle) {
        const minPanelHeight = 220;
        let heightStartY = 0;
        let startHeight = 0;
        let isHeightDragging = false;

        const onHeightMove = (event) => {
          if (!isHeightDragging) return;
          const deltaY = event.clientY - heightStartY;
          const nextHeight = Math.max(minPanelHeight, startHeight + deltaY);
          const heightValue = `${nextHeight}px`;
          dealPanel.style.height = heightValue;
          alertsPanel.style.height = heightValue;
          if (primaryChart) primaryChart.style.height = heightValue;
          if (secondaryChart) secondaryChart.style.height = heightValue;
        };

        const stopHeightDragging = () => {
          if (!isHeightDragging) return;
          isHeightDragging = false;
          document.body.classList.remove('select-none', 'resize-row');
          window.removeEventListener('pointermove', onHeightMove);
          window.removeEventListener('pointerup', stopHeightDragging);
          DashboardState.layout.dealPanelHeight = dealPanel.getBoundingClientRect().height;
          schedulePersistPreferences();
        };

        if (typeof DashboardState.layout.dealPanelHeight === 'number' && window.innerWidth >= 1024) {
          const heightValue = `${DashboardState.layout.dealPanelHeight}px`;
          dealPanel.style.height = heightValue;
          alertsPanel.style.height = heightValue;
          if (primaryChart) primaryChart.style.height = heightValue;
          if (secondaryChart) secondaryChart.style.height = heightValue;
        }

        heightHandle.addEventListener('pointerdown', (event) => {
          if (window.innerWidth < 1024) return;
          isHeightDragging = true;
          heightStartY = event.clientY;
          startHeight = dealPanel.getBoundingClientRect().height;
          document.body.classList.add('select-none', 'resize-row');
          window.addEventListener('pointermove', onHeightMove);
          window.addEventListener('pointerup', stopHeightDragging);
        });
      }

      if (fullChartCards.length && fullChartHandle) {
        const minFullHeight = 220;
        let fullStartY = 0;
        let startFullHeight = 0;
        let isFullDragging = false;

        const onFullHeightMove = (event) => {
          if (!isFullDragging) return;
          const deltaY = event.clientY - fullStartY;
          const nextHeight = Math.max(minFullHeight, startFullHeight + deltaY);
          fullChartCards.forEach((chart) => {
            chart.style.height = `${nextHeight}px`;
          });
        };

        const stopFullDragging = () => {
          if (!isFullDragging) return;
          isFullDragging = false;
          document.body.classList.remove('select-none', 'resize-row');
          window.removeEventListener('pointermove', onFullHeightMove);
          window.removeEventListener('pointerup', stopFullDragging);
          DashboardState.layout.fullChartHeight = fullChartCards[0].getBoundingClientRect().height;
          schedulePersistPreferences();
        };

        if (typeof DashboardState.layout.fullChartHeight === 'number') {
          fullChartCards.forEach((chart) => {
            chart.style.height = `${DashboardState.layout.fullChartHeight}px`;
          });
        }

        fullChartHandle.addEventListener('pointerdown', (event) => {
          if (window.innerWidth < 1024) return;
          if (fullChartCards[0].dataset.collapsed === 'true') return;
          isFullDragging = true;
          fullStartY = event.clientY;
          startFullHeight = fullChartCards[0].getBoundingClientRect().height;
          document.body.classList.add('select-none', 'resize-row');
          window.addEventListener('pointermove', onFullHeightMove);
          window.addEventListener('pointerup', stopFullDragging);
        });
      }
    };

    const initializeFilterPanel = () => {
      const toggle = document.getElementById('filter-toggle');
      const activeFilters = document.getElementById('active-filters');
      const builder = document.getElementById('filter-builder');
      const advancedToggle = document.getElementById('advanced-toggle');
      const categoryBlock = document.getElementById('filter-category-block');
      if (!toggle || !activeFilters || !builder) return;

      toggle.classList.add(...PILL_CLASSES.split(' '));
      document.querySelectorAll('[data-pill-control]').forEach((button) => {
        if (button === toggle) return;
        button.classList.add(...PILL_CLASSES.split(' '));
      });

      const mediaQuery = window.matchMedia('(min-width: 768px)');
      let userToggled = false;

      const setExpanded = (expanded) => {
        activeFilters.classList.toggle('hidden', !expanded);
        toggle.setAttribute('aria-expanded', String(expanded));
      };

      setExpanded(mediaQuery.matches);

      toggle.addEventListener('click', () => {
        userToggled = true;
        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
        setExpanded(!isExpanded);
      });

      const handleMediaChange = (event) => {
        if (!userToggled) setExpanded(event.matches);
      };

      if (mediaQuery.addEventListener) {
        mediaQuery.addEventListener('change', handleMediaChange);
      } else {
        mediaQuery.addListener(handleMediaChange);
      }

      if (advancedToggle && categoryBlock) {
        const setAdvanced = (expanded) => {
          categoryBlock.classList.toggle('hidden', !expanded);
          advancedToggle.setAttribute('aria-expanded', String(expanded));
        };

        setAdvanced(false);
        advancedToggle.addEventListener('click', () => {
          const isExpanded = advancedToggle.getAttribute('aria-expanded') === 'true';
          setAdvanced(!isExpanded);
        });
      }
    };

    // ==========================================================
    // 3) REALTIME + HYDRATE
    // ==========================================================

    const handleVehicleChange = (payload) => {
      const record = payload.new || payload.old;
      if (!record) return;

      if (!DashboardState.schema.length) {
        DashboardState.schema = buildSchemaFromData([record]);
        initializeTablePreferences();
      }

      const normalized = normalizeVehicle(record);
      const eventTimestamp = payload.commit_timestamp ? new Date(payload.commit_timestamp).getTime() : Date.now();
      normalized.lastEventAt = eventTimestamp;

      const key = getVehicleKey(normalized);
      if (!key) return;

      if (payload.eventType === 'DELETE') DashboardState.vehiclesRaw.delete(key);
      else DashboardState.vehiclesRaw.set(key, normalized);

      renderDashboard();
    };

    const initializeSupabaseRealtime = () => {
      if (!supabaseClient?.channel) return;

      if (DashboardState.realtime.channel) return;

      const channel = supabaseClient
        .channel('inventory-control-changes')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'DealsJP1' }, handleVehicleChange);

      DashboardState.realtime.channel = channel;

      channel.subscribe((status) => {
        if (status === 'SUBSCRIBED') setConnectionStatus('Live');
        else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') setConnectionStatus('Reconnectingâ€¦');
        else if (status === 'CLOSED') setConnectionStatus('Offline');
      });

      window.addEventListener('beforeunload', () => {
        if (DashboardState.realtime.channel) {
          supabaseClient.removeChannel(DashboardState.realtime.channel);
          DashboardState.realtime.channel = null;
        }
      });
    };

    const hydrateVehiclesFromSupabase = async () => {
      if (supabaseClient === null) {
        console.warn('Supabase client not available, skipping vehicle hydration.');
        DashboardState.ui.isLoading = false;
        setConnectionStatus('Offline');
        renderDashboard();
        return;
      }
      if (!supabaseClient?.from) {
        DashboardState.ui.isLoading = false;
        setConnectionStatus('Offline');
        renderDashboard();
        return;
      }

      setConnectionStatus('Reconnectingâ€¦');

      const { data, error } = await supabaseClient
        .from('DealsJP1')
        .select('*')
        .limit(5000);

      if (error) {
        setConnectionStatus('Offline');
        DashboardState.ui.isLoading = false;
        renderDashboard();

        showDebug(
          'Supabase SELECT failed',
          'Esto suele ser RLS (no tienes SELECT permitido), credenciales, o tabla/columnas distintas.',
          { code: error.code, message: error.message, details: error.details, hint: error.hint }
        );
        return;
      }

      if (data && data.length === 0) {
        showDebug(
          'Query returned 0 records',
          'The "DealsJP1" table appears empty or RLS policies are hiding all records.',
          {}
        );
      }

      DashboardState.schema = buildSchemaFromData(data || []);

      setVehiclesFromArray((data || []).map((v) => {
        const updatedAt = getField(v, 'Updated At', 'Updated', 'Last Updated');
        return {
          ...v,
          lastEventAt: updatedAt ? new Date(updatedAt).getTime() : null,
        };
      }));

      DashboardState.ui.isLoading = false;
      initializeTablePreferences();
      setupFilters({ preserveSelections: true });
      renderDashboard();
      setConnectionStatus('Live');
    };

    // ==========================================================
    // 4) BOOT
    // ==========================================================

    initializeFilterPanel();
    setupFilters();
    bindFilterEvents();
    initializeResizablePanels();
    renderDashboard();

    // Mobile nav
    const mobileToggle = document.getElementById('mobile-menu-toggle');
    const primaryNav = document.getElementById('primary-nav');
    mobileToggle?.addEventListener('click', () => {
      const isOpen = primaryNav.classList.toggle('hidden');
      mobileToggle.setAttribute('aria-expanded', String(!isOpen));
    });

    // Start Supabase
    (async () => {
      setConnectionStatus('Bootingâ€¦');
      supabaseClient = await getSupabaseClient();
      await loadDashboardPreferences();
      applyLayoutPreferencesToDom();

      if (!supabaseClient) {
        setConnectionStatus('Offline');
        DashboardState.ui.isLoading = false;
        renderDashboard();
        return;
      }

      // If RLS blocks, debug banner will show exact error
      await hydrateVehiclesFromSupabase();
      initializeSupabaseRealtime();
    })();
  </script>
</body>

</html>