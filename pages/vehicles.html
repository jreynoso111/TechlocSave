<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Control Map</title>

  <!-- Styles & Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="../assets/scripts/authManager.js"></script>
  <script type="module" src="../assets/scripts/admin-auth.js"></script>
  <script type="module" src="../assets/scripts/datasets.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: { slate: { 850: '#1a2233', 950: '#020617' } }
        },
      },
    };
  </script>

  <style>
    :root {
      --left-sidebar-width: 360px;
      --right-sidebar-width: 360px;
      --reseller-sidebar-width: 320px;
      --repair-sidebar-width: 320px;
      --custom-sidebar-width: 320px;
      --dynamic-sidebar-width: 320px;
    }

    @media (max-width: 1280px) {
      :root {
        --left-sidebar-width: 320px;
        --right-sidebar-width: 320px;
        --reseller-sidebar-width: 280px;
        --repair-sidebar-width: 280px;
        --custom-sidebar-width: 280px;
        --dynamic-sidebar-width: 280px;
      }
    }

    @media (max-width: 1024px) {
      :root {
        --left-sidebar-width: 260px;
        --right-sidebar-width: 260px;
        --reseller-sidebar-width: 240px;
        --repair-sidebar-width: 240px;
        --custom-sidebar-width: 240px;
        --dynamic-sidebar-width: 240px;
      }

      header .max-w-7xl {
        row-gap: 1rem;
      }
    }

    /* Map */
    #tech-map {
      height: 100%;
      width: 100%;
      background-color: #0b1220;
      z-index: 1;
      position: absolute;
      inset: 0;
    }

    .leaflet-control-container .leaflet-top,
    .leaflet-control-container .leaflet-bottom {
      z-index: 500;
    }

    .resizable-sidebar {
      position: absolute;
      top: 0;
      bottom: 0;
      backdrop-filter: blur(12px);
      background: rgba(15, 23, 42, 0.9);
      transition: transform 0.3s ease;
    }

    .collapsed-left {
      transform: translateX(calc(-1 * var(--left-sidebar-width)));
    }

    .collapsed-right {
      transform: translateX(var(--right-sidebar-width));
    }

    .collapsed-reseller {
      transform: translateX(calc(-1 * var(--reseller-sidebar-width)));
    }

    .collapsed-repair {
      transform: translateX(calc(-1 * var(--repair-sidebar-width)));
    }

    .collapsed-custom {
      transform: translateX(calc(-1 * var(--custom-sidebar-width)));
    }

    .collapsed-dynamic {
      transform: translateX(calc(-1 * var(--dynamic-sidebar-width)));
    }

    .resize-handle {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 10px;
      cursor: col-resize;
      z-index: 60;
      background: linear-gradient(90deg, transparent 30%, rgba(148, 163, 184, 0.12), transparent 70%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .resizable-sidebar:hover .resize-handle {
      opacity: 1;
    }

    .resize-handle::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 28px;
      background: rgba(226, 232, 240, 0.35);
      border-radius: 9999px;
      transform: translate(-50%, -50%);
    }

    /* Legend */
    .legend-heading {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 800;
      color: #cbd5e1;
    }

    .legend-heading::before {
      content: '';
      display: inline-block;
      width: 18px;
      height: 1px;
      border-radius: 9999px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.1), rgba(148, 163, 184, 0.6));
    }

    .legend-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 6px 10px;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
      color: #e2e8f0;
      font-weight: 600;
      font-size: 11px;
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 9999px;
      border: 1px solid rgba(226, 232, 240, 0.65);
    }

    .legend-hotspot {
      position: relative;
      display: inline-flex;
      height: 14px;
      width: 14px;
      align-items: center;
      justify-content: center;
    }

    .legend-hotspot::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 9999px;
      border: 1px solid rgba(52, 211, 153, 0.7);
      background: rgba(16, 185, 129, 0.2);
    }

    .legend-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 6px;
      background: rgba(248, 113, 113, 0.12);
      color: #fda4af;
      font-weight: 800;
      font-size: 12px;
      border: 1px solid rgba(248, 113, 113, 0.4);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04);
    }

    /* Vehicle popup styling */
    .vehicle-popup .leaflet-popup-content-wrapper {
      background: #0b1120ee;
      color: #e2e8f0;
      border: 1px solid #1f2937;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      overflow: hidden;
      width: min(260px, calc(100vw - 80px));
      max-width: min(260px, calc(100vw - 80px));
    }

    .vehicle-popup .leaflet-popup-content {
      margin: 0;
      width: 100%;
    }

    .vehicle-popup .leaflet-popup-tip {
      background: #0b1120;
      border: 1px solid #1f2937;
    }

    .service-mini-popup .leaflet-popup-content-wrapper {
      background: #0b1120f0;
      color: #e2e8f0;
      border: 1px solid #1f2937;
      border-radius: 10px;
      box-shadow: 0 18px 34px rgba(0, 0, 0, 0.4);
      padding: 4px 6px;
      width: min(220px, calc(100vw - 80px));
      max-width: min(220px, calc(100vw - 80px));
    }

    .service-mini-popup .leaflet-popup-content {
      margin: 2px 4px;
      width: 100%;
    }

    .service-mini-popup .leaflet-popup-tip {
      background: #0b1120;
      border: 1px solid #1f2937;
    }

    .service-mini-card {
      font-family: 'Inter', sans-serif;
      min-width: 0;
    }

    .service-mini-title {
      margin: 0;
      font-size: 13px;
      font-weight: 800;
      color: #fff;
      line-height: 1.2;
    }

    .service-mini-location {
      margin: 2px 0 0;
      font-size: 11px;
      color: #cbd5e1;
      line-height: 1.3;
    }

    .service-mini-meta {
      margin: 6px 0 0;
      font-size: 11px;
      color: #e2e8f0;
      line-height: 1.3;
      display: flex;
      gap: 6px;
      align-items: baseline;
    }

    .service-mini-label {
      font-weight: 700;
      color: #cbd5e1;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      font-size: 10px;
    }

    .service-mini-note {
      margin: 4px 0 0;
      font-size: 11px;
      color: #fef3c7;
      line-height: 1.35;
      font-weight: 600;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 3px;
    }

    .vehicle-cross-badge {
      color: #facc15;
      font-size: 12px;
      font-weight: 900;
      text-shadow: 0 2px 5px rgba(15, 23, 42, 0.35);
      line-height: 1;
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      animation: vehicle-cross-shift 2.6s ease-in-out infinite alternate;
    }

    @keyframes vehicle-cross-shift {
      0% {
        color: #f59e0b;
        text-shadow: 0 2px 5px rgba(15, 23, 42, 0.35);
      }

      100% {
        color: #fef3c7;
        text-shadow: 0 2px 5px rgba(15, 23, 42, 0.35);
      }
    }

    .hotspot-pin {
      display: inline-flex;
      width: 16px;
      height: 16px;
      border-radius: 9999px;
      background: #ef4444;
      border: 2px solid #fff;
      box-shadow: 0 0 0 6px rgba(248, 113, 113, 0.2), 0 14px 24px rgba(0, 0, 0, 0.45);
    }

    .vehicle-dot {
      filter: drop-shadow(0 8px 14px rgba(0, 0, 0, 0.45));
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .vehicle-marker-icon {
      position: relative;
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      filter: drop-shadow(0 8px 14px rgba(0, 0, 0, 0.45));
    }

    .vehicle-marker-dot {
      width: 14px;
      height: 14px;
      border-radius: 9999px;
      border: 2.6px solid #0f172a;
      background: #38bdf8;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    .vehicle-marker-icon .vehicle-cross-badge {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }

    .blacklist-marker {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #ef4444;
      font-size: 18px;
      font-weight: 900;
      line-height: 1;
      text-shadow: 0 6px 16px rgba(0, 0, 0, 0.45);
      animation: blacklist-pulse 1.2s ease-in-out infinite alternate;
      transform: translateY(-2px);
    }

    @keyframes blacklist-pulse {
      0% {
        color: #ef4444;
        text-shadow: 0 6px 16px rgba(239, 68, 68, 0.35);
      }

      100% {
        color: #facc15;
        text-shadow: 0 6px 16px rgba(250, 204, 21, 0.35);
      }
    }

    .service-icon-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .service-cross {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ef4444;
      font-size: 11px;
      font-weight: 900;
      text-shadow: 0 1px 2px rgba(15, 23, 42, 0.45);
      pointer-events: none;
    }

    .service-check {
      position: absolute;
      top: -6px;
      right: -6px;
      font-size: 11px;
      font-weight: 900;
      color: #22c55e;
      text-shadow: 0 1px 2px rgba(15, 23, 42, 0.45);
      pointer-events: none;
      animation: service-check-pulse 1.1s ease-in-out infinite alternate;
    }

    @keyframes service-check-pulse {
      0% {
        color: #22c55e;
      }

      100% {
        color: var(--service-check-accent, #22c55e);
      }
    }

    .distance-label-wrapper {
      pointer-events: none;
    }

    .distance-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--line-color, #e2e8f0);
      background: rgba(10, 14, 26, 0.95);
      border: 1px solid color-mix(in srgb, var(--line-color, #e2e8f0) 70%, transparent);
      border-radius: 9999px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
    }

    .sidebar-toggle-btn {
      position: relative;
      z-index: 500;
      padding: 0.5rem 0.75rem;
      font-size: 12px;
      font-weight: 700;
      border-radius: 9999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      transition: all 0.2s ease;
    }

    .sidebar-toggle-btn:hover {
      border-color: rgba(251, 191, 36, 0.7);
      color: #fef9c3;
    }

    .sidebar-toggle-btn.active {
      border-color: rgba(59, 130, 246, 0.8);
      color: #e0f2fe;
      background: linear-gradient(120deg, rgba(59, 130, 246, 0.25), rgba(14, 165, 233, 0.25));
      box-shadow: 0 10px 25px rgba(59, 130, 246, 0.35);
    }

    .sidebar-toggle-group {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 500;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      pointer-events: none;
      align-items: flex-start;
    }

    .sidebar-toggle-group.items-end {
      align-items: flex-end;
    }

    .sidebar-toggle-group .sidebar-toggle-btn {
      position: relative;
      pointer-events: auto;
      align-self: flex-start;
      width: auto;
    }

    .sidebar-toggle-group.items-end .sidebar-toggle-btn {
      align-self: flex-end;
    }

    .sidebar-toggle-pill {
      padding: 0.4rem 0.85rem;
      font-size: 11px;
    }

    #loading-overlay {
      transition: opacity 0.2s ease;
    }

    #loading-overlay .spinner {
      border-top-color: transparent;
    }

    body.loading,
    body.loading * {
      cursor: progress !important;
    }
  </style>
  <link rel="stylesheet" href="../assets/visuals/theme.css" />
</head>

<body class="h-screen bg-slate-950 font-sans text-slate-50 overflow-hidden flex flex-col">
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-80 mix-blend-screen" aria-hidden="true">
    <canvas id="constellation-canvas" class="h-full w-full"></canvas>
  </div>
  <div data-auth-loading class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950">
    <div
      class="flex items-center gap-3 rounded-2xl border border-slate-800 bg-slate-900 px-5 py-3 shadow-xl shadow-slate-900/60">
      <span class="h-3 w-3 animate-pulse rounded-full bg-blue-400"></span>
      <p class="text-sm font-semibold text-slate-200">Validating secure session…</p>
    </div>
  </div>

  <div id="loading-overlay"
    class="hidden fixed inset-0 z-40 flex items-center justify-center bg-slate-950/60 backdrop-blur-sm pointer-events-none">
    <div
      class="flex items-center gap-3 rounded-xl border border-slate-800/70 bg-slate-900/90 px-4 py-2 text-sm font-semibold text-slate-100 shadow-lg shadow-slate-900/50">
      <span class="spinner h-5 w-5 animate-spin rounded-full border-2 border-slate-500"></span>
      <span id="loading-text">Loading…</span>
    </div>
  </div>

  <div data-auth-protected class="hidden h-full flex flex-col">

    <!-- App Header -->
    <div id="header-root"></div>
    <script type="module">
      import { renderHeader } from '../assets/components/Header.js';
      renderHeader('header-root');
    </script>

    <main id="map-layout" class="relative flex-1 overflow-hidden bg-slate-950">

      <div class="absolute inset-0">
        <div id="tech-map"></div>
      </div>

      <div id="selection-banner"
        class="pointer-events-auto absolute bottom-4 right-4 z-[450] hidden rounded-full border border-amber-400/60 bg-amber-500/15 px-4 py-2 text-xs font-semibold text-amber-100 shadow-lg shadow-amber-500/20 backdrop-blur">
        <span id="selection-text">Filtered by selection</span>
        <button id="clear-selection"
          class="ml-3 rounded-full bg-amber-400/20 px-3 py-1 text-[11px] font-bold text-amber-50 hover:bg-amber-400/30 border border-amber-300/70">Clear</button>
      </div>

      <div class="sidebar-toggle-group left-3">
        <button id="open-left-sidebar" class="sidebar-toggle-btn">GPS Technicians</button>
        <button id="open-reseller-sidebar" class="sidebar-toggle-btn">Resellers</button>
        <button id="open-repair-sidebar" class="sidebar-toggle-btn">Repair Shops</button>
        <div id="custom-toggle-slot" class="flex flex-col gap-2 items-start self-start">
          <div id="custom-category-toggles" class="flex flex-col gap-2 items-start self-start"></div>
        </div>
      </div>
      <div id="map-visibility-group"
        class="pointer-events-none absolute top-4 left-1/2 z-[500] -translate-x-1/2 transform flex flex-wrap justify-center gap-2">
        <button id="toggle-hotspots" class="sidebar-toggle-btn sidebar-toggle-pill pointer-events-auto active"
          aria-pressed="true">Hide Hotspot Areas</button>
        <button id="toggle-blacklist" class="sidebar-toggle-btn sidebar-toggle-pill pointer-events-auto active"
          aria-pressed="true">Hide Blacklist Marks</button>
        <button id="toggle-vehicle-markers" class="sidebar-toggle-btn sidebar-toggle-pill pointer-events-auto active"
          aria-pressed="true">Hide Vehicles Marks</button>
      </div>
      <div id="right-toggle-group" class="sidebar-toggle-group right-3 items-end">
        <button id="open-right-sidebar" class="sidebar-toggle-btn text-[11px]">Show Vehicles</button>
      </div>

      <!-- Floating Legend -->
      <div
        class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[400] w-[min(95vw,1100px)] rounded-2xl border border-slate-800 bg-slate-950/85 px-4 py-3 text-[11px] text-slate-200 shadow-xl backdrop-blur">
        <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between md:gap-8">
          <div class="flex-1 space-y-2">
            <p class="legend-heading">Services</p>
            <div class="flex flex-wrap items-center gap-2">
              <div class="legend-pill" data-legend="tech">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16"
                    fill="#3b82f6" stroke="#0f172a" stroke-width="1.2">
                    <path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path>
                  </svg></span>
                Tech
              </div>
              <div class="legend-pill" data-legend="reseller">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16"
                    fill="#34d399" stroke="#0f172a" stroke-width="1.2">
                    <path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path>
                  </svg></span>
                Reseller
              </div>
              <div class="legend-pill" data-legend="repair">
                <span class="inline-flex items-center justify-center"><svg class="h-3 w-3" viewBox="0 0 18 16"
                    fill="#fb923c" stroke="#0f172a" stroke-width="1.2">
                    <path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path>
                  </svg></span>
                Repair
              </div>
              <div id="custom-legend-slot" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
          <div class="flex-1 space-y-2 md:text-right">
            <p class="legend-heading md:justify-end">Vehicles</p>
            <div class="flex flex-wrap items-center gap-2 md:justify-end">
              <div class="legend-pill">
                <span class="legend-dot bg-red-500"></span>
                GPS Fix: All
              </div>
              <div class="legend-pill">
                <span class="legend-dot bg-emerald-400"></span>
                Fully Working
              </div>
              <div class="legend-pill">
                <span class="legend-dot bg-amber-500"></span>
                Other states
              </div>
              <div class="legend-pill">
                <span class="vehicle-cross-badge">✕</span>
                Not moving
              </div>
            </div>
            <div class="flex flex-wrap items-center gap-2 md:justify-end">
              <div class="legend-pill">
                <span class="legend-dot bg-red-500 border-white/90"></span>
                Client location
              </div>
              <div class="legend-pill">
                <span class="legend-hotspot"></span>
                Hotspot Area
              </div>
              <div class="legend-pill">
                <span class="legend-badge">!</span>
                Blacklist
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Sidebar: Control Panel -->
      <aside id="left-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-30 shadow-2xl"
        style="width: var(--left-sidebar-width)">
        <div class="resize-handle right-0"></div>

        <!-- Search -->
        <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10 space-y-4">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-[10px] font-bold uppercase text-slate-400 mb-1">Client starting point</p>
              <h2 class="text-xl font-black text-white leading-tight">Find the nearest installer</h2>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Installers</p>
                <p id="total-count" class="text-2xl font-black text-white leading-none">0</p>
              </div>
              <button id="collapse-left"
                class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200"
                aria-label="Minimize sidebar">-</button>
            </div>
          </div>
          <form id="search-form" class="relative">
            <input id="address-input" type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Ex: 33101, Phoenix, AZ..." autocomplete="off">
            <button type="submit" id="search-btn"
              class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
              CALCULATE
            </button>
          </form>

          <div class="flex justify-between items-end">
            <div id="search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...
            </div>
            <div id="file-error" class="hidden text-xs text-red-300">Unable to read installer partner data.</div>
          </div>
        </div>

        <!-- Technicians List -->
        <div id="tech-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
          <div class="text-center mt-10 text-slate-600 text-xs">Waiting for installer data...</div>
        </div>
      </aside>

      <div id="partner-sidebars"></div>

      <!-- Vehicles Sidebar -->
      <aside id="right-sidebar"
        class="resizable-sidebar right-0 border-l border-slate-800 flex flex-col z-30 shadow-2xl"
        style="width: var(--right-sidebar-width)">
        <div class="resize-handle left-0"></div>
        <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-[10px] font-bold uppercase text-amber-300 mb-1">Control Map</p>
              <h2 class="text-xl font-black text-white leading-tight">GPS issues around the network</h2>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
                <p id="vehicles-count" class="text-2xl font-black text-white leading-none">0</p>
              </div>
              <button id="collapse-right"
                class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200"
                aria-label="Minimize vehicles sidebar">-</button>
            </div>
          </div>
          <div class="mt-4 relative">
            <input id="vehicle-search" type="text" placeholder="Search by VIN, model, city..."
              class="w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-10 py-2.5 text-sm text-white placeholder-slate-500 focus:border-amber-400 focus:ring-1 focus:ring-amber-400 outline-none transition-all">
            <svg class="h-4 w-4 text-slate-500 absolute right-3 top-1/2 -translate-y-1/2" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
              aria-hidden="true">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </div>
          <div class="mt-2 space-y-2 rounded-xl border border-slate-800 bg-slate-900/70 p-2.5">
            <div class="flex items-center justify-between text-[11px] font-semibold text-slate-300">
              <span>Vehicle filters</span>
              <button id="vehicle-filters-reset"
                class="text-amber-300 hover:text-amber-200 text-[10px] font-bold">Reset</button>
            </div>
            <div class="grid grid-cols-2 gap-1.5 text-[10px]">
              <label class="space-y-0.5">
                <span class="block text-slate-400 font-semibold">Inv. Prep. Stat</span>
                <select id="filter-invprep"
                  class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                  <option value="all">All</option>
                </select>
              </label>
              <label class="space-y-0.5">
                <span class="block text-slate-400 font-semibold">GPS Fix</span>
                <select id="filter-gps"
                  class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                  <option value="all">All</option>
                </select>
              </label>
              <label class="space-y-0.5">
                <span class="block text-slate-400 font-semibold">Moving</span>
                <select id="filter-moving"
                  class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                  <option value="all">All</option>
                  <option value="moving">Moving</option>
                  <option value="stopped">Not moving</option>
                </select>
              </label>
              <label class="space-y-0.5">
                <span class="block text-slate-400 font-semibold">Deal status</span>
                <select id="filter-deal-status"
                  class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                  <option value="all">All</option>
                </select>
              </label>
              <label class="space-y-0.5">
                <span class="block text-slate-400 font-semibold">PT Status</span>
                <select id="filter-pt"
                  class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white text-[10px] focus:border-amber-400 focus:ring-1 focus:ring-amber-400">
                  <option value="all">All</option>
                </select>
              </label>
              <label class="space-y-0.5">
                <span class="block text-slate-400 font-semibold">Deal completion %</span>
                <div class="flex items-center gap-1.5 text-[10px] text-slate-300">
                  <input id="filter-deal-min" type="number" min="0" max="100" step="1"
                    class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white focus:border-amber-400 focus:ring-1 focus:ring-amber-400"
                    placeholder="0">
                  <span class="text-slate-500">to</span>
                  <input id="filter-deal-max" type="number" min="0" max="100" step="1"
                    class="w-full rounded-md border border-slate-800 bg-slate-950 px-2 py-1 text-white focus:border-amber-400 focus:ring-1 focus:ring-amber-400"
                    placeholder="100">
                </div>
              </label>
            </div>
          </div>
        </div>
        <div id="vehicle-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
          <div class="text-center mt-10 text-slate-600 text-xs">Waiting for vehicle data...</div>
        </div>
      </aside>
    </main>

    <!-- Vehicle detail modal -->
    <div id="vehicle-modal"
      class="fixed inset-0 z-[500] hidden items-center justify-center bg-black/60 backdrop-blur-sm p-4">
      <div
        class="flex w-[90vw] max-w-7xl flex-col border border-slate-800 bg-slate-950 shadow-2xl overflow-hidden max-h-[85vh]">
        <div
          class="sticky top-0 z-20 flex items-center justify-between border-b border-slate-800 bg-slate-900/80 px-4 py-3 backdrop-blur">
          <div>
            <p class="text-[10px] font-black uppercase tracking-[0.18em] text-amber-300">Vehicle details</p>
            <h3 id="vehicle-modal-title" class="text-lg font-bold text-white"></h3>
            <p id="vehicle-modal-vin" class="text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-400"></p>
          </div>
          <div class="flex items-center gap-2">
            <button id="vehicle-modal-columns-toggle"
              class="rounded-lg border border-slate-700 bg-slate-800/80 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:border-amber-400 hover:text-amber-200 transition-colors">Columns</button>
            <button id="vehicle-modal-close"
              class="rounded-lg border border-slate-700 bg-slate-800/80 px-3 py-1.5 text-xs font-semibold text-slate-200 hover:border-amber-400 hover:text-amber-200 transition-colors">Close</button>
          </div>
        </div>
        <div id="vehicle-modal-columns-panel" class="hidden border-b border-slate-800 bg-slate-950/70 px-4 py-3">
          <div class="flex items-center justify-between gap-4">
            <div>
              <p class="text-xs font-semibold text-slate-200">Choose columns</p>
              <p class="text-[10px] text-slate-400">Drag rows in the table to reorder columns.</p>
            </div>
          </div>
          <div id="vehicle-modal-columns-list" class="mt-3 grid grid-cols-2 gap-2 text-[11px] text-slate-200"></div>
        </div>
        <div class="flex-1 overflow-y-auto p-4" id="vehicle-modal-body"></div>
      </div>
    </div>

    <script type="module">
      import { supabase as supabaseClient } from '../assets/scripts/supabaseClient.js';
      import { getDistance, loadStateCenters, resolveCoords, MILES_TO_METERS, HOTSPOT_RADIUS_MILES } from '../assets/scripts/geoUtils.js';
      import { getField, normalizeInstaller, normalizePartner, normalizeVehicle } from '../assets/scripts/dataMapper.js';
      import { createRepairHistoryManager } from '../assets/scripts/repairHistory.js';

      // --- Base Config ---

      let map, techLayer, targetLayer, connectionLayer, serviceLayer, serviceConnectionLayer, vehicleLayer, highlightLayer, resellerLayer, repairLayer, customServiceLayer, hotspotLayer, blacklistLayer;
      let technicians = [];
      let blacklistSites = [];
      let hotspots = [];
      let resellers = [];
      let repairShops = [];
      let customServices = [];
      let customCategories = new Map();
      let customToggleRef = null;
      let selectedCustomCategoryKey = null;
      let serviceCacheByCategory = new Map();
      let serviceFetchPromise = null;
      let vehicles = [];
      let vehicleHeaders = [];
      let vehicleMarkersVisible = true;
      let hotspotsVisible = true;
      let blacklistMarkersVisible = true;
      const serviceHeadersByCategory = {};
      let selectedVehicleId = null;
      let selectedTechId = null;
      const vehicleMarkers = new Map();
      let sidebarStateController = null;
      let techSidebarVisible = false;
      let resellerSidebarVisible = false;
      let repairSidebarVisible = false;
      let customSidebarVisible = false;
      let lastCustomSidebarVisible = false;
      let activeLeftPanel = null;
      let lastClientLocation = null;
      let renderedTechIds = '';
      let lastOriginPoint = null;
      const serviceFilters = {
        tech: '',
        reseller: '',
        repair: '',
        custom: ''
      };
      const vehicleFilters = {
        invPrep: 'all',
        gpsFix: 'all',
        moving: 'all',
        dealStatus: 'all',
        ptStatus: 'all',
        dealMin: 0,
        dealMax: 100,
      };

      const selectedServiceByType = {};
      const distanceCaches = {
        tech: { originKey: null, distances: new Map() },
        partners: { originKey: null, distances: new Map() }
      };

      const getOriginKey = (origin) => origin ? `${Number(origin.lat).toFixed(6)},${Number(origin.lng).toFixed(6)}` : null;

      const attachDistances = (list, origin, cache, distanceCalculator) => {
        if (!origin) return [...list];
        const originKey = getOriginKey(origin);
        if (cache.originKey !== originKey) {
          cache.distances.clear();
          cache.originKey = originKey;
        }

        return list.map((item) => {
          const cached = cache.distances.get(item.id);
          if (cached !== undefined) return { ...item, distance: cached };
          const distance = distanceCalculator(item);
          cache.distances.set(item.id, distance);
          return { ...item, distance };
        });
      };

      const debounce = (fn, delay = 200) => {
        let timeoutId;
        return (...args) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn(...args), delay);
        };
      };

      const createPartnerClusterIcon = (cluster, color = '#334155') => {
        const count = cluster.getChildCount();
        return L.divIcon({
          html: `<div class="relative text-xs font-semibold rounded-full flex items-center justify-center w-8 h-8 border-2 shadow-md bg-slate-900/90" style="color:${color}; border-color:${color}">${count}</div>`,
          className: 'partner-cluster-icon',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
      };

      const createPartnerClusterGroup = (color = '#334155') => L.markerClusterGroup({
        maxClusterRadius: 45,
        disableClusteringAtZoom: 17,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        iconCreateFunction: (cluster) => createPartnerClusterIcon(cluster, color)
      });

      const debounceAsync = (fn, delay = 300) => {
        let timeoutId;
        return (...args) => new Promise((resolve, reject) => {
          clearTimeout(timeoutId);
          timeoutId = setTimeout(async () => {
            try {
              resolve(await fn(...args));
            } catch (error) {
              reject(error);
            }
          }, delay);
        });
      };

      let loadingCounter = 0;
      function startLoading(message = 'Loading…') {
        const overlay = document.getElementById('loading-overlay');
        const text = document.getElementById('loading-text');
        if (!overlay || !text) return () => { };

        loadingCounter++;
        text.textContent = message;
        overlay.classList.remove('hidden');
        document.body.classList.add('loading');

        return () => {
          loadingCounter = Math.max(0, loadingCounter - 1);
          if (loadingCounter === 0) {
            overlay.classList.add('hidden');
            document.body.classList.remove('loading');
          }
        };
      }

      const SERVICE_TABLE = 'Services';
      const SERVICE_CATEGORY_HINTS = {
        tech: ['GPS Technician'],
        reseller: ['dealer/auction'],
        repair: ['Repair Shop'],
      };

      const TABLES = {
        services: SERVICE_TABLE,
        vehicles: 'vehicles',
        hotspots: 'Hotspots',
        blacklist: 'Services_Blacklist',
        repairHistory: 'repair_history'
      };

      const SUPABASE_TIMEOUT_MS = 10000;
      const runWithTimeout = (promise, timeoutMs, message) => new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
          reject(new Error(message));
        }, timeoutMs);
        promise
          .then((result) => {
            clearTimeout(timeoutId);
            resolve(result);
          })
          .catch((error) => {
            clearTimeout(timeoutId);
            reject(error);
          });
      });

      const ensureSupabaseSession = async () => {
        const { data, error } = await supabaseClient.auth.getSession();
        if (error || !data?.session) {
          const { data: refreshed, error: refreshError } = await supabaseClient.auth.refreshSession();
          if (refreshError || !refreshed?.session) {
            throw refreshError || new Error('Supabase session unavailable');
          }
        }
      };

      const serviceCategoryLabelsByType = new Map();
      const getServiceCategoryLabel = (type) => serviceCategoryLabelsByType.get(type) || '';

      const getCategoryCacheKey = (value = '') => normalizeCategoryLabel(value).toLowerCase();

      const buildServiceCache = (rows = []) => {
        const cache = new Map();
        rows.forEach((row) => {
          const key = getCategoryCacheKey(row?.category || 'uncategorized');
          const list = cache.get(key) || [];
          list.push(row);
          cache.set(key, list);
        });
        return cache;
      };

      const ensureServiceCache = async () => {
        if (!supabaseClient) return null;
        if (serviceCacheByCategory.size) return serviceCacheByCategory;
        if (serviceFetchPromise) return serviceFetchPromise;

        const stopLoading = startLoading('Loading Services…');
        serviceFetchPromise = (async () => {
          const { data, error } = await supabaseClient.from(SERVICE_TABLE).select('*');
          if (error) throw error;
          serviceCacheByCategory = buildServiceCache(data || []);
          return serviceCacheByCategory;
        })().finally(() => {
          stopLoading();
          serviceFetchPromise = null;
        });

        return serviceFetchPromise;
      };

      const getCachedServices = (categoryLabel) => {
        if (!categoryLabel) return [];
        return serviceCacheByCategory.get(getCategoryCacheKey(categoryLabel)) || [];
      };

      const updateServiceCategoryLabels = (rawCategories = new Map()) => {
        serviceCategoryLabelsByType.clear();

        const normalizedToOriginal = new Map();
        rawCategories.forEach((original) => {
          const normalizedKey = normalizeCategoryLabel(original).toLowerCase();
          if (!normalizedToOriginal.has(normalizedKey)) normalizedToOriginal.set(normalizedKey, original);
        });

        SERVICE_TYPES.filter((type) => type !== 'custom').forEach((type) => {
          const hints = SERVICE_CATEGORY_HINTS[type] || [];
          const matchKey = hints
            .map((hint) => normalizeCategoryLabel(hint).toLowerCase())
            .find((hintKey) => normalizedToOriginal.has(hintKey));

          if (matchKey) {
            serviceCategoryLabelsByType.set(type, normalizedToOriginal.get(matchKey));
          }
        });
      };

      const normalizeCategoryLabel = (value = '') => `${value}`.trim();
      const getCustomCategoryKey = (label = '') => normalizeKey(label) || `custom-${customCategories.size + 1}`;
      const ensureCustomCategoryMeta = (label = '') => {
        const normalizedLabel = normalizeCategoryLabel(label) || 'Custom';
        const key = getCustomCategoryKey(normalizedLabel);
        if (!customCategories.has(key)) {
          const color = CUSTOM_COLOR_PALETTE[customCategories.size % CUSTOM_COLOR_PALETTE.length] || SERVICE_COLORS.custom;
          const layer = createPartnerClusterGroup(color);
          customCategories.set(key, { key, label: normalizedLabel, color, layer });
        }
        return customCategories.get(key);
      };

      function rebuildCustomLegendItems() {
        const legendSlot = document.getElementById('custom-legend-slot');
        if (!legendSlot) return;

        legendSlot.innerHTML = '';

        if (!customCategoryLabels.size) {
          legendSlot.classList.add('hidden');
          return;
        }

        legendSlot.classList.remove('hidden');

        Array.from(customCategoryLabels)
          .sort((a, b) => `${a}`.localeCompare(`${b}`))
          .forEach((label) => {
            const meta = ensureCustomCategoryMeta(label);
            const pill = document.createElement('div');
            pill.className = 'legend-pill';
            pill.dataset.legend = meta.key || 'custom';
            pill.innerHTML = `
            <span class="inline-flex items-center justify-center">
              <svg class="h-3 w-3" viewBox="0 0 18 16" fill="${meta.color}" stroke="#0f172a" stroke-width="1.2">
                <path d="M9 1.2L16.2 14.5H1.8L9 1.2Z"></path>
              </svg>
            </span>
          `;
            pill.appendChild(document.createTextNode(` ${meta.label}`));
            legendSlot.appendChild(pill);
          });
      }

      function rebuildCustomCategoryToggles() {
        const slot = document.getElementById('custom-category-toggles');
        if (!slot) return;

        slot.innerHTML = '';
        selectedCustomCategoryKey = null;

        if (!customCategoryLabels.size) {
          slot.classList.add('hidden');
          customToggleRef = null;
          rebuildCustomLegendItems();
          return;
        }

        const buttons = [];

        const updateCustomToggleStates = () => {
          buttons.forEach((button) => {
            const key = button.dataset.categoryKey || '';
            const isActive = key && selectedCustomCategoryKey === key;
            button.classList.toggle('active', isActive);
          });
        };

        const buildButton = (label, key = null) => {
          const button = document.createElement('button');
          button.className = 'sidebar-toggle-btn';
          button.textContent = label;
          button.dataset.categoryKey = key || '';
          button.addEventListener('click', () => {
            selectedCustomCategoryKey = selectedCustomCategoryKey === key ? null : key;
            sidebarStateController?.setState?.('custom', true);
            renderCategorySidebar(selectedCustomCategoryKey);
            updateCustomToggleStates();

            // Force recalculation when switching dynamic categories (e.g., Parking to Repo)
            const origin = getCurrentOrigin();
            if (origin && selectedCustomCategoryKey) {
              showServicesFromOrigin(origin, { forceType: 'custom' });
            }
          });
          slot.appendChild(button);
          buttons.push(button);
        };

        Array.from(customCategoryLabels)
          .sort((a, b) => `${a}`.localeCompare(`${b}`))
          .forEach((label) => {
            const meta = ensureCustomCategoryMeta(label);
            buildButton(meta.label, meta.key);
          });

        rebuildCustomLegendItems();

        customToggleRef = buttons[0] || null;
        slot.classList.remove('hidden');
        updateCustomToggleStates();
        sidebarStateController?.updateTogglePositions?.();
      }

      const isServiceTypeEnabled = (type) => enabledServiceTypes.has(type);

      const getEnabledServiceTypes = () => SERVICE_TYPES.filter(isServiceTypeEnabled);

      async function syncAvailableServiceTypes() {
        if (!supabaseClient) return;

        try {
          const { data, error } = await supabaseClient.from(SERVICE_TABLE).select('category');
          if (error) throw error;

          const rawCategories = new Map();
          (data || []).forEach((row) => {
            const raw = `${row?.category ?? ''}`.trim();
            if (!raw) return;
            const key = normalizeCategoryLabel(raw).toLowerCase();
            if (!rawCategories.has(key)) rawCategories.set(key, raw);
          });

          updateServiceCategoryLabels(rawCategories);

          const detected = SERVICE_TYPES.filter((type) => {
            if (type === 'custom') return false;
            return serviceCategoryLabelsByType.has(type);
          });

          const knownLabels = new Set(
            Array.from(serviceCategoryLabelsByType.values()).map((c) => `${c}`.trim().toLowerCase())
          );
          const customLabelMap = new Map();
          rawCategories.forEach((original, key) => {
            if (!knownLabels.has(key)) customLabelMap.set(key, original);
          });
          customCategoryLabels = new Set(customLabelMap.values());

          if (customCategoryLabels.size) detected.push('custom');

          rebuildCustomCategoryToggles();

          enabledServiceTypes = detected.length ? new Set(detected) : new Set();
        } catch (err) {
          console.warn(`Service availability warning: ${err.message}`);
        }

        updateServiceVisibilityUI();
      }

      const updateServiceVisibilityUI = () => {
        SERVICE_TYPES.forEach((type) => {
          const config = SERVICE_UI_CONFIG[type];
          if (!config) return;

          const enabled = isServiceTypeEnabled(type);
          if (type === 'custom') {
            const slot = document.getElementById('custom-category-toggles');
            if (slot) slot.classList.toggle('hidden', !enabled || !customCategoryLabels.size);
          }

          const toggle = config.toggleId ? document.getElementById(config.toggleId) : null;
          const sidebar = document.getElementById(config.sidebarId);
          const layer = config.layer?.();

          if (toggle) {
            toggle.classList.toggle('hidden', !enabled);
            toggle.setAttribute('aria-hidden', (!enabled).toString());
          }

          if (sidebar) {
            sidebar.classList.toggle('hidden', !enabled);
            if (!enabled && config.collapsedClass) sidebar.classList.add(config.collapsedClass);
          }

          if (config.legendSelector) {
            document.querySelectorAll(config.legendSelector).forEach((el) => {
              el.classList.remove('hidden');
            });
          }

          if (!enabled) layer?.clearLayers?.();
        });

        document.querySelectorAll('[data-legend]').forEach((el) => el.classList.remove('hidden'));
      };

      const setServiceHeaders = (category, data = []) => {
        if (!category || !Array.isArray(data) || !data.length) return;
        serviceHeadersByCategory[category] = Object.keys(data[0]);
      };

      const getServiceHeaders = (category) => serviceHeadersByCategory[category] || [];

      const isAdminUser = () => `${window.currentUserRole || ''}`.toLowerCase() === 'administrator';

      const toStateCode = (value = '') => {
        if (!value) return '';
        const match = `${value}`.match(/([A-Z]{2})/i);
        return match ? match[1].toUpperCase() : '';
      };

      const normalizeKey = (key = '') => `${key}`.trim().toLowerCase().replace(/\s+/g, '_');

      const escapeHTML = (value = '') => `${value}`
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const VEHICLE_HEADER_LABELS = {
        days_stationary: 'Days Parked',
        short_location: 'GPS City'
      };

      const EDITABLE_VEHICLE_FIELDS = {
        'gps fix': 'gpsFix',
        'gps fix reason': 'gpsReason'
      };

      const VEHICLE_MODAL_STORAGE_KEY = 'vehicleModalColumns';

      const formatDateTime = (value) => {
        if (!value) return '—';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '—';
        return date.toLocaleString('en-US', {
          month: '2-digit',
          day: '2-digit',
          year: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }).replace(',', '');
      };

      const repairHistoryManager = createRepairHistoryManager({
        supabaseClient,
        startLoading,
        ensureSupabaseSession,
        runWithTimeout,
        timeoutMs: SUPABASE_TIMEOUT_MS,
        tableName: TABLES.repairHistory,
        escapeHTML,
        formatDateTime
      });

      const loadVehicleModalPrefs = () => {
        try {
          const raw = localStorage.getItem(VEHICLE_MODAL_STORAGE_KEY);
          const parsed = raw ? JSON.parse(raw) : {};
          return {
            order: Array.isArray(parsed.order) ? parsed.order : [],
            hidden: Array.isArray(parsed.hidden) ? parsed.hidden : []
          };
        } catch (error) {
          console.warn('Failed to load vehicle modal column preferences.', error);
          return { order: [], hidden: [] };
        }
      };

      const saveVehicleModalPrefs = (prefs) => {
        localStorage.setItem(VEHICLE_MODAL_STORAGE_KEY, JSON.stringify(prefs));
      };

      const getVehicleModalHeaders = () => {
        const baseHeaders = vehicleHeaders.filter((header) => header.toLowerCase() !== 'pt city');
        const prefs = loadVehicleModalPrefs();
        const ordered = prefs.order.filter((header) => baseHeaders.includes(header));
        baseHeaders.forEach((header) => {
          if (!ordered.includes(header)) ordered.push(header);
        });
        return { headers: ordered, hidden: new Set(prefs.hidden || []) };
      };

      const renderVehicleModalColumnsList = (headers, hiddenSet) => {
        const list = document.getElementById('vehicle-modal-columns-list');
        if (!list) return;
        list.innerHTML = '';
        headers.forEach((header) => {
          const id = `vehicle-col-${header.replace(/\s+/g, '-').toLowerCase()}`;
          const label = VEHICLE_HEADER_LABELS[header] || header;
          const item = document.createElement('label');
          item.className = 'flex items-center gap-2 rounded-md border border-slate-800 bg-slate-900/60 px-2 py-1';
          item.innerHTML = `
          <input type="checkbox" class="rounded border-slate-700 bg-slate-900 text-amber-400 focus:ring-amber-400" id="${id}">
          <span class="text-[11px] text-slate-200">${label}</span>
        `;
          const checkbox = item.querySelector('input');
          checkbox.checked = !hiddenSet.has(header);
          checkbox.addEventListener('change', () => {
            const prefs = loadVehicleModalPrefs();
            const hidden = new Set(prefs.hidden || []);
            if (checkbox.checked) {
              hidden.delete(header);
            } else {
              hidden.add(header);
            }
            prefs.hidden = [...hidden];
            saveVehicleModalPrefs(prefs);
            const safeHeader = (window.CSS && CSS.escape) ? CSS.escape(header) : header.replace(/"/g, '\\"');
            const row = document.querySelector(`tr[data-header="${safeHeader}"]`);
            if (row) row.classList.toggle('hidden', !checkbox.checked);
          });
          list.appendChild(item);
        });
      };

      const normalizeHotspot = (row, idx = 0) => {
        const stateCode = toStateCode(getField(row, 'state', 'State')) || 'US';
        const city = getField(row, 'city', 'City');
        const zip = getField(row, 'zip', 'Zip');
        const rawLat = parseFloat(getField(row, 'lat', 'Lat'));
        const rawLng = parseFloat(getField(row, 'long', 'Long', 'lng', 'Lng', 'longitude', 'Longitude'));
        const rawRadius = parseFloat(getField(row, 'radius', 'Radius'));
        const fallbackLatLng = Number.isFinite(rawLat) && Number.isFinite(rawLng) ? { lat: rawLat, lng: rawLng } : null;

        const { coords } = resolveCoords(row, { zip, city, stateCode, seed: idx, fallbackLatLng, getField });

        return {
          id: row?.id ?? `hotspot-${idx}`,
          city: city || '',
          state: stateCode,
          zip: zip || '',
          lat: coords.lat,
          lng: coords.lng,
          radiusMiles: Number.isFinite(rawRadius) ? rawRadius : HOTSPOT_RADIUS_MILES,
        };
      };

      const normalizeBlacklistEntry = (row, idx = 0) => {
        // Use explicit lat/long columns from Supabase (no geocoding fallbacks)
        const lat = parseFloat(getField(row, 'lat', 'Lat', 'latitude', 'Latitude'));
        const lng = parseFloat(getField(row, 'long', 'Long', 'lng', 'Lng', 'longitude', 'Longitude'));

        return {
          id: row?.id ?? `blacklist-${idx}`,
          company: getField(row, 'company_name', 'Company', 'company', 'name'),
          assocUnit: getField(row, 'Assoc.Unit', 'assoc_unit', 'AssocUnit'),
          note: getField(row, 'Note', 'note', 'notes', 'Notes'),
          lat,
          lng,
        };
      };

      const hasValidCoords = (entry) => Number.isFinite(entry?.lat) && Number.isFinite(entry?.lng) && entry.lat !== 0 && entry.lng !== 0;

      const getLocationNote = (accuracy = '') => {
        if (accuracy === 'zip') return 'Approximate location (based on ZIP code)';
        if (accuracy === 'city') return 'Approximate location (based on city)';
        if (accuracy === 'state') return 'Approximate location (state center)';
        return '';
      };

      const getAccuracyDot = (accuracy = '') => {
        return accuracy === 'exact' ? 'bg-emerald-300' : 'bg-amber-300';
      };

      const ICON_PATHS = {
        mapPin: '<path d="M21 10c0 7-9 13-9 13S3 17 3 10a9 9 0 1 1 18 0Z"></path><circle cx="12" cy="10" r="3"></circle>',
        navigation: '<polygon points="3 11 12 2 21 11 12 20 3 11"></polygon><line x1="12" y1="22" x2="12" y2="13"></line>',
        mail: '<rect x="3" y="5" width="18" height="14" rx="2"></rect><polyline points="3 7 12 13 21 7"></polyline>',
        wifiOff: '<line x1="1" y1="1" x2="23" y2="23"></line><path d="M16.72 11.06A10.94 10.94 0 0 0 12 9.5 10.94 10.94 0 0 0 4.08 12.74"></path><path d="M5.1 16.5A6.95 6.95 0 0 1 12 14.5a6.95 6.95 0 0 1 3.53.96"></path><line x1="12" y1="20" x2="12.01" y2="20"></line>',
        hash: '<line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line>',
        clock: '<circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline>',
        info: '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>',
        search: '<circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>',
        save: '<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2Z"></path><path d="M17 21v-8H7v8"></path><path d="M7 3v5h8"></path>',
        alertCircle: '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>',
        fileWarning: '<path d="M14.5 2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V9.5L14.5 2Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path>',
        loader2: '<path d="M21 12a9 9 0 1 1-6.219-8.56"></path>'
      };

      const svgIcon = (name, className = 'h-3 w-3') => {
        const paths = ICON_PATHS[name];
        if (!paths) return '';
        return `<svg class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">${paths}</svg>`;
      };

      const VEHICLE_RENDER_LIMIT = 35;
      const PARTNER_CARD_LIMIT = 35;

      const SERVICE_TYPES = ['tech', 'reseller', 'repair', 'custom'];
      const SERVICE_COLORS = {
        tech: '#3b82f6',
        reseller: '#34d399',
        repair: '#fb923c',
        custom: '#f472b6'
      };
      const SERVICE_SIDEBAR_KEYS = {
        tech: 'left',
        reseller: 'reseller',
        repair: 'repair',
        custom: 'custom'
      };
      const SIDEBAR_TYPE_BY_KEY = Object.fromEntries(
        Object.entries(SERVICE_SIDEBAR_KEYS).map(([type, key]) => [key, type])
      );

      const SERVICE_UI_CONFIG = {
        tech: { sidebarId: 'left-sidebar', toggleId: 'open-left-sidebar', legendSelector: '[data-legend="tech"]', collapsedClass: 'collapsed-left', layer: () => techLayer },
        reseller: { sidebarId: 'reseller-sidebar', toggleId: 'open-reseller-sidebar', legendSelector: '[data-legend="reseller"]', collapsedClass: 'collapsed-reseller', layer: () => resellerLayer },
        repair: { sidebarId: 'repair-sidebar', toggleId: 'open-repair-sidebar', legendSelector: '[data-legend="repair"]', collapsedClass: 'collapsed-repair', layer: () => repairLayer },
        custom: { sidebarId: 'dynamic-service-sidebar', toggleId: null, legendSelector: '#custom-legend-slot [data-legend]', collapsedClass: 'collapsed-dynamic', layer: () => customServiceLayer }
      };

      const PARTNER_SIDEBAR_CONFIGS = [
        { type: 'reseller', eyebrow: 'Reseller network', title: 'Nearby resellers', accentClass: 'text-emerald-300', filterPlaceholder: 'Filter resellers by name, city, or state', emptyText: 'Resellers will appear here.' },
        { type: 'repair', eyebrow: 'Repair network', title: 'Repair shops nearby', accentClass: 'text-orange-200', filterPlaceholder: 'Filter repair shops by name, city, or state', emptyText: 'Repair shops will appear here.' },
      ];

      const CUSTOM_SIDEBAR_CONFIG = {
        eyebrow: 'Dynamic services',
        title: 'New categories',
        accentClass: 'text-indigo-200',
        description: 'Showing every new category detected in Supabase.'
      };

      const partnerSidebarTemplate = ({ type, eyebrow, title, accentClass, filterPlaceholder, emptyText }) => `
      <aside id="${type}-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl" style="width: var(--${type}-sidebar-width)">
        <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p class="text-[10px] font-bold uppercase ${accentClass} mb-1">${eyebrow}</p>
              <h2 class="text-xl font-black text-white leading-tight">${title}</h2>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
                <p id="${type}-count" class="text-xl font-black text-white leading-none">0</p>
              </div>
              <button id="collapse-${type}" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize ${type} sidebar">-</button>
            </div>
          </div>
          <div class="mt-4 space-y-2">
            <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">Client starting point</p>
            <form id="${type}-search-form" class="relative">
              <input
                id="${type}-address-input"
                type="text"
                class="block w-full rounded-xl border border-slate-700 bg-slate-800 pl-4 pr-24 py-3 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
                placeholder="Ex: 33101, Phoenix, AZ..."
                autocomplete="off"
              >
              <button type="submit" id="${type}-search-btn" class="absolute inset-y-1.5 right-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 text-xs font-bold transition-colors flex items-center justify-center min-w-[90px]">
                CALCULATE
              </button>
            </form>
            <div class="flex justify-between items-end">
              <div id="${type}-search-status" class="hidden text-xs text-blue-400 animate-pulse font-medium">Locating address...</div>
            </div>
            <input
              id="${type}-filter"
              type="text"
              class="mt-2 block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="${filterPlaceholder}"
              autocomplete="off"
            >
          </div>
        </div>
        <div id="${type}-list" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-900 scroll-smooth relative">
          <div class="text-center mt-10 text-slate-600 text-xs">${emptyText}</div>
        </div>
      </aside>
    `;

      const dynamicSidebarTemplate = (config) => `
      <aside id="dynamic-service-sidebar" class="resizable-sidebar left-0 border-r border-slate-800 flex flex-col z-20 shadow-2xl collapsed-dynamic" style="width: var(--dynamic-sidebar-width)">
        <div class="p-5 border-b border-slate-800 bg-slate-900 shadow-md z-10">
          <div class="flex items-center justify-between gap-3">
            <div>
              <p id="dynamic-service-eyebrow" class="text-[10px] font-bold uppercase ${config.accentClass} mb-1">${config.eyebrow}</p>
              <h2 id="dynamic-service-title" class="text-xl font-black text-white leading-tight">${config.title}</h2>
              <p id="dynamic-service-description" class="mt-1 text-[12px] text-slate-400">${config.description}</p>
            </div>
            <div class="flex items-center gap-3">
              <div class="text-right">
                <p class="text-[10px] uppercase text-slate-400 font-bold">Total</p>
                <p id="dynamic-service-count" class="text-xl font-black text-white leading-none">0</p>
              </div>
              <button id="collapse-dynamic" class="h-8 w-8 rounded-full border border-slate-700 bg-slate-800/80 text-lg font-bold text-slate-200 hover:border-amber-400 hover:text-amber-200" aria-label="Minimize dynamic services sidebar">-</button>
            </div>
          </div>
          <div class="mt-4 space-y-2">
            <input
              id="dynamic-service-filter"
              type="text"
              class="block w-full rounded-xl border border-slate-700 bg-slate-800 px-3 py-2 text-sm text-white placeholder-slate-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all"
              placeholder="Filter services by name, city, or state"
              autocomplete="off"
            >
          </div>
        </div>
        <div id="dynamic-service-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-900 scroll-smooth relative">
          <div class="text-center mt-10 text-slate-600 text-xs">New categories will appear here.</div>
        </div>
      </aside>
    `;

      function buildPartnerSidebars() {
        const slot = document.getElementById('partner-sidebars');
        if (!slot) return;

        const sidebarMarkup = [
          ...PARTNER_SIDEBAR_CONFIGS.map((config) => partnerSidebarTemplate(config)),
          dynamicSidebarTemplate(CUSTOM_SIDEBAR_CONFIG)
        ].join('\n');

        slot.innerHTML = sidebarMarkup;
      }

      buildPartnerSidebars();

      const isServiceSidebarVisible = (type) => {
        if (!isServiceTypeEnabled(type)) return false;
        const config = SERVICE_UI_CONFIG[type];
        if (!config?.sidebarId) return false;
        const sidebar = document.getElementById(config.sidebarId);
        if (!sidebar || sidebar.classList.contains('hidden')) return false;
        return !config.collapsedClass || !sidebar.classList.contains(config.collapsedClass);
      };

      let enabledServiceTypes = new Set(SERVICE_TYPES);
      let customCategoryLabels = new Set();
      const CUSTOM_COLOR_PALETTE = ['#f472b6', '#f97316', '#14b8a6', '#a78bfa', '#ec4899', '#10b981', '#fb7185', '#22d3ee'];

      const isUnauthorizedPartner = (partner = {}) => {
        const value = `${partner.authorization || partner.details?.authorization || ''}`.trim().toLowerCase();
        return value === 'no' || value === 'unauthorized';
      };

      const isAuthorizedReseller = (partner = {}) => `${partner.authorization ?? ''}`.trim().toLowerCase() === 'authorized';

      const isRepoAgentPartner = (partner = {}) => `${partner.categoryLabel || partner.category || ''}`.trim().toLowerCase() === 'repo agent';
      const isParkingStoragePartner = (partner = {}) => `${partner.categoryLabel || partner.category || ''}`.trim().toLowerCase() === 'parking/storage';

      const hasSpAgentNote = (partner = {}) => `${partner.notes || ''}`.trim().toLowerCase() === 'sp agent';
      const hasSpStorageNote = (partner = {}) => `${partner.notes || ''}`.trim().toLowerCase() === 'sp storage';

      const getPartnerColor = (partner, defaultColor) => isUnauthorizedPartner(partner) ? '#94a3b8' : defaultColor;

      const formatPartnerLocation = (partner = {}) => {
        const cityText = partner.city ? `${partner.city}, ` : '';
        const stateText = partner.state || partner.region || 'US';
        const zipText = partner.zip ? ` ${partner.zip}` : '';
        return `${cityText}${stateText}${zipText}`.trim();
      };

      const showServicePreviewCard = (partner) => {
        if (!map || !partner) return;
        const locationText = formatPartnerLocation(partner) || 'Location unavailable';
        const zipText = partner.zip || 'N/A';
        const noteText = partner.notes || partner.note || partner.details?.note || '';
        const popup = L.popup({
          className: 'service-mini-popup',
          closeButton: true,
          autoClose: true,
          closeOnClick: true,
          maxWidth: 220,
          offset: [0, -6]
        })
          .setLatLng([partner.lat, partner.lng])
          .setContent(`
          <div class="service-mini-card">
            <p class="service-mini-title">${escapeHTML(partner.company || partner.name || 'Service')}</p>
            <p class="service-mini-location">${escapeHTML(locationText)}</p>
            <p class="service-mini-meta"><span class="service-mini-label">ZIP</span><span>${escapeHTML(zipText)}</span></p>
            ${noteText ? `<p class="service-mini-note"><span class="service-mini-label">Note</span> ${escapeHTML(noteText)}</p>` : ''}
          </div>
        `);

        popup.openOn(map);
      };

      const createServiceIcon = (color, { unauthorized = false, checkPulseColor = null } = {}) => L.divIcon({
        className: 'service-triangle-icon',
        html: `<div class="service-icon-wrapper"><svg width="18" height="16" viewBox="0 0 18 16" fill="${color}" stroke="#0f172a" stroke-width="1.4" xmlns="http://www.w3.org/2000/svg"><path d="M9 1.1L17 14.8H1L9 1.1Z"/></svg>${unauthorized ? '<span class="service-cross">✕</span>' : ''}${checkPulseColor ? `<span class="service-check" style="--service-check-accent:${checkPulseColor}">✓</span>` : ''}</div>`,
        iconSize: [18, 16],
        iconAnchor: [9, 14],
        popupAnchor: [0, -10]
      });

      const localDatasetKey = (key, suffix = 'csv') => `techloc:dataset:${key}:${suffix}`;

      async function loadDatasetText({ key, path }) {
        const override = localStorage.getItem(localDatasetKey(key));
        if (override) return override;
        const response = await fetch(path);
        if (!response.ok) throw new Error(`Unable to read ${path} (Status ${response.status})`);
        return response.text();
      }

      // --- 1. Initialize map ---
      function initMap() {
        map = L.map('tech-map', {
          renderer: L.canvas(),
          zoomControl: false,
          minZoom: 3,
          zoomSnap: 0.25,
          zoomDelta: 0.5
        }).setView([39.8, -98.5], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, minZoom: 3 }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', { maxZoom: 19, minZoom: 3, opacity: 0.95 }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        hotspotLayer = L.layerGroup().addTo(map);
        blacklistLayer = L.layerGroup().addTo(map);
        techLayer = createPartnerClusterGroup(SERVICE_COLORS.tech);
        vehicleLayer = L.markerClusterGroup({
          maxClusterRadius: 35,
          disableClusteringAtZoom: 17,
          spiderfyOnMaxZoom: true,
          showCoverageOnHover: false,
          iconCreateFunction(cluster) {
            const count = cluster.getChildCount();
            let sizeClass = 'w-8 h-8 text-xs';
            let iconSize = [32, 32];

            if (count > 100) {
              sizeClass = 'w-10 h-10 text-sm';
              iconSize = [40, 40];
            } else if (count > 10) {
              sizeClass = 'w-9 h-9 text-sm';
              iconSize = [36, 36];
            }

            const childMarkers = typeof cluster.getAllChildMarkers === 'function' ? cluster.getAllChildMarkers() : [];
            let hasRed = false;
            let hasAmber = false;
            let allGreen = true;
            let hasStopped = false;

            childMarkers.forEach((marker) => {
              const markerColor = marker?.options?.markerColor || (marker?.options?.vehicleData ? getVehicleMarkerColor(marker.options.vehicleData) : null);
              const isStopped = marker?.options?.isStopped || (marker?.options?.vehicleData ? isVehicleNotMoving(marker.options.vehicleData) : false);

              if (isStopped) {
                hasStopped = true;
              }

              if (markerColor) {
                const colorValue = `${markerColor}`.toLowerCase();
                if (colorValue === '#ef4444') {
                  hasRed = true;
                  allGreen = false;
                } else if (colorValue === '#f59e0b' || colorValue === '#fbbf24') {
                  hasAmber = true;
                  allGreen = false;
                } else if (colorValue !== '#22c55e') {
                  allGreen = false;
                }
              } else {
                allGreen = false;
              }
            });

            let clusterColor = '#f59e0b';
            if (hasRed) {
              clusterColor = '#ef4444';
            } else if (hasAmber) {
              clusterColor = '#f59e0b';
            } else if (allGreen && childMarkers.length > 0) {
              clusterColor = '#22c55e';
            }

            const badgeHtml = hasStopped ? '<span class="vehicle-cross-badge absolute inset-0 flex items-center justify-center pointer-events-none">✕</span>' : '';
            const [width, height] = iconSize;
            return L.divIcon({
              html: `<div class="relative border-2 font-bold rounded-full flex items-center justify-center shadow-lg bg-slate-900/90 ${sizeClass}" style="color:${clusterColor}; border-color:${clusterColor}">${badgeHtml}<span>${count}</span></div>`,
              className: 'vehicle-cluster-icon',
              iconSize,
              iconAnchor: [width / 2, height / 2]
            });
          }
        }).addTo(map);
        targetLayer = L.layerGroup().addTo(map);
        connectionLayer = L.layerGroup().addTo(map);
        serviceLayer = L.layerGroup().addTo(map);
        serviceConnectionLayer = L.layerGroup().addTo(map);
        highlightLayer = L.layerGroup().addTo(map);
        resellerLayer = createPartnerClusterGroup(SERVICE_COLORS.reseller);
        repairLayer = createPartnerClusterGroup(SERVICE_COLORS.repair);
        customServiceLayer = createPartnerClusterGroup(SERVICE_COLORS.custom);

        const invalidateMapSize = () => map?.invalidateSize();

        const mapContainer = document.getElementById('tech-map');
        if (mapContainer && typeof ResizeObserver !== 'undefined') {
          const resizeObserver = new ResizeObserver(() => {
            invalidateMapSize();
          });
          resizeObserver.observe(mapContainer);
        }

        const authBlock = document.querySelector('[data-auth-protected]');
        if (authBlock && typeof MutationObserver !== 'undefined') {
          const authObserver = new MutationObserver(() => {
            if (!authBlock.classList.contains('hidden')) {
              requestAnimationFrame(() => invalidateMapSize());
            }
          });
          authObserver.observe(authBlock, { attributes: true, attributeFilter: ['class'] });
        }

        map.on('click', (e) => {
          if (e.originalEvent?.handledByMarker) return;

          const lat = parseFloat(e.latlng.lat.toFixed(6));
          const lng = parseFloat(e.latlng.lng.toFixed(6));

          const hasActiveMapSelection = selectedVehicleId !== null || lastClientLocation !== null || lastOriginPoint !== null;
          if (hasActiveMapSelection) {
            resetSelection();
            lastOriginPoint = null;
            lastClientLocation = null;
            targetLayer?.clearLayers();
            renderVisibleSidebars();
            return;
          }

          resetSelection();
          targetLayer?.clearLayers();
          const locationPoint = { lat, lng, name: 'Pinned location' };
          lastClientLocation = locationPoint;
          lastOriginPoint = locationPoint;
          const targetIcon = L.divIcon({
            className: '',
            html: `<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>`
          });
          L.marker([lat, lng], { icon: targetIcon }).addTo(targetLayer);
          const popup = L.marker([lat, lng]).addTo(targetLayer);
          popup.bindPopup(`<b>Selected point</b><br>${lat.toFixed(4)}, ${lng.toFixed(4)}`).openPopup();

          showServicesFromOrigin(locationPoint, { forceType: isAnyServiceSidebarOpen() ? getActivePartnerType() : null });
          renderVisibleSidebars();
        });
      }

      // --- 2. Load data from Supabase ---
      async function loadTechnicians() {
        if (!isServiceTypeEnabled('tech')) return;
        if (!supabaseClient) {
          console.warn('Supabase unavailable: showing local installer placeholders.');
          document.getElementById('tech-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            ${svgIcon('alertCircle', 'mx-auto h-8 w-8 text-slate-600 mb-2')}
            <p class="text-slate-500 text-xs">Supabase is offline. Unable to load installers.</p>
          </div>
        `;
          return;
        }
        const stopLoading = startLoading('Loading Installers…');
        try {
          await ensureServiceCache();
          const data = getCachedServices(getServiceCategoryLabel('tech'));
          technicians = (data || []).map((row, idx) => normalizeInstaller(row, idx, { getField, toStateCode, resolveCoords })).filter(t => t.company || t.city || t.state);
          setServiceHeaders('technicians', data || []);
          renderedTechIds = '';
          document.getElementById('total-count').textContent = technicians.length;
          updateTechUI(technicians);
          renderVehicles();
        } catch (err) {
          console.warn("System warning: " + err.message);
          document.getElementById('file-error').classList.remove('hidden');
          document.getElementById('tech-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            ${svgIcon('fileWarning', 'mx-auto h-8 w-8 text-slate-600 mb-2')}
            <p class="text-slate-500 text-xs">No installer data detected.</p>
          </div>
        `;
        } finally {
          stopLoading();
        }
      }

      async function loadVehicles() {
        if (vehicles.length) return;
        if (!supabaseClient) {
          console.warn('Supabase unavailable: skipping vehicle load.');
          return;
        }
        const stopLoading = startLoading('Loading Vehicles…');
        try {
          const { data, error } = await supabaseClient.from(TABLES.vehicles).select('*');
          if (error) throw error;
          vehicles = (data || []).map((row, idx) => normalizeVehicle(row, idx, { getField, toStateCode, resolveCoords }));
          vehicleHeaders = data?.length ? Object.keys(data[0]) : [];
          updateVehicleFilterOptions();
          syncVehicleFilterInputs();
          renderVehicles();
        } catch (err) {
          console.warn("Vehicle load warning: " + err.message);
          document.getElementById('vehicle-list').innerHTML = `
          <div class="text-center mt-10 px-6">
            ${svgIcon('fileWarning', 'mx-auto h-8 w-8 text-slate-600 mb-2')}
            <p class="text-slate-500 text-xs">Unable to load vehicle data.</p>
          </div>
        `;
        } finally {
          stopLoading();
        }
      }

      function renderHotspots() {
        if (!hotspotLayer) return;
        hotspotLayer.clearLayers();

        hotspots.filter(hasValidCoords).forEach((hotspot) => {
          const circle = L.circle([hotspot.lat, hotspot.lng], {
            radius: hotspot.radiusMiles * MILES_TO_METERS,
            color: '#22c55e',
            weight: 1.5,
            fillColor: '#22c55e',
            fillOpacity: 0.18,
            opacity: 0.7,
          }).addTo(hotspotLayer);

          circle?.bringToBack?.();

          const locationText = [hotspot.city, hotspot.state, hotspot.zip].filter(Boolean).join(', ');
          circle.bindPopup(`
          <div class="text-xs text-slate-100 space-y-1">
            <p class="font-bold text-white text-sm">Hotspot</p>
            <p class="text-[11px] text-slate-300">${locationText || 'Location unavailable'}</p>
            <p class="text-[11px] text-emerald-300">Coverage radius: ${hotspot.radiusMiles} miles</p>
          </div>
        `);
        });
      }

      const createBlacklistIcon = () => L.divIcon({
        className: 'blacklist-triangle-icon',
        html: `<div class="blacklist-marker">!</div>`,
        iconSize: [18, 24],
        iconAnchor: [9, 20],
        popupAnchor: [0, -18]
      });

      function renderBlacklistSites() {
        if (!blacklistLayer) return;
        blacklistLayer.clearLayers();

        blacklistSites.filter(hasValidCoords).forEach((entry) => {
          const marker = L.marker([entry.lat, entry.lng], { icon: createBlacklistIcon() }).addTo(blacklistLayer);
          marker.on('click', (e) => { e.originalEvent.handledByMarker = true; });

          marker.bindPopup(`
          <div class="text-xs text-slate-100 space-y-1">
            <p class="font-bold text-amber-200 flex items-center gap-2 text-sm">
              <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-amber-500/20 text-amber-200 border border-amber-400/60">!</span>
              Device removal location
            </p>
            <p class="text-[11px] text-slate-300"><span class="text-slate-400">Company:</span> ${escapeHTML(entry.company || 'Unknown')}</p>
            ${entry.assocUnit ? `<p class="text-[11px] text-slate-300"><span class="text-slate-400">Assoc. Unit:</span> ${escapeHTML(entry.assocUnit)}</p>` : ''}
            ${entry.note ? `<p class="text-[11px] text-amber-200 font-semibold">${escapeHTML(entry.note)}</p>` : ''}
          </div>
        `);
        });
      }

      async function loadHotspots() {
        if (!supabaseClient) {
          console.warn('Supabase unavailable: skipping hotspot load.');
          return;
        }

        const stopLoading = startLoading('Loading hotspots…');
        try {
          const { data, error } = await supabaseClient.from(TABLES.hotspots).select('*');
          if (error) throw error;
          hotspots = (data || []).map((row, idx) => normalizeHotspot(row, idx)).filter(hasValidCoords);
          renderHotspots();
        } catch (err) {
          console.warn(`Hotspot load warning: ${err.message}`);
        } finally {
          stopLoading();
        }
      }

      async function loadBlacklistSites() {
        if (!supabaseClient) {
          console.warn('Supabase unavailable: skipping blacklist load.');
          return;
        }

        const stopLoading = startLoading('Loading Blacklist Locations…');
        try {
          const { data, error } = await supabaseClient.from(TABLES.blacklist).select('*');
          if (error) throw error;
          blacklistSites = (data || []).map((row, idx) => normalizeBlacklistEntry(row, idx)).filter(hasValidCoords);
          renderBlacklistSites();
        } catch (err) {
          console.warn(`Blacklist load warning: ${err.message}`);
        } finally {
          stopLoading();
        }
      }

      const SERVICE_LOAD_CONFIG = {
        reseller: {
          uiUpdate: updateResellerUI,
          setList: (list) => { resellers = list; },
          warningLabel: 'Reseller'
        },
        repair: {
          uiUpdate: updateRepairUI,
          setList: (list) => { repairShops = list; },
          warningLabel: 'Repair shop'
        }
      };

      async function loadPartnerService(type) {
        if (!isServiceTypeEnabled(type)) return;
        if (!supabaseClient) return;

        const config = SERVICE_LOAD_CONFIG[type];
        if (!config) {
          console.warn(`No service config found for type "${type}".`);
          return;
        }

        try {
          await ensureServiceCache();
          const data = getCachedServices(getServiceCategoryLabel(type));
          setServiceHeaders(type, data);
          const normalized = (data || []).map((row, idx) => normalizePartner(row, type, idx, { getField, toStateCode, resolveCoords }));
          config.setList(normalized);
          config.uiUpdate(normalized);
        } catch (err) {
          const label = config.warningLabel || type;
          console.warn(`${label} load warning: ${err.message}`);
        }
      }

      async function loadAllServices() {
        if (!supabaseClient) return;

        await ensureServiceCache();

        const categoryMap = new Map();
        serviceCacheByCategory.forEach((rows, key) => {
          const sample = rows?.[0];
          const label = sample?.category || key || 'Custom';
          categoryMap.set(key, label);
        });

        updateServiceCategoryLabels(categoryMap);

        const knownLabels = new Set(
          Array.from(serviceCategoryLabelsByType.values()).map((label) => normalizeCategoryLabel(label).toLowerCase())
        );
        customCategoryLabels = new Set(
          Array.from(categoryMap.values()).filter((label) => !knownLabels.has(normalizeCategoryLabel(label).toLowerCase()))
        );
        rebuildCustomCategoryToggles();

        for (const type of Object.keys(SERVICE_LOAD_CONFIG)) {
          await loadPartnerService(type);
        }

        if (isServiceTypeEnabled('custom') && customCategoryLabels.size) {
          await loadCustomServices();
        }
      }

      async function loadCustomServices() {
        if (!isServiceTypeEnabled('custom') || !customCategoryLabels.size) return;
        if (!supabaseClient) {
          console.warn('Supabase unavailable: skipping custom categories.');
          return;
        }

        try {
          const labels = Array.from(customCategoryLabels);
          await ensureServiceCache();
          const data = labels.flatMap((label) => getCachedServices(label));

          customCategories.forEach(({ layer }) => layer?.clearLayers?.());
          customServices = (data || []).map((row, idx) => {
            const rawLabel = normalizeCategoryLabel(row?.category || 'Custom');
            const meta = ensureCustomCategoryMeta(rawLabel);
            const partner = normalizePartner(row, 'custom', idx, { getField, toStateCode, resolveCoords });
            return { ...partner, categoryKey: meta.key, categoryLabel: meta.label, color: meta.color, type: `custom-${meta.key}` };
          });

          if (!selectedCustomCategoryKey && customServices.length) {
            selectedCustomCategoryKey = customServices[0].categoryKey;
          }

          renderCategorySidebar(selectedCustomCategoryKey, customServices);
        } catch (err) {
          console.warn(`Custom service warning: ${err.message}`);
        }
      }

      // --- 4. Update map and list ---
      function updateTechUI(techList, target = null, clientLocation = null) {
        if (!techSidebarVisible) {
          techLayer?.clearLayers();
          return;
        }
        const listContainer = document.getElementById('tech-list');
        listContainer.innerHTML = '';

        const origin = clientLocation || getCurrentOrigin();
        const techWithDistances = attachDistances(
          techList,
          origin,
          distanceCaches.tech,
          (tech) => getDistance(origin.lat, origin.lng, tech.lat, tech.lng)
        );
        const sortedList = origin
          ? techWithDistances.sort((a, b) => a.distance - b.distance)
          : [...techWithDistances];

        const selectedTech = selectedTechId !== null
          ? sortedList.find(t => t.id === selectedTechId) || techList.find(t => t.id === selectedTechId)
          : null;

        const displayList = selectedTech
          ? [selectedTech, ...sortedList.filter(t => t.id !== selectedTech.id)]
          : sortedList;

        const displayKey = displayList.map(t => t.id).join('|');
        const shouldRenderMarkers = techSidebarVisible && displayKey !== renderedTechIds;

        if (shouldRenderMarkers) {
          techLayer.clearLayers();
        }

        if (displayList.length === 0) {
          listContainer.innerHTML = `<div class="text-center mt-10 text-slate-600 text-xs">No technicians match this selection.</div>`;
        }

        if (shouldRenderMarkers) {
          displayList.forEach(tech => {
            const marker = L.marker([tech.lat, tech.lng], {
              icon: createServiceIcon(SERVICE_COLORS.tech)
            }).addTo(techLayer);

            marker.bindPopup(`
            <div class="text-slate-900 p-1 font-sans">
              <strong class="block text-sm font-bold mb-1">${tech.company}</strong>
              <div class="text-xs text-slate-500 mb-2">${tech.city}, ${tech.state} ${tech.zip}</div>
              <a href="tel:${tech.phoneDial || tech.phone}" class="block bg-blue-100 text-blue-700 px-2 py-1 rounded text-center text-xs font-bold mb-1">${tech.phone}</a>
              <div class="text-[10px] text-slate-400 truncate">${tech.email}</div>
            </div>
          `);

            marker.on('click', (e) => {
              e.originalEvent.handledByMarker = true;
              map.flyTo([tech.lat, tech.lng], 15, { duration: 1.2 });
              applySelection(null, tech.id);
            });
          });

          renderedTechIds = displayKey;
        }

        displayList.slice(0, 50).forEach((tech, idx) => {
          const isNearest = target && idx === 0;

          const card = document.createElement('div');
          card.className = `p-3 rounded-lg border transition-colors cursor-pointer ${isNearest ? 'bg-slate-800 border-blue-500 ring-1 ring-blue-500' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;
          card.dataset.id = tech.id;
          card.dataset.type = 'tech';

          const distanceLabel = origin && typeof tech.distance === 'number'
            ? `${Math.round(tech.distance)} mi`
            : '';

          card.innerHTML = `
          <div class="flex justify-between items-start gap-3">
            <div class="min-w-0 space-y-1">
              <h3 class="font-bold text-white text-sm break-words leading-tight" title="${tech.company}">${tech.company}</h3>
              <p class="flex items-center gap-1 text-[11px] text-slate-400 leading-tight">${svgIcon('mapPin', 'h-3 w-3')}<span class="truncate">${tech.city || 'Unknown'}, ${tech.state || 'US'}</span></p>
            </div>
            <div class="text-right text-[11px] text-slate-400 leading-tight space-y-0.5">
              <p class="font-semibold text-slate-200">${tech.phone || ''}</p>
              ${tech.email ? `<p class="flex items-center gap-1 justify-end text-slate-400">${svgIcon('mail', 'h-3 w-3')}<span class="truncate max-w-[160px]">${tech.email}</span></p>` : ''}
              ${distanceLabel ? `<p class="flex items-center gap-1 justify-end text-slate-300">${svgIcon('navigation', 'h-3 w-3')}<span class="font-semibold text-slate-100">${distanceLabel}</span></p>` : ''}
            </div>
          </div>
          ${tech.zip ? `<p class="text-[10px] text-slate-500 mt-1">${tech.zip}</p>` : ''}

        `;

          listContainer.appendChild(card);
        });

      }

      const isAnyServiceSidebarOpen = () => getVisibleServiceTypes().length > 0;

      const getPartnerFilterValue = (type = 'tech') => `${serviceFilters[type] || ''}`.trim().toLowerCase();

      const applyServiceFilter = (list = [], type = 'tech') => {
        const query = getPartnerFilterValue(type);
        if (!query) return list;
        return list.filter((partner) => {
          return [partner.company, partner.contact, partner.city, partner.state, partner.zip, partner.region]
            .some(value => `${value || ''}`.toLowerCase().includes(query));
        });
      };

      function filterSidebarForPartner(type, partner) {
        if (!type || !partner) return;
        const filterValue = partner.company || partner.name || partner.zip || '';
        serviceFilters[type] = filterValue;
        const inputId = type === 'custom' ? 'dynamic-service-filter' : `${type}-filter`;
        const input = document.getElementById(inputId);
        if (input) {
          input.value = filterValue;
        }
        renderVisibleSidebars();
      }

      const updateServiceCount = (type, total, filteredTotal = total) => {
        const countId = type === 'custom' ? 'dynamic-service-count' : `${type}-count`;
        const el = document.getElementById(countId);
        if (el) {
          el.textContent = filteredTotal !== total ? `${filteredTotal}/${total}` : total;
        }
      };

      const getCurrentOrigin = () => {
        if (selectedVehicleId !== null) {
          const vehicle = vehicles.find(v => v.id === selectedVehicleId && hasValidCoords(v));
          if (vehicle) return vehicle;
        }

        if (selectedTechId !== null) {
          const tech = technicians.find(t => t.id === selectedTechId && hasValidCoords(t));
          if (tech) return tech;
        }

        const selectedPartner = Object.values(selectedServiceByType).find(Boolean);
        if (selectedPartner && hasValidCoords(selectedPartner)) return selectedPartner;

        if (lastOriginPoint) return lastOriginPoint;
        if (lastClientLocation) return lastClientLocation;
        return null;
      };

      const getSelectedService = (type) => selectedServiceByType[type] || null;

      function renderPartnerUI(partners = [], options) {
        const { containerId, layer, visible, accentColor, badgeLabel, type } = options;
        if (!isServiceTypeEnabled(type)) return;
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!visible) {
          const placeholder = document.createElement('div');
          placeholder.className = 'text-center mt-10 text-slate-600 text-xs';
          placeholder.textContent = 'Open this sidebar to view nearby partners.';
          container.replaceChildren(placeholder);
          layer?.clearLayers();
          updateServiceCount(type, partners.length, applyServiceFilter(partners, type).length);
          return;
        }

        container.replaceChildren();
        layer?.clearLayers();

        const totalPartners = partners.length;
        const filteredPartners = applyServiceFilter(partners, type);
        const selectedService = getSelectedService(type);
        const origin = getCurrentOrigin() || selectedService;
        const partnersWithDistances = attachDistances(
          filteredPartners,
          origin,
          distanceCaches.partners,
          (partner) => getDistance(origin.lat, origin.lng, partner.lat, partner.lng)
        );
        const sorted = origin
          ? partnersWithDistances.sort((a, b) => a.distance - b.distance)
          : [...partnersWithDistances];

        const prioritized = selectedService
          ? [sorted.find(p => p.id === selectedService.id) || selectedService, ...sorted.filter(p => p.id !== selectedService.id)]
          : sorted;

        updateServiceCount(type, totalPartners, prioritized.length);

        if (!prioritized.length) {
          const empty = document.createElement('div');
          empty.className = 'text-center mt-10 text-slate-600 text-xs';
          empty.textContent = 'No partners available.';
          container.replaceChildren(empty);
          return;
        }

        const fragment = document.createDocumentFragment();
        const markerLimit = Math.min(prioritized.length, 75);
        const cardLimit = Math.min(prioritized.length, PARTNER_CARD_LIMIT);

        prioritized.forEach((partner, idx) => {
          const unauthorized = isUnauthorizedPartner(partner);
          const markerColor = getPartnerColor(partner, accentColor);
          const checkPulseColor =
            !unauthorized && type === 'reseller' && isAuthorizedReseller(partner)
              ? markerColor
              : null;

          if (idx < markerLimit) {
            const marker = L.marker([partner.lat, partner.lng], {
              icon: createServiceIcon(markerColor, { unauthorized, checkPulseColor })
            }).addTo(layer);

            const locationText = formatPartnerLocation(partner);

            marker.bindPopup(`
              <div class="text-slate-900 p-1 font-sans">
                <strong class="block text-sm font-bold mb-1">${partner.company}</strong>
                <div class="text-xs text-slate-500 mb-2">${locationText || 'US'}</div>
                <a href="tel:${partner.phoneDial || partner.phone}" class="block bg-slate-100 text-slate-800 px-2 py-1 rounded text-center text-xs font-bold mb-1">${partner.phone || 'Contact'}</a>
                <div class="text-[10px] text-slate-500">${partner.availability || ''}</div>
              </div>
            `);

            marker.on('click', (e) => {
              e.originalEvent.handledByMarker = true;
              sidebarStateController?.setState?.(SERVICE_SIDEBAR_KEYS[type] || 'left', true);
              selectedServiceByType[type] = partner;
              filterSidebarForPartner(type, partner);
              const originPoint = getCurrentOrigin() || partner;
              if (originPoint) {
                showServicesFromOrigin(originPoint, { forceType: type });
              }
              showServicePreviewCard(partner);
              renderPartnerUI(partners, options);
              map.flyTo([partner.lat, partner.lng], 15, { duration: 1.2 });
            });
          }

          if (idx >= cardLimit) return;

          const locationText = formatPartnerLocation(partner);
          const card = document.createElement('div');
          const isSelected = selectedService?.id === partner.id;
          card.className = `p-3 rounded-lg border transition-colors cursor-pointer ${isSelected || (idx === 0 && origin) ? 'bg-slate-800 border-amber-400 ring-1 ring-amber-400' : 'bg-slate-900 border-slate-800 hover:border-slate-700'}`;
          card.dataset.id = partner.id;
          card.dataset.type = 'partner';
          card.dataset.partnerType = type;
          card.innerHTML = `
            <div class="flex justify-between items-start gap-3">
              <div class="min-w-0">
                <p class="text-[10px] font-semibold uppercase tracking-wide text-slate-400">${badgeLabel}</p>
                <h3 class="font-bold text-white text-sm break-words leading-tight" title="${partner.company}">${partner.company}</h3>
              </div>
              <div class="text-right text-[11px] text-slate-400 leading-tight">
                <p class="font-semibold text-slate-200">${partner.contact || 'Dispatch'}</p>
                <a class="block font-bold text-blue-200" href="tel:${partner.phoneDial || partner.phone}">${partner.phone || ''}</a>
                <p class="text-[10px] text-slate-500">${partner.availability || ''}</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2 text-[11px] text-slate-300">
              <div class="flex items-center gap-1 text-slate-400">${svgIcon('mapPin')}<span>${locationText || 'US'}</span></div>
              ${origin ? `<div class="flex items-center gap-1 justify-end text-slate-300">${svgIcon('navigation')}<span class="font-semibold text-slate-100">${Math.round(partner.distance)} mi</span></div>` : ''}
              ${partner.notes ? `<div class="col-span-2 text-[10px] text-slate-400 leading-tight">${partner.notes}</div>` : ''}
            </div>

          `;

          fragment.appendChild(card);
        });

        if (prioritized.length > cardLimit) {
          const notice = document.createElement('p');
          notice.className = 'text-[11px] text-slate-500 px-1 pt-1';
          notice.textContent = `Showing the first ${cardLimit} of ${prioritized.length} partners.`;
          fragment.appendChild(notice);
        }

        container.replaceChildren(fragment);
      }

      function updateResellerUI(list = resellers) {
        renderPartnerUI(list, { containerId: 'reseller-list', layer: resellerLayer, visible: resellerSidebarVisible, accentColor: '#34d399', badgeLabel: 'Reseller', type: 'reseller', countId: 'reseller-count' });
      }

      function updateRepairUI(list = repairShops) {
        renderPartnerUI(list, { containerId: 'repair-list', layer: repairLayer, visible: repairSidebarVisible, accentColor: '#fb923c', badgeLabel: 'Repair shop', type: 'repair', countId: 'repair-count' });
      }

      function renderCategorySidebar(categoryKey = selectedCustomCategoryKey, list = customServices) {
        const container = document.getElementById('dynamic-service-list');
        const counter = document.getElementById('dynamic-service-count');
        const titleEl = document.getElementById('dynamic-service-title');
        const eyebrowEl = document.getElementById('dynamic-service-eyebrow');
        const descEl = document.getElementById('dynamic-service-description');
        const filterInput = document.getElementById('dynamic-service-filter');
        if (!container) return;

        const meta = categoryKey ? customCategories.get(categoryKey) || ensureCustomCategoryMeta(categoryKey) : null;
        const label = meta?.label || 'Dynamic services';
        if (titleEl) titleEl.textContent = `${label} Network`;
        if (eyebrowEl) eyebrowEl.textContent = label;
        if (descEl) descEl.textContent = `Showing ${label} partners detected in Supabase.`;

        const normalizedList = list.filter((item) => !categoryKey || item?.categoryKey === categoryKey);
        const filterValue = `${serviceFilters.custom || filterInput?.value || ''}`.toLowerCase();
        const origin = getCurrentOrigin();
        const withDistances = attachDistances(normalizedList, origin, distanceCaches.partners, (partner) => {
          if (!origin) return 0;
          return getDistance(origin.lat, origin.lng, partner.lat, partner.lng);
        });
        const sorted = origin ? [...withDistances].sort((a, b) => a.distance - b.distance) : [...withDistances];
        const filtered = filterValue
          ? sorted.filter((partner) => {
            const haystack = `${partner.company || partner.name || ''} ${partner.city || ''} ${partner.state || ''}`.toLowerCase();
            return haystack.includes(filterValue);
          })
          : sorted;

        const markersAllowed = customSidebarVisible && isServiceTypeEnabled('custom');
        customCategories.forEach(({ layer }) => layer?.clearLayers?.());

        container.innerHTML = '';

        if (!filtered.length) {
          container.innerHTML = '<div class="text-center mt-10 text-slate-600 text-xs">No services available.</div>';
          counter && (counter.textContent = '0');
          return;
        }

        const fragment = document.createDocumentFragment();
        filtered.slice(0, PARTNER_CARD_LIMIT).forEach((partner) => {
          const locationText = formatPartnerLocation(partner) || 'US';
          const card = document.createElement('article');
          card.className = 'rounded-xl border border-slate-800 bg-slate-900/70 p-3 shadow-sm hover:border-blue-500/70 transition-colors';
          card.dataset.id = partner.id;
          card.dataset.type = 'partner';
          card.dataset.partnerType = 'custom';

          const distanceLabel = origin && typeof partner.distance === 'number' ? `${Math.round(partner.distance)} mi` : '';
          card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm font-bold text-white leading-tight">${escapeHTML(partner.company || partner.name || 'Service')}</p>
              <p class="flex items-center gap-1 text-[11px] text-slate-400 leading-tight">${svgIcon('mapPin', 'h-3 w-3')}<span class="truncate">${escapeHTML(locationText)}</span></p>
            </div>
            <div class="text-right text-[11px] text-slate-400 leading-tight space-y-0.5">
              ${partner.phone ? `<a class="font-bold text-blue-200 block" href="tel:${partner.phoneDial || partner.phone}">${partner.phone}</a>` : ''}
              ${distanceLabel ? `<p class="flex items-center gap-1 justify-end text-slate-300">${svgIcon('navigation', 'h-3 w-3')}<span class="font-semibold text-slate-100">${distanceLabel}</span></p>` : ''}
            </div>
          </div>
          ${partner.notes ? `<p class="mt-2 text-[11px] text-slate-400 leading-tight">${escapeHTML(partner.notes)}</p>` : ''}
        `;

          fragment.appendChild(card);

          if (markersAllowed && map && meta?.layer) {
            if (!map.hasLayer(meta.layer)) {
              meta.layer.addTo(map);
            }

            if (hasValidCoords(partner)) {
              const checkPulseColor =
                (isRepoAgentPartner(partner) && hasSpAgentNote(partner)) ||
                  (isParkingStoragePartner(partner) && hasSpStorageNote(partner))
                  ? meta.color
                  : null;
              const icon = createServiceIcon(meta.color, { unauthorized: isUnauthorizedPartner(partner), checkPulseColor });
              const marker = L.marker([partner.lat, partner.lng], { icon });
              marker.on('click', (e) => {
                e.originalEvent.handledByMarker = true;
                showServicePopup(partner, meta.color);
              });
              marker.addTo(meta.layer);
            }
          }
        });

        container.appendChild(fragment);
        counter && (counter.textContent = filtered.length);
      }

      function renderVisibleSidebars() {
        if (techSidebarVisible && isServiceTypeEnabled('tech')) updateTechUI(getTechList(technicians));
        if (resellerSidebarVisible && isServiceTypeEnabled('reseller')) updateResellerUI(resellers);
        if (repairSidebarVisible && isServiceTypeEnabled('repair')) updateRepairUI(repairShops);
        if (customSidebarVisible && isServiceTypeEnabled('custom')) renderCategorySidebar(selectedCustomCategoryKey, customServices);
      }

      const PARTNER_TYPE_CONFIG = {
        reseller: { containerId: 'reseller-list', updater: updateResellerUI, getList: () => resellers },
        repair: { containerId: 'repair-list', updater: updateRepairUI, getList: () => repairShops },
        custom: { containerId: 'dynamic-service-list', updater: renderCategorySidebar, getList: () => customServices }
      };

      const findVehicleById = (id) => vehicles.find((vehicle) => `${vehicle.id}` === `${id}`);
      const findTechById = (id) => technicians.find((tech) => `${tech.id}` === `${id}`);
      const findPartnerById = (type, id) => {
        const getter = PARTNER_TYPE_CONFIG[type]?.getList;
        const list = typeof getter === 'function' ? getter() : [];
        return list.find((partner) => `${partner.id}` === `${id}`);
      };

      function handleVehicleListClick(event) {
        const container = event.currentTarget;
        const card = event.target.closest('[data-type="vehicle"]');
        const viewMoreBtn = event.target.closest('[data-action="vehicle-view-more"]');
        const repairHistoryBtn = event.target.closest('[data-action="repair-history"]');
        if (!card || !container.contains(card)) return;

        const vehicle = findVehicleById(card.dataset.id);
        if (!vehicle) return;

        if (viewMoreBtn) {
          event.stopPropagation();
          openVehicleModal(vehicle);
          return;
        }

        if (repairHistoryBtn) {
          event.stopPropagation();
          openRepairModal(vehicle);
          return;
        }

        applySelection(vehicle.id, null);
        focusVehicle(vehicle);
      }

      function handleTechListClick(event) {
        const container = event.currentTarget;
        const card = event.target.closest('[data-type="tech"]');
        if (!card || !container.contains(card)) return;

        const tech = findTechById(card.dataset.id);
        if (!tech) return;

        map.flyTo([tech.lat, tech.lng], 15, { duration: 1.2 });
        applySelection(null, tech.id);
      }

      function handlePartnerListClick(event, type) {
        const container = event.currentTarget;
        const card = event.target.closest('[data-type="partner"]');
        if (!card || !container.contains(card) || card.dataset.partnerType !== type) return;

        const partner = findPartnerById(type, card.dataset.id);
        if (!partner) return;

        sidebarStateController?.setState?.(SERVICE_SIDEBAR_KEYS[type] || 'left', true);
        if (hasValidCoords(partner) && map) {
          map.flyTo([partner.lat, partner.lng], 15, { duration: 1.2 });
        }
        selectedServiceByType[type] = partner;

        const originPoint = type === 'custom' ? null : getCurrentOrigin() || partner;
        if (originPoint) {
          showServicesFromOrigin(originPoint, { forceType: type });
        }

        if (type === 'custom' && hasValidCoords(partner)) {
          showServicePopup(partner, partner.color || SERVICE_COLORS.custom);
        }

        const updater = PARTNER_TYPE_CONFIG[type]?.updater;
        if (typeof updater === 'function') updater();
      }

      function setupEventDelegation() {
        const vehicleList = document.getElementById('vehicle-list');
        if (vehicleList) vehicleList.addEventListener('click', handleVehicleListClick);

        const techList = document.getElementById('tech-list');
        if (techList) techList.addEventListener('click', handleTechListClick);

        Object.entries(PARTNER_TYPE_CONFIG).forEach(([type, config]) => {
          const container = document.getElementById(config.containerId);
          if (!container) return;
          container.addEventListener('click', (event) => handlePartnerListClick(event, type));
        });
      }

      function updateHotspotToggle() {
        const toggle = document.getElementById('toggle-hotspots');
        if (!toggle) return;

        toggle.textContent = hotspotsVisible ? 'Hide Hotspot Areas' : 'Show Hotspot Areas';
        toggle.classList.toggle('active', hotspotsVisible);
        toggle.setAttribute('aria-pressed', hotspotsVisible ? 'true' : 'false');
      }

      function setHotspotsVisible(visible) {
        hotspotsVisible = !!visible;
        updateHotspotToggle();

        if (!hotspotLayer || !map) return;
        if (!hotspotsVisible) {
          if (map.hasLayer(hotspotLayer)) map.removeLayer(hotspotLayer);
          return;
        }

        if (!map.hasLayer(hotspotLayer)) hotspotLayer.addTo(map);
        renderHotspots();
      }

      function setupHotspotToggle() {
        const toggle = document.getElementById('toggle-hotspots');
        if (!toggle) return;

        toggle.addEventListener('click', () => setHotspotsVisible(!hotspotsVisible));
        updateHotspotToggle();
      }

      function updateBlacklistToggle() {
        const toggle = document.getElementById('toggle-blacklist');
        if (!toggle) return;

        toggle.textContent = blacklistMarkersVisible ? 'Hide Blacklist Marks' : 'Show Blacklist Marks';
        toggle.classList.toggle('active', blacklistMarkersVisible);
        toggle.setAttribute('aria-pressed', blacklistMarkersVisible ? 'true' : 'false');
      }

      function setBlacklistVisible(visible) {
        blacklistMarkersVisible = !!visible;
        updateBlacklistToggle();

        if (!blacklistLayer || !map) return;
        if (!blacklistMarkersVisible) {
          if (map.hasLayer(blacklistLayer)) map.removeLayer(blacklistLayer);
          return;
        }

        if (!map.hasLayer(blacklistLayer)) blacklistLayer.addTo(map);
        renderBlacklistSites();
      }

      function setupBlacklistToggle() {
        const toggle = document.getElementById('toggle-blacklist');
        if (!toggle) return;

        toggle.addEventListener('click', () => setBlacklistVisible(!blacklistMarkersVisible));
        updateBlacklistToggle();
      }

      function updateVehicleMarkerToggle() {
        const toggle = document.getElementById('toggle-vehicle-markers');
        if (!toggle) return;

        toggle.textContent = vehicleMarkersVisible ? 'Hide Vehicles Marks' : 'Show Vehicles Marks';
        toggle.classList.toggle('active', vehicleMarkersVisible);
        toggle.setAttribute('aria-pressed', vehicleMarkersVisible ? 'true' : 'false');
      }

      function setVehicleMarkersVisible(visible) {
        vehicleMarkersVisible = !!visible;
        updateVehicleMarkerToggle();

        if (!vehicleMarkersVisible) {
          if (vehicleLayer) {
            vehicleLayer.clearLayers();
            if (map?.hasLayer(vehicleLayer)) map.removeLayer(vehicleLayer);
          }
          vehicleMarkers.clear();
          highlightLayer?.clearLayers();
          return;
        }

        if (vehicleLayer && map && !map.hasLayer(vehicleLayer)) {
          vehicleLayer.addTo(map);
        }

        renderVehicles();
      }

      function setupVehicleMarkerToggle() {
        const toggle = document.getElementById('toggle-vehicle-markers');
        if (!toggle) return;

        toggle.addEventListener('click', () => setVehicleMarkersVisible(!vehicleMarkersVisible));
        updateVehicleMarkerToggle();
      }

      function createVehicleMarkerIcon(markerColor, borderColor, isStopped) {
        return L.divIcon({
          className: 'vehicle-marker-wrapper',
          html: `<div class="vehicle-marker-icon"><span class="vehicle-marker-dot" style="background:${markerColor}; border-color:${borderColor}"></span>${isStopped ? '<span class="vehicle-cross-badge">✕</span>' : ''}</div>`,
          iconSize: [18, 18],
          iconAnchor: [9, 9]
        });
      }

      function syncVehicleMarkers(vehiclesWithCoords) {
        if (!vehicleLayer) return;

        if (!vehicleMarkersVisible) {
          vehicleLayer.clearLayers();
          vehicleMarkers.clear();
          return;
        }

        const activeIds = new Set();

        vehiclesWithCoords.forEach(({ vehicle, coords, focusHandler }) => {
          if (!coords) return;

          const markerColor = getVehicleMarkerColor(vehicle);
          const borderColor = getVehicleMarkerBorderColor(markerColor);
          const isStopped = isVehicleNotMoving(vehicle);
          const icon = createVehicleMarkerIcon(markerColor, borderColor, isStopped);

          const stored = vehicleMarkers.get(vehicle.id);
          let marker = stored?.marker;

          if (marker) {
            marker.setLatLng([coords.lat, coords.lng]);
            marker.setIcon(icon);
            marker.setZIndexOffset(isStopped ? 500 : 0);
            marker.options.vehicleData = vehicle;
            marker.options.markerColor = markerColor;
            marker.options.isStopped = isStopped;
          } else {
            marker = L.marker([coords.lat, coords.lng], { icon, zIndexOffset: isStopped ? 500 : 0, vehicleData: vehicle, markerColor, isStopped }).addTo(vehicleLayer);
            marker.on('click', (e) => { e.originalEvent.handledByMarker = true; focusHandler(); });
          }

          vehicleMarkers.set(vehicle.id, { marker });
          activeIds.add(vehicle.id);
        });

        [...vehicleMarkers.keys()].forEach((id) => {
          if (activeIds.has(id)) return;
          const stored = vehicleMarkers.get(id);
          if (stored?.marker) vehicleLayer.removeLayer(stored.marker);
          vehicleMarkers.delete(id);
        });
      }

      function renderVehicles() {
        const container = document.getElementById('vehicle-list');
        if (!container) return;

        if (map) map.closePopup();
        container.replaceChildren();

        if (!vehicleMarkersVisible && map?.hasLayer(vehicleLayer)) {
          map.removeLayer(vehicleLayer);
        } else if (vehicleMarkersVisible && map && vehicleLayer && !map.hasLayer(vehicleLayer)) {
          vehicleLayer.addTo(map);
        }

        const searchBox = document.getElementById('vehicle-search');
        const filtered = getVehicleList(searchBox?.value || '');
        document.getElementById('vehicles-count').textContent = filtered.length;

        if (filtered.length === 0) {
          const empty = document.createElement('div');
          empty.className = 'text-center mt-10 text-slate-600 text-xs';
          empty.textContent = 'No vehicles match your search.';
          container.replaceChildren(empty);
          syncVehicleMarkers([]);
          return;
        }

        const fragment = document.createDocumentFragment();
        const vehiclesForMarkers = [];

        filtered.forEach((vehicle, idx) => {
          const movingMeta = getMovingMeta(vehicle);

          const focusHandler = () => {
            if (!hasValidCoords(vehicle)) {
              console.warn(`No coordinates available for vehicle ${vehicle.vin || vehicle.id || 'unknown'}`);
              return;
            }
            applySelection(vehicle.id, null);
            focusVehicle(vehicle);
          };

          let coords = null;
          if (hasValidCoords(vehicle)) {
            vehicle.locationAccuracy = vehicle.locationAccuracy || 'exact';
            vehicle.locationNote = getLocationNote(vehicle.locationAccuracy);
            coords = { lat: vehicle.lat, lng: vehicle.lng };
          } else if (vehicle.zipcode || vehicle.city || vehicle.state) {
            const derived = resolveCoords(vehicle, { zip: vehicle.zipcode, city: vehicle.city, stateCode: vehicle.state });
            coords = derived.coords;
            vehicle.lat = coords.lat;
            vehicle.lng = coords.lng;
            vehicle.locationAccuracy = derived.accuracy;
            vehicle.locationNote = getLocationNote(vehicle.locationAccuracy);
          } else {
            console.warn(`No location data for vehicle ${vehicle.vin || vehicle.id || 'unknown'}`);
          }

          if (coords && vehicleMarkersVisible) {
            vehiclesForMarkers.push({ vehicle, coords, focusHandler });
          }

          if (idx >= VEHICLE_RENDER_LIMIT) return;

          const card = document.createElement('div');
          const dealStatusStyles = getStatusCardStyles(vehicle.status, 'deal');
          const prepStatusStyles = getStatusCardStyles(vehicle.invPrepStatus, 'prep');
          const ptStatusStyles = getStatusCardStyles(vehicle.ptStatus, 'pt');
          card.className = 'p-3 rounded-lg border border-slate-800 bg-slate-900/80 hover:border-amber-500/80 transition-all cursor-pointer shadow-sm hover:shadow-amber-500/20 backdrop-blur space-y-3';
          card.dataset.id = vehicle.id;
          card.dataset.type = 'vehicle';
          card.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-300">${vehicle.model}</p>
                <h3 class="font-extrabold text-white text-sm leading-tight flex items-center gap-2">${vehicle.year || '—'} <span class="text-slate-600">•</span> ${vehicle.vin || 'VIN N/A'}</h3>
                <p class="text-[11px] text-slate-400 flex items-center gap-1">${svgIcon('mapPin')} ${vehicle.lastLocation || 'No location provided'}</p>
                ${vehicle.locationNote ? `<p class="text-[10px] text-amber-200 font-semibold">${vehicle.locationNote}</p>` : ''}
                <p class="text-[11px] text-blue-200 font-semibold">Customer ID: <span class="text-slate-100">${vehicle.customerId || '—'}</span></p>
              </div>
              <div class="flex flex-col items-end gap-1 text-right">
                <div class="inline-flex items-center gap-2 text-[10px] font-bold text-slate-300">
                  <span class="px-2 py-1 rounded-full border border-amber-400/40 bg-amber-500/10 text-amber-100">${vehicle.status}</span>
                </div>
                <div class="inline-flex items-center gap-2 text-[10px] font-semibold ${movingMeta.text} px-2 py-1 rounded-full border border-slate-800 ${movingMeta.bg}">
                  <span class="w-2 h-2 rounded-full ${movingMeta.dot}"></span>
                  <span>${movingMeta.label}</span>
                </div>
                <div class="text-[10px] font-semibold text-slate-300">
                  Days Parked <span class="text-slate-100">${vehicle.daysStationary || '—'}</span>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                ${svgIcon('wifiOff', 'h-3 w-3 text-amber-300')}
                <div class="text-left leading-tight">
                  <p class="font-semibold">${vehicle.gpsFix || 'GPS issue'}</p>
                  <p class="text-[10px] text-slate-400">${vehicle.gpsReason || 'Pending'}</p>
                </div>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-2 py-1.5 flex items-center gap-2 text-slate-200">
                ${svgIcon('hash', 'h-3 w-3 text-blue-400')}
                <div class="text-left leading-tight">
                  <p class="font-semibold">VIN</p>
                  <p class="text-[10px] text-slate-400">${vehicle.vin || 'Not available'}</p>
                </div>
              </div>
            </div>
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-[10px] text-slate-200 space-y-2">
              <div class="grid grid-cols-4 gap-2">
                <div class="rounded border px-2 py-1.5 ${dealStatusStyles.card}">
                  <p class="text-[9px] uppercase font-bold ${dealStatusStyles.label}">Deal</p>
                  <p class="text-[11px] font-semibold ${dealStatusStyles.value}">${vehicle.status || '—'}</p>
                </div>
                <div class="rounded border px-2 py-1.5 ${prepStatusStyles.card}">
                  <p class="text-[9px] uppercase font-bold ${prepStatusStyles.label}">Prep</p>
                  <p class="text-[11px] font-semibold ${prepStatusStyles.value}">${vehicle.invPrepStatus || '—'}</p>
                </div>
                <div class="rounded border border-slate-800 bg-slate-900 px-2 py-1.5">
                  <p class="text-[9px] uppercase text-slate-500 font-bold">Deal %</p>
                  <p class="text-[11px] font-semibold text-slate-100">${vehicle.dealCompletion || '—'}</p>
                </div>
                <div class="rounded border px-2 py-1.5 ${ptStatusStyles.card}">
                  <p class="text-[9px] uppercase font-bold ${ptStatusStyles.label}">PT</p>
                  <p class="text-[11px] font-semibold ${ptStatusStyles.value}">${vehicle.ptStatus || '—'}</p>
                </div>
              </div>
              <div class="flex items-center justify-between text-[11px] text-slate-400">
                <span class="flex items-center gap-2 font-semibold text-slate-200">${svgIcon('clock', 'h-3 w-3')} PT Last Read ${formatDateTime(vehicle.lastRead)}</span>
                <span class="text-slate-400">${vehicle.payment || ''}</span>
              </div>
            </div>
            <div class="pt-1 flex items-center justify-end gap-2">
              <button data-view-more data-action="vehicle-view-more" class="inline-flex items-center gap-1.5 rounded-lg border border-amber-400/50 bg-amber-500/15 px-3 py-1 text-[10px] font-bold text-amber-100 hover:bg-amber-500/25 transition-colors">
                ${svgIcon('info', 'h-3.5 w-3.5')}
                See more
              </button>
              <button data-action="repair-history" class="inline-flex items-center gap-1.5 rounded-lg border border-blue-400/50 bg-blue-500/15 px-3 py-1 text-[10px] font-bold text-blue-100 hover:bg-blue-500/25 transition-colors">History</button>
            </div>
          `;

          fragment.appendChild(card);
        });

        if (filtered.length > VEHICLE_RENDER_LIMIT) {
          const notice = document.createElement('p');
          notice.className = 'text-[11px] text-slate-500 px-1 pt-1';
          notice.textContent = `Showing the first ${VEHICLE_RENDER_LIMIT} of ${filtered.length} vehicles. Refine filters to see more.`;
          fragment.appendChild(notice);
        }

        container.replaceChildren(fragment);

        syncVehicleMarkers(vehiclesForMarkers);
      }

      function focusVehicle(vehicle) {
        if (!vehicle) return;
        if (!hasValidCoords(vehicle)) return;
        if (!vehicleMarkersVisible) return;
        highlightLayer.clearLayers();

        const storedMarker = vehicleMarkers.get(vehicle.id)?.marker;
        const markerColor = getVehicleMarkerColor(vehicle);
        const anchorMarker = storedMarker || L.circleMarker([vehicle.lat, vehicle.lng], {
          radius: 9,
          color: '#0b1220',
          weight: 2.8,
          fillColor: markerColor,
          fillOpacity: 0.95,
          opacity: 0.98,
          className: 'vehicle-dot'
        }).addTo(highlightLayer);

        const halo = L.circleMarker([vehicle.lat, vehicle.lng], { radius: 12, color: markerColor, weight: 1.2, fillColor: markerColor, fillOpacity: 0.18 }).addTo(highlightLayer);
        halo.bringToBack();

        if (isVehicleNotMoving(vehicle)) {
          L.marker([vehicle.lat, vehicle.lng], {
            icon: L.divIcon({ className: 'vehicle-cross', html: '<div class="vehicle-cross-badge">✕</div>', iconSize: [16, 16], iconAnchor: [8, 8] }),
            interactive: false,
            zIndexOffset: 500
          }).addTo(highlightLayer);
        }

        anchorMarker.bindPopup(vehicleCard(vehicle), {
          className: 'vehicle-popup',
          autoPan: false,
          keepInView: false,
        }).openPopup();

        setTimeout(attachPopupHandlers, 50);

        showServicesFromOrigin(vehicle, { forceType: isAnyServiceSidebarOpen() ? getActivePartnerType() : null });

        applySelection(vehicle.id, null);
      }

      function vehicleCard(vehicle) {
        const accuracyDot = getAccuracyDot(vehicle.locationAccuracy);
        const modelYear = [vehicle.model || 'Vehicle', vehicle.year].filter(Boolean).join(' · ');
        return `
        <div class="w-[240px] bg-slate-950/90 text-white">
          <div class="p-3 space-y-2">
            <div class="flex items-start justify-between gap-2">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-[0.15em] text-amber-400">Vehicle</p>
                <h3 class="text-base font-extrabold leading-tight text-white">${modelYear}</h3>
                <p class="text-[11px] text-slate-300">VIN ${vehicle.vin || 'N/A'}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full bg-amber-500/15 px-2 py-1 text-[10px] font-semibold text-amber-200 border border-amber-400/40">${vehicle.status || 'ACTIVE'}</span>
            </div>

            <div class="text-[12px] text-slate-200 space-y-1">
              <p class="font-semibold">${vehicle.customer || 'Customer pending'}</p>
              <p class="flex items-center gap-2">
                <span class="inline-flex h-2 w-2 rounded-full ${accuracyDot}"></span>
                <span>${vehicle.lastLocation || 'No location provided'}</span>
              </p>
              ${vehicle.locationNote ? `<p class="text-[11px] text-amber-200 font-semibold">${vehicle.locationNote}</p>` : ''}
            </div>

            <div class="grid grid-cols-2 gap-2 text-[11px]">
              <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-2 py-2">
                <p class="text-[9px] uppercase text-slate-500 font-bold">GPS</p>
                <p class="font-semibold text-slate-50">${vehicle.gpsFix || 'Unknown'}</p>
              </div>
              <div class="rounded-lg border border-slate-800 bg-slate-900/80 px-2 py-2">
                <p class="text-[9px] uppercase text-slate-500 font-bold">Deal %</p>
                <p class="font-semibold text-slate-50">${vehicle.dealCompletion || '—'}</p>
              </div>
            </div>
          </div>
        </div>
      `;
      }

      function parseDealCompletion(value) {
        if (value === null || value === undefined) return null;
        const raw = String(value).replace(/%/g, '').trim();
        const num = parseFloat(raw);
        if (!Number.isFinite(num)) return null;
        if (num <= 1) return num * 100;
        return num;
      }

      function matchesRange(value, min, max) {
        const pct = parseDealCompletion(value);
        if (!Number.isFinite(pct)) return min <= 0; // allow unknowns only when the range starts at 0
        return pct >= min && pct <= max;
      }

      const normalizeFilterValue = (value) => (value ?? '').toString().trim().toLowerCase();

      function getStatusCardStyles(value, type) {
        const normalized = normalizeFilterValue(value);
        if (type === 'deal' && normalized === 'active') {
          return {
            card: 'border-emerald-500/60 bg-emerald-500/15 text-emerald-100',
            label: 'text-emerald-200/80',
            value: 'text-emerald-50'
          };
        }
        if (type === 'prep' && normalized === 'out for repo') {
          return {
            card: 'border-red-500/60 bg-red-500/15 text-red-100',
            label: 'text-red-200/80',
            value: 'text-red-50'
          };
        }
        if (type === 'pt' && normalized === 'disabled') {
          return {
            card: 'border-red-500/60 bg-red-500/15 text-red-100',
            label: 'text-red-200/80',
            value: 'text-red-50'
          };
        }
        return {
          card: 'border-slate-800 bg-slate-900 text-slate-200',
          label: 'text-slate-500',
          value: 'text-slate-100'
        };
      }

      function matchesVehicleFilters(vehicle, query) {
        const q = (query || '').toLowerCase();
        if (q && !vehicle._searchBlob.includes(q)) return false;

        const invPrep = normalizeFilterValue(vehicle.invPrepStatus);
        if (vehicleFilters.invPrep !== 'all' && invPrep !== vehicleFilters.invPrep) return false;

        const gpsFix = normalizeFilterValue(vehicle.gpsFix);
        if (vehicleFilters.gpsFix !== 'all' && gpsFix !== vehicleFilters.gpsFix) return false;

        const dealStatus = normalizeFilterValue(vehicle.status);
        if (vehicleFilters.dealStatus !== 'all' && dealStatus !== vehicleFilters.dealStatus) return false;

        const ptStatus = normalizeFilterValue(vehicle.ptStatus);
        if (vehicleFilters.ptStatus !== 'all' && ptStatus !== vehicleFilters.ptStatus) return false;

        if (!matchesRange(vehicle.dealCompletion, vehicleFilters.dealMin, vehicleFilters.dealMax)) return false;

        const isStopped = isVehicleNotMoving(vehicle);
        if (vehicleFilters.moving === 'moving' && isStopped) return false;
        if (vehicleFilters.moving === 'stopped' && !isStopped) return false;

        return true;
      }

      function filterVehicles(list, query) {
        return list.filter(v => matchesVehicleFilters(v, query));
      }

      function getVehiclesForTech(tech) {
        if (!tech || !map) return [];
        const withDistance = vehicles
          .filter(hasValidCoords)
          .map(v => ({
            vehicle: v,
            distance: getDistance(v.lat, v.lng, tech.lat, tech.lng)
          }));
        return withDistance
          .filter(item => item.distance <= 180)
          .sort((a, b) => a.distance - b.distance)
          .map(item => item.vehicle);
      }

      function getUniqueVehicleValues(field) {
        return Array.from(new Set(vehicles
          .map(v => normalizeFilterValue(v?.[field]))
          .filter(Boolean)))
          .sort();
      }

      function setSelectOptions(selectId, values) {
        const select = document.getElementById(selectId);
        if (!select) return;
        const previous = select.value;
        select.innerHTML = '<option value="all">All</option>';
        values.forEach((val) => {
          const option = document.createElement('option');
          option.value = val;
          option.textContent = val;
          select.appendChild(option);
        });
        if (values.includes(previous)) {
          select.value = previous;
        }
      }

      function updateVehicleFilterOptions() {
        setSelectOptions('filter-invprep', getUniqueVehicleValues('invPrepStatus'));
        setSelectOptions('filter-gps', getUniqueVehicleValues('gpsFix'));
        setSelectOptions('filter-deal-status', getUniqueVehicleValues('status'));
        setSelectOptions('filter-pt', getUniqueVehicleValues('ptStatus'));
      }

      function syncVehicleFilterInputs() {
        const invPrepSelect = document.getElementById('filter-invprep');
        const gpsSelect = document.getElementById('filter-gps');
        const movingSelect = document.getElementById('filter-moving');
        const dealStatusSelect = document.getElementById('filter-deal-status');
        const ptSelect = document.getElementById('filter-pt');
        const minInput = document.getElementById('filter-deal-min');
        const maxInput = document.getElementById('filter-deal-max');

        if (invPrepSelect) invPrepSelect.value = vehicleFilters.invPrep;
        if (gpsSelect) gpsSelect.value = vehicleFilters.gpsFix;
        if (movingSelect) movingSelect.value = vehicleFilters.moving;
        if (dealStatusSelect) dealStatusSelect.value = vehicleFilters.dealStatus;
        if (ptSelect) ptSelect.value = vehicleFilters.ptStatus;
        if (minInput) minInput.value = vehicleFilters.dealMin;
        if (maxInput) maxInput.value = vehicleFilters.dealMax;
      }

      function resetVehicleFilters() {
        vehicleFilters.invPrep = 'all';
        vehicleFilters.gpsFix = 'all';
        vehicleFilters.moving = 'all';
        vehicleFilters.dealStatus = 'all';
        vehicleFilters.ptStatus = 'all';
        vehicleFilters.dealMin = 0;
        vehicleFilters.dealMax = 100;
        syncVehicleFilterInputs();
        renderVehicles();
      }

      function bindVehicleFilterHandlers() {
        const selectHandlers = [
          { id: 'filter-invprep', key: 'invPrep' },
          { id: 'filter-gps', key: 'gpsFix' },
          { id: 'filter-moving', key: 'moving' },
          { id: 'filter-deal-status', key: 'dealStatus' },
          { id: 'filter-pt', key: 'ptStatus' }
        ];

        selectHandlers.forEach(({ id, key }) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('change', () => {
            vehicleFilters[key] = el.value || 'all';
            renderVehicles();
          });
        });

        const minInput = document.getElementById('filter-deal-min');
        const maxInput = document.getElementById('filter-deal-max');
        [minInput, maxInput].forEach((input, idx) => {
          if (!input) return;
          input.addEventListener('input', () => {
            const val = parseFloat(input.value);
            if (Number.isFinite(val)) {
              if (idx === 0) vehicleFilters.dealMin = Math.max(0, Math.min(val, 100));
              else vehicleFilters.dealMax = Math.max(0, Math.min(val, 100));
            } else {
              if (idx === 0) vehicleFilters.dealMin = 0;
              else vehicleFilters.dealMax = 100;
            }
            if (vehicleFilters.dealMin > vehicleFilters.dealMax) {
              vehicleFilters.dealMin = vehicleFilters.dealMax;
              syncVehicleFilterInputs();
            }
            renderVehicles();
          });
        });

        const resetBtn = document.getElementById('vehicle-filters-reset');
        resetBtn?.addEventListener('click', (e) => {
          e.preventDefault();
          resetVehicleFilters();
        });
      }

      function getVehicleList(query) {
        if (selectedVehicleId !== null) {
          return vehicles.filter(v => v.id === selectedVehicleId);
        }

        if (selectedTechId !== null) {
          const tech = technicians.find(t => t.id === selectedTechId);
          const nearby = getVehiclesForTech(tech);
          return nearby.length ? nearby : vehicles;
        }

        return filterVehicles(vehicles, query);
      }

      function getTechList(baseList = technicians) {
        const origin = getCurrentOrigin();

        const sorted = origin
          ? baseList
            .map(t => ({ ...t, distance: getDistance(origin.lat, origin.lng, t.lat, t.lng) }))
            .sort((a, b) => a.distance - b.distance)
          : [...baseList];

        if (selectedTechId !== null) {
          const selectedTech = sorted.find(t => t.id === selectedTechId) || baseList.find(t => t.id === selectedTechId);
          if (selectedTech) {
            return [selectedTech, ...sorted.filter(t => t.id !== selectedTech.id)];
          }
        }

        return sorted;
      }

      function findNearestTechnician(point, maxDistanceMeters = 40000) {
        if (!technicians.length || !map) return null;
        let closest = null;
        let closestDistance = Infinity;

        technicians.forEach((tech) => {
          const dist = map.distance([point.lat, point.lng], [tech.lat, tech.lng]);
          if (dist < closestDistance) {
            closestDistance = dist;
            closest = tech;
          }
        });

        return closestDistance <= maxDistanceMeters ? closest : null;
      }

      function getVehicleMarkerColor(vehicle) {
        const fix = (vehicle.gpsFix || '').trim().toLowerCase();
        if (fix.includes('fully working')) return '#22c55e';
        if (fix === 'all' || fix.includes('all')) return '#ef4444';
        return '#f59e0b';
      }

      function getVehicleMarkerBorderColor(fillColor) {
        const color = (fillColor || '').toLowerCase();
        if (color === '#22c55e') return '#166534';
        if (color === '#f59e0b') return '#92400e';
        return '#991b1b';
      }

      function getMovingMeta(vehicle) {
        const movingValue = parseInt(vehicle.moving || vehicle.movingCalc || vehicle.gpsMoving || '', 10);
        if (movingValue === 1) {
          return { label: 'Moving', text: 'text-emerald-200', bg: 'bg-emerald-500/10', dot: 'bg-emerald-400' };
        }
        if (movingValue === -1) {
          return { label: 'Not moving', text: 'text-amber-200', bg: 'bg-amber-500/10', dot: 'bg-amber-400' };
        }
        return { label: 'Unknown', text: 'text-slate-300', bg: 'bg-slate-800/70', dot: 'bg-slate-400' };
      }

      function isVehicleNotMoving(vehicle) {
        const movingValue = parseInt(vehicle.moving || vehicle.movingCalc || vehicle.gpsMoving || '', 10);
        return movingValue === -1;
      }

      function toggleSelectionBanner() {
        const banner = document.getElementById('selection-banner');
        const text = document.getElementById('selection-text');
        if (!banner || !text) return;

        if (selectedVehicleId === null && selectedTechId === null) {
          banner.classList.add('hidden');
          return;
        }

        const vehicle = vehicles.find(v => v.id === selectedVehicleId);
        const tech = technicians.find(t => t.id === selectedTechId);
        const parts = [];
        if (vehicle) parts.push(`Vehicle ${vehicle.vin || vehicle.model}`);
        if (tech) parts.push(`Technician ${tech.company}`);
        text.textContent = `Filtered by ${parts.join(' & ')}`;
        banner.classList.remove('hidden');
      }

      function applySelection(vehicleId = null, techId = null) {
        selectedVehicleId = vehicleId;
        selectedTechId = techId;
        if (vehicleId !== null) {
          sidebarStateController?.setState?.('right', true);
        }
        renderVehicles();
        renderVisibleSidebars();
        toggleSelectionBanner();
      }

      function resetSelection() {
        selectedVehicleId = null;
        selectedTechId = null;
        Object.keys(selectedServiceByType).forEach(key => delete selectedServiceByType[key]);
        highlightLayer?.clearLayers();
        connectionLayer?.clearLayers();
        serviceLayer?.clearLayers();
        serviceConnectionLayer?.clearLayers();
        lastOriginPoint = null;
        lastClientLocation = null;
        renderVehicles();
        renderVisibleSidebars();
        toggleSelectionBanner();
        sidebarStateController?.setState?.('right', false);
      }

      function findNearestVehicle(point, maxDistanceMeters = 80000) {
        if (!vehicles.length || !map) return null;
        let closest = null;
        let closestDistance = Infinity;

        vehicles.forEach((vehicle) => {
          if (!hasValidCoords(vehicle)) return;
          const dist = map.distance([point.lat, point.lng], [vehicle.lat, vehicle.lng]);
          if (dist < closestDistance) {
            closestDistance = dist;
            closest = vehicle;
          }
        });

        return closestDistance <= maxDistanceMeters ? closest : null;
      }

      // --- 5. Real search logic (Nominatim) ---
      async function geocodeAddress(query) {
        try {
          const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", USA")}`);
          const data = await response.json();
          if (data && data.length > 0) {
            return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };
          }
          return null;
        } catch (e) {
          console.error("Geocoding error", e);
          return null;
        }
      }

      const debouncedGeocodeAddress = debounceAsync(geocodeAddress, 400);

      function processLocation(location, label = '', partnerTypeOverride = null) {
        if (!location) return;

        if (label) {
          document.getElementById('address-input').value = label;
        }

        targetLayer.clearLayers();
        connectionLayer.clearLayers();
        serviceLayer?.clearLayers();
        serviceConnectionLayer?.clearLayers();
        const targetIcon = L.divIcon({
          className: '',
          html: `<div class="w-4 h-4 bg-red-600 rounded-full border-2 border-white animate-ping"></div>`
        });
        L.marker([location.lat, location.lng], { icon: targetIcon }).addTo(targetLayer);
        const popup = L.marker([location.lat, location.lng]).addTo(targetLayer);
        popup.bindPopup(`<b>Client</b><br>${label || location.name || ''}`).openPopup();
        lastClientLocation = location;

        const partnerType = partnerTypeOverride || (isAnyServiceSidebarOpen() ? getActivePartnerType() : null);
        if (partnerType) {
          const partnerList = getPartnerListByType(partnerType);
          if (partnerType === 'tech') {
            updateTechUI(partnerList, true, location);
          } else if (partnerType === 'reseller') {
            updateResellerUI(partnerList);
          } else if (partnerType === 'repair') {
            updateRepairUI(partnerList);
          }
        }

        showServicesFromOrigin(location, { forceType: partnerType });
        map.flyTo([location.lat, location.lng], 13, { duration: 1.5 });
      }

      function setupAddressSearch({ formId, inputId, buttonId, statusId, partnerType }) {
        const form = document.getElementById(formId);
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        const status = statusId ? document.getElementById(statusId) : null;
        if (!form || !input || !button) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const query = input.value.trim();
          const partners = getPartnerListByType(partnerType);
          if (!query || partners.length === 0) return;

          const originalBtnText = button.innerHTML;
          const stopLoading = startLoading('Searching address…');
          button.innerHTML = svgIcon('loader2', 'animate-spin h-4 w-4');
          button.disabled = true;
          status?.classList.remove('hidden');

          let location = null;
          try {
            location = await debouncedGeocodeAddress(query);
          } finally {
            stopLoading();
            button.innerHTML = originalBtnText;
            button.disabled = false;
            status?.classList.add('hidden');
          }

          if (!location) {
            alert("Address not found. Try a ZIP code or city name.");
            return;
          }

          processLocation(location, location.name || query, partnerType);
        });
      }

      setupAddressSearch({
        formId: 'search-form',
        inputId: 'address-input',
        buttonId: 'search-btn',
        statusId: 'search-status',
        partnerType: 'tech'
      });

      setupAddressSearch({
        formId: 'reseller-search-form',
        inputId: 'reseller-address-input',
        buttonId: 'reseller-search-btn',
        statusId: 'reseller-search-status',
        partnerType: 'reseller'
      });

      setupAddressSearch({
        formId: 'repair-search-form',
        inputId: 'repair-address-input',
        buttonId: 'repair-search-btn',
        statusId: 'repair-search-status',
        partnerType: 'repair'
      });

      function openVehicleModal(vehicle) {
        const modal = document.getElementById('vehicle-modal');
        const title = document.getElementById('vehicle-modal-title');
        const vinDisplay = document.getElementById('vehicle-modal-vin');
        const body = document.getElementById('vehicle-modal-body');
        const columnsToggle = document.getElementById('vehicle-modal-columns-toggle');
        const columnsPanel = document.getElementById('vehicle-modal-columns-panel');
        if (!modal || !title || !body) return;

        const VIN = repairHistoryManager.getRepairVehicleVin(vehicle);
        modal.dataset.vehicleId = vehicle.id;
        columnsToggle?.classList.remove('hidden');
        columnsPanel?.classList.add('hidden');
        title.textContent = `${vehicle.model || 'Vehicle'} ${vehicle.year || ''} • ${vehicle.vin || ''}`;
        if (vinDisplay) {
          vinDisplay.textContent = VIN ? `VIN: ${VIN}` : '';
        }
        const { headers, hidden } = getVehicleModalHeaders();
        const detailRows = headers.map(header => {
          const displayHeader = VEHICLE_HEADER_LABELS[header] || header;
          const fieldKey = EDITABLE_VEHICLE_FIELDS[header.toLowerCase()];
          const isEditable = Boolean(fieldKey);
          const value = vehicle.details?.[header] || vehicle[header] || vehicle[header.toLowerCase()] || '—';
          return `
          <tr class="border-b border-slate-800/80 ${hidden.has(header) ? 'hidden' : ''}" draggable="true" data-header="${header}">
            <th class="text-left text-xs font-semibold text-slate-300 py-2 pr-3">
              <span class="inline-flex items-center gap-2">
                <span class="text-slate-600 text-sm">⋮⋮</span>
                ${displayHeader}
              </span>
            </th>
            <td class="text-xs text-slate-100 py-2">
              <div class="flex items-center justify-between gap-2">
                <span data-field-value>${value || '—'}</span>
                ${isEditable ? `
                  <button type="button" class="rounded border border-amber-400/40 px-2 py-1 text-[10px] font-semibold text-amber-200 hover:border-amber-300 hover:text-amber-100 transition-colors" data-edit-field="${fieldKey}" data-edit-header="${header}">Edit</button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
        }).join('');
        body.innerHTML = `<table class="w-full text-left">${detailRows}</table>`;

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        renderVehicleModalColumnsList(headers, hidden);
        attachVehicleModalRowDrag();
        attachVehicleModalEditors(vehicle);
      }

      function openRepairModal(vehicle) {
        const modal = document.getElementById('vehicle-modal');
        const title = document.getElementById('vehicle-modal-title');
        const vinDisplay = document.getElementById('vehicle-modal-vin');
        const body = document.getElementById('vehicle-modal-body');
        const columnsToggle = document.getElementById('vehicle-modal-columns-toggle');
        const columnsPanel = document.getElementById('vehicle-modal-columns-panel');
        if (!modal || !title || !body) return;

        if (modal.repairModalController) {
          modal.repairModalController.abort();
        }
        const repairModalController = new AbortController();
        modal.repairModalController = repairModalController;
        const { signal } = repairModalController;

        const VIN = repairHistoryManager.getRepairVehicleVin(vehicle);
        modal.dataset.vehicleId = vehicle.id;
        title.textContent = 'Repair Management';
        if (vinDisplay) {
          vinDisplay.textContent = VIN ? `VIN: ${VIN}` : '';
        }
        columnsToggle?.classList.add('hidden');
        columnsPanel?.classList.add('hidden');
        body.innerHTML = `
        <div class="space-y-4">
          <div class="sticky top-0 z-10 -mx-4 border-b border-slate-800 bg-slate-950/95 px-4 pb-3 pt-1 backdrop-blur">
            <div class="inline-flex rounded-lg border border-slate-800 bg-slate-950/70 p-1 text-[11px] font-semibold text-slate-300">
              <button type="button" class="repair-tab-btn rounded-md px-3 py-1.5 text-white bg-slate-800/80" data-tab="history">History</button>
              <button type="button" class="repair-tab-btn rounded-md px-3 py-1.5 text-slate-400 hover:text-white" data-tab="new-entry">New Entry</button>
            </div>
          </div>
          <div class="repair-tab-panel" data-tab-panel="history">
            <div class="rounded-lg border border-slate-800 bg-slate-950/70 p-3">
              <div class="flex flex-wrap items-center justify-between gap-3 pb-3">
                <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-slate-400">Repair History</p>
                <div class="flex flex-wrap items-center gap-2">
                  <input type="text" class="w-48 rounded border border-slate-700 bg-slate-900 px-2 py-1 text-[10px] text-slate-200 placeholder-slate-500" placeholder="Search notes, status, company" data-repair-search />
                  <div class="relative">
                  <button type="button" class="rounded border border-slate-700 bg-slate-900 px-3 py-1 text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-200 hover:border-slate-500" data-repair-columns-toggle>
                    Columns
                  </button>
                  <div class="absolute right-0 z-10 mt-2 hidden w-64 rounded-lg border border-slate-800 bg-slate-950/95 p-3 text-[11px] text-slate-200 shadow-xl" data-repair-columns-panel>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.3em] text-slate-400">Show columns</p>
                    <div class="mt-2 grid gap-2" data-repair-columns-list></div>
                  </div>
                  </div>
                </div>
              </div>
              <table class="w-full text-left text-[11px] text-slate-200">
                <thead class="text-[10px] uppercase text-slate-500" data-repair-history-head></thead>
                <tbody class="divide-y divide-slate-800/80" data-repair-history-body>
                  <tr data-repair-empty>
                    <td class="py-2 pr-3 text-slate-400" colspan="1">Loading history...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="repair-tab-panel hidden" data-tab-panel="new-entry">
            <form class="space-y-3 rounded-lg border border-slate-800 bg-slate-950/70 p-4 text-[11px] text-slate-200" data-repair-form>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Status</span>
                  <input type="text" name="status" placeholder="Pending" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">DOC</span>
                  <input type="text" name="doc" placeholder="DOC-12345" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Date</span>
                  <input type="date" name="cs_contact_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Shipping Date</span>
                  <input type="date" name="shipping_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">POC Name</span>
                  <input type="text" name="poc_name" placeholder="Primary contact" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">POC Phone</span>
                  <input type="tel" name="poc_phone" placeholder="(555) 555-5555" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Customer Availability</span>
                  <input type="text" name="customer_availability" placeholder="Mon-Fri afternoons" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Installer Request Date</span>
                  <input type="date" name="installer_request_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Installation Company</span>
                  <input type="text" name="installation_company" placeholder="Techloc Installers" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Technician Availability</span>
                  <input type="date" name="technician_availability_date" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Installation Place</span>
                  <input type="text" name="installation_place" placeholder="123 Main St" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="grid gap-3 md:grid-cols-2">
                <label class="space-y-1 block">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Cost</span>
                  <input type="text" name="repair_price" placeholder="$0.00" class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
                <label class="space-y-1 block">
                  <span class="text-[10px] uppercase text-slate-500 font-semibold">Notes</span>
                  <input type="text" name="repair_notes" placeholder="Internal notes..." class="w-full rounded border border-slate-700 bg-slate-900 px-2 py-1.5 text-[11px] text-slate-100" />
                </label>
              </div>
              <div class="flex items-center justify-between gap-3">
                <p class="text-[10px] text-slate-400" data-repair-status></p>
                <button type="submit" data-repair-submit class="rounded-lg border border-blue-400/50 bg-blue-500/20 px-4 py-1.5 text-[11px] font-semibold text-blue-100 hover:bg-blue-500/30 transition-colors">Save entry</button>
              </div>
            </form>
          </div>
        </div>
      `;

        const tabButtons = body.querySelectorAll('.repair-tab-btn');
        const tabPanels = body.querySelectorAll('.repair-tab-panel');
        const setActiveTab = (tabKey) => {
          tabButtons.forEach((button) => {
            const isActive = button.dataset.tab === tabKey;
            button.classList.toggle('bg-slate-800/80', isActive);
            button.classList.toggle('text-white', isActive);
            button.classList.toggle('text-slate-400', !isActive);
          });
          tabPanels.forEach((panel) => {
            panel.classList.toggle('hidden', panel.dataset.tabPanel !== tabKey);
          });
        };

        tabButtons.forEach((button) => {
          button.addEventListener('click', () => setActiveTab(button.dataset.tab), { signal });
        });

        setActiveTab('history');

        repairHistoryManager.setupRepairHistoryUI({
          vehicle,
          body,
          signal,
          setActiveTab
        });

        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }

      function attachVehicleModalRowDrag() {
        const modal = document.getElementById('vehicle-modal');
        if (!modal) return;
        const rows = modal.querySelectorAll('tr[data-header]');
        let draggedRow = null;

        rows.forEach((row) => {
          row.addEventListener('dragstart', (event) => {
            draggedRow = row;
            row.classList.add('opacity-50');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', row.dataset.header || '');
          });

          row.addEventListener('dragend', () => {
            row.classList.remove('opacity-50');
            draggedRow = null;
          });

          row.addEventListener('dragover', (event) => {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
          });

          row.addEventListener('drop', (event) => {
            event.preventDefault();
            if (!draggedRow || draggedRow === row) return;
            const tbody = row.parentElement;
            if (!tbody) return;
            const rowList = [...tbody.querySelectorAll('tr[data-header]')];
            const draggedIndex = rowList.indexOf(draggedRow);
            const targetIndex = rowList.indexOf(row);
            if (draggedIndex < targetIndex) {
              tbody.insertBefore(draggedRow, row.nextSibling);
            } else {
              tbody.insertBefore(draggedRow, row);
            }
            const prefs = loadVehicleModalPrefs();
            prefs.order = [...tbody.querySelectorAll('tr[data-header]')].map((entry) => entry.dataset.header);
            saveVehicleModalPrefs(prefs);
          });
        });
      }

      async function attachVehicleModalEditors(vehicle) {
        const modal = document.getElementById('vehicle-modal');
        if (!modal) return;
        const editButtons = modal.querySelectorAll('[data-edit-field]');
        editButtons.forEach((button) => {
          let saveInProgress = false;
          const saveEdit = async () => {
            if (saveInProgress) return;
            const fieldKey = button.dataset.editField;
            const headerKey = button.dataset.editHeader;
            const cell = button.closest('td');
            const valueNode = cell?.querySelector('[data-field-value]');
            if (!cell || !valueNode) return;

            const input = cell.querySelector('input[data-edit-input]');
            const newValue = input ? input.value.trim() : '';
            saveInProgress = true;
            button.disabled = true;
            button.textContent = 'Saving...';
            const stopLoading = startLoading('Saving...');

            try {
              if (!supabaseClient || !headerKey || vehicle?.id === undefined) {
                throw new Error('Supabase unavailable');
              }

              const { error } = await supabaseClient
                .from(TABLES.vehicles)
                .update({ [headerKey]: newValue })
                .eq('id', vehicle.id);

              if (error) throw error;

              valueNode.textContent = newValue || '—';
              button.dataset.editing = 'false';
              if (input) input.remove();

              if (vehicle?.details) {
                vehicle.details[headerKey] = newValue;
              }
              if (fieldKey && vehicle) {
                vehicle[fieldKey] = newValue;
              }
              renderVehicles();
              return;
            } catch (error) {
              console.warn('Failed to update vehicle field:', error);
              alert(error?.message || 'Failed to save vehicle update.');
            } finally {
              stopLoading();
              saveInProgress = false;
              button.disabled = false;
              button.textContent = button.dataset.editing === 'true' ? 'Save' : 'Edit';
            }
          };

          button.onclick = async () => {
            const cell = button.closest('td');
            const valueNode = cell?.querySelector('[data-field-value]');
            if (!cell || !valueNode) return;

            if (button.dataset.editing === 'true') {
              await saveEdit();
              return;
            }

            const currentValue = valueNode.textContent === '—' ? '' : valueNode.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentValue;
            input.dataset.editInput = 'true';
            input.className = 'flex-1 rounded border border-slate-700 bg-slate-900 px-2 py-1 text-[10px] text-slate-100';
            valueNode.textContent = '';
            valueNode.appendChild(input);
            button.dataset.editing = 'true';
            button.textContent = 'Save';
            input.focus();
            input.addEventListener('keydown', (event) => {
              if (event.key === 'Enter') {
                event.preventDefault();
                saveEdit();
              }
            });
          };
        });
      }

      function closeVehicleModal() {
        const modal = document.getElementById('vehicle-modal');
        if (!modal) return;
        if (modal.repairModalController) {
          modal.repairModalController.abort();
          modal.repairModalController = null;
        }
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        const panel = document.getElementById('vehicle-modal-columns-panel');
        panel?.classList.add('hidden');
      }

      function attachPopupHandlers() {
        const btn = document.querySelector('.vehicle-popup button[data-view-more-popup]');
        if (btn) {
          btn.addEventListener('click', () => {
            const vehicleId = selectedVehicleId;
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (vehicle) openVehicleModal(vehicle);
          });
        }
      }

      function getPartnerListByType(type) {
        if (type === 'reseller') return resellers;
        if (type === 'repair') return repairShops;
        if (type === 'custom') {
          return selectedCustomCategoryKey
            ? customServices.filter((service) => service?.categoryKey === selectedCustomCategoryKey)
            : customServices;
        }
        return technicians;
      }

      function getActivePartnerType() {
        const visibleTypes = getVisibleServiceTypes();
        if (visibleTypes.length) return visibleTypes[0];

        const sidebarType = SIDEBAR_TYPE_BY_KEY[activeLeftPanel];
        if (sidebarType && isServiceTypeEnabled(sidebarType)) return sidebarType;

        const [firstEnabled] = getEnabledServiceTypes();
        return firstEnabled || null;
      }

      function getVisibleServiceTypes() {
        return SERVICE_TYPES.filter((type) => isServiceSidebarVisible(type));
      }

      function getPartnerLabel(type) {
        if (type === 'reseller') return 'reseller';
        if (type === 'repair') return 'repair shop';
        return 'technician';
      }

      function getNearestFromList(point, list, type) {
        if (!point || !list.length) return null;
        let nearest = null;
        let bestDist = Infinity;
        list.forEach(item => {
          const dist = getDistance(point.lat, point.lng, item.lat, item.lng);
          if (dist < bestDist) {
            bestDist = dist;
            nearest = item;
          }
        });
        return nearest ? { entry: nearest, distance: bestDist, type } : null;
      }

      function getNearestPartner(vehicle) {
        const type = getActivePartnerType();
        const list = getPartnerListByType(type);
        return getNearestFromList(vehicle, list, type);
      }

      function addLabeledConnection(layer, start, end, distance, color, options = {}) {
        if (!layer || !start || !end) return null;
        const { dashArray = '6 4', weight = 3, opacity = 0.85 } = options;

        L.polyline(
          [
            [start.lat, start.lng],
            [end.lat, end.lng]
          ],
          { color, weight, opacity, dashArray }
        ).addTo(layer);

        const midLat = (start.lat + end.lat) / 2;
        const midLng = (start.lng + end.lng) / 2;
        const label = L.marker([midLat, midLng], {
          icon: L.divIcon({
            className: 'distance-label-wrapper',
            html: `<div class="distance-label" style="--line-color:${color}">${distance.toFixed(1)} mi</div>`,
            iconSize: [0, 0],
            iconAnchor: [0, 0]
          }),
          interactive: false
        });

        label.addTo(layer);
        return label;
      }

      function showServicesFromOrigin(origin, { forceType = null } = {}) {
        serviceLayer?.clearLayers();
        serviceConnectionLayer?.clearLayers();
        const hasSidebarOpen = isAnyServiceSidebarOpen();
        const hasExplicitType = !!forceType;
        if (!origin || (!hasSidebarOpen && !hasExplicitType)) return;

        lastOriginPoint = { lat: origin.lat, lng: origin.lng, name: origin.name || origin.customer || '' };

        const visibleTypes = getVisibleServiceTypes();
        const activeTypes = forceType
          ? [forceType]
          : visibleTypes;

        activeTypes.forEach((type) => {
          const baseList = getPartnerListByType(type);
          if (!baseList.length) return;
          const filtered = applyServiceFilter(baseList, type);
          const selectedPartner = getSelectedService(type);
          const chosen = selectedPartner || getNearestFromList(origin, filtered, type)?.entry;
          if (!chosen) return;

          const unauthorized = isUnauthorizedPartner(chosen);
          let color = SERVICE_COLORS[type] || '#38bdf8';

          if (type === 'custom' || type.startsWith('custom-')) {
            const categoryKey = chosen.categoryKey || selectedCustomCategoryKey;
            const meta = customCategories.get(categoryKey);
            if (meta) color = meta.color;
          } else {
            color = getPartnerColor(chosen, color);
          }
          const marker = L.marker([chosen.lat, chosen.lng], {
            icon: createServiceIcon(color, { unauthorized })
          }).addTo(serviceLayer);

          marker.on('click', (e) => {
            e.originalEvent.handledByMarker = true;
            sidebarStateController?.setState?.(SERVICE_SIDEBAR_KEYS[type] || 'left', true);
            selectedServiceByType[type] = chosen;
            filterSidebarForPartner(type, chosen);
            showServicePreviewCard(chosen);
            map.flyTo([chosen.lat, chosen.lng], 15, { duration: 1.2 });
          });

          const distance = getDistance(origin.lat, origin.lng, chosen.lat, chosen.lng);
          addLabeledConnection(
            serviceConnectionLayer,
            origin,
            chosen,
            Math.max(distance, 0),
            color,
            { dashArray: '6 4', weight: 3, opacity: 0.85 }
          );
        });
      }

      function drawConnection(origin, partnerInfo) {
        const type = partnerInfo?.type || getActivePartnerType();
        const target = partnerInfo?.entry || partnerInfo;
        const isVisible = isServiceSidebarVisible(type);
        if (!target || !origin || !isVisible) return;
        const baseColor = SERVICE_COLORS[type] || '#818cf8';
        const color = getPartnerColor(target, baseColor);
        connectionLayer.clearLayers();
        const miles = getDistance(origin.lat, origin.lng, target.lat, target.lng);
        addLabeledConnection(
          connectionLayer,
          origin,
          target,
          miles,
          color,
          { dashArray: '6 6', weight: 3, opacity: 0.8 }
        );
      }

      function setupResizableSidebars() {
        const layout = document.getElementById('map-layout');
        const leftSidebar = document.getElementById('left-sidebar');
        const rightSidebar = document.getElementById('right-sidebar');
        if (!layout || !leftSidebar || !rightSidebar) return;

        const rootStyle = document.documentElement.style;
        const minWidth = 260;
        const maxWidth = 720;
        let activeDrag = null;
        let resizePending = false;

        const clampWidth = (value) => Math.min(Math.max(value, minWidth), maxWidth);

        const applyWidth = (side, width) => {
          rootStyle.setProperty(side === 'left' ? '--left-sidebar-width' : '--right-sidebar-width', `${width}px`);
          if (map && !resizePending) {
            resizePending = true;
            requestAnimationFrame(() => {
              map.invalidateSize();
              resizePending = false;
            });
          }
        };

        const handleMove = (clientX) => {
          if (!activeDrag) return;
          const bounds = layout.getBoundingClientRect();

          if (activeDrag === 'left') {
            const newWidth = clampWidth(clientX - bounds.left);
            applyWidth('left', newWidth);
          }

          if (activeDrag === 'right') {
            const newWidth = clampWidth(bounds.right - clientX);
            applyWidth('right', newWidth);
          }
        };

        const onMouseMove = (event) => handleMove(event.clientX);
        const onTouchMove = (event) => {
          const touch = event.touches?.[0];
          if (!touch) return;
          handleMove(touch.clientX);
        };

        const stopDrag = () => {
          activeDrag = null;
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', stopDrag);
          document.removeEventListener('touchmove', onTouchMove);
          document.removeEventListener('touchend', stopDrag);
        };

        const startDrag = (side, event) => {
          event.preventDefault();
          activeDrag = side;
          document.addEventListener('mousemove', onMouseMove);
          document.addEventListener('mouseup', stopDrag);
          document.addEventListener('touchmove', onTouchMove, { passive: false });
          document.addEventListener('touchend', stopDrag);
        };

        const attachHandle = (element, side) => {
          const handle = element.querySelector('.resize-handle');
          if (!handle) return;

          handle.addEventListener('mousedown', (e) => startDrag(side, e));
          handle.addEventListener('touchstart', (e) => startDrag(side, e), { passive: false });
        };

        attachHandle(leftSidebar, 'left');
        attachHandle(rightSidebar, 'right');
      }

      const isControlViewRoute = window.location.pathname.toLowerCase().includes('vehicles.html');
      const defaultSidebarVisible = !isControlViewRoute;

      function setupSidebarToggles() {
        const leftSidebar = document.getElementById('left-sidebar');
        const rightSidebar = document.getElementById('right-sidebar');
        const resellerSidebar = document.getElementById('reseller-sidebar');
        const repairSidebar = document.getElementById('repair-sidebar');
        const customSidebar = document.getElementById('dynamic-service-sidebar');
        const openLeft = document.getElementById('open-left-sidebar');
        const openRight = document.getElementById('open-right-sidebar');
        const openReseller = document.getElementById('open-reseller-sidebar');
        const openRepair = document.getElementById('open-repair-sidebar');
        const openCustom = customToggleRef || document.querySelector('#custom-category-toggles .sidebar-toggle-btn');
        const collapseLeft = document.getElementById('collapse-left');
        const collapseRight = document.getElementById('collapse-right');
        const collapseReseller = document.getElementById('collapse-reseller');
        const collapseRepair = document.getElementById('collapse-repair');
        const collapseCustom = document.getElementById('collapse-dynamic');

        const defaultLeftOffset = 12;
        const defaultRightOffset = 12;
        const syncSidebarVisibility = () => {
          const previousCustomVisible = customSidebarVisible;
          techSidebarVisible = isServiceSidebarVisible('tech');
          resellerSidebarVisible = isServiceSidebarVisible('reseller');
          repairSidebarVisible = isServiceSidebarVisible('repair');
          customSidebarVisible = isServiceSidebarVisible('custom');

          if (!techSidebarVisible) {
            if (map?.hasLayer(techLayer)) map.removeLayer(techLayer);
            connectionLayer?.clearLayers();
          } else if (techLayer && map && !map.hasLayer(techLayer)) {
            techLayer.addTo(map);
          }

          if (!resellerSidebarVisible) {
            resellerLayer?.clearLayers();
          } else if (resellerLayer && map && !map.hasLayer(resellerLayer)) {
            resellerLayer.addTo(map);
          }

          if (!repairSidebarVisible) {
            repairLayer?.clearLayers();
          } else if (repairLayer && map && !map.hasLayer(repairLayer)) {
            repairLayer.addTo(map);
          }

          if (!customSidebarVisible) {
            customServiceLayer?.clearLayers?.();
            customCategories.forEach(({ layer }) => layer?.clearLayers?.());
          } else if (customServiceLayer && map && !map.hasLayer(customServiceLayer)) {
            customServiceLayer.addTo(map);
            customCategories.forEach(({ layer }) => layer && !map.hasLayer(layer) && layer.addTo(map));
          }

          if (customSidebarVisible !== previousCustomVisible) {
            lastCustomSidebarVisible = customSidebarVisible;
            if (customSidebarVisible) renderCategorySidebar(selectedCustomCategoryKey, customServices);
          }

          activeLeftPanel = leftSideKeys.find(key => {
            const cfg = configs[key];
            return cfg?.sidebar && !cfg.sidebar.classList.contains(cfg.collapsedClass);
          }) || null;

          renderVisibleSidebars();

          if (!isAnyServiceSidebarOpen()) {
            serviceLayer?.clearLayers();
            serviceConnectionLayer?.clearLayers();
          } else {
            const origin = getCurrentOrigin();
            if (origin) {
              showServicesFromOrigin(origin, { forceType: getActivePartnerType() });
            }
          }
        };

        const getSidebarWidth = (sidebar) => sidebar?.getBoundingClientRect().width || 0;

        const rawConfigs = {
          left: { sidebar: leftSidebar, toggle: openLeft, collapse: collapseLeft, collapsedClass: 'collapsed-left', group: 'left' },
          reseller: { sidebar: resellerSidebar, toggle: openReseller, collapse: collapseReseller, collapsedClass: 'collapsed-reseller', group: 'left', type: 'reseller' },
          repair: { sidebar: repairSidebar, toggle: openRepair, collapse: collapseRepair, collapsedClass: 'collapsed-repair', group: 'left', type: 'repair' },
          custom: { sidebar: customSidebar, toggle: openCustom, collapse: collapseCustom, collapsedClass: 'collapsed-dynamic', group: 'left', type: 'custom' },
          right: { sidebar: rightSidebar, toggle: openRight, collapse: collapseRight, collapsedClass: 'collapsed-right', group: 'right' }
        };

        const configs = Object.fromEntries(
          Object.entries(rawConfigs).filter(([, cfg]) => {
            if (!cfg.sidebar || !cfg.toggle) return false;
            if (!cfg.type) return true;
            return isServiceTypeEnabled(cfg.type);
          })
        );

        const syncMap = () => { if (map) setTimeout(() => map.invalidateSize(), 320); };

        const leftSideKeys = Object.keys(configs).filter((key) => configs[key]?.group === 'left');

        const updateTogglePositions = () => {
          const expandedEntry = leftSideKeys
            .map((key) => configs[key])
            .find(cfg => cfg?.sidebar && !cfg.sidebar.classList.contains(cfg.collapsedClass));

          const anchorLeft = expandedEntry
            ? getSidebarWidth(expandedEntry.sidebar) + defaultLeftOffset
            : defaultLeftOffset;

          leftSideKeys.forEach(key => {
            const toggle = configs[key]?.toggle;
            if (toggle) toggle.style.left = `${anchorLeft}px`;
          });

          const customSlot = document.getElementById('custom-toggle-slot');
          if (customSlot) customSlot.style.left = `${anchorLeft}px`;
          document.querySelectorAll('#custom-category-toggles .sidebar-toggle-btn').forEach((btn) => {
            btn.style.left = `${anchorLeft}px`;
          });

          const rightSidebarIsCollapsed = configs.right?.sidebar?.classList.contains(configs.right.collapsedClass);
          const anchorRight = rightSidebarIsCollapsed
            ? defaultRightOffset
            : getSidebarWidth(configs.right.sidebar) + defaultRightOffset;

          const rightToggleGroup = document.getElementById('right-toggle-group');
          if (rightToggleGroup) {
            rightToggleGroup.style.right = `${anchorRight}px`;
          }
        };

        const applyState = (side, expanded) => {
          const config = configs[side];
          if (!config?.sidebar || !config?.toggle) return false;
          const wasCollapsed = config.sidebar.classList.contains(config.collapsedClass);
          const shouldCollapse = !expanded;
          if (shouldCollapse && !wasCollapsed) {
            config.sidebar.classList.add(config.collapsedClass);
            config.toggle.classList.remove('active');
            config.toggle.setAttribute('aria-pressed', 'false');
          } else if (!shouldCollapse && wasCollapsed) {
            config.sidebar.classList.remove(config.collapsedClass);
            config.toggle.classList.add('active');
            config.toggle.setAttribute('aria-pressed', 'true');
          }
          return wasCollapsed !== shouldCollapse;
        };

        const setState = (side, expanded) => {
          const changed = applyState(side, expanded);
          if (!changed) return;

          if (expanded && configs[side]?.group === 'left') {
            leftSideKeys.forEach(key => {
              if (key !== side) applyState(key, false);
            });

            const origin = getCurrentOrigin();
            if (origin) {
              const newType = configs[side].type || SIDEBAR_TYPE_BY_KEY[side];
              setTimeout(() => {
                showServicesFromOrigin(origin, { forceType: newType });
              }, 50);
            }
          }

          updateTogglePositions();
          syncSidebarVisibility();
          syncMap();
        };

        sidebarStateController = { setState, updateTogglePositions };

        Object.entries(configs).forEach(([side, config]) => {
          if (config.toggle) config.toggle.addEventListener('click', () => setState(side, true));
          if (config.collapse) config.collapse.addEventListener('click', () => setState(side, false));
          setState(side, defaultSidebarVisible);
        });

        updateTogglePositions();
        window.addEventListener('resize', updateTogglePositions);
      }

      document.addEventListener('DOMContentLoaded', () => {
        (async () => {
          await loadStateCenters();
          initMap();
          await syncAvailableServiceTypes();
          updateServiceVisibilityUI();
          if (isServiceTypeEnabled('tech')) loadTechnicians();
          loadHotspots();
          loadBlacklistSites();
          loadVehicles();
          await loadAllServices();
          setupResizableSidebars();
          setupSidebarToggles();
          setupHotspotToggle();
          setupBlacklistToggle();
          setupVehicleMarkerToggle();
          bindVehicleFilterHandlers();
          syncVehicleFilterInputs();
          const filterConfigs = [
            { id: 'tech-filter', type: 'tech' },
            { id: 'reseller-filter', type: 'reseller' },
            { id: 'repair-filter', type: 'repair' },
            { id: 'dynamic-service-filter', type: 'custom' },
          ].filter(({ type }) => isServiceTypeEnabled(type));

          filterConfigs.forEach(({ id, type }) => {
            const input = document.getElementById(id);
            if (!input) return;
            input.addEventListener('input', () => {
              serviceFilters[type] = input.value;
              renderVisibleSidebars();
              const origin = getCurrentOrigin();
              if (origin) {
                showServicesFromOrigin(origin, { forceType: isAnyServiceSidebarOpen() ? getActivePartnerType() : null });
              }
            });
          });

          setupEventDelegation();

          let vehicleSearchTimer;
          document.getElementById('vehicle-search').addEventListener('input', () => {
            clearTimeout(vehicleSearchTimer);
            vehicleSearchTimer = setTimeout(() => renderVehicles(), 250);
          });

          document.getElementById('clear-selection')?.addEventListener('click', () => resetSelection());
          document.getElementById('vehicle-modal-close')?.addEventListener('click', closeVehicleModal);
          document.getElementById('vehicle-modal-columns-toggle')?.addEventListener('click', () => {
            const panel = document.getElementById('vehicle-modal-columns-panel');
            if (!panel) return;
            panel.classList.toggle('hidden');
          });
          document.getElementById('vehicle-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'vehicle-modal') closeVehicleModal();
          });

          setInterval(async () => {
            if (!supabaseClient) return;
            try {
              await supabaseClient.auth.getSession();
            } catch (error) {
              // Keep-alive failures are non-blocking.
            }
          }, 5 * 60 * 1000);

          window.addEventListener('auth:role-ready', () => renderVehicles());
        })();
      });
    </script>
    <script type="module">
      import { createConstellationBackground } from '../assets/scripts/constellation.js';

      document.addEventListener('DOMContentLoaded', () => {
        createConstellationBackground();
      });
    </script>
  </div>
</body>

</html>