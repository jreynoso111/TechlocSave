<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechLoc • Services Admin</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />


  <link rel="stylesheet" href="../../assets/visuals/theme.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="../../assets/scripts/authManager.js"></script>
  <script type="module" src="../../assets/scripts/admin-auth.js"></script>

  <style>
    html,
    body {
      width: 100%;
      height: auto;
    }

    body {
      overflow-x: hidden;
      overflow-y: auto;
    }

    main {
      width: 100%;
      height: auto;
      overflow: visible;
    }

    .directory-shell {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow: visible;
      height: auto !important;
      min-height: 0 !important;
    }

    .analytics-wrap {
      max-width: 100%;
      overflow: hidden;
    }

    .mini-analytics {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: .75rem;
      max-width: 100%;
      overflow: hidden;
    }

    @media (min-width: 1024px) {
      .mini-analytics {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .mini-chart {
      height: 150px;
      max-width: 100%;
      overflow: hidden;
    }

    .mini-chart canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      max-width: 100% !important;
    }

    .table-window {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      flex: none;
      min-height: 0;
      overflow: visible;
    }

    .top-scrollbar-shell {
      flex: 0 0 auto;
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 0.5rem;
      border: 1px solid rgb(30 41 59);
      background: rgba(2, 6, 23, 0.75);
      border-radius: 0.75rem;
      backdrop-filter: blur(6px);
    }

    .top-scrollbar {
      overflow-x: auto;
      overflow-y: hidden;
      height: 14px;
      border-radius: 0.75rem;
    }

    .top-scrollbar::-webkit-scrollbar {
      height: 12px;
    }

    .top-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, .25);
      border-radius: 999px;
    }

    .top-scrollbar::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, .35);
      border-radius: 999px;
    }

    #table-scroll {
      overflow-x: auto;
      overflow-y: visible;
      width: 100%;
      max-width: 100%;
      border-radius: 0.75rem;
    }

    #table-scroll::-webkit-scrollbar {
      height: 12px;
      width: 12px;
    }

    #table-scroll::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, .25);
      border-radius: 999px;
    }

    #table-scroll::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, .35);
      border-radius: 999px;
    }

    thead.sticky-head th {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
    }

    th.resizable {
      position: relative;
      user-select: none;
    }

    .col-resizer {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 10px;
      cursor: col-resize;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .col-resizer::after {
      content: "";
      display: block;
      width: 2px;
      height: 55%;
      background: rgba(148, 163, 184, .35);
      border-radius: 999px;
    }

    th.dragging {
      opacity: .55;
    }

    th.drop-target {
      outline: 2px dashed rgba(59, 130, 246, .55);
      outline-offset: -6px;
    }

    table.fixed-layout {
      table-layout: fixed;
      width: max-content;
      min-width: 100%;
    }

    #services-table th,
    #services-table td {
      white-space: normal !important;
      overflow-wrap: anywhere;
      word-break: break-word;
      vertical-align: top;
    }

    .th-inner {
      display: flex;
      align-items: center;
      gap: .5rem;
      justify-content: space-between;
      width: 100%;
      padding-right: 10px;
      min-width: 0;
    }

    .th-label {
      font-size: 11px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: rgba(226, 232, 240, .85);
      line-height: 1.2;
    }

    .sort-btn {
      padding: 4px 6px;
      height: 24px;
      width: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: 1px solid rgba(71, 85, 105, .8);
      background: rgba(2, 6, 23, .75);
    }

    .sort-btn:hover {
      border-color: rgba(59, 130, 246, .8);
      color: #fff;
    }

    .header-actions {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .filter-btn {
      padding: 4px 6px;
      height: 24px;
      width: 28px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      border: 1px solid rgba(71, 85, 105, .8);
      background: rgba(2, 6, 23, .75);
    }

    .filter-btn:hover {
      border-color: rgba(59, 130, 246, .8);
      color: #fff;
    }

    .filter-popover {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      width: min(320px, 92vw);
      z-index: 50;
      border-radius: 16px;
      border: 1px solid rgba(30, 41, 59, .9);
      background: rgba(2, 6, 23, .96);
      padding: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .4);
    }

    .filter-popover label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: rgba(148, 163, 184, .85);
    }

    .filter-options {
      margin-top: 10px;
      max-height: 180px;
      overflow-y: auto;
      display: grid;
      gap: 6px;
    }

    .filter-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(30, 41, 59, .6);
      background: rgba(15, 23, 42, .65);
      font-size: 11px;
      color: rgba(226, 232, 240, .9);
    }

    .filter-option:hover {
      border-color: rgba(59, 130, 246, .6);
    }

    .filter-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    .filter-search {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-radius: 12px;
      border: 1px solid rgba(51, 65, 85, .8);
      background: rgba(2, 6, 23, .85);
      padding: 6px 8px;
    }

    .filter-search input {
      flex: 1;
      background: transparent;
      border: none;
      color: rgba(226, 232, 240, .95);
      font-size: 11px;
      outline: none;
    }

    .popover {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      width: min(340px, 92vw);
      z-index: 50;
    }

    .compact-th {
      padding: 0.5rem 0.8rem;
    }

    .compact-td {
      padding: 0.5rem 0.8rem;
    }

    .compact-text {
      font-size: 12px;
      line-height: 1.25rem;
    }

    .stats-grid {
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
    }

    /* Inline editing visuals */
    td[data-editable="true"] {
      cursor: text;
    }

    td.editing {
      outline: 2px solid rgba(59, 130, 246, .65);
      outline-offset: -2px;
      background: rgba(2, 6, 23, .65);
    }

    td.saving {
      opacity: .75;
    }

    td.saved {
      box-shadow: inset 0 0 0 2px rgba(16, 185, 129, .4);
    }

    td.failed {
      box-shadow: inset 0 0 0 2px rgba(239, 68, 68, .45);
    }

    .cell-input,
    .cell-select {
      width: 100%;
      border: 1px solid rgba(51, 65, 85, .8);
      background: rgba(2, 6, 23, .9);
      color: rgba(248, 250, 252, .95);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12.5px;
      line-height: 1.25rem;
      outline: none;
    }

    .cell-input:focus,
    .cell-select:focus {
      border-color: rgba(59, 130, 246, .9);
    }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-slate-50 relative">

  <!-- HEADER -->
  <div id="header-root"></div>
  <script type="module">
    import { renderHeader } from '../../assets/components/Header.js';
    renderHeader('header-root');
  </script>

  <div class="pointer-events-none fixed inset-0 z-0 mix-blend-screen" aria-hidden="true">
    <canvas id="constellation-canvas" class="h-full w-full"></canvas>
  </div>

  <main class="mx-auto w-full max-w-[1400px] px-6 py-5 lg:px-10 space-y-5">
    <section class="flex min-w-0 flex-col gap-4">
      <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Partner network</p>
          <h2 class="text-2xl font-black text-white">Service roster and coverage</h2>
          <p class="text-sm text-slate-400">Double-click any cell to edit (admins only). Enter = save, Esc = cancel.</p>
        </div>

        <div
          class="flex items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-300">
          <i data-lucide="cloud" class="h-4 w-4"></i>
          <span id="dataset-status">Connecting…</span>
        </div>
      </div>

      <!-- STATS -->
      <section class="grid stats-grid gap-3 sm:grid-cols-3">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-300">Total services</p>
          <p id="tech-total" class="text-3xl font-black text-white">-</p>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-300">States covered</p>
          <p id="tech-states" class="text-3xl font-black text-amber-300">-</p>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4">
          <p class="text-sm font-semibold text-slate-300">Companies</p>
          <p id="tech-companies" class="text-3xl font-black text-emerald-300">-</p>
        </div>
      </section>

      <!-- DIRECTORY -->
      <section
        class="directory-shell rounded-2xl border border-slate-800 bg-slate-900/70 p-5 shadow-inner shadow-slate-900/60">
        <div class="flex flex-col gap-3">

          <div class="flex flex-col gap-2">
            <div>
              <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-200">Directory</p>
              <h3 class="text-lg font-bold text-white">Service list</h3>
            </div>

            <!-- ANALYTICS -->
            <div class="analytics-wrap" id="analytics-wrap">
              <div class="mini-analytics">
                <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 overflow-hidden">
                  <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                  <h3 class="text-sm font-bold text-white">Top states (filtered)</h3>
                  <div class="mt-3 mini-chart"><canvas id="chart-states"></canvas></div>
                </div>
                <div class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 overflow-hidden">
                  <p class="text-[11px] font-semibold uppercase tracking-[0.2em] text-blue-200">Analytics</p>
                  <h3 class="text-sm font-bold text-white">Categories share (filtered)</h3>
                  <div class="mt-3 mini-chart"><canvas id="chart-categories"></canvas></div>
                </div>
              </div>
            </div>

            <!-- FILTERS / ACTIONS -->
            <div class="flex flex-wrap items-center gap-2 pt-1">
              <div class="relative">
                <button id="columns-btn"
                  class="inline-flex items-center gap-2 rounded-full border border-slate-700 bg-slate-950/60 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white"
                  type="button">
                  <i data-lucide="columns-3" class="h-4 w-4"></i> Columns
                  <i data-lucide="chevron-down" class="h-4 w-4"></i>
                </button>

                <div id="columns-popover"
                  class="popover hidden rounded-2xl border border-slate-800 bg-slate-950/95 p-3 shadow-2xl shadow-black">
                  <div class="flex items-center justify-between px-2 pb-2">
                    <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-400">Visible columns</p>
                    <div class="flex items-center gap-2">
                      <button id="cols-all" type="button"
                        class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">All</button>
                      <button id="cols-none" type="button"
                        class="rounded-full px-3 py-1 text-xs font-semibold text-slate-200 hover:bg-slate-800/70">None</button>
                    </div>
                  </div>
                  <div id="columns-list" class="max-h-56 overflow-y-auto px-2 pb-2"></div>
                  <p class="px-2 pt-1 text-[11px] text-slate-500">Tip: drag headers to reorder • drag header edge to
                    resize</p>
                </div>
              </div>

              <button id="add-record"
                class="inline-flex items-center gap-2 rounded-full border border-emerald-600 bg-emerald-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-100 shadow shadow-emerald-600/30 transition hover:-translate-y-0.5"
                data-admin-actions type="button">
                <i data-lucide="plus" class="h-4 w-4"></i> New record
              </button>

              <button id="refresh-button"
                class="inline-flex items-center gap-2 rounded-full border border-blue-600 bg-blue-600/20 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-blue-100 shadow shadow-blue-600/30 transition hover:-translate-y-0.5"
                type="button">
                <i data-lucide="refresh-ccw" class="h-4 w-4"></i> Refresh
              </button>

              <div
                class="ml-auto hidden items-center gap-2 rounded-full border border-slate-800 bg-slate-900/70 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-slate-300 md:flex">
                <i data-lucide="mouse-pointer-2" class="h-4 w-4"></i> <span>Resize • Reorder • Sort • Filter</span>
              </div>
            </div>
          </div>

          <!-- PAGINATION (TOP) -->
          <div
            class="flex flex-col gap-2 rounded-xl border border-slate-800 bg-slate-950/40 px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
            <p id="pagination-summary" class="text-sm text-slate-300">Showing 0-0 of 0</p>
            <div class="flex items-center gap-2">
              <button id="prev-page" type="button"
                class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                <i data-lucide="chevron-left" class="h-4 w-4"></i> Prev
              </button>
              <span id="page-indicator" class="text-sm font-semibold text-slate-100">1 / 1</span>
              <button id="next-page" type="button"
                class="inline-flex items-center gap-2 rounded-full border border-slate-700 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-200 transition hover:border-blue-500 hover:text-white disabled:cursor-not-allowed disabled:opacity-50">
                Next <i data-lucide="chevron-right" class="h-4 w-4"></i>
              </button>
            </div>
          </div>

          <div class="table-window">
            <div class="top-scrollbar-shell">
              <div id="top-scrollbar" class="top-scrollbar">
                <div id="top-scrollbar-inner" style="height:1px;"></div>
              </div>
            </div>

            <div id="table-scroll" class="w-full border border-slate-800 bg-slate-950/25">
              <table id="services-table" class="fixed-layout divide-y divide-slate-800 compact-text">
                <colgroup id="colgroup"></colgroup>
                <thead id="table-head" class="sticky-head bg-slate-950/60 text-slate-300"></thead>
                <tbody id="table-body" class="divide-y divide-slate-800 bg-slate-950/40"></tbody>
              </table>
            </div>
          </div>

        </div>
      </section>
    </section>
  </main>

  <script type="module">
    import { setupBackgroundManager } from '../../assets/scripts/backgroundManager.js';
    import {
      loadPreferredBackgroundMode,
      persistBackgroundMode,
    } from '../../assets/scripts/backgroundPreference.js';
    import { supabase as supabaseClient } from '../../assets/js/supabaseClient.js';
    import { logAdminEvent } from '../../assets/scripts/adminAudit.js';

    const READ_TABLE = 'services';
    const WRITE_TABLE = 'services';
    const CHANGE_LOG_TABLE = 'admin_change_log';
    const PAGE_CATEGORY = 'GPS Technician';

    const toBool = (v) => {
      if (v === true || v === false) return v;
      const s = String(v ?? '').trim().toLowerCase();
      if (['true', '1', 'yes', 'y', 'verified'].includes(s)) return true;
      if (['false', '0', 'no', 'n', 'unverified', 'not verified'].includes(s)) return false;
      return null;
    };
    const boolToLabel = (v) => {
      if (v === true) return 'Verified';
      if (v === false) return 'Not verified';
      if (v === null || v === undefined || String(v).trim() === '') return '—';
      return String(v);
    };

    const getField = (row, ...keys) => {
      for (const key of keys) {
        const value = row[key];
        if (value !== undefined && value !== null && String(value).trim() !== '') return value;
      }
      return '';
    };

    const normalizeVerified = (value) => {
      const boolVal = toBool(value);
      if (boolVal === true || boolVal === false) return boolVal;
      const raw = value === null || value === undefined ? '' : String(value).trim();
      return raw === '' ? null : raw;
    };

    const normalizeRow = (row) => ({
      id: row.id,
      company: getField(row, 'company_name', 'Installation Company', 'Company', 'company', 'name'),
      authorization: getField(row, 'Authorization', 'authorization'),
      category: getField(row, 'category', 'Category'),
      phone: getField(row, 'Phone', 'phone'),
      contact: getField(row, 'contact', 'Contact'),
      address: getField(row, 'address', 'Address'),
      city: getField(row, 'City', 'city'),
      state: getField(row, 'State', 'state', 'state_code'),
      zip: getField(row, 'Zip', 'zip', 'zipcode', 'postal_code'),
      email: getField(row, 'Email', 'email'),
      notes: getField(row, 'Notes', 'notes'),
      website: getField(row, 'website', 'Website'),
      availability: getField(row, 'availability', 'Availability'),
      verified: normalizeVerified(getField(row, 'Verified', 'verified', 'is_verified', 'Is Verified')),
      lat: getField(row, 'lat', 'latitude', 'Lat'),
      long: getField(row, 'long', 'lng', 'longitude', 'Lon'),
    });

    // IMPORTANT: map UI columns -> DB columns for updates
    const DB_FIELD_BY_COL_ID = {
      company: 'company_name',
      authorization: 'authorization',
      category: 'category',
      verified: 'verified',
      phone: 'phone',
      contact: 'contact',
      address: 'address',
      city: 'city',
      state: 'state',
      zip: 'zip',
      email: 'email',
      notes: 'notes',
      website: 'website',
      availability: 'availability',
      lat: 'lat',
      long: 'long',
    };

    const els = {
      status: document.getElementById('dataset-status'),
      total: document.getElementById('tech-total'),
      states: document.getElementById('tech-states'),
      companies: document.getElementById('tech-companies'),
      paginationSummary: document.getElementById('pagination-summary'),
      prevPage: document.getElementById('prev-page'),
      nextPage: document.getElementById('next-page'),
      pageIndicator: document.getElementById('page-indicator'),
      refresh: document.getElementById('refresh-button'),
      addRecord: document.getElementById('add-record'),
      colgroup: document.getElementById('colgroup'),
      thead: document.getElementById('table-head'),
      tbody: document.getElementById('table-body'),
      tableScroll: document.getElementById('table-scroll'),
      topScrollbar: document.getElementById('top-scrollbar'),
      topScrollbarInner: document.getElementById('top-scrollbar-inner'),
      columnsBtn: document.getElementById('columns-btn'),
      columnsPopover: document.getElementById('columns-popover'),
      columnsList: document.getElementById('columns-list'),
      colsAll: document.getElementById('cols-all'),
      colsNone: document.getElementById('cols-none'),
      analyticsWrap: document.getElementById('analytics-wrap'),
    };

    const ALL_COLUMNS = [
      { id: 'company', label: 'Company Name', key: 'company', defaultWidth: 220 },
      { id: 'authorization', label: 'Authorization', key: 'authorization', defaultWidth: 160 },
      { id: 'category', label: 'Category', key: 'category', defaultWidth: 170 },
      { id: 'verified', label: 'Verified', key: 'verified', defaultWidth: 120 },
      { id: 'phone', label: 'Phone', key: 'phone', defaultWidth: 150 },
      { id: 'contact', label: 'Contact', key: 'contact', defaultWidth: 160 },
      { id: 'address', label: 'Address', key: 'address', defaultWidth: 260 },
      { id: 'city', label: 'City', key: 'city', defaultWidth: 140 },
      { id: 'state', label: 'State', key: 'state', defaultWidth: 100 },
      { id: 'zip', label: 'Zip', key: 'zip', defaultWidth: 100 },
      { id: 'email', label: 'Email', key: 'email', defaultWidth: 240 },
      { id: 'notes', label: 'Notes', key: 'notes', defaultWidth: 260 },
      { id: 'website', label: 'Website', key: 'website', defaultWidth: 220 },
      { id: 'availability', label: 'Availability', key: 'availability', defaultWidth: 180 },
      { id: 'lat', label: 'Lat', key: 'lat', defaultWidth: 120 },
      { id: 'long', label: 'Long', key: 'long', defaultWidth: 120 },
    ];

    const state = {
      rows: [],
      currentUserRole: 'user',
      currentUserId: 'anon',
      currentUserEmail: '',
      filters: { columnFilters: {} },
      sort: { key: '', dir: 'asc' },
      pagination: { page: 1, pageSize: 20 },
      columnOrder: ['actions', ...ALL_COLUMNS.map(c => c.id)],
      columnVisibility: Object.fromEntries([['actions', true], ...ALL_COLUMNS.map(c => [c.id, true])]),
      columnWidths: Object.fromEntries([['actions', 140], ...ALL_COLUMNS.map(c => [c.id, c.defaultWidth])]),
      columnLabels: {},
      drag: { resizing: null, draggingCol: null },

      // inline edit session
      inlineEdit: { td: null, rowId: null, colId: null, original: null, inputEl: null, saving: false, skipBlurCommit: false }
    };

    // ================== PERSISTENCE ==================
    const STORAGE_PREFIX = 'techloc_services_table_prefs_v1';
    const storageKey = () => `${STORAGE_PREFIX}:${state.currentUserId}`;
    const safeParse = (raw) => { try { return JSON.parse(raw); } catch { return null; } };

    const savePrefs = () => {
      localStorage.setItem(storageKey(), JSON.stringify({
        columnOrder: state.columnOrder,
        columnVisibility: state.columnVisibility,
        columnWidths: state.columnWidths,
        columnLabels: state.columnLabels,
        filters: state.filters,
        pagination: state.pagination,
      }));
    };

    const loadPrefs = () => {
      const prefs = safeParse(localStorage.getItem(storageKey()) || '');
      if (!prefs) return;

      const validCols = new Set(['actions', ...ALL_COLUMNS.map(c => c.id)]);

      if (Array.isArray(prefs.columnOrder)) {
        const cleaned = prefs.columnOrder.filter(c => validCols.has(c));
        const missing = [...validCols].filter(c => !cleaned.includes(c));
        state.columnOrder = [...cleaned, ...missing];
      }

      if (prefs.columnVisibility && typeof prefs.columnVisibility === 'object') {
        const next = { ...state.columnVisibility };
        for (const [k, v] of Object.entries(prefs.columnVisibility)) {
          if (validCols.has(k)) next[k] = !!v;
        }
        next.actions = true;
        state.columnVisibility = next;
      }

      if (prefs.columnWidths && typeof prefs.columnWidths === 'object') {
        const next = { ...state.columnWidths };
        for (const [k, v] of Object.entries(prefs.columnWidths)) {
          if (validCols.has(k) && Number.isFinite(+v)) next[k] = +v;
        }
        state.columnWidths = next;
      }

      if (prefs.columnLabels && typeof prefs.columnLabels === 'object') {
        const next = {};
        for (const [k, v] of Object.entries(prefs.columnLabels)) {
          if (validCols.has(k) && typeof v === 'string') next[k] = v;
        }
        state.columnLabels = next;
      }

      if (prefs.filters && typeof prefs.filters === 'object') {
        const nextFilters = { columnFilters: {} };
        if (prefs.filters.columnFilters && typeof prefs.filters.columnFilters === 'object') {
          for (const [colId, filter] of Object.entries(prefs.filters.columnFilters)) {
            if (!validCols.has(colId)) continue;
            const values = Array.isArray(filter?.values) ? filter.values : [];
            const query = typeof filter?.query === 'string' ? filter.query : '';
            if (values.length || query) nextFilters.columnFilters[colId] = { values, query };
          }
        }
        state.filters = nextFilters;
      }

      if (prefs.pagination && typeof prefs.pagination === 'object') {
        const page = Number.isFinite(+prefs.pagination.page) ? +prefs.pagination.page : 1;
        state.pagination.page = Math.max(1, page);
        if (Number.isFinite(+prefs.pagination.pageSize)) state.pagination.pageSize = +prefs.pagination.pageSize;
      }
    };

    // ---------------- AUTH ----------------
    const requireSession = async () => {
      const { data } = await supabaseClient.auth.getSession();

      if (data?.session) {
        state.currentUserId = data.session.user.id;
        state.currentUserEmail = data.session.user.email || '';
        if (window.currentUserRole) {
          state.currentUserRole = window.currentUserRole;
        } else {
          const { data: profile } = await supabaseClient
            .from('profiles')
            .select('role')
            .eq('id', data.session.user.id)
            .single();
          state.currentUserRole = profile?.role || 'user';
        }
      } else {
        state.currentUserRole = 'anon';
        state.currentUserId = 'anon';
      }

      loadPrefs();

      const isAdmin = state.currentUserRole === 'administrator';
      if (els.addRecord) {
        els.addRecord.classList.toggle('hidden', !isAdmin);
        els.addRecord.disabled = !isAdmin;
      }
    };

    supabaseClient.auth.onAuthStateChange((_event, session) => {
      const nextUserId = session?.user?.id || 'anon';
      if (nextUserId === state.currentUserId) return;
      state.currentUserId = nextUserId;
      state.currentUserEmail = session?.user?.email || '';
      loadPrefs();
      renderTable();
    });

    // ---------------- HELPERS ----------------
    const ensureToastContainer = () => {
      let container = document.getElementById('toast-container');
      if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'fixed bottom-6 right-6 z-50 flex flex-col gap-3';
        document.body.appendChild(container);
      }
      return container;
    };

    const showToast = (message, type = 'info') => {
      const container = ensureToastContainer();
      const toast = document.createElement('div');

      const variantClasses =
        type === 'success'
          ? 'border-emerald-500/60 bg-emerald-500/10 text-emerald-50 shadow-emerald-500/30'
          : type === 'warning'
            ? 'border-amber-500/60 bg-amber-500/10 text-amber-50 shadow-amber-500/30'
            : type === 'info'
              ? 'border-blue-500/60 bg-blue-500/10 text-blue-50 shadow-blue-500/30'
              : 'border-red-500/60 bg-red-500/10 text-red-50 shadow-red-500/30';

      toast.className = `flex min-w-[260px] max-w-sm items-start gap-3 rounded-xl border px-4 py-3 text-sm shadow-xl backdrop-blur ${variantClasses}`;

      const icon = document.createElement('span');
      icon.className = `mt-0.5 h-2.5 w-2.5 rounded-full ${type === 'success' ? 'bg-emerald-400' : type === 'warning' ? 'bg-amber-400' : type === 'info' ? 'bg-blue-400' : 'bg-red-400'
        }`;

      const text = document.createElement('p');
      text.className = 'whitespace-pre-line font-semibold leading-relaxed';
      text.textContent = message;

      toast.appendChild(icon);
      toast.appendChild(text);

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-2', 'transition', 'duration-300');
        setTimeout(() => toast.remove(), 320);
      }, 4200);
    };

    const logChange = async ({
      action = 'edit',
      summary = '',
      tableName = WRITE_TABLE,
      recordId = null,
      columnName = null,
      previousValue = null,
      newValue = null,
    } = {}) => {
      await logAdminEvent({
        client: supabaseClient,
        action,
        tableName,
        summary,
        recordId,
        columnName,
        previousValue,
        newValue,
        actor: state.currentUserEmail || state.currentUserId || null,
      });
    };

    const showConfirm = (message, { confirmText = 'Confirm', cancelText = 'Cancel' } = {}) =>
      new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70 backdrop-blur';

        const dialog = document.createElement('div');
        dialog.className = 'w-[min(420px,92vw)] rounded-2xl border border-slate-800 bg-slate-900/95 p-5 shadow-2xl shadow-black';

        dialog.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="mt-1 h-3 w-3 rounded-full bg-amber-400"></div>
            <div class="space-y-3">
              <p class="text-sm font-semibold text-white">${message}</p>
              <div class="flex flex-wrap gap-2">
                <button type="button" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow shadow-emerald-600/40 hover:-translate-y-0.5 transition" data-confirm> ${confirmText} </button>
                <button type="button" class="rounded-xl border border-slate-700 px-4 py-2 text-sm font-semibold text-slate-200 hover:-translate-y-0.5 transition" data-cancel> ${cancelText} </button>
              </div>
            </div>
          </div>
        `;

        const cleanup = (result) => {
          document.removeEventListener('keydown', onKey);
          overlay.remove();
          resolve(result);
        };

        dialog.querySelector('[data-confirm]')?.addEventListener('click', () => cleanup(true));
        dialog.querySelector('[data-cancel]')?.addEventListener('click', () => cleanup(false));
        overlay.addEventListener('click', (e) => { if (e.target === overlay) cleanup(false); });
        function onKey(e) {
          if (e.key === 'Escape') cleanup(false);
        }
        document.addEventListener('keydown', onKey);

        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
      });

    const getText = (value) => String(value ?? '').toLowerCase().trim();

    const skeleton = {
      show: () => {
        els.status.textContent = 'Loading data…';
        els.total.innerHTML = '<div class="h-7 w-16 rounded bg-slate-800/70 animate-pulse"></div>';
        els.states.innerHTML = '<div class="h-7 w-12 rounded bg-slate-800/70 animate-pulse"></div>';
        els.companies.innerHTML = '<div class="h-7 w-12 rounded bg-slate-800/70 animate-pulse"></div>';

        els.paginationSummary.textContent = 'Loading…';
        els.pageIndicator.textContent = '—';
        els.prevPage.disabled = true;
        els.nextPage.disabled = true;
        if (els.refresh) els.refresh.disabled = true;

        const cols = getVisibleOrderedColumns();
        els.tbody.innerHTML = '';
        for (let i = 0; i < 6; i += 1) {
          const tr = document.createElement('tr');
          cols.forEach(() => {
            const td = document.createElement('td');
            td.className = 'compact-td';
            td.innerHTML = '<div class="h-4 w-full rounded bg-slate-800/70 animate-pulse"></div>';
            tr.appendChild(td);
          });
          els.tbody.appendChild(tr);
        }
      },
      hide: () => {
        els.prevPage.disabled = false;
        els.nextPage.disabled = false;
        if (els.refresh) els.refresh.disabled = false;
      }
    };

    const updateStats = () => {
      const total = state.rows.length;
      const statesCount = new Set(state.rows.map(r => (r.state || '').trim()).filter(Boolean)).size;
      const companiesCount = new Set(state.rows.map(r => (r.company || '').trim()).filter(Boolean)).size;
      els.total.textContent = total;
      els.states.textContent = statesCount;
      els.companies.textContent = companiesCount;
      els.status.textContent = total ? `Connected • ${total} records` : 'Awaiting data';
    };

    const getColumnDisplayValue = (colId, row) => {
      if (colId === 'verified') return boolToLabel(row.verified);
      const col = ALL_COLUMNS.find(c => c.id === colId);
      const raw = col ? row[col.key] : '';
      if (raw === null || raw === undefined || String(raw).trim() === '') return '—';
      return String(raw);
    };

    const getFilterOptionsForColumn = (colId) => {
      const values = new Set();
      state.rows.forEach((row) => {
        values.add(getColumnDisplayValue(colId, row));
      });
      return Array.from(values).sort((a, b) => getText(a).localeCompare(getText(b), undefined, { numeric: true }));
    };

    const getColumnFilterState = (colId) => {
      const stored = state.filters.columnFilters[colId] || {};
      return {
        values: Array.isArray(stored.values) ? stored.values : [],
        query: typeof stored.query === 'string' ? stored.query : '',
      };
    };

    const setColumnFilter = (colId, next) => {
      const values = Array.isArray(next.values) ? next.values : [];
      const query = typeof next.query === 'string' ? next.query : '';
      if (!values.length && !query) {
        delete state.filters.columnFilters[colId];
      } else {
        state.filters.columnFilters[colId] = { values, query };
      }
      state.pagination.page = 1;
      savePrefs();
      renderTable();
    };

    const applyFilters = () => {
      let result = [...state.rows];
      const filters = state.filters.columnFilters || {};
      Object.entries(filters).forEach(([colId, filter]) => {
        const values = Array.isArray(filter.values) ? filter.values : [];
        const query = typeof filter.query === 'string' ? filter.query.trim() : '';
        if (!values.length && !query) return;
        const selected = new Set(values.map(getText));
        result = result.filter((row) => {
          const display = getColumnDisplayValue(colId, row);
          const text = getText(display);
          const matchesQuery = query ? text.includes(getText(query)) : true;
          const matchesSelection = selected.size ? selected.has(text) : true;
          return matchesQuery && matchesSelection;
        });
      });
      return result;
    };

    const applySort = (rows) => {
      const { key, dir } = state.sort;
      if (!key) return rows;
      const col = ALL_COLUMNS.find(c => c.id === key);
      if (!col) return rows;

      const sorted = [...rows].sort((a, b) => {
        if (col.id === 'verified') {
          const normalize = (v) => (v === true ? '2' : v === false ? '1' : getText(v));
          const as = normalize(a.verified);
          const bs = normalize(b.verified);
          return as.localeCompare(bs, undefined, { numeric: true, sensitivity: 'base' });
        }
        return getText(a[col.key]).localeCompare(getText(b[col.key]), undefined, { numeric: true, sensitivity: 'base' });
      });

      return dir === 'asc' ? sorted : sorted.reverse();
    };

    const getVisibleOrderedColumns = () => state.columnOrder.filter(colId => state.columnVisibility[colId]);

    // ---------------- TABLE RENDER ----------------
    const renderColgroup = () => {
      const cols = getVisibleOrderedColumns();
      els.colgroup.innerHTML = '';
      cols.forEach((colId) => {
        const colEl = document.createElement('col');
        colEl.setAttribute('data-col', colId);
        colEl.style.width = `${state.columnWidths[colId] || 140}px`;
        els.colgroup.appendChild(colEl);
      });
    };

    const syncTopScrollbar = () => {
      els.topScrollbarInner.style.width = els.tableScroll.scrollWidth + 'px';
      els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
    };

    const setColWidth = (colId, px) => {
      const min = 72;
      const max = 800;
      state.columnWidths[colId] = Math.max(min, Math.min(max, px));
      const colEl = els.colgroup.querySelector(`col[data-col="${colId}"]`);
      if (colEl) colEl.style.width = `${state.columnWidths[colId]}px`;
      const th = els.thead.querySelector(`th[data-col="${colId}"]`);
      if (th) {
        th.style.width = `${state.columnWidths[colId]}px`;
        th.style.minWidth = `${state.columnWidths[colId]}px`;
      }
      syncTopScrollbar();
      savePrefs();
      requestAnimationFrame(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
    };

    const sortIcon = (colId) => {
      if (state.sort.key !== colId) return 'arrow-up-down';
      return state.sort.dir === 'asc' ? 'arrow-up' : 'arrow-down';
    };

    const renameColumn = (colId) => {
      if (!colId || colId === 'actions') return;
      const baseLabel = state.columnLabels[colId] || (ALL_COLUMNS.find(c => c.id === colId)?.label) || colId;
      const next = prompt('Nuevo nombre de columna', baseLabel);
      if (next === null) return;
      const trimmed = next.trim();
      if (!trimmed) return;
      state.columnLabels[colId] = trimmed;
      savePrefs();
      renderTable();
    };

    const toggleSort = (colId) => {
      if (state.sort.key === colId) state.sort.dir = state.sort.dir === 'asc' ? 'desc' : 'asc';
      else { state.sort.key = colId; state.sort.dir = 'asc'; }
      state.pagination.page = 1;
      renderTable();
    };

    const buildHeaderCell = (colId) => {
      const th = document.createElement('th');
      th.className = 'text-left font-semibold text-slate-200 resizable bg-slate-950/60 compact-th';
      th.setAttribute('data-col', colId);

      const startingWidth = state.columnWidths[colId] || 140;
      th.style.width = `${startingWidth}px`;
      th.style.minWidth = `${startingWidth}px`;

      if (colId === 'actions') {
        th.className = 'text-left font-semibold text-blue-300 resizable bg-slate-950/60 compact-th';
        th.style.width = `${state.columnWidths[colId] || 110}px`;
        th.style.minWidth = `${state.columnWidths[colId] || 110}px`;
        th.innerHTML = `
          <div class="th-inner">
            <span class="text-blue-300">Actions</span>
            <span class="opacity-60 text-[11px] uppercase tracking-wide">—</span>
          </div>
          <div class="col-resizer" data-resize="${colId}" title="Drag to resize"></div>
        `;
        return th;
      }

      const col = ALL_COLUMNS.find(c => c.id === colId);
      const label = state.columnLabels[colId] || col?.label || colId;

      th.setAttribute('draggable', 'true');

      const thInner = document.createElement('div');
      thInner.className = 'th-inner';

      const labelWrap = document.createElement('div');
      labelWrap.className = 'flex items-center gap-2 min-w-0';
      const labelSpan = document.createElement('span');
      labelSpan.className = 'truncate th-label';
      labelSpan.dataset.renameCol = colId;
      labelSpan.title = 'Doble click para renombrar';
      labelSpan.textContent = label;
      labelWrap.appendChild(labelSpan);

      const actionsWrap = document.createElement('div');
      actionsWrap.className = 'header-actions';

      const filterWrapper = document.createElement('div');
      filterWrapper.className = 'relative';

      const filterBtn = document.createElement('button');
      filterBtn.type = 'button';
      filterBtn.title = 'Filter column';
      filterBtn.className = 'filter-btn';
      const filterState = getColumnFilterState(colId);
      const hasFilter = filterState.values.length || filterState.query;
      filterBtn.innerHTML = `<i data-lucide="list-filter" class="h-3.5 w-3.5 ${hasFilter ? 'text-blue-400' : 'text-slate-400'}"></i>`;

      const filterPopover = document.createElement('div');
      filterPopover.className = 'filter-popover hidden';

      const filterTitle = document.createElement('label');
      filterTitle.textContent = 'Filter this column';
      filterPopover.appendChild(filterTitle);

      const searchWrap = document.createElement('div');
      searchWrap.className = 'filter-search';
      const searchIcon = document.createElement('i');
      searchIcon.setAttribute('data-lucide', 'search');
      searchIcon.className = 'h-3.5 w-3.5 text-slate-500';
      const searchInput = document.createElement('input');
      searchInput.type = 'search';
      searchInput.placeholder = `Search ${label}`;
      searchInput.value = filterState.query;
      searchWrap.appendChild(searchIcon);
      searchWrap.appendChild(searchInput);
      filterPopover.appendChild(searchWrap);

      const optionsWrapper = document.createElement('div');
      optionsWrapper.className = 'filter-options';
      filterPopover.appendChild(optionsWrapper);

      const selected = new Set(filterState.values);
      const renderOptions = (term = '') => {
        const normalizedTerm = getText(term);
        optionsWrapper.innerHTML = '';
        const options = getFilterOptionsForColumn(colId);
        const filteredOptions = normalizedTerm
          ? options.filter(value => getText(value).includes(normalizedTerm))
          : options;

        if (!filteredOptions.length) {
          const empty = document.createElement('p');
          empty.className = 'text-xs text-slate-500';
          empty.textContent = 'No options';
          optionsWrapper.appendChild(empty);
          return;
        }

        filteredOptions.forEach((value) => {
          const optionLabel = document.createElement('label');
          optionLabel.className = 'filter-option';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'h-4 w-4 accent-blue-600';
          checkbox.value = value;
          checkbox.checked = selected.has(value);
          checkbox.addEventListener('change', (event) => {
            if (event.target.checked) {
              selected.add(value);
            } else {
              selected.delete(value);
            }
          });
          const text = document.createElement('span');
          text.className = 'truncate';
          text.textContent = value;
          optionLabel.appendChild(checkbox);
          optionLabel.appendChild(text);
          optionsWrapper.appendChild(optionLabel);
        });
      };

      renderOptions(searchInput.value);

      const actionsRow = document.createElement('div');
      actionsRow.className = 'filter-actions';
      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.className = 'flex-1 rounded-md bg-blue-600 px-3 py-2 text-xs font-semibold text-white hover:bg-blue-500';
      applyBtn.textContent = 'Apply';
      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.className = 'flex-1 rounded-md border border-slate-700 bg-slate-900 px-3 py-2 text-xs font-semibold text-slate-200 hover:border-blue-500';
      clearBtn.textContent = 'Clear';
      actionsRow.appendChild(applyBtn);
      actionsRow.appendChild(clearBtn);
      filterPopover.appendChild(actionsRow);

      const closePopover = (event) => {
        if (!event || !filterWrapper.contains(event.target)) {
          filterPopover.classList.add('hidden');
          document.removeEventListener('click', closePopover);
        }
      };

      filterBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        const willOpen = filterPopover.classList.contains('hidden');
        filterPopover.classList.toggle('hidden');
        if (willOpen) {
          renderOptions(searchInput.value);
          document.addEventListener('click', closePopover);
        } else {
          document.removeEventListener('click', closePopover);
        }
      });

      searchInput.addEventListener('input', () => {
        renderOptions(searchInput.value);
      });

      applyBtn.addEventListener('click', () => {
        setColumnFilter(colId, { values: Array.from(selected), query: searchInput.value.trim() });
        closePopover();
      });

      clearBtn.addEventListener('click', () => {
        selected.clear();
        searchInput.value = '';
        renderOptions('');
        setColumnFilter(colId, { values: [], query: '' });
        closePopover();
      });

      filterWrapper.appendChild(filterBtn);
      filterWrapper.appendChild(filterPopover);

      const sortBtn = document.createElement('button');
      sortBtn.type = 'button';
      sortBtn.className = 'sort-btn text-[11px] font-semibold text-slate-200';
      sortBtn.dataset.sortCol = colId;
      sortBtn.title = 'Sort';
      sortBtn.innerHTML = `<i data-lucide="${sortIcon(colId)}" class="h-3.5 w-3.5"></i>`;

      actionsWrap.appendChild(filterWrapper);
      actionsWrap.appendChild(sortBtn);

      thInner.appendChild(labelWrap);
      thInner.appendChild(actionsWrap);
      th.appendChild(thInner);

      const resizer = document.createElement('div');
      resizer.className = 'col-resizer';
      resizer.dataset.resize = colId;
      resizer.title = 'Drag to resize';
      th.appendChild(resizer);

      return th;
    };

    const renderHeader = () => {
      const cols = getVisibleOrderedColumns();
      const tr = document.createElement('tr');
      cols.forEach((colId) => tr.appendChild(buildHeaderCell(colId)));
      els.thead.innerHTML = '';
      els.thead.appendChild(tr);

      els.thead.querySelectorAll('th[draggable="true"]').forEach((th) => {
        th.addEventListener('dragstart', (e) => {
          if (state.drag.resizing) {
            e.preventDefault();
            return;
          }
          const colId = th.dataset.col;
          state.drag.draggingCol = colId;
          th.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', colId);
        });

        th.addEventListener('dragend', () => {
          th.classList.remove('dragging');
          state.drag.draggingCol = null;
          els.thead.querySelectorAll('th').forEach(x => x.classList.remove('drop-target'));
        });

        th.addEventListener('dragover', (e) => {
          e.preventDefault();
          const targetCol = th.dataset.col;
          if (!state.drag.draggingCol || state.drag.draggingCol === targetCol) return;
          th.classList.add('drop-target');
        });

        th.addEventListener('dragleave', () => th.classList.remove('drop-target'));

        th.addEventListener('drop', (e) => {
          e.preventDefault();
          const from = state.drag.draggingCol;
          const to = th.dataset.col;
          if (!from || !to || from === to) return;
          const order = [...state.columnOrder];
          const fromIdx = order.indexOf(from);
          const toIdx = order.indexOf(to);
          if (fromIdx === -1 || toIdx === -1) return;
          order.splice(fromIdx, 1);
          order.splice(toIdx, 0, from);
          state.columnOrder = order;
          savePrefs();
          renderTable();
        });
      });

      els.thead.querySelectorAll('[data-sort-col]').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleSort(btn.getAttribute('data-sort-col'));
        });
      });

      els.thead.querySelectorAll('[data-rename-col]').forEach((el) => {
        el.addEventListener('dblclick', (e) => {
          e.stopPropagation();
          const colId = el.getAttribute('data-rename-col');
          renameColumn(colId);
        });
      });

      lucide.createIcons();
    };

    const renderBody = (pageRows) => {
      const cols = getVisibleOrderedColumns();
      const isAdmin = state.currentUserRole === 'administrator';
      els.tbody.innerHTML = '';

      pageRows.forEach((row) => {
        const tr = document.createElement('tr');
        tr.className = 'transition hover:bg-slate-800/40';

        cols.forEach((colId) => {
          const td = document.createElement('td');
          td.className = 'align-top text-slate-200 compact-td';

          if (colId === 'actions') {
            td.className = 'text-center align-top compact-td';

            if (isAdmin) {
              const actions = document.createElement('div');
              actions.className = 'inline-flex items-center justify-center gap-2';

              const duplicateBtn = document.createElement('button');
              duplicateBtn.type = 'button';
              duplicateBtn.className = 'text-blue-300 transition hover:text-blue-200 hover:scale-110';
              duplicateBtn.innerHTML = '<i data-lucide="copy" class="h-4 w-4"></i>';
              duplicateBtn.onclick = () => duplicateRow(row);
              actions.appendChild(duplicateBtn);

              const deleteBtn = document.createElement('button');
              deleteBtn.type = 'button';
              deleteBtn.className = 'text-red-400 transition hover:text-red-300 hover:scale-110';
              deleteBtn.innerHTML = '<i data-lucide="trash-2" class="h-4 w-4"></i>';
              deleteBtn.onclick = () => deleteRow(row);
              actions.appendChild(deleteBtn);

              td.appendChild(actions);
            } else {
              td.innerHTML = '<span class="text-slate-600 text-xs">Read Only</span>';
            }

            tr.appendChild(td);
            return;
          }

          const col = ALL_COLUMNS.find(c => c.id === colId);
          let value = col ? row[col.key] : '';

          // display formatting for verified
          if (colId === 'verified') value = boolToLabel(row.verified);

          if (colId === 'company') td.className = 'font-semibold text-white align-top compact-td';

          td.textContent = (value === '' || value === null || value === undefined) ? '—' : String(value);

          // ✅ make cells editable by dblclick (admin only)
          td.dataset.rowId = row.id;
          td.dataset.colId = colId;
          td.dataset.editable = (isAdmin && colId !== 'actions') ? 'true' : 'false';

          tr.appendChild(td);
        });

        els.tbody.appendChild(tr);
      });

      lucide.createIcons();
    };

    const renderPagination = (rows) => {
      const totalPages = Math.max(1, Math.ceil(rows.length / state.pagination.pageSize));
      const prevPage = state.pagination.page;
      if (state.pagination.page > totalPages) state.pagination.page = totalPages;

      const start = (state.pagination.page - 1) * state.pagination.pageSize;
      const end = Math.min(rows.length, start + state.pagination.pageSize);

      els.paginationSummary.textContent = rows.length
        ? `Showing ${start + 1}-${end} of ${rows.length}`
        : 'No entries to display';

      els.pageIndicator.textContent = `${state.pagination.page} / ${totalPages}`;
      els.prevPage.disabled = state.pagination.page === 1 || rows.length === 0;
      els.nextPage.disabled = state.pagination.page >= totalPages || rows.length === 0;

      if (prevPage !== state.pagination.page) savePrefs();

      return { start, end };
    };

    const renderTable = () => {
      const filtered = applyFilters();
      const sorted = applySort(filtered);
      const { start, end } = renderPagination(sorted);
      renderColgroup();
      renderHeader();
      renderBody(sorted.slice(start, end));
      renderColumnsPopover();
      syncTopScrollbar();
      renderCharts(sorted);
      lucide.createIcons();
    };

    // ---------------- INLINE CELL EDITING ----------------
    const withTimeout = (promise, ms = 20000) => {
      let t;
      const timeout = new Promise((_, reject) => {
        t = setTimeout(() => reject(new Error(`Request timed out after ${ms / 1000}s`)), ms);
      });
      return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
    };

    const getRowById = (id) => state.rows.find(r => String(r.id) === String(id));

    const endInlineEdit = (opts = { save: false }) => {
      const ses = state.inlineEdit;
      if (!ses.td) return;

      const td = ses.td;
      const rowId = ses.rowId;
      const colId = ses.colId;
      const original = ses.original;

      td.classList.remove('editing');
      td.classList.remove('failed');
      td.classList.remove('saved');

      // restore view (if not saving)
      if (!opts.save) {
        td.innerHTML = '';
        td.textContent = original === '' ? '—' : original;
        ses.td = null; ses.rowId = null; ses.colId = null; ses.original = null; ses.inputEl = null;
        return;
      }

      // if saving handled elsewhere, just cleanup refs
      ses.td = null; ses.rowId = null; ses.colId = null; ses.original = null; ses.inputEl = null;
    };

    const parseEditedValue = (colId, raw) => {
      if (colId === 'verified') {
        const v = String(raw ?? '').trim();
        if (v === '') return null;
        if (v === 'true') return true;
        if (v === 'false') return false;
        return v;
      }
      const v = String(raw ?? '').trim();
      return v === '' ? null : v;
    };

    const valueForDisplay = (colId, value) => {
      if (colId === 'verified') return boolToLabel(value);
      if (value === null || value === undefined || String(value).trim() === '') return '—';
      return String(value);
    };

    const selectColumns = new Set(['category', 'authorization', 'state', 'verified']);

    const optionLabel = (colId, value) => {
      if (colId === 'state') return String(value).toUpperCase();
      if (colId === 'verified') return boolToLabel(value);
      return String(value);
    };

    const INSERT_NEW_VALUE = '__insert_new__';

    const getSelectOptions = (colId) => {
      if (colId === 'verified') {
        const base = [
          { value: '', label: '—' },
          { value: 'true', label: 'Verified' },
          { value: 'false', label: 'Not verified' },
        ];
        const seen = new Set(base.map(o => o.value));
        const custom = [];
        state.rows.forEach((row) => {
          const val = row.verified;
          const value = val === true ? 'true' : val === false ? 'false' : (val === null || val === undefined ? '' : String(val));
          if (!value || seen.has(value)) return;
          seen.add(value);
          custom.push({ value, label: optionLabel(colId, val) });
        });
        return [...base, ...custom, { value: INSERT_NEW_VALUE, label: 'Insert new…' }];
      }

      const col = ALL_COLUMNS.find(c => c.id === colId);
      if (!col) return [];
      const seen = new Set();
      const opts = [];
      state.rows.forEach((row) => {
        const raw = row[col.key];
        const value = raw === null || raw === undefined ? '' : String(raw).trim();
        if (!value) return;
        const key = getText(value);
        if (seen.has(key)) return;
        seen.add(key);
        opts.push({ value, label: optionLabel(colId, value) });
      });
      return [{ value: '', label: '—' }, ...opts, { value: INSERT_NEW_VALUE, label: 'Insert new…' }];
    };

    const addSelectOption = (select, value, label) => {
      if ([...select.options].some(o => o.value === value)) return;
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      const insertOpt = [...select.options].find(o => o.value === INSERT_NEW_VALUE);
      if (insertOpt) {
        select.insertBefore(opt, insertOpt);
      } else {
        select.appendChild(opt);
      }
    };

    const writeLocalRowValue = (rowId, colId, newValue) => {
      const row = getRowById(rowId);
      if (!row) return;
      const col = ALL_COLUMNS.find(c => c.id === colId);
      if (!col) return;
      row[col.key] = newValue;
    };

    const saveCellToSupabase = async ({ rowId, colId, newValue, td }) => {
      const dbField = DB_FIELD_BY_COL_ID[colId];
      if (!dbField) throw new Error(`No DB mapping for column "${colId}"`);

      td.classList.add('saving');

      const payload = { [dbField]: newValue };

      const { error } = await withTimeout(
        supabaseClient.from(WRITE_TABLE).update(payload).eq('id', rowId),
        20000
      );

      if (error) throw error;
    };

    const commitInlineEdit = async () => {
      const ses = state.inlineEdit;
      if (!ses.td || ses.saving) return;

      const td = ses.td;
      const rowId = ses.rowId;
      const colId = ses.colId;

      const input = ses.inputEl;
      if (!input) return;

      const raw = input.value;
      let newValue = parseEditedValue(colId, raw);

      if (colId === 'phone') {
        const digits = String(raw ?? '').replace(/\D/g, '');
        if (digits.length !== 10) {
          td.classList.add('failed');
          showToast('Phone numbers must include exactly 10 digits (e.g., 809-555-1234).', 'error');
          return;
        }
        newValue = `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;
      }

      if (colId === 'email') {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (newValue && !emailRegex.test(newValue)) {
          td.classList.add('failed');
          showToast('Please enter a valid email address.', 'error');
          return;
        }
      }

      // compute original value (from local row, not formatted)
      const row = getRowById(rowId);
      const col = ALL_COLUMNS.find(c => c.id === colId);
      const currentValue = colId === 'verified' ? (row?.verified ?? null) : (row?.[col?.key] ?? null);

      const same =
        (colId === 'verified')
          ? (String(currentValue ?? '').trim() === String(newValue ?? '').trim())
          : (String(currentValue ?? '') === String(newValue ?? ''));

      if (same) {
        td.innerHTML = '';
        td.textContent = valueForDisplay(colId, currentValue);
        endInlineEdit({ save: true });
        return;
      }

      try {
        if (rowId === null || rowId === undefined) {
          throw new Error('Cannot save cell: missing row id');
        }

        ses.saving = true;
        td.classList.remove('failed');
        td.classList.remove('saved');

        // optimistic UI
        writeLocalRowValue(rowId, colId, newValue);
        td.innerHTML = '';
        td.textContent = valueForDisplay(colId, colId === 'verified' ? newValue : newValue);

        await saveCellToSupabase({ rowId, colId, newValue, td });

        td.classList.add('saved');
        setTimeout(() => td.classList.remove('saved'), 900);

        endInlineEdit({ save: true });

        // refresh charts/stats based on local changes
        renderCharts(applySort(applyFilters()));

        logChange({
          action: 'edit',
          summary: `Updated ${col?.label || colId} for ${row.company || 'Service'} (#${rowId})`,
          recordId: rowId,
          columnName: colId,
          previousValue: currentValue,
          newValue,
        });
      } catch (err) {
        console.error('Cell save failed:', err);

        // revert local value
        writeLocalRowValue(rowId, colId, currentValue);

        td.classList.add('failed');
        td.innerHTML = '';
        td.textContent = valueForDisplay(colId, currentValue);

        endInlineEdit({ save: true });
        showToast('Error saving cell: ' + (err?.message || JSON.stringify(err)), 'error');
      } finally {
        ses.saving = false;
        td.classList.remove('saving');
      }
    };

    const startInlineEdit = (td) => {
      const editable = td?.dataset?.editable === 'true';
      if (!editable) return;

      const rowId = td.dataset.rowId;
      const colId = td.dataset.colId;

      // only known columns
      if (!rowId || !colId || colId === 'actions') return;

      // end any existing edit first (cancel)
      if (state.inlineEdit.td) endInlineEdit({ save: false });

      const row = getRowById(rowId);
      if (!row) return;

      const col = ALL_COLUMNS.find(c => c.id === colId);
      if (!col) return;

      const rawCurrent = (colId === 'verified')
        ? row.verified
        : (row[col.key] ?? null);

      const displayCurrent = valueForDisplay(colId, rawCurrent);

      state.inlineEdit.td = td;
      state.inlineEdit.rowId = rowId;
      state.inlineEdit.colId = colId;
      state.inlineEdit.original = displayCurrent === '—' ? '—' : displayCurrent;
      state.inlineEdit.skipBlurCommit = false;

      td.classList.add('editing');
      td.innerHTML = '';

      let inputEl;

      if (selectColumns.has(colId)) {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex items-center gap-2';

        const sel = document.createElement('select');
        sel.className = 'cell-select flex-1 min-w-0';

        const opts = getSelectOptions(colId);
        opts.forEach(({ value, label }) => addSelectOption(sel, value, label));

        const currentValue = colId === 'verified'
          ? (rawCurrent === true ? 'true' : rawCurrent === false ? 'false' : (rawCurrent === null || rawCurrent === undefined ? '' : String(rawCurrent)))
          : (rawCurrent === null || rawCurrent === undefined ? '' : String(rawCurrent));
        sel.value = [...sel.options].some(o => o.value === currentValue) ? currentValue : '';

        let previousValue = sel.value;

        sel.addEventListener('change', () => {
          if (sel.value !== INSERT_NEW_VALUE) {
            previousValue = sel.value;
            return;
          }

          const label = colId === 'verified' ? 'verification' : col.label.toLowerCase();
          const entry = prompt(`Enter a new ${label} value:`);
          if (entry === null) {
            sel.value = previousValue;
            return;
          }

          const trimmed = entry.trim();
          if (trimmed === '') {
            sel.value = previousValue;
            return;
          }

          let value = trimmed;
          if (colId === 'verified') {
            const boolVal = toBool(trimmed);
            if (boolVal === true) value = 'true';
            else if (boolVal === false) value = 'false';
          }

          addSelectOption(sel, value, optionLabel(colId, trimmed));
          sel.value = value;
          previousValue = value;
        });

        wrapper.appendChild(sel);
        inputEl = sel;
        state.inlineEdit.inputEl = inputEl;
        td.appendChild(wrapper);
      } else {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.className = 'cell-input';
        inp.value = rawCurrent === null || rawCurrent === undefined ? '' : String(rawCurrent);
        inputEl = inp;
        state.inlineEdit.inputEl = inputEl;
        td.appendChild(inputEl);
      }

      // focus + select
      setTimeout(() => {
        inputEl.focus();
        if (inputEl.select) inputEl.select();
      }, 0);

      // handlers
      inputEl.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          state.inlineEdit.skipBlurCommit = true;
          try {
            await commitInlineEdit();
          } finally {
            state.inlineEdit.skipBlurCommit = false;
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          endInlineEdit({ save: false });
        } else if (e.key === 'Tab') {
          // save current and move to next cell in the row
          e.preventDefault();
          await commitInlineEdit();
          focusNextEditableCell(td, e.shiftKey ? -1 : 1);
        }
      });

      inputEl.addEventListener('blur', async () => {
        // save on blur unless just handled by Enter
        if (state.inlineEdit.skipBlurCommit) {
          state.inlineEdit.skipBlurCommit = false;
          return;
        }

        await commitInlineEdit();
      });
    };

    const focusNextEditableCell = (fromTd, dir) => {
      const tr = fromTd.closest('tr');
      if (!tr) return;
      const tds = Array.from(tr.querySelectorAll('td[data-editable="true"]'));
      const idx = tds.indexOf(fromTd);
      const next = tds[idx + dir];
      if (!next) return;
      startInlineEdit(next);
    };

    // delegate dblclick to tbody
    const attachInlineEditing = () => {
      els.tbody.addEventListener('dblclick', (e) => {
        const td = e.target.closest('td');
        if (!td) return;
        startInlineEdit(td);
      });

      // click outside to commit (blur usually handles, but this is extra safety)
      document.addEventListener('mousedown', (e) => {
        const ses = state.inlineEdit;
        if (!ses.td) return;
        const inside = e.target.closest('td.editing');
        if (inside) return;
        // if clicked elsewhere, attempt to commit (blur will also fire)
        // no-op here to avoid double commits
      });
    };

    // ---------------- RESIZE ----------------
    const onMouseMoveResize = (e) => {
      const session = state.drag.resizing;
      if (!session) return;
      if (session.pointerId !== undefined && session.pointerId !== null && e.pointerId !== undefined && e.pointerId !== session.pointerId) return;
      e.preventDefault();
      const { colId, startX, startW } = session;
      const dx = e.clientX - startX;
      setColWidth(colId, startW + dx);
    };

    const stopResize = (e) => {
      const session = state.drag.resizing;
      if (!session) return;
      if (session.pointerId !== undefined && session.pointerId !== null && e && e.pointerId !== undefined && e.pointerId !== session.pointerId) return;
      state.drag.resizing = null;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      window.removeEventListener('pointermove', onMouseMoveResize);
      window.removeEventListener('pointerup', stopResize, true);
    };

    const attachResizeHandles = () => {
      els.thead.addEventListener('pointerdown', (e) => {
        const handle = e.target.closest('[data-resize]');
        if (!handle) return;
        e.preventDefault();
        e.stopPropagation();

        const colId = handle.getAttribute('data-resize');
        const th = handle.closest('th');
        const thWidth = th ? parseFloat(getComputedStyle(th).width) : 0;
        const startWidth = Number.isFinite(state.columnWidths[colId]) ? state.columnWidths[colId] : (thWidth || 140);

        state.drag.resizing = { colId, startX: e.clientX, startW: startWidth, pointerId: e.pointerId };
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
        if (handle.setPointerCapture) handle.setPointerCapture(e.pointerId);
        window.addEventListener('pointermove', onMouseMoveResize);
        window.addEventListener('pointerup', stopResize, true);
      });
    };

    // ---------------- COLUMN PICKER ----------------
    const renderColumnsPopover = () => {
      els.columnsList.innerHTML = '';

      const makeRow = (colId, label, locked = false) => {
        const wrapper = document.createElement('label');
        wrapper.className = 'flex items-center justify-between gap-3 rounded-xl border border-slate-800 bg-slate-900/40 px-3 py-2 text-sm text-slate-200 hover:border-blue-500/60';

        const left = document.createElement('div');
        left.className = 'flex items-center gap-2 min-w-0';
        left.innerHTML = `
          <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500">${locked ? 'Locked' : 'Show'}</span>
          <span class="truncate font-semibold">${state.columnLabels[colId] || label}</span>
        `;

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = !!state.columnVisibility[colId];
        input.disabled = locked;
        input.className = 'h-4 w-4 accent-blue-600';
        input.addEventListener('change', () => {
          state.columnVisibility[colId] = input.checked;
          state.columnVisibility.actions = true;
          savePrefs();
          renderTable();
        });

        wrapper.appendChild(left);
        wrapper.appendChild(input);
        return wrapper;
      };

      els.columnsList.appendChild(makeRow('actions', 'Actions', true));
      ALL_COLUMNS.forEach((c) => els.columnsList.appendChild(makeRow(c.id, c.label)));

      lucide.createIcons();
    };

    const toggleColumnsPopover = (force) => {
      const willShow = typeof force === 'boolean' ? force : els.columnsPopover.classList.contains('hidden');
      els.columnsPopover.classList.toggle('hidden', !willShow);
      if (willShow) renderColumnsPopover();
    };

    document.addEventListener('click', (e) => {
      const insideColumns = e.target.closest('#columns-popover') || e.target.closest('#columns-btn');
      if (!insideColumns) toggleColumnsPopover(false);
    });

    els.columnsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleColumnsPopover();
    });

    els.colsAll.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => state.columnVisibility[k] = true);
      state.columnVisibility.actions = true;
      savePrefs();
      renderTable();
    });

    els.colsNone.addEventListener('click', () => {
      Object.keys(state.columnVisibility).forEach((k) => state.columnVisibility[k] = false);
      state.columnVisibility.actions = true;
      savePrefs();
      renderTable();
    });

    // ---------------- TOP SCROLLBAR SYNC ----------------
    const attachScrollSync = () => {
      let syncing = false;

      els.tableScroll.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.topScrollbar.scrollLeft = els.tableScroll.scrollLeft;
        syncing = false;
      });

      els.topScrollbar.addEventListener('scroll', () => {
        if (syncing) return;
        syncing = true;
        els.tableScroll.scrollLeft = els.topScrollbar.scrollLeft;
        syncing = false;
      });

      window.addEventListener('resize', () => {
        syncTopScrollbar();
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
    };

    // ---------------- CHARTS ----------------
    let chartStates = null;
    let chartCategories = null;

    const buildCounts = (rows, key) => {
      const m = new Map();
      rows.forEach((r) => {
        const k = (r[key] || '—').toString().trim() || '—';
        m.set(k, (m.get(k) || 0) + 1);
      });
      return [...m.entries()].sort((a, b) => b[1] - a[1]);
    };

    const makeChartOptions = () => ({
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        legend: { labels: { color: 'rgba(226,232,240,.85)', boxWidth: 10, boxHeight: 10, usePointStyle: true } },
        tooltip: {
          backgroundColor: 'rgba(2,6,23,.95)',
          borderColor: 'rgba(51,65,85,.8)',
          borderWidth: 1,
          titleColor: 'rgba(226,232,240,.95)',
          bodyColor: 'rgba(226,232,240,.85)',
        }
      },
      scales: {
        x: { ticks: { color: 'rgba(148,163,184,.8)' }, grid: { color: 'rgba(51,65,85,.35)' } },
        y: { ticks: { color: 'rgba(148,163,184,.8)' }, grid: { color: 'rgba(51,65,85,.35)' } }
      }
    });

    const renderCharts = (filteredRows) => {
      const topStates = buildCounts(filteredRows, 'state').slice(0, 10);
      const topCats = buildCounts(filteredRows, 'category').slice(0, 8);

      const stateLabels = topStates.map(([k]) => (k === '—' ? 'Unknown' : k.toUpperCase()));
      const stateValues = topStates.map(([, v]) => v);

      const catLabels = topCats.map(([k]) => (k === '—' ? 'Unknown' : k));
      const catValues = topCats.map(([, v]) => v);

      const palette = [
        'rgba(59,130,246,.55)', 'rgba(99,102,241,.55)', 'rgba(16,185,129,.55)',
        'rgba(245,158,11,.55)', 'rgba(236,72,153,.55)', 'rgba(148,163,184,.45)',
        'rgba(34,197,94,.45)', 'rgba(14,165,233,.45)',
      ];

      const ctxStates = document.getElementById('chart-states');
      const ctxCats = document.getElementById('chart-categories');
      if (!ctxStates || !ctxCats) return;

      if (chartStates) chartStates.destroy();
      if (chartCategories) chartCategories.destroy();

      chartStates = new Chart(ctxStates, {
        type: 'bar',
        data: { labels: stateLabels, datasets: [{ label: 'Services', data: stateValues, backgroundColor: palette[0], borderColor: 'rgba(59,130,246,.85)', borderWidth: 1, borderRadius: 10 }] },
        options: { ...makeChartOptions() }
      });

      chartCategories = new Chart(ctxCats, {
        type: 'doughnut',
        data: { labels: catLabels, datasets: [{ label: 'Services', data: catValues, backgroundColor: catValues.map((_, i) => palette[i % palette.length]), borderColor: 'rgba(15,23,42,.9)', borderWidth: 2, hoverOffset: 6 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '62%',
          animation: false,
          plugins: { legend: { position: 'right', labels: { color: 'rgba(226,232,240,.85)', boxWidth: 10, boxHeight: 10, usePointStyle: true } }, tooltip: makeChartOptions().plugins.tooltip },
        }
      });

      requestAnimationFrame(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
        syncTopScrollbar();
      });
    };

    const attachAnalyticsResizeObserver = () => {
      if (!('ResizeObserver' in window)) return;
      const ro = new ResizeObserver(() => {
        if (chartStates) chartStates.resize();
        if (chartCategories) chartCategories.resize();
      });
      ro.observe(els.analyticsWrap);
    };

    // ---------------- DATA FETCH ----------------
    const refresh = async () => {
      skeleton.show();

      if (!supabaseClient) {
        console.error('Supabase client is not initialized.');
        skeleton.hide();
        els.status.textContent = 'Client Error';
        els.tbody.innerHTML = `<tr><td class="compact-td text-sm text-red-200" colspan="${getVisibleOrderedColumns().length || 1}">Supabase client initialization failed. Check console.</td></tr>`;
        showToast('Supabase client unavailable.', 'error');
        return;
      }

      try {
        const { data, error } = await supabaseClient.from(READ_TABLE).select('*');
        if (error) throw error;

        state.rows = (data || []).map(normalizeRow);

        skeleton.hide();
        updateStats();
        renderTable();
        savePrefs();
      } catch (error) {
        console.error('Error fetching services:', error);
        skeleton.hide();
        els.status.textContent = 'Error loading data';
        els.tbody.innerHTML = `<tr><td class="compact-td text-sm text-red-200" colspan="${getVisibleOrderedColumns().length || 1}">Unable to load data: ${error.message || 'Unknown error'}</td></tr>`;
        els.paginationSummary.textContent = 'No data available';
        els.pageIndicator.textContent = '—';
        showToast('Error loading services data: ' + (error.message || 'Check console'), 'error');
      }
    };

    const buildInsertPayload = (row) => {
      const payload = {};
      ALL_COLUMNS.forEach((col) => {
        const dbField = DB_FIELD_BY_COL_ID[col.id];
        if (!dbField) return;
        payload[dbField] = row[col.key] ?? null;
      });
      return payload;
    };

    async function duplicateRow(row) {
      if (!row?.id) return;
      if (state.currentUserRole !== 'administrator') { showToast('Only administrators can duplicate records.', 'warning'); return; }
      const confirmed = await showConfirm(`Duplicate "${row.company}"?`, { confirmText: 'Duplicate' });
      if (!confirmed) return;

      try {
        const payload = buildInsertPayload(row);
        const { data, error } = await supabaseClient
          .from(WRITE_TABLE)
          .insert([payload])
          .select('*')
          .single();

        if (error) throw error;

        const duplicated = normalizeRow(data);
        const index = state.rows.findIndex(r => r.id === row.id);
        if (index >= 0) {
          state.rows.splice(index + 1, 0, duplicated);
        } else {
          state.rows.push(duplicated);
        }

        renderTable();
        showToast('Record duplicated successfully.', 'success');

        logChange({
          action: 'insert',
          summary: `Duplicated ${row.company || 'service'} as #${duplicated.id}`,
          recordId: duplicated.id,
        });
      } catch (err) {
        console.error(err);
        showToast('Error duplicating record: ' + (err?.message || JSON.stringify(err)), 'error');
      }
    }

    async function deleteRow(row) {
      if (!row?.id) return;
      if (state.currentUserRole !== 'administrator') { showToast('Only administrators can delete records.', 'warning'); return; }
      const confirmed = await showConfirm(`Delete "${row.company}"?`, { confirmText: 'Delete', cancelText: 'Cancel' });
      if (!confirmed) return;
      const { error } = await supabaseClient.from(WRITE_TABLE).delete().eq('id', row.id);
      if (error) showToast('Error deleting: ' + error.message, 'error');
      else {
        showToast('Record deleted.', 'success');
        logChange({
          action: 'delete',
          summary: `Deleted ${row.company || 'service'} (#${row.id})`,
          recordId: row.id,
        });
        refresh();
      }
    }

    // ---------------- EVENTS ----------------
    els.prevPage.addEventListener('click', () => { if (state.pagination.page > 1) { state.pagination.page -= 1; savePrefs(); renderTable(); } });
    els.nextPage.addEventListener('click', () => {
      const total = applySort(applyFilters()).length;
      const totalPages = Math.max(1, Math.ceil(total / state.pagination.pageSize));
      if (state.pagination.page < totalPages) { state.pagination.page += 1; savePrefs(); renderTable(); }
    });

    els.refresh.addEventListener('click', refresh);

    // Create new record inline (adds blank row in DB, then you edit cells)
    els.addRecord?.addEventListener('click', async () => {
      if (state.currentUserRole !== 'administrator') return;
      try {
        const payload = {
          company_name: '',
          authorization: '',
          category: '',
          verified: null,
          phone: '',
          contact: '',
          address: '',
          city: '',
          state: '',
          zip: '',
          email: '',
          notes: '',
          website: '',
          availability: '',
          lat: null,
          long: null,
        };
        const { data, error } = await supabaseClient.from(WRITE_TABLE).insert([payload]).select('*').single();
        if (error) throw error;
        const normalized = normalizeRow(data);
        if (normalized?.id === undefined || normalized?.id === null || normalized.id === '') {
          console.error('Insert returned row without a valid id', data);
          showToast('Error creating record: missing ID from server. Please refresh and try again.', 'error');
          return;
        }

        state.rows.unshift(normalized);
        state.pagination.page = 1;
        renderTable();
        savePrefs();

        logChange({
          action: 'insert',
          summary: `Created new service record (#${normalized.id})`,
          recordId: normalized.id,
        });
      } catch (err) {
        console.error(err);
        showToast('Error creating record: ' + (err?.message || JSON.stringify(err)), 'error');
      }
    });

    // ---------------- INIT ----------------
    const initBackground = async () => {
      const initialMode = await loadPreferredBackgroundMode();
      setupBackgroundManager({
        canvasId: 'constellation-canvas',
        initialMode,
        onModeChange: persistBackgroundMode,
      });
    };

    const init = async () => {
      await initBackground();
      await requireSession();
      attachResizeHandles();
      attachScrollSync();
      attachAnalyticsResizeObserver();
      attachInlineEditing();
      await refresh();
      renderColumnsPopover();
      syncTopScrollbar();
      lucide.createIcons();
    };
    init();
  </script>
  <script type="module">
    import { supabase as supabaseClient } from '../../assets/js/supabaseClient.js';

    const redirectToLogin = async () => {
      if (!supabaseClient?.auth?.getSession) return;
      const { data } = await supabaseClient.auth.getSession();
      if (!data?.session) {
        window.location.href = '../login.html';
      }
    };

    redirectToLogin();
  </script>
</body>

</html>